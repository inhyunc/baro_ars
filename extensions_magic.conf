; ********************************************************************************
; *                                                                              *
; * 무인 택배함                                                                  *
; *                                                                              *
; ********************************************************************************

[magicbox-main]

exten => _X.,1,Noop([magicbox-main] Recieving Call[${EXTEN}] From [${CHANNEL(peerip)}])

	; ----------------------------------------
	; invite head 정보에서 발신번호 찾기
	; ----------------------------------------
	same => n, Set(FromNum=${CUT(SIP_HEADER(From),:,2)})
	same => n, Set(GLOBAL(CALLER)=${CUT(FromNum,@,1)})

	; ----------------------------------------
	; invite head 정보에서 070 수신번호 찾기
	; ----------------------------------------
	same => n, Set(ToNum=${CUT(SIP_HEADER(To),:,2)})
	same => n, Set(GLOBAL(CALLEE)=${CUT(ToNum,@,1)})

	same => n, Goto(magicbox-find,start,1)

	same => n, Hangup()






; ********************************************************************************
; *                                                                              *
; * 무인 택배함 : 가입자가 무인택배함에 전화를 걸어 물건 찾아가기                *
; *                                                                              *
; ********************************************************************************

[magicbox-find]

exten => start,1,Noop([magicbox-find] ${STRFTIME(${EPOCH},,%F %T)} [${CALLER}] --> [${CALLEE}])

	same => n, Set(CHANNEL(language)=kr)
	same => n, Set(countWRONG=0)
	same => n, Set(countAUTH=0)
	same => n, Set(countNoInput=0)
	same => n, Set(countTIMEOUT=0)

	same => n, Set(currentItem=1)
;	same => n, Set(RESULT1=****)
;	same => n, Set(RESULT2=****)
;	same => n, Set(RESULT3=****)
;	same => n, Set(RESULT4=****)
	same => n, Set(ErrorCode=****)

	same => n, Set(baseDIR=magic)
	same => n, Set(wavDIR=magic)
	same => n, Set(MAX_COUNT=4)
	same => n, Set(MAX_RECV_DIGIT=4)
	same => n, Set(MIN_RECV_DIGIT=0)
	same => n, Set(WAITING_TIME=5)
	same => n, Set(update_sts=0)
	same => n, Set(m_SvcType=0)

	same => n, Log(NOTICE,[magicbox-find] ${STRFTIME(${EPOCH},,%F %T)} [${CALLER}] --> [${CALLEE}])

;	same => n, Set(MGTNO="")
;	same => n, Set(MACADDR=************)
;	same => n, Set(ARSMGTNO=************)

	same => n, Set(ACCUSRTYPE=D)	; G=일반거주자, T=단체

	same => n, Set(PAYMENT=0)
	same => n, Set(ITEMCNT=0)
	same => n, Set(CONTNO=0)
	same => n, Set(LOCKNO1=0)
	same => n, Set(LOCKNO2=0)
	same => n, Set(LOCKNO3=0)
	same => n, Set(LOCKNO4=0)
	same => n, Set(LOCKNO5=0)
	same => n, Set(LOCKNO6=0)
	same => n, Set(LOCKNO7=0)
	same => n, Set(LOCKNO8=0)
	same => n, Set(LOCKNO9=0)
	same => n, Set(DAOU050NUMBER="")
	same => n, Set(m_PhoneNumber=)		; // m_PhoneNumber 초기화
	same => n, Set(m_v_PhoneNumber=)	; // m_v_PhoneNumber 안심번호초기화

	same => n, Answer()	; Progress()


	; ================================================================================
	; 인사말
	; ================================================================================
	same => n, Playback(${baseDIR}/greeting_message)		; 안녕하세요. 무인 택배함입니다.


	; ================================================================================
	; 발신번호를 가지고 발신자가 누른 050번호를 찾는다
	; ================================================================================
	same => n(get_050_number), Noop(get_050_number)

	same => n, AGI(box_daou_050_number.php)
	same => n, Log(NOTICE,[magicbox-find] [${CALLER} --> ${CALLEE}] : AGI=${AGISTATUS} RESULT1=[${RESULT1}] DAOU050NUMBER=${DAOU050NUMBER})

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?mbox_PlayErrMesg,start,1(M01_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT1}"="0000"]?M01_050_succ:M01_050_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S01_not_define,SBOX_022,0))

	; ----------------------------------------
	; 050 번호 검색 실패
	; ----------------------------------------
	same => n(M01_050_fail), Set(ErrorCode=M01_050_fail)

	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, Wait(1)
	same => n, GotoIF($[${countWRONG} < 3]?get_050_number)

	same => n, Playback(${baseDIR}/not_serviced_number)		; 지금 거신 전화번호는 서비스를
	                                                            	; 받을 수 있는 번호가 아닙니다.
	same => n, Goto(mbox_GoodBye,1)


	; ----------------------------------------
	; 050 번호 검색 성공
	; ----------------------------------------
	same => n(M01_050_succ), Set(ErrorCode=M01_050_succ)
	same => n, GotoIf($[${LEN(${DAOU050NUMBER})}<5]?M01_050_fail)           ; // 050번호 길이가 5 이상인 경우에만 유효


	same => n, AGI(sbox/sbox_check_dnid.php)
	same => n, Log(NOTICE,[sbox_check_dnid.php] [${CALLER} --> ${CALLEE}] : AGI=[${AGISTATUS}] RLT=[${RESULT}], m_SvcType=[${m_SvcType}])

	same => n, Goto(M21_recvDgt)



	; ================================================================================
	;                                                                                *
	; ================================================================================
	same => n(M21_recvDgt), Set(ErrorCode=M21_recvDgt)
	same => n, read(SELNUM,${baseDIR}/MBOX_002,1,n,1,5)		; 사용자는 1번.
	                                                   		; 택배 기사는 2번.
	                                                   		; 관리자는 3번.
	                                                   		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?M21_not_enter)         ; // 미입력

	same => n, GotoIf($["${SELNUM}"="1"]?M31_main)			; // 사용자 서비스
	same => n, GotoIf($["${SELNUM}"="2"]?M21_2_3)			; // 택배 기사 서비스
	same => n, GotoIf($["${SELNUM}"="3"]?M21_2_3)			; // 관리자 서비스
	same => n, GotoIf($["${SELNUM}"="0"]?M21_recvDgt)		; // 다시 듣기 선택

	; ----------------------------------------
	; 입력 정보 오류
	; ----------------------------------------
	same => n(M21_wrong), Set(ErrorCode=M21_wrong)
	same => n, GoSub(mbox_PlayErrMesg,start,1(M21_wrong,pressWrong,2))        ; 잘못 눌렀습니다.
	same => n, Goto(M21_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음
	; ----------------------------------------
	same => n(M21_not_enter), Set(ErrorCode=M21_not_enter)
	same => n, GoSub(mbox_PlayErrMesg,start,1(M21_not_enter,timeOut,3))    ; 입력된 정보가 없습니다.
	same => n, Goto(M21_recvDgt)


	; ----------------------------------------
	; 2 or 3번 선택시
	; ----------------------------------------
	same => n(M21_2_3), Set(ErrorCode=M21_2_3)

	same => n, AGI(barobox/box_find_mgtno.php)
	same => n, Log(NOTICE,[magicbox-find] [${CALLER} --> ${CALLEE}] : AGI=${AGISTATUS} MGTNO=[${MGTNO}] MAC=[${MACADDR}] RESULT1=[${RESULT1}], ACCUSRTYPE=${ACCUSRTYPE})

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?mgt_1111_error)

	same => n, GotoIf($["${RESULT1}"="8999"]?mgt_8999_error)

	same => n, GotoIf($["${SELNUM}"="2"]?magicbox-delivery,start,1)	; // 택배 기사 서비스
	same => n, GotoIf($["${SELNUM}"="3"]?magicbox-admin,start,1)			; // 관리자 서비스

	same => n(M31_main), Noop(M31_main)



	; ================================================================================
	; 발신번호 및 착신번호로 관리번호를 가져온다 :                                   *
	; RESULT1 : 0000 : 해당 ARS번호로 된 택배함이 1개인 경우                         *
	;           1111 : 해당 ARS번호로 된 택배함이 1개 이상일 경우 -> 관리번호 입력받아야 함 
	;           8888 : DB connect 에러                                               *
	;           8898 : 고객님은 시스템에 등록된 가입자가 아닙니다.                   *
	;           8899 : 미등록 회원입니다. 해당 보관함 사용자 등록을 하려면 1번을 눌러 주세요. 
	;           8999 : 해당 ARS 번호가 등록된 택배함 존재하지 않음                   *
	;           9999 : 프로그램 에러                                                 *
	; ================================================================================
	same => n(find_mgtno), Noop(find_mgtno)

	same => n, AGI(barobox/box_find_mgtno.php)

	same => n, Log(NOTICE,[magicbox-find] [${CALLER} --> ${CALLEE}] : AGI=${AGISTATUS} MGTNO=[${MGTNO}] MAC=[${MACADDR}] RESULT1=[${RESULT1}], ACCUSRTYPE=${ACCUSRTYPE})

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?mgt_8888_error)

	same => n, GotoIf($["${RESULT1}"="0000"]?get_box_inform)
	same => n, GotoIf($["${RESULT1}"="1111"]?mgt_1111_error)	; 0313 : recv_msg_no --> mgt_1111_error
	same => n, GotoIf($["${RESULT1}"="8888"]?mgt_8888_error)
	same => n, GotoIf($["${RESULT1}"="8898"]?mgt_8898_error)
	same => n, GotoIf($["${RESULT1}"="8899"]?mgt_8899_error)
	same => n, GotoIf($["${RESULT1}"="8999"]?mgt_8999_error)
	same => n, GotoIf($["${RESULT1}"="9999"]?mgt_9999_error:mgt_unknown_error)

	same => n(mgt_1111_error), Set(ErrorCode=mgt_1111_error)
	same => n, Playback(${baseDIR}/mb_mgt_1111_error)		; 시스템 정보에 접근하지 못했습니다.
	same => n, Goto(end_on_mgt_step)

	same => n(mgt_8888_error), Set(ErrorCode=mgt_8888_error)
	same => n, Playback(${baseDIR}/mb_mgt_8888_error)		; 시스템 정보에 접근하지 못했습니다.
	same => n, Goto(end_on_mgt_step)

	same => n(mgt_8898_error), Set(ErrorCode=mgt_8898_error)
	same => n, Playback(${baseDIR}/mb_mgt_8899_error)		; 고객님은 시스템에 등록된 가입자가 아닙니다.
	same => n, Playback(${baseDIR}/MBOX_025)			; 관리자에게 문의하시기 바랍니다.
	same => n, Goto(end_on_mgt_step)

	same => n(mgt_8899_error), Set(ErrorCode=mgt_8899_error)
	same => n, GotoIf($[${m_SvcType}=1]?:mgt_8898_error)
	same => n, read(SELNUM,${baseDIR}/press1_toRegister,1,n,1,5)	; 미등록 회원입니다. 해당 보관함 사용자 등록을 하려면 1번을 눌러 주세요.
	same => n, GotoIf($["${SELNUM}"="1"]?magicbox-reg,start,1)

;	same => n, Playback(${baseDIR}/mb_mgt_8899_error)		; 고객님은 시스템에 등록된 가입자가 아닙니다.
;	same => n, Set(ErrorCode=mgt_8899_error)
	same => n, Goto(end_on_mgt_step)

	same => n(mgt_8999_error), Set(ErrorCode=mgt_8999_error)
	same => n, Playback(${baseDIR}/mb_mgt_8999_error)		; 해당 ARS번호에 등록된 택배함 번호가 존재하지 않습니다.
	same => n, Goto(end_on_mgt_step)

	same => n(mgt_9999_error), Set(ErrorCode=mgt_9999_error)
	same => n, Playback(${baseDIR}/mb_mgt_9999_error)		; 시스템 서버 장애로 서비스를 제공하지 못합니다.
	same => n, Goto(end_on_mgt_step)

	same => n(mgt_unknown_error), Set(ErrorCode=mgt_unknown_error)
	same => n, Playback(${baseDIR}/mb_mgt_unknown_error)		; 알려지지 않은 장애로 관리번호를 찾을 수 없습니다.
	same => n, Goto(end_on_mgt_step)

	same => n(end_on_mgt_step), Noop(end_on_mgt_step)
	same => n, Goto(mbox_Finish,1)



	; ================================================================================
	; Read(variable[,filename][,maxdigits][,option][,attempts][,timeout])            *
	; MGTNO : MagicBox Control Number                                                *
	; ================================================================================
	same => n(recv_mgt_no), Set(soundFileName=inputControlNumber_4)
	same => n, read(ARSMGTNO,${baseDIR}/${soundFileName},${MAX_RECV_DIGIT},n,1,${WAITING_TIME})	; 택배함 관리번호 8자리를 누르세요.

	same => n, GotoIf($[${LEN(${ARSMGTNO})}=${MAX_RECV_DIGIT}]?get_box_inform)
	same => n, GotoIf($[${LEN(${ARSMGTNO})}=${MIN_RECV_DIGIT}]?retry_not_input)


	; ----------------------------------------
	; 입력된 정보가 4자릿수가 안되는 경우     
	; ----------------------------------------
	same => n(retry_error), Noop(retry_error countWRONG=${countWRONG})

	same => n, Set(ErrorCode=pressWrong-2)
	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?wrong_12:wrong_13)

	same => n(wrong_12), Playback(${baseDIR}/pressWrong)		; 잘못 눌렀습니다.
	same => n, Goto(recv_mgt_no)

	same => n(wrong_13), Playback(${baseDIR}/checkAgain)		; 확인후 다시 이용해 주십시요.
	same => n, Goto(mbox_Finish,1)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(retry_not_input), Noop(retry_not_input)

	same => n, Set(ErrorCode=noInput)
	same => n, Set(countNoInput=[${countNoInput}+1])
	same => n, GotoIF($[${countNoInput} < 3]?wrong_22:wrong_23)

	same => n(wrong_22), Playback(${baseDIR}/noInput)		; 입력된 정보가 없습니다.
	same => n, Goto(recv_mgt_no)

	same => n(wrong_23), Playback(${baseDIR}/checkAgain)		; 확인후 다시 이용해 주십시요.
	same => n, Goto(mbox_Finish,1)


	; ================================================================================
	; 발신번호와 ARSMGTNO번호로 열어주어야 할 택배함 갯수와 도어 번호를 가지고 온다  *
	; RESULT2 :                                                                      *
	;           7777 : 찾을 물건 / 세탁물이 없을 때                                  *
	;           0000 : 찾을 물건이 1개 일 때                                         *
	;           0001 : 찾을 물건이 2개 이상 9개 이하일 때                            *
	;           6666 : 찾을 물건이 10개 이상일 때                                    *
	;                                                                                *
	;           8008 : 할당된 관리번호 존재하지않음                                  *
	;           8009 : 할당된 ARS_MST_NO 없음                                        *
	;           8888 : DB connect 에러                                               *
	;           8999 : 해당 ARS 전화번호에 해당하는 데이터 없음                      *
	;           9998 :                                                               *
	;           9999 : 프로그램 에러                                                 *
	; ================================================================================
	same => n(get_box_inform), Noop(Get_Box_Inform MGTNO=${MGTNO})

	same => n, AGI(barobox/box_find_lock.php)

	same => n, Log(NOTICE,[magicbox-find] [${CALLER} --> ${CALLEE}] : AGI=${AGISTATUS} MGTNO=[${MGTNO}] MAC=[${MACADDR}] RESULT2=[${RESULT2}] PAYMENT=[${PAYMENT}] ITEMCNT=[${ITEMCNT}] LOCKNO1=[${LOCKNO1},${LOCKNO2},${LOCKNO3},${LOCKNO4},${LOCKNO5},${LOCKNO6},${LOCKNO7},${LOCKNO8},${LOCKNO9}] )

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?lock_8888_error)

	same => n, ExecIf($["${RESULT2}"="6666"]?Set(ITEMCNT=10))

	same => n, GotoIf($["${RESULT2}"="7777"]?lock_succ)	; nothingFind
	same => n, GotoIf($["${RESULT2}"="0000"]?lock_succ)	; onething_toFind
	same => n, GotoIf($["${RESULT2}"="0001"]?lock_succ)	; severalThing_toFind
	same => n, GotoIf($["${RESULT2}"="6666"]?lock_succ)	; useApp

	same => n, GotoIf($["${RESULT2}"="8008"]?lock_8008_error)
	same => n, GotoIf($["${RESULT2}"="8888"]?lock_8888_error)
	same => n, GotoIf($["${RESULT2}"="8999"]?lock_8999_error)
	same => n, GotoIf($["${RESULT2}"="9998"]?lock_9998_error)
	same => n, GotoIf($["${RESULT2}"="9999"]?lock_9999_error:lock_unknown_error)

	same => n(lock_8008_error), Noop(lock_8008_error)
	same => n, Playback(${baseDIR}/mb_lock_8008_error)		; 고객께서 요청하신 정보를 찾을 수 없습니다.
	same => n, Set(ErrorCode=lock_8008_error)
	same => n, Goto(end_on_lock_step)

	same => n(lock_8888_error), Noop(lock_8888_error)
	same => n, Playback(${baseDIR}/mb_lock_8888_error)		; 시스템 정보에 접근하지 못했습니다.
	same => n, Set(ErrorCode=lock_8888_error)
	same => n, Goto(end_on_lock_step)

	same => n(lock_8999_error), Noop(lock_8999_error)
	same => n, Playback(${baseDIR}/mb_lock_8999_error)		; 해당 ARS 번호에 등록된 택배함 번호가 존재하지 않습니다.
	same => n, Set(ErrorCode=lock_8999_error)
	same => n, Goto(end_on_lock_step)

	same => n(lock_9998_error), Noop(lock_9998_error)
	same => n, Playback(${baseDIR}/mb_lock_9998_error)		; 지금은 이용할 수 없습니다. 잠시후 이용해 주시기 바랍니다.
	same => n, Set(ErrorCode=lock_9998_error)
	same => n, Goto(end_on_lock_step)

	same => n(lock_9999_error), Noop(lock_9999_error)
	same => n, Playback(${baseDIR}/mb_lock_9999_error)		; 시스템 서버 장애로 서비스를 제공하지 못합니다.
	same => n, Set(ErrorCode=lock_9999_error)
	same => n, Goto(end_on_lock_step)

	same => n(lock_unknown_error), Noop(lock_unknown_error)
	same => n, Playback(${baseDIR}/mb_lock_unknown_error)		; 알려지지 않은 장애로 도어함 정보를 찾을 수 없습니다.
	same => n, Set(ErrorCode=lock_unknown_error)
	same => n, Goto(end_on_lock_step)

	same => n(end_on_lock_step), Noop(end_on_1_step)
	same => n, Goto(mbox_Finish,1)


	; ================================================================================
	; 인증 실패(인증 코드는 있는 상태인데 원인불명으로 인증안됨)                     *
	; ================================================================================
	same => n(auth_fail), Noop(Auth_Fail)

	same => n, Playback(${baseDIR}/notAuth_withUnknownError)	; 알려지지 않은 오류로 인증이 되지 않고 있습니다.
	same => n, Set(ErrorCode=notAuth_withUnknownError)
	same => n, Goto(retryAgain)


	; ----------------------------------------
	; 인증에라(인증코드 자릿수 오류로 인증안됨)
	; ----------------------------------------
	same => n(auth_error), Noop(auth_error)

	same => n, Playback(${baseDIR}/errorInAuthCode)			; 관리번호에 오류가 있습니다.
	same => n, Set(ErrorCode=errorInAuthCode)
	same => n, Set(countAUTH=[${countAUTH}+1])
	same => n, GotoIF($[${countAUTH}<3]?recv_mgt_no:retryAgain)


	; ----------------------------------------
	; 등록된 인증코드 없음                    
	; ----------------------------------------
	same => n(notRegAuth), Noop(NotReg_Auth)

	same => n, Playback(${baseDIR}/notRegAuthCode)			; 등록된 관리번호가 없습니다.
	same => n, Set(ErrorCode=notRegAuthCode)
	same => n, Goto(retryAgain)


	; ----------------------------------------
	; 등록된 전화번호 없음                    
	; ----------------------------------------
	same => n(notRegPhone), Noop(NotReg_Phone)

	same => n, Playback(${baseDIR}/notRegPhoneNumber)		; 등록된 전화번호가 없습니다.
	same => n, Set(ErrorCode=notRegPhoneNumber)
	same => n, Goto(retryAgain)


	; ================================================================================
	; 종료함                                                                         *
	; ================================================================================
	same => n(retryAgain), Noop(RetryAgain)

	same => n, Playback(${baseDIR}/checkAgain)			; 확인후 다시 이용해 주십시요.
	same => n, Goto(mbox_Finish,1)


	; ================================================================================
	;                                                                                *
	; ================================================================================
	same => n(lock_succ), Noop(Auth_Succ)

	same => n, GotoIF($[${PAYMENT}>0]?anm_payment,1)

	same => n, Set(countWRONG=0)

	same => n, GotoIF($[${ITEMCNT}=0]?nothingFind) 
	same => n, GotoIF($[${ITEMCNT}=1]?onething_toFind) 
	same => n, GotoIF($[${ITEMCNT}<4]?severalThing_toFind:useApp)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(nothingFind), Noop(NoThingFind)

	same => n, Playback(${baseDIR}/nothing_toFind)			; 찾으실 택배 물건이나 세탁물이 없습니다.
	same => n, Set(ErrorCode=noItems_toFind)
	same => n, Goto(step_sendPkg,1)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(useApp), Noop(UseApp)

;	same => n, Set(soundFileName=if_over_10)
;	same => n, Playback(${baseDIR}/${soundFileName})		; 찾을 물건이 10개 넘습니다.

	same => n, Set(i=4)
	same => n, Set(soundFileName=${SPRINTF(counts/%d_gae,${i})})

	same => n, Playback(${baseDIR}/things_toFind)			; 찾을 물건이
	same => n, Playback(${baseDIR}/${soundFileName})		; [XX] 개
	same => n, Playback(${baseDIR}/is_over)				; 넘습니다.
	same => n, Playback(${baseDIR}/useApp_toFind)			; 앱을 이용하여 찾으시기 바랍니다.

	same => n, Set(ErrorCode=useApp_toFind)
	same => n, Goto(mbox_Finish,1)

	; ================================================================================
	; 찾을 물건이 한개인 경우                                                        *
	; ================================================================================
	same => n(onething_toFind), Noop(onething_toFind)


	; ================================================================================
	; 찾을 물건이 2개 ~ 9개인 경우                                                   *
	; ================================================================================
	same => n(severalThing_toFind), Noop(serveralThing_toFind)

	same => n, Set(currentItem=1)
	same => n, Set(str_FOLDER="${baseDIR}/counts/")
	same => n, Set(soundFileName=${SPRINTF(%s%d_gae,${str_FOLDER},${ITEMCNT})})

	same => n, Set(F1=${SPRINTF(${baseDIR}/things_toFind)})		; 찾을 물건이
	same => n, Set(F2=${SPRINTF(${soundFileName})})			; X 개
	same => n, Set(F3=${SPRINTF(${baseDIR}/thereAre)})		; 있습니다.


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(severalThing_toFind_2), Noop(serveralThing_toFind_2)

	same => n(makeSndFile), Noop(makeSndFile)

	same => n, Set(str_FOLDER="${baseDIR}/digits/")
	same => n, ExecIF($[${currentItem}=1]?Set(value_xx=${MATH(${LOCKNO1}%100,int)}))
	same => n, ExecIF($[${currentItem}=2]?Set(value_xx=${MATH(${LOCKNO2}%100,int)}))
	same => n, ExecIF($[${currentItem}=3]?Set(value_xx=${MATH(${LOCKNO3}%100,int)}))
	same => n, ExecIF($[${currentItem}=4]?Set(value_xx=${MATH(${LOCKNO4}%100,int)}))
	same => n, ExecIF($[${currentItem}=5]?Set(value_xx=${MATH(${LOCKNO5}%100,int)}))
	same => n, ExecIF($[${currentItem}=6]?Set(value_xx=${MATH(${LOCKNO6}%100,int)}))
	same => n, ExecIF($[${currentItem}=7]?Set(value_xx=${MATH(${LOCKNO7}%100,int)}))
	same => n, ExecIF($[${currentItem}=8]?Set(value_xx=${MATH(${LOCKNO8}%100,int)}))
	same => n, ExecIF($[${currentItem}=9]?Set(value_xx=${MATH(${LOCKNO9}%100,int)}))

	same => n, Noop(value_xx = [${value_xx}])

	; ---------------------------------------------------------
	; 읽는 방식 : 십자리 + 단단위(단 10이하이면 십단위는 생략)
	; ---------------------------------------------------------
	same => n, Set(value_0x=${MATH(${value_xx}%10,int)})
	same => n, Set(value_x0=${MATH(${value_xx}-${value_0x},int)})

	same => n, Set(FstDigit=${SPRINTF(%s%d,${str_FOLDER},${value_x0})})
	same => n, Set(SndDigit=${SPRINTF(%s%d,${str_FOLDER},${value_0x})})


	same => n, GotoIf($[${value_xx}<10]?p2_below_10)
	same => n, GotoIf($[${value_0x}=0]?p2_equal_0:p2_more_0)

	same => n(p2_below_10), NoOp(p2_below_10)
	same => n, Set(soundFileName=${SPRINTF(%s_beon,${SndDigit})})
	same => n, Goto(p2_play_soundfile)

	same => n(p2_equal_0), NoOp(p2_equal_0)
	same => n, Set(soundFileName=${SPRINTF(%s_beon,${FstDigit})})
	same => n, Goto(p2_play_soundfile)

	same => n(p2_more_0), NoOp(p2_more_0)
	same => n, Set(soundFileName=${SPRINTF(%s&%s_beon,${FstDigit},${SndDigit})})
	same => n, Goto(p2_play_soundfile)


	; ----------------------------------------
	; 보관함 번호는 [XX] 번 입니다.               
	; ----------------------------------------
	same => n(p2_play_soundfile), NoOp(p2_play_soundfile)

	same => n, Set(S1=${soundFileName})		; [XX] 번

	same => n, ExecIF($[${currentItem}=1]?Set(C1=${SPRINTF(%s,${S1})}))
	same => n, ExecIF($[${currentItem}=2]?Set(C2=${SPRINTF(%s&%s,${C1},${S1})}))
	same => n, ExecIF($[${currentItem}=3]?Set(C3=${SPRINTF(%s&%s,${C2},${S1})}))
	same => n, ExecIF($[${currentItem}=4]?Set(C4=${SPRINTF(%s&%s,${C3},${S1})}))
	same => n, ExecIF($[${currentItem}=5]?Set(C5=${SPRINTF(%s&%s,${C4},${S1})}))
	same => n, ExecIF($[${currentItem}=6]?Set(C6=${SPRINTF(%s&%s,${C5},${S1})}))
	same => n, ExecIF($[${currentItem}=7]?Set(C7=${SPRINTF(%s&%s,${C6},${S1})}))
	same => n, ExecIF($[${currentItem}=8]?Set(C8=${SPRINTF(%s&%s,${C7},${S1})}))
	same => n, ExecIF($[${currentItem}=9]?Set(C9=${SPRINTF(%s&%s,${C8},${S1})}))

	same => n, ExecIF($[${currentItem}=1]?Set(CN=${C1}))
	same => n, ExecIF($[${currentItem}=2]?Set(CN=${C2}))
	same => n, ExecIF($[${currentItem}=3]?Set(CN=${C3}))
	same => n, ExecIF($[${currentItem}=4]?Set(CN=${C4}))
	same => n, ExecIF($[${currentItem}=5]?Set(CN=${C5}))
	same => n, ExecIF($[${currentItem}=6]?Set(CN=${C6}))
	same => n, ExecIF($[${currentItem}=7]?Set(CN=${C7}))
	same => n, ExecIF($[${currentItem}=8]?Set(CN=${C8}))
	same => n, ExecIF($[${currentItem}=9]?Set(CN=${C9}))

	same => n, Set(currentItem=$[${currentItem}+1])
	same => n, GotoIF($[${currentItem}<=${ITEMCNT}]?makeSndFile)

	same => n, Set(B1=${SPRINTF(${baseDIR}/lockerNum_is)})	; 보관함 번호는
	same => n, Set(B2=${SPRINTF(%s,${CN})})			; [XX]번 ... [XX]번
	same => n, Set(B3=${SPRINTF(${baseDIR}/it_is)})		; 입니다. 
	same => n, Set(B4=${SPRINTF(${baseDIR}/press1_toFind)})	; 찾으실려면 1번을 누르세요.

	same => n, Set(FN=${SPRINTF(%s&%s&%s&%s&%s&%s&%s,${F1},${F2},${F3},${B1},${B2},${B3},${B4})})

	same => n, read(SELNUM,${FN},1,n,1,5)

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?timeOut)
	same => n, GotoIf($["${SELNUM}"="1"]?open,1)


	; ================================================================================
	; 고객이 1번을 누르지 않고 다른 버튼 누르는 경우                                 *
	; ================================================================================
	same => n, Set(ErrorCode=pressWrong)
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < ${MAX_COUNT}]?lessThan_00:moreThan_00)

	same => n(lessThan_00), Noop(lessThan_00)
	same => n, read(SELNUM,${baseDIR}/pressWrong,1,n,1,1)		; 잘못 눌렀습니다.
	same => n, GotoIf($["${SELNUM}"="1"]?open,1)

	same => n, Set(currentItem=1)
	same => n, Goto(start,severalThing_toFind_2)

	same => n(moreThan_00), Noop(moreThan_00)
	same => n, Playback(${baseDIR}/checkAgain)			; 확인후 다시 이용해 주십시요.
	same => n, Goto(mbox_Finish,1)


	; ================================================================================
	; 고객이 다이얼 버튼을 누르지 않아 타임아웃이 발생하는 경우                      *
	; ================================================================================
	same => n(timeOut), Set(ErrorCode=timeOut)
	same => n, Set(countTIMEOUT=$[${countTIMEOUT}+1])
	same => n, GotoIF($[${countTIMEOUT} < ${MAX_COUNT}]?lessThan_10:moreThan_10)

	same => n(lessThan_10), Noop(lessThan_10)
	same => n, read(SELNUM,${baseDIR}/timeOut,1,n,1,1)		; 입력 시간이 초과되었습니다.
	same => n, GotoIf($["${SELNUM}"="1"]?open,1)

	same => n, Set(currentItem=1)
	same => n, Goto(start,severalThing_toFind_2)

	same => n(moreThan_10), Noop(moreThan_10)
	same => n, Goto(mbox_GoodBye,1)


	; ================================================================================
	; 고객이 1번을 누르는 경우                                                       *
	; ================================================================================
exten => open, 1, Noop(OpenDoor)
	same => n, Set(currentItem=1)

	same => n(openDoor), Noop(openDoor-${curretItem})


	; ================================================================================
	; 택배함 도어를 열어준다                                                         *
	; RESULT3 :                                                                      *
	;           0000 : Door 오픈 됨                                                  *
	;           9999 : 프로그램 에러                                                 *
	;           9998 : 3-1의 파라미터 누락                                           *
	;           1111 : 도어 오픈 요청을 했으나 해당 TCPBOX가 존재하지 않음           *
	; ================================================================================
	same => n, Set(update_sts=1)

;	same => n, AGI(agi://218.232.94.161:8200,open,${MACADDR},${CONTNO})
	same => n, AGI(agi://box.baro.so:8200,open,${MACADDR},${CONTNO})

	same => n, Log(NOTICE,[magicbox-find] [${CALLER} --> ${CALLEE}] : AGI=${AGISTATUS} MGTNO=[${MGTNO}] MAC=[${MACADDR}] RESULT3=[${RESULT3}] CONTNO=[${CONTNO}] )

	same => n, GotoIf($["${RESULT3}"="0000"]?open_succ)
	same => n, GotoIf($["${RESULT3}"="1111"]?open_1111_error)
	same => n, GotoIf($["${RESULT3}"="9998"]?open_9998_error)
	same => n, GotoIf($["${RESULT3}"="9999"]?open_9999_error:open_unknown_error)

	; ==============================================
	; 도어를 순차적으로 열 때는 여기를 풀어야 한다.
	; ==============================================
	same => n(open_succ), Noop(open_succ)

	; ==============================================
	; 도어를 여는데 성공하는 경우 
	; ==============================================
	same => n, Set(FstDigit="${baseDIR}/doorOpened");		; 해당 보관함 도어가 열렸습니다.
	same => n, Set(SndDigit="${baseDIR}/doorOpenedSequencely");	; 해당 보관함 도어가 순차적으로 모두 열렸습니다. 
	same => n, Set(soundFileName=${IF($[${ITEMCNT}=1]?${FstDigit}:${SndDigit})})


	same => n, Playback(${soundFileName})				; 해당 보관함 도어가 (순차적으로 모두) 열렸습니다.

	same => n, Set(FstDigit="${baseDIR}/makeClose_afterFinding");
	same => n, Set(SndDigit="${baseDIR}/makeAllClose_afterFinding");
	same => n, Set(soundFileName=${IF($[${ITEMCNT}=1]?${FstDigit}:${SndDigit})})

	same => n, Playback(${soundFileName})				; 보관된 물품을 찾으신 후에
	                                             			; 반드시 (모든) 보관함 도어를 닫아 주시기 바랍니다.
	same => n, Set(ErrorCode=OK)
	same => n, Goto(check_update)


	; ==============================================
	; 도어를 여는데 실패하는 경우 
	; ==============================================
	same => n(open_1111_error), Noop(open_1111_error)

	same => n, Playback(${baseDIR}/mb_open_1111_error)		; 도어 오픈을 요청하였으나 일시적으로 해당 박스가
	                                                          	; 존재하지 않아 도어를 여는데 실패하였습니다.
	same => n, Set(ErrorCode=open_1111_error)
	same => n, Goto(end_on_open_step)


	same => n(open_9998_error), Noop(open_9998_error)
	same => n, Playback(${baseDIR}/mb_open_9998_error)		; 시스템 장애로 요청하신 도어를 여는데 실패하였습니다.
	same => n, Set(ErrorCode=open_9998_error)
	same => n, Goto(end_on_open_step)


	same => n(open_9999_error), Noop(open_9999_error)
	same => n, Playback(${baseDIR}/mb_open_9999_error)		; 시스템 장애로 요청하신 도어를 열지 못 했습니다.
	same => n, Set(ErrorCode=open_9999_error)
	same => n, Goto(end_on_open_step)


	same => n(open_unknown_error), Noop(open_unknown_error)
	same => n, Playback(${baseDIR}/mb_open_unknown_error)		; 알려지지 않은 장애로 도어를 열지 못했습니다.
	same => n, Set(ErrorCode=open_unknown_error)
	same => n, Goto(end_on_open_step)


	same => n(end_on_open_step), Noop(end_on_open_step)
	same => n, Goto(mbox_GoodBye,1)


	; ================================================================================
	; 보관함 히스토리 업데이트                                                       *
	; RESULT4 :                                                                      *
	;           0000 : 히스토리 업데이트 완료                                        *
	;           8888 : DB connect 에러                                               *
	;           8999: 해당 관리번호 에 대한 인덱스 조회 실패                         *
	;           9999 : 프로그램 에러                                                 *
	; ================================================================================
	same => n(check_update), Noop(check_update)

	same => n, AGI(barobox/box_history_update_find.php)

	same => n, Set(update_sts=2)

	same => n, Log(NOTICE,[magicbox-find] [${CALLER} --> ${CALLEE}] : AGI=${AGISTATUS} RESULT4=[${RESULT4}])

	same => n, GotoIf($["${RESULT4}"="0000"]?update_succ)
	same => n, GotoIf($["${RESULT4}"="8888"]?update_8888_error)
	same => n, GotoIf($["${RESULT4}"="8999"]?update_8999_error)
	same => n, GotoIf($["${RESULT4}"="9999"]?update_9999_error:update_unknown_error)

	same => n(update_succ), Noop(update_succ)
	same => n, Goto(mbox_GoodBye,1)

	; ==============================================
	; 업데이트 실패하는 경우 
	; ==============================================
	same => n(update_8888_error), Set(ErrorCode=update_8888_error)
	same => n, Playback(${baseDIR}/mb_update_8888_error)		; 이력 정보를 업데이트하는 서버 접근이 허용되지 않고 있습니다.
	same => n, Goto(end_on_update_step)

	same => n(update_8999_error), Set(ErrorCode=update_8999_error)
	same => n, Playback(${baseDIR}/mb_update_8999_error)		; 요청하신 정보를 조회하였는데 일시적으로 정보에 접근할 수 없습니다.
	same => n, Goto(end_on_update_step)

	same => n(update_9999_error), Set(ErrorCode=update_9999_error)
	same => n, Playback(${baseDIR}/mb_update_9999_error)		; 이력 정보를 업데이트하는데 장애가 발생하였습니다. 
	same => n, Goto(end_on_update_step)

	same => n(update_unknown_error), Set(ErrorCode=update_unknown_error)
	same => n, Playback(${baseDIR}/mb_update_unknown_error)		; 알려지지 않은 장애로 업데이트를 하지 못 했습니다.
	same => n, Goto(end_on_update_step)

	same => n(end_on_update_step), Noop(end_on_update_step)
	same => n, Goto(mbox_GoodBye,1)

	; ================================================================================
	; 고객이 다이얼 버튼을 누르기를 기다리는 중 시스템에서 hangup이 발생하는 경우    *
	; ================================================================================
exten => h,1, Noop(mbox_Hangup)
	same => n, ExecIf($[${update_sts}=1]?AGI(barobox/box_history_update_find.php))
	same => n, Log(NOTICE,[magicbox-find] [${CALLER} --> ${CALLEE}] : AGI=${AGISTATUS} MGTNO=[${MGTNO}] ${ErrorCode}/The_Caller_HangUp )
	same => n, Hangup()


	; ================================================================================
	; 종료 원인을 로그에 저장하고 종료함                                             *
	; ================================================================================
exten => mbox_GoodBye,1, Noop(mbox_GoodBye)
	same => n, Playback(${baseDIR}/thankYou_forUsing)		; 이용해 주셔서 감사합니다.

	same => n, Log(NOTICE,[magicbox-find] [${CALLER} --> ${CALLEE}] : MGTNO=[${MGTNO}] ERR=[${ErrorCode}] )
	same => n, Hangup()


exten => mbox_Finish,1, Noop(mbox_Finish)
	same => n, Log(NOTICE,[magicbox-find] [${CALLER} --> ${CALLEE}] : MGTNO=[${MGTNO}] ERR=[${ErrorCode}] )
	same => n, Hangup()


	; ================================================================================
	; 찾을 물건이 없을 시에 택배 발송 기능 제공                                      *
	; ================================================================================
exten => step_sendPkg,1, Noop(step_sendPkg)

;	아래 두줄은 2018.6.7 소장님 지시로 막음
;	same => n, read(SELNUM,${baseDIR}/press1_toSendPkg,1,n,1,9)	; 택배를 보내시려면 1번을 누르세요.

;	same => n, GotoIf($["${SELNUM}"="1"]?magicbox-send,start,1)
	same => n, Goto(mbox_GoodBye,1)




	; ================================================================================
	; 결재 금액 안내
        ; VN : 금액 
        ; V1 : 만단위
        ; V2 : 천단위
        ; V3 : 백단위
        ; V4 : 십단위
        ; V5 : 십단위
	; ================================================================================
exten => anm_payment,1, Noop(anm_payment)
	same => n, Set(VN=${PAYMENT})

	same => n, Set(V1=${MATH(${VN}/10000,int)})
	same => n, Set(YY=${MATH(${V1}*10000,int)})

	same => n, Set(VN=${MATH(${VN}-${YY},int)})
	same => n, Set(V2=${MATH(${VN}/1000,int)})
	same => n, Set(YY=${MATH(${V2}*1000,int)})

	same => n, Set(VN=${MATH(${VN}-${YY},int)})
	same => n, Set(V3=${MATH(${VN}/100,int)})
	same => n, Set(YY=${MATH(${V3}*100,int)})

	same => n, Set(VN=${MATH(${VN}-${YY},int)})
	same => n, Set(V4=${MATH(${VN}/10,int)})
	same => n, Set(YY=${MATH(${V4}*10,int)})

	same => n, Set(VN=${MATH(${VN}-${YY},int)})
	same => n, Set(V5=${VN})

	same => n, GotoIf($[${PAYMENT}>=100000]?more_than_100000)	; 결재 금액이 십만원 이상인 경우 안내멘트 별도

	; -------------------------------------------------------
	;                                                        
	; -------------------------------------------------------
	same => n, Set(str_FOLDER="${baseDIR}/digits/")

	same => n, Set(D1="")
	same => n, Set(D2="")
	same => n, Set(D3="")
	same => n, Set(D4="")
	same => n, Set(D5="")

	same => n, ExecIf($[${V1}>0]?Set(D1=${SPRINTF(%s%d_man,${str_FOLDER},${V1})}))
	same => n, ExecIf($[${V2}>0]?Set(D2=${SPRINTF(%s%d_cheon,${str_FOLDER},${V2})}))
	same => n, ExecIf($[${V3}>0]?Set(D3=${SPRINTF(%s%d_baek,${str_FOLDER},${V3})}))
	same => n, ExecIf($[${V4}>0]?Set(D4=${SPRINTF(%s%d_sib,${str_FOLDER},${V4})}))
	same => n, ExecIf($[${V5}>0]?Set(D5=${SPRINTF(%s%d,${str_FOLDER},${V5})}))

	; -------------------------------------------------------
	;                                                        
	; -------------------------------------------------------
	same => n, Playback(${baseDIR}/pm_payment_amount)			; 결재 금액이 

	same => n, ExecIf($[${V1}>0]?Playback(${D1}))
	same => n, ExecIf($[${V2}>0]?Playback(${D2}))
	same => n, ExecIf($[${V3}>0]?Playback(${D3}))
	same => n, ExecIf($[${V4}>0]?Playback(${D4}))
	same => n, ExecIf($[${V5}>0]?Playback(${D5}))

	same => n, Playback(${baseDIR}/pm_won)					; 원
	same => n, Playback(${baseDIR}/pm_there_is)				; 있습니다.
	same => n, Playback(${baseDIR}/pm_find_it_after_paid_using_app)		; 앱을 이용하여 결재한 후 찾으십시요.
	same => n, Goto(mbox_GoodBye,1)

	same => n(more_than_100000), Noop(more_than_100000)
	same => n, Playback(${baseDIR}/pm_more_than_sibmanwon)			; 결재 금액이 십만원이 넘습니다. 
	same => n, Playback(${baseDIR}/pm_find_it_after_paid_using_app)		; 앱을 이용하여 결재한 후 찾으십시요.
	same => n, Goto(mbox_GoodBye,1)



[magicbox-delivery]
exten => start, 1, Noop(***** start magicbox-delivery *****)


	same => n, Set(wavDIR=sbox)
	same => n, Set(ErrorCode=M33_start)
	same => n, GoSub(mbox_CheckBoxStyle,start,1(${ErrorCode}))

	; ********************************************************************************
	;                                                                                *
	; 3-3 택배 기사 보관 첫 음성안내                                                 *
	;                                                                                *
	; ********************************************************************************
	same => n(M33_main), Set(ErrorCode=M33_main)

	same => n, Playback(${wavDIR}/SBOX_037)				; 택배 기사 물품 보관 서비스입니다.

	same => n, Goto(M43_main)					; // 보관함 선택 단계로 이동


	; ********************************************************************************
	;                                                                                *
	; 4-3 보관함 크기 지정 및 함번호 할당,                                           *
	;   - 고객이 ARS 멘트를 듣고 보관함 크기 선택                                    *
	;   - m_BoxType : 보관함 타입                                                    *
	;                                                                                *
	; ********************************************************************************
	same => n(M43_main), Set(ErrorCode=M43_main)

	same => n, GoSub(init_mBoxData,start,1(${ErrorCode}))

	; ----------------------------------------
	; 보관함 크기 동일 크기시 아래 메뉴 SKIP         
	; ----------------------------------------
	same => n, GotoIf($[${m_BoxStyle}>1]?M43_GetBoxType)
	same => n, GoSub(mbox_GetStyleEmptyLocker,start,1(${ErrorCode}))
	same => n, Goto(M432_main)


	; ----------------------------------------
	; 보관함 크기 선택                              
	; ----------------------------------------
	same => n(M43_GetBoxType), Noop(M43_GetBoxType)
	same => n, GoSub(mbox_GetBoxType,start,1(${ErrorCode}))		; 보관함 크기를 선택하세요.
	                                                      		; 소형은 1번.
	                                                      		; 중형은 2번.
	                                                      		; 대형은 3번.
	                                                      		; 이전 단계는 별표.
	                                                      		; 다시 듣기는 0번을 누르세요.
	same => n, Set(RESULT=${GOSUB_RETVAL})

	same => n, GotoIf($[${RESULT}=4444]?M21_main)			; // 이전 단계 --> 2-1 단계로 이동
	same => n, GotoIf($[${RESULT}=2222]?M43_main)			; // 비어 있는 보관함 없음 -> 재선택
	same => n, Goto(M432_main)



	; ********************************************************************************
	;                                                                                *
	; 4-3-2 사용할 보관함 번호 확정                                                  *
	;   -  m_BoxNumber                                                               *
	;                                                                                *
	; ********************************************************************************
	same => n(M432_main), Set(ErrorCode=M432_main)

	same => n, GoSub(init_mBoxData,start,1(${ErrorCode}))
	same => n, GoSub(mbox_SelBoxNumber,start,1(M432_recvDgt))	; 사용 가능한 보관함은 xx 번 입니다.
	                                                        	; 이 보관함 사용은 1번.
	                                                     		; 다른 보관함으로 변경은 2번.
	                                                        	; 보관함 크기 변경은 3번.
	                                                        	; 이전 단계는 별표.
	                                                        	; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})

	same => n, GotoIf($[${SELNUM}=1]?M53_main) 			; // 고객 핸드폰 입력 단계로 이동         
	same => n, GotoIf($[${SELNUM}=3]?M43_main)			; // 보관함 크기 변경                      
	same => n, GotoIf($[${SELNUM}=4]?M21_main)			; // 이전 단계 -> 2-1 단계로 이동            
	same => n, Goto(mbox_GoodBye,1)					; // 리턴값 오류시 종료



	; ********************************************************************************
	;                                                                                *
	; 5-3 물품 수령자 핸드폰 번호 입력                                               *
	;   - m_PhoneNumber : 물품 수령자 핸드폰 번호                                    *
	;                                                                                *
	; ********************************************************************************
	same => n(M53_main), Set(ErrorCode=M53_main)

	same => n, GoSub(init_mBoxData,start,1(${ErrorCode}))

	; -----------------------------------------------------
	; 핸드폰 번호 입력                                    
	; -----------------------------------------------------
	same => n(M531_PhoneNum), Set(ErrorCode=M531_PhoneNum)
	same => n, Read(m_PhoneNumber,${wavDIR}/SBOX_030_1,12,n,1,10)	; 물품을 수령하실 고객님의 휴대폰 번호와 #를 입력하세요.

	same => n, GotoIf($[${LEN(${m_PhoneNumber})}=0]?M531_not_enter)
	same => n, GotoIf($[${LEN(${m_PhoneNumber})}<10]?M531_wrong:M532_ChkDgt)

	; -----------------------------------------------------
	; 입력된 정보 없음                                    
	; -----------------------------------------------------
	same => n(M531_not_enter), Set(ErrorCode=M531_not_enter)
	same => n, GoSub(mbox_PlayErrMesg,start,1(M531_not_enter,SBOX_C02,3))
	same => n, Goto(M531_PhoneNum)

	; -----------------------------------------------------
	; 고객 전화번호를 10자리 미만으로 입력하는 경우        
	; -----------------------------------------------------
	same => n(M531_wrong), Set(ErrorCode=M531_wrong)
	same => n, GoSub(mbox_PlayErrMesg,start,1(M531_wrong,SBOX_C09,2))	; 입력 정보의 자릿수가 맞지 않습니다.
	same => n, Goto(M531_PhoneNum)

	; -----------------------------------------------------
	; 고객 전화번호를 10~ 11자리 입력,택배 기사 전화번호와 동일 여부 체크
	; -----------------------------------------------------
	same => n(M532_ChkDgt), Set(ErrorCode=M532_ChkDgt)
	same => n, GotoIf($["${CALLER}"!="${m_PhoneNumber}"]?M532_rcvDgt)
	same => n, Playback(${wavDIR}/SBOX_075)				; 택배 기사님의 휴대폰 번호를, 
	                                       				; 고객님의 휴대폰 번호로 사용할 수 없습니다.
	                                       				; 다시 입력하여야 합니다.
	same => n, Goto(M531_PhoneNum)


	same => n(M532_rcvDgt), Set(ErrorCode=M532_rcvDgt)
	same => n, Playback(${wavDIR}/SBOX_031)				; 입력하신 휴대폰 번호는
	same => n, SayDigits(${m_PhoneNumber})				; xxxxxxxx
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.

	same => n, Read(SELNUM,${wavDIR}/SBOX_032,1,n,1,3)		; 맞으면 1번.
	                                                 		; 변경은 2번.
	                                                 		; 이전 단계는 별표.
	                                                 		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?M532_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="1"]?M63_main)			; // 택배 기사 문열기
	same => n, GotoIf($["${SELNUM}"="2"]?M53_main)			; // 변경 선택
	same => n, GotoIf($["${SELNUM}"="*"]?M43_main)			; // 이전 단계 --> 보관함 크기 선택
	same => n, GotoIf($["${SELNUM}"="0"]?M532_rcvDgt)		; // 다시 듣기 선택

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(M532_wrong), Set(ErrorCode=M532_wrong)
	same => n, GoSub(mbox_PlayErrMesg,start,1(M532_wrong,SBOX_C01,2))
	same => n, Goto(M532_rcvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(M532_not_enter), Set(ErrorCode=M532_not_enter)
	same => n, GoSub(mbox_PlayErrMesg,start,1(M532_not_enter,SBOX_C02,3))
	same => n, Goto(M532_rcvDgt)




	; ********************************************************************************
	;                                                                                *
	; 6-3 사용할 보관함 개방하기 위한 정보 획득                                      *
	;   - mbox_get_door_data.php                                                     *
	;                                                                                *
	; ********************************************************************************
	same => n(M63_main), Set(ErrorCode=M63_main)

	same => n, GoSub(init_mBoxData,start,1(${ErrorCode}))
;	same => n, GotoIf($[${m_SvcType}=1]?M63_not_check_user)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, AGI(barobox/box_check_user.php)
	same => n, Log(NOTICE, box_check_user.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_PhoneNumber=[${m_PhoneNumber}] m_v_PhoneNumber=[${m_v_PhoneNumber}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?M63_agi_fail)
	same => n, GotoIf($["${RESULT}"="0000"]?M63_not_check_user)	; // 등록된 사용자
	same => n, Playback(${wavDIR}/SBOX_039)				; 입력하신 번호는 등록된 가입자가 아닙니다.
	same => n, Wait(1)
	same => n, Goto(M53_main)					; // 고객 번호 재입력

	same => n(M63_agi_fail), Noop(M63_agi_fail)
	same => n, Playback(${wavDIR}/SBOX_038)				; 서버 접속이 되지 않아,
	                                       				; 입력 번호의 등록 상태를 확인할 수 없습니다.

	same => n, Goto(M53_main)					; // 고객 번호 재입력

	same => n(M63_not_check_user), Noop(M63_not_check_user)

	; ----------------------------------------
	;                                         
	; ----------------------------------------

	same => n(M63_recvDgt), Noop(M63_recvDgt)

	same => n, Read(SELNUM,${wavDIR}/SBOX_033,1,n,1,3)		; 보관함 열기는 1번.
	                                                 		; 보관함 변경은 2번.
	                                                 		; 고객님 핸드폰 번호 변경은 3번.
	                                                 		; 처음부터 다시 하려면 4번.
	                                                 		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?M63_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="1"]?M73_main)			; // 보관함 열기      --> 7-3 단계로 이동
	same => n, GotoIf($["${SELNUM}"="2"]?M43_main)			; // 보관함 크기 변경 --> 5-3 단계로 이동
	same => n, GotoIf($["${SELNUM}"="3"]?M53_main)			; // 핸드폰 번호 변경 --> 4-3 단계로 이동
	same => n, GotoIf($["${SELNUM}"="4"]?M21_main)			; // 처음부터 다시    --> 2-1 단계로 이동
	same => n, GotoIf($["${SELNUM}"="0"]?M63_recvDgt)		; // 다시듣기 선택

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(M63_wrong), Set(ErrorCode=M63_wrong)
	same => n, GoSub(mbox_PlayErrMesg,start,1(M63_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(M63_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(M63_not_enter), Set(ErrorCode=M63_not_enter)
	same => n, GoSub(mbox_PlayErrMesg,start,1(M63_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(M63_recvDgt)





	; ********************************************************************************
	;                                                                                *
	; 7-3 DB에 수령자 번화번호와 보관함 번호 등록후 보관함 열기                      *
	;   - mbox_delivery_using_locker.php                                             *
	;     INPUT = m_BoxNumber, m_PhoneNumber, m_v_PhoneNumber                        *
	;                                                                                *
	; ********************************************************************************
	same => n(M73_main), Noop(M73_main)

	same => n, GoSub(init_mBoxData,start,1(${ErrorCode}))

	same => n, AGI(barobox/sbox_delivery_using_locker.php)
	same => n, Log(NOTICE, sbox_delivery_using_locker.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_BoxNumber=[${m_BoxNumber}] m_PhoneNumber=[${m_PhoneNumber}]  m_v_PhoneNumber=[${m_v_PhoneNumber}])

	; ----------------------------------------
	;                                  
	; ----------------------------------------
	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?mbox_PlayErrMesg,start,1(M73_agi_fail,SBOX_021,0))

	same => n, GotoIf($["${RESULT}"="1111"]?M73_reg_succ)
	same => n, GotoIf($["${RESULT}"="2222"]?M73_reg_fail)

	same => n, GoSub(mbox_PlayErrMesg,start,1(M73_not_define,SBOX_022,0))

	; ----------------------------------------
	; SBOX_023 : 서버로부터 사용 허가를 받지 못하여, 서비스>를 진행할 수 없습니다.
	; SBOX_024 : 서버로부터 추가 정보를 가져오지 못하여, 서>비스를 진행할 수 없습니다.
	; ----------------------------------------
	same => n(M73_reg_fail), Set(ErrorCode=M73_reg_fail)
	same => n, GoSub(mbox_PlayErrMesg,start,1(M73_reg_fail,SBOX_023,1))	; // SBOX_023 or SBOX_024
	same => n, Goto(magicbox-find,mbox_Finish,1)

	; ----------------------------------------
	;                                  
	; ----------------------------------------
	same => n(M73_reg_succ), Set(ErrorCode=M73_reg_succ)
	same => n, Set(m_UserType=2)				; // 1=일반고객, 2=택배기사 문열기, 3=장기사용고객
	same => n, GoSub(open_mBoxDoor,start,1(${ErrorCode},2))	; xx번 보관함 문을 열었습니다.

	; ----------------------------------------
	;                                 
	; ----------------------------------------
	same => n, Read(SELNUM,${wavDIR}/SBOX_035,1,n,1,1)	; 물품 보관을 계속해서 더 하시려면 1번을 누르시면 됩니다.

	same => n, GotoIf($["${SELNUM}"="1"]?M73_go_retry)

	same => n, Read(SELNUM,${wavDIR}/SBOX_BGM,1,n,1,2)	; // 대기 음악
	same => n, GotoIf($["${SELNUM}"="1"]?M73_go_retry)

	same => n, Goto(magicbox-find,mbox_GoodBye,1)

	; ----------------------------------------
	;                                  
	; ----------------------------------------
	same => n(M73_go_retry), Set(ErrorCode=M73_go_retry)

	same => n, Set(m_BoxNumber=0)		; // m_BoxNumber 초기화
	same => n, Set(m_PhoneNumber=)		; // m_PhoneNumber 초기화
	same => n, Set(m_v_PhoneNumber=)	; // m_v_PhoneNumber 안심번호초기화
	same => n, Set(m_DoorContData=)		; // m_DoorContData 초기화

	same => n, Goto(M43_main)		; // 보관함 선택 단계로 이동


	; ----------------------------------------
	; 처음부터 다시                          
	; ----------------------------------------
	same => n(M21_main), Noop(M21_main)
	same => n, Goto(magicbox-find,start,M21_recvDgt)



; ********************************************************************************
; *                                                                              *
; * 공통 데이타 초기화                                                           *
; *                                                                              *
; ********************************************************************************

[init_mBoxData]

exten => start,1,Noop(init_mBoxData from ${ARG1})

	same => n, Set(RESULT=)		; // RESULT 초기화
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(countAUTH=0)
	same => n, Set(countNoInput=0)
	same => n, Set(countTIMEOUT=0)

	same => n, Return(0)





; ********************************************************************************
; *                                                                              *
; * 보관함 크기 선택하기(3-1,5-3,4-5-1)                                          *
; *      - 1번 선택 = 소형                                                       *
; *      - 2번 선택 = 중형                                                       *
; *      - 3번 선택 = 대형                                                       *
; *      - *번 선택 = 이전 단계                                                  *
; *      - 그외번호 = 3회 재시도후 서비스 종료                                   *
; *      - 미선택   = 3회 재시도후 서비스 종료                                   *
; *                                                                              *
; ********************************************************************************

[mbox_GetBoxType]

exten => start,1,Noop(mbox_GetBoxType from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	; ----------------------------------------
	; 보관함 선택 및 번호 수집                
	; ----------------------------------------
	same => n(GBS_recvDgt), Set(ErrCode=GBS_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/SBOX_006,1,n,1,5)		; 보관함 크기를 선택하세요.
	                                                  		; 소형은 1번.
	                                                  		; 중형은 2번.
	                                                  		; 대형은 3번.
	                                                  		; 이전 단계는 별표.
	                                                  		; 다시 듣기는 0번을 누르세요.

	; ----------------------------------------
	; 선택 번호 기능 분기                             
	; ----------------------------------------
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?GBS_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="0"]?GBS_recvDgt)		; // 메뉴 다시 듣기
	same => n, GotoIf($["${SELNUM}"="1"]?GBS_1)			; // 소형 선택
	same => n, GotoIf($["${SELNUM}"="2"]?GBS_2)			; // 중형 선택
	same => n, GotoIf($["${SELNUM}"="3"]?GBS_3)			; // 대형 선택
	same => n, GotoIf($["${SELNUM}"="*"]?GBS_4)			; // 이전 단계


	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(GBS_wrong), Set(ErrCode=GBS_wrong)
	same => n, GoSub(mbox_PlayErrMesg,start,1(GBS_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(GBS_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(GBS_not_enter), Set(ErrCode=GBS_not_enter)
	same => n, GoSub(mbox_PlayErrMesg,start,1(GBS_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(GBS_recvDgt)

	; ----------------------------------------
	;                                  
	; ----------------------------------------
	same => n(GBS_1), Set(m_BoxType=1)	; 1번 선택
	same => n, Goto(GBS_get_empty_locker)

	same => n(GBS_2), Set(m_BoxType=2)	; 2번 선택
	same => n, Goto(GBS_get_empty_locker)

	same => n(GBS_3), Set(m_BoxType=3)	; 3번 선택
	same => n, Goto(GBS_get_empty_locker)

	same => n(GBS_4), Return(4444)		; *번 선택 : 이전 단계로 이동

	; ----------------------------------------
	; 선택한 보관함 크기의 비어 있는 함 갯수 검색
	; ----------------------------------------
	same => n(GBS_get_empty_locker), Noop(GBS_get_empty_locker)
	same => n, GoSub(mbox_GetEmptyLocker,start,1(1,${ErrCode}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, Return(${RESULT})


exten => h,1, Noop(mbox_GetBoxType/Hangup)
	same => n, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/mbox_GetBoxType/mbox_Hangup] ERR=${ErrCode}])
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; * 보관함 번호 선택하기                                                         *
; *      - 1 번 : 사용 확정                                                      *
; *      - 2 번 : 보관함 번호 변경                                               *
; *      - 3 번 : 보관함 크기 다시 선택                                          *
; *      - 0 번 : 다시 듣기                                                      *
; *      - 그외 : 3회 재시도후 서비스 종료                                       *
; *      - 미선택 : 3회 재시도후 서비스 종료                                     *
; *                                                                              *
; ********************************************************************************

[mbox_SelBoxNumber]

exten => start,1,Noop(mbox_SelBoxNumber from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; // ErrCode
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(countLOOP=1)

	same => n, Set(m_BoxNumber=${LN0})

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SBN_recvDgt), Set(ErrCode=SBN_recvDgt)

	same => n, Playback(${wavDIR}/SBOX_008)				; 사용 가능한 보관함은
	same => n, GoSub(read_Number,start,1(${m_BoxNumber},B))		; xx 번
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.

	same => n, Read(SELNUM,${wavDIR}/SBOX_009,1,n,1,5)		; 이 보관함 사용은 1번. 
	                                                     		; 다른 보관함으로 변경은 2번.
	                                                     		; 보관함 크기 변경은 3번.
	                                                     		; 이전 단계는 별표.
	                                                     		; 다시 듣기는 0번을 누르세요.

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?SBN_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="0"]?SBN_recvDgt)		; // 다시 듣기
	same => n, GotoIf($["${SELNUM}"="1"]?SBN_1) 			; // 현재 보관함 사용 확정
	same => n, GotoIf($["${SELNUM}"="2"]?SBN_nextBox)		; // 다른 보관함으로 변경
	same => n, GotoIf($["${SELNUM}"="3"]?SBN_chgSize)		; // 보관함 크기 변경
	same => n, GotoIf($["${SELNUM}"="*"]?SBN_4)			; // 이전 단계 이동


	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(SBN_wrong), Set(ErrCode=SBN_wrong)
	same => n, GoSub(mbox_PlayErrMesg,start,1(SBN_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(SBN_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(SBN_not_enter), Set(ErrCode=SBN_not_enter)
	same => n, GoSub(mbox_PlayErrMesg,start,1(SBN_wrong,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(SBN_recvDgt)


	; ----------------------------------------
	; 다른 보관함으로 변경                    
	; ----------------------------------------
	same => n(SBN_nextBox), Set(ErrorCode=SBN_nextBox)
	same => n, GoSub(mbox_GetNextBox,start,1(${m_EmptyCount},${ErrorCode}))
	same => n, Goto(SBN_recvDgt)


	; ----------------------------------------
	; 단일 크기로 구성하는 경우에는 보관함 크기 선택은 입력정보 오류로 변경
	; ----------------------------------------
	same => n(SBN_chgSize), Set(ErrorCode=SBN_chgSize)
	same => n, GotoIf($[${m_BoxStyle}!=1]?SBN_3)
	same => n, GoSub(mbox_PlayErrMesg,start,1(SBN_wrong,SBOX_027,5))	; 동일 크기로 구성되어 있어서,
	                                                                	; 보관함 크기를 변경할 수는 없습니다.
	same => n, Goto(SBN_recvDgt)


	same => n(SBN_1), Return(1)
	same => n(SBN_3), Return(3)
	same => n(SBN_4), Return(4)
	same => n(SBN_0), Return(0)

exten => h,1, Noop(mbox_SelBoxNumber/Hangup)
	same => n, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/mbox_SelBoxNumber/mbox_Hangup] ERR=${ErrCode}])
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; * 다음 보관함 번호 가져오기                                                    *
; *                                                                              *
; ********************************************************************************

[mbox_GetNextBox]

exten => start,1,Noop(mbox_GetNextBox from ${ARG2})

	same => n, Set(LOCAL(MaxCount)=${ARG1})
	same => n, Set(countLOOP=$[${countLOOP}+1])

	same => n, ExecIf($[${countLOOP}>20]?Set(countLOOP=1))
	same => n, ExecIf($[${countLOOP}>${MaxCount}]?Set(countLOOP=1))

	same => n, ExecIf($[${countLOOP} = 1]?Set(m_BoxNumber=${LN0}))
	same => n, ExecIf($[${countLOOP} = 2]?Set(m_BoxNumber=${LN1}))
	same => n, ExecIf($[${countLOOP} = 3]?Set(m_BoxNumber=${LN2}))
	same => n, ExecIf($[${countLOOP} = 4]?Set(m_BoxNumber=${LN3}))
	same => n, ExecIf($[${countLOOP} = 5]?Set(m_BoxNumber=${LN4}))
	same => n, ExecIf($[${countLOOP} = 6]?Set(m_BoxNumber=${LN5}))
	same => n, ExecIf($[${countLOOP} = 7]?Set(m_BoxNumber=${LN6}))
	same => n, ExecIf($[${countLOOP} = 8]?Set(m_BoxNumber=${LN7}))
	same => n, ExecIf($[${countLOOP} = 9]?Set(m_BoxNumber=${LN8}))
	same => n, ExecIf($[${countLOOP} = 10]?Set(m_BoxNumber=${LN9}))

	same => n, ExecIf($[${countLOOP} = 11]?Set(m_BoxNumber=${LN10}))
	same => n, ExecIf($[${countLOOP} = 12]?Set(m_BoxNumber=${LN11}))
	same => n, ExecIf($[${countLOOP} = 13]?Set(m_BoxNumber=${LN12}))
	same => n, ExecIf($[${countLOOP} = 14]?Set(m_BoxNumber=${LN13}))
	same => n, ExecIf($[${countLOOP} = 15]?Set(m_BoxNumber=${LN14}))
	same => n, ExecIf($[${countLOOP} = 16]?Set(m_BoxNumber=${LN15}))
	same => n, ExecIf($[${countLOOP} = 17]?Set(m_BoxNumber=${LN16}))
	same => n, ExecIf($[${countLOOP} = 18]?Set(m_BoxNumber=${LN17}))
	same => n, ExecIf($[${countLOOP} = 19]?Set(m_BoxNumber=${LN18}))
	same => n, ExecIf($[${countLOOP} = 20]?Set(m_BoxNumber=${LN19}))

	same => n, Return(0)





; ********************************************************************************
; *                                                                              *
; * 에라 메세지 음원 파일 동작                                                   *
; *                                                                              *
; ********************************************************************************

[mbox_PlayErrMesg]

exten => start,1,Noop(mbox_PlayErrMesg from ${ARG1})
	same => n, Set(LOCAL(ErrCode)=${ARG1})	; ErrorCode
	same => n, Set(LOCAL(FN)=${ARG2})	; 음원 파일 이름
	same => n, Set(LOCAL(EM)=${ARG3})	; 0/1=최종 멘트(0=없음,1=있음)  --> 음원 플레이후 서비스 종료
	                                 	; 2=버튼 잘못 누름              --> 에라 횟수 이상이면 서비스 종료
	                                 	; 3=버튼 누르지 않음            --> 에라 횟수 이상이면 서비스 종료
	                                 	; 4=인증 오류                   --> 에라 횟수 이상이면 서비스 종료
	                                 	; 5=음원 동작                   --> 음원 플레이후 복귀


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GotoIf($[${EM}==0]?SPEM_endSvc)
	same => n, GotoIf($[${EM}==1]?SPEM_endSvc)
	same => n, GotoIf($[${EM}==2]?SPEM_ErrWrong)
	same => n, GotoIf($[${EM}==3]?SPEM_ErrNoEnt)
	same => n, GotoIf($[${EM}==4]?SPEM_ErrAuth)
	same => n, GotoIf($[${EM}==5]?SPEM_retSvc)
	same => n, Hangup()

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SPEM_ErrWrong), Set(ErrCode=SPEM_ErrWrong)
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 13]?:SPEM_GoodBye)
	same => n, Playback(${wavDIR}/${FN})
	same => n, Return(0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SPEM_ErrNoEnt), Set(ErrCode=SPEM_ErrNoEnt)
	same => n, Set(countENTER=$[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?:SPEM_GoodBye)
	same => n, Playback(${wavDIR}/${FN})
	same => n, Return(0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SPEM_ErrAuth), Set(ErrCode=SPEM_ErrAuth)
	same => n, Set(countAUTH=$[${countAUTH}+1])
	same => n, GotoIF($[${countAUTH} < 3]?:SPEM_GoodBye)
	same => n, Playback(${wavDIR}/${FN})
	same => n, Return(0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SPEM_retSvc), Noop(ErrCode=SPEM_retSvc)
	same => n, Playback(${wavDIR}/${FN})
	same => n, Return(0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SPEM_endSvc), Noop(ErrCode=SPEM_endSvc)
	same => n, Playback(${wavDIR}/${FN})
	same => n, GotoIf($[${EM}==1]?SPEM_GoodBye)
	same => n, Hangup()

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SPEM_GoodBye), Noop(ErrCode=SPEM_GoodBye)
	same => n, Playback(${wavDIR}/SBOX_C04)			; 이용해 주셔서 감사합니다.
	same => n, Hangup()


exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/mbox_PlayErrMesg/mbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; * 선택한 보관함 크기별로 비어있는 보관함 갯수 확인                             *
; *  - 3-1  5-3  4-5-5                                                           *
; *  - 고객이 선택한 박스 타입에 사용 가능한 보관함이 있는지 확인                *
; *  - mbox_get_empty_locker.php                                                 *
; *  - input : (1) m_BoxType(1=소형,2=중형,3=대형,4=전부)                        *
; *  - output: (1) RESULT(1111=OK, 2222=NOK)                                     *
; *            (2) m_EmptyCount : 비어 있는 보관함 갯수, 0 ~ 20                  *
; *            (3) LN0,LN1, ..... LN19, LN20 : 비어있는 보관함 번호              *
; *                                                                              *
; ********************************************************************************

[mbox_GetEmptyLocker]

exten => start,1,Noop(mbox_GetEmptyLocker from ${ARG1} ${ARG2})

	same => n, Set(LOCAL(BoxStyle)=${ARG1})	; 1=단일 타입, 2=복합 타입
	same => n, Set(LOCAL(ErrCode)=${ARG2})
	same => n, Set(m_EmptyCount=)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, AGI(barobox/sbox_get_empty_locker.php)

	same => n, Log(NOTICE, sbox_get_empty_locker.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_EmptyCount=[${m_EmptyCount}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?mbox_PlayErrMesg,start,1(GEL_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?GEL_many_empty)		; // 비어 있는 보관함 있음
	same => n, GotoIf($["${RESULT}"="2222"]?GEL_none_empty)		; // 비어 있는 보관함 없음
	same => n, GoSub(mbox_PlayErrMesg,start,1(S312_not_define,SBOX_022,0))

	; ----------------------------------------
	; 사용 가능한 보관함 갯수가 0 인 경우     
	; ----------------------------------------
	same => n(GEL_not_using), Set(Err=GEL_not_using)
	same => n, Playback(${wavDIR}/SBOX_004)			; 지금은 비어 있는 보관함이 없습니다. 다음에 이용해 주세요.
	same => n, Goto(magicbox-find,mbox_GoodBye,1)

	; ----------------------------------------
	; 비어 있는 보관함 없음                   
	; ----------------------------------------
	same => n(GEL_none_empty), Set(Err=GEL_none_empty)
	same => n, GotoIf($[${BoxStyle}=2]?GEL_not_using)
	same => n, Playback(${wavDIR}/SBOX_007)			; 선택하신 타입에는 비어 있는 보관함이 없습니다.
	                                       			; 다른 타입을 선택하세요.
	same => n, Return(2222)

	; ----------------------------------------
	; 비어 있는 보관함 있음                   
	; ----------------------------------------
	same => n(GEL_many_empty), Set(ErrCode=GEL_many_empty)
	same => n, GotoIf($[${LEN(${m_EmptyCount})}=0]?GEL_not_using)	; // 갯수 정보 미 수신시
	same => n, GotoIf($[${m_EmptyCount}=0]?GEL_none_empty)		; // 갯수가 0 인 경우
	same => n, ExecIf($[${m_EmptyCount}>20]?Set(m_EmptyCount=20))	; // 20초과시 20으로 설정
	same => n, Return(1111)


exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/mbox_GetEmptyLocker/mbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; *  보관함이 단일 크기 운영시 설치된 보관함 갯수 가져오기                       *
; *  - input : (1) m_S_TypeCount                                                 *
; *            (2) m_M_TypeCount                                                 *
; *            (3) m_L_TypeCount                                                 *
; *                                                                              *
; ********************************************************************************

[mbox_GetStyleEmptyLocker]

exten => start,1,Noop(mbox_GetStyleEmptyLocker from ${ARG1})
	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode

	same => n, ExecIf($[${m_S_TypeCount} = 1]?Set(m_BoxType=1))
	same => n, ExecIf($[${m_M_TypeCount} = 1]?Set(m_BoxType=2))
	same => n, ExecIf($[${m_L_TypeCount} = 1]?Set(m_BoxType=3))

	same => n, GoSub(mbox_GetEmptyLocker,start,1(2,${ErrCode}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}=1111]?GSEL_1111)
	same => n, Goto(magicbox-find,mbox_GoodBye,1)

	same => n(GSEL_1111), Return

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/mbox_GetStyleEmptyLocker/mbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()


; ********************************************************************************
;                                                                                *
; 0-3 물품 보관함 내의 소형,중형,대형 크기별로 설정되어 있는 갯수 검색           *
;   - sbox_get_box_style.php                                                     *
;   - input : (1) DAOU050NUMBER                                                  *
;   - output: (1) RESULT(1111=OK, 9999=NOK)                                      *
;             (2) m_S_TypeCount : 소형 갯수                                      *
;                 m_M_TypeCount : 중형 갯수                                      *
;                 m_L_TypeCount : 대형 갯수                                      *
;                                                                                *
; ********************************************************************************

[mbox_CheckBoxStyle]

exten => start,1, Set(ErrorCode=CheckBoxStyle)

	same => n, Set(RESULT=)						; // RESULT 초기화

	same => n, AGI(barobox/sbox_get_box_style.php)
	same => n, Log(NOTICE, mbox_get_box_style.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_S_TypeCount=[${m_S_TypeCount}] m_M_TypeCount=[${m_M_TypeCount}] m_L_TypeCount=[${m_L_TypeCount}])

	same => n, GotoIf($["${AGISTATUS}"="SUCCESS"]?:CBS_agi_fail)
	same => n, GotoIf($["${RESULT}"="1111"]?:CBS_agi_fail)

	same => n(CBS_agi_succ), Set(ErrorCode=CBS_agi_succ)
	same => n, ExecIf($[${m_S_TypeCount}>1]?Set(m_S_TypeCount=1))
	same => n, ExecIf($[${m_M_TypeCount}>1]?Set(m_M_TypeCount=1))
	same => n, ExecIf($[${m_L_TypeCount}>1]?Set(m_L_TypeCount=1))
	same => n, Goto(CBS_CheckStyle)

	same => n(CBS_agi_fail), Set(ErrorCode=CBS_agi_fail)
	same => n, Set(m_S_TypeCount=1)					; // 소형함 있음
	same => n, Set(m_M_TypeCount=1)					; // 중형함 있음
	same => n, Set(m_L_TypeCount=1)					; // 대형함 있음
	same => n, Goto(CBS_CheckStyle)

	same => n(CBS_CheckStyle), Set(ErrorCode=CBS_CheckStyle)
	same => n, Set(m_BoxStyle=$[${m_S_TypeCount}+${m_M_TypeCount}+${m_L_TypeCount}])
	same => n, GotoIf($[${m_BoxStyle}>0]?CBS_nextStep)
	same => n, Playback(${wavDIR}/SBOX_018)				; 지금 거신 전화번호는 서비스를 받을 수가 없습니다.
	                                       				; 시스템 관리자에게 문의하시기 바랍니다.
	same => n, Goto(magicbox-find,mbox_Finish,1)

	same => n(CBS_nextStep), Return



[magicbox-admin]
exten => start, 1, Noop(***** start magicbox-admin *****)

	same => n, Set(wavDIR=sbox)

	; ********************************************************************************
	;                                                                                *
	; 3-5 관리자 모드                                                                *
	;                                                                                *
	; ********************************************************************************
	same => n(M35_main), Set(ErrorCode=M35_main)

	same => n, AGI(sbox/sbox_check_admin.php)
	same => n, Log(NOTICE, sbox_check_admin.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] )

	same => n, GotoIf($["${AGISTATUS}"="SUCCESS"]?M35_AgiSucc)
	same => n, Playback(${wavDIR}/SBOX_T01)				; 서버 연결이 어렵습니다.
	                                       				; 서비스 관리자에게 확인하세요.
	same => n, Goto(sbox_GoodBye,1)

	same => n(M35_AgiSucc), Set(ErrorCode=M35_AgiSucc)
	same => n, GotoIf($["${RESULT}"="1111"]?M35_recvDgt)
	same => n, Playback(${wavDIR}/SBOX_T02)				; 관리자 전화번호가 아닙니다.
	                                       				; 서비스 관리자에게 확인하고 이용하세요.
	same => n, Goto(sbox_GoodBye,1)

	same => n(M35_recvDgt), Set(ErrorCode=M35_recvDgt)
	same => n, Read(m_BoxNumber,${wavDIR}/SBOX_T00,3,n,1,5)		; 보관함 번호를 입력하세요.
	                                                       		; 이전 단계로 이동은 별표입니다.

	same => n, GotoIf($["${m_BoxNumber}"="*"]?magicbox-find,start,M21_recvDgt)		; // 이전 메뉴로 이동

	same => n, Set(m_UserType=4)			; // 1=일반고객, 2=택배기사 문열기, 3=장기사용고객 4=관리자 모드
	same => n, GoSub(open_mbox_by_admin,start,1(${ErrorCode},4,${m_BoxNumber}))		; xx번 보관함 문을 열었습니다.
	same => n, Goto(M35_main)



; ********************************************************************************
; *                                                                              *
; * 보관함 열기                                                                  *
; *  - sbox_get_door_cont_data.php                                               *
; *  - input : (1) m_BoxNumber                                                   *
; *            (2) m_UserType : 1=일반고객,     2=택배기사 문열기                *
; *                             3=장기사용고객, 4=관리자 모드                    *
; *  - output: (1) RESULT(1111=OK                                                *
; *                       2222=해당 LOCKNO에 대한 정보없음                       *
; *                       3333=비어있는 보관함이 아님)                           *
; *                                                                              *
; ********************************************************************************

[open_mbox_door]
exten => start,1,Noop(open_mbox_door from ${ARG1})
	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode
	same => n, Set(LOCAL(MacAddr)=${ARG2})			; ErrCode
	same => n, Set(LOCAL(DorData)=${ARG3})			; ErrCode
	same => n, Set(LOCAL(BoxNum)=${ARG4})			; ErrCode

;	same => n, AGI(agi://218.232.94.161:8200,open,${MacAddr},${DorData})
	same => n, AGI(agi://box.baro.so:8200,open,${MacAddr},${DorData})
	same => n, Log(NOTICE, AGI://box.baro.so [${CALLER} -> ${DAOU050NUMBER}] : AGI=[${AGISTATUS}] MAC=[${MacAddr}] BoxNumber=[${BoxNum}] DoorContData=[${DorData}])

	same => n, GotoIf($["${AGISTATUS}"="SUCCESS"]?OMD_succ:OMD_fail)

	same => n(OMD_succ), Set(ErrCode=OMD_succ)
	same => n, GoSub(read_Number,start,1(${BoxNum},B))	; xx 번
	same => n, Playback(${wavDIR}/SBOX_017)			; 보관함 문을 열었습니다.
	same => n, Return(0)

	same => n(OMD_fail), Set(ErrCode=OMD_fail)
	same => n, Playback(magic/mb_open_9998_error)		; 시스템 장애로 요청하신 도어를 여는데 실패하였습니다.
	same => n, Return(0)

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/open_mbox_door/mbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()



; ********************************************************************************
; *                                                                              *
; * 시스템 관리자에 의한 물품 보관함 개방                                        *
; *                                                                              *
; ********************************************************************************
[open_mbox_by_admin]
exten => start,1,Noop(open_door_by_admin from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode
	same => n, Set(LOCAL(UserType)=${ARG2})			; UserType
	same => n, Set(LOCAL(BoxNumber)=${ARG3})		; BoxNumber
	same => n, Set(m_DoorContData=0)			; // m_DoorContData 초기화

	; ----------------------------------------
	; 보관함 열기 위한 control Data 가져오기            
	; ----------------------------------------
	same => n, AGI(barobox/sbox_get_door_cont_data.php)
	same => n, Log(NOTICE, sbox_get_door_cont_data.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_BoxNumber=[${m_BoxNumber}] m_DoorContData=[${m_DoorContData}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?CBD_0000)
	same => n, GotoIf($["${RESULT}"="1111"]?CBD_1111)	; // OK
	same => n, GotoIf($["${RESULT}"="2222"]?CBD_2222)	; // 해당 LOCKNO에 대한 정보없음
	same => n, GotoIf($["${RESULT}"="3333"]?CBD_3333)	; // 비어있는 보관함이 아님
	same => n, Goto(CBD_9999)

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(CBD_1111), Set(ErrCode=CBD_1111)
	same => n, GoSub(open_mbox_door,start,1(${ErrCode},${MACADDR},${m_DoorContData},${BoxNumber}))	; xx 번 보관함 문을 열었습니다.
	same => n, Return(111)

	same => n(CBD_2222), Set(ErrCode=CBD_2222)
	same => n, Playback(${wavDIR}/SBOX_T03)			; 선택하신 보관함 정보가 없습니다.
	same => n, Return(2222)

	same => n(CBD_3333), Set(ErrCode=CBD_3333)
	same => n, Playback(${wavDIR}/SBOX_T04)			; 비어 있는 보관함이 아닙니다.
	same => n, Return(3333)

	same => n(CBD_9999), Set(ErrCode=CBD_9999)
	same => n, Playback(${wavDIR}/SBOX_T05)			; 알수 없는 원인으로 문을 열수 없습니다.
	same => n, Return(9999)

	same => n(CBD_0000), Set(ErrCode=CBD_0000)
	same => n, Playback(${wavDIR}/SBOX_T06)			; 서버와 연결이 되지 않았습니다.
	same => n, Return(9999)

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/open_mbox_by_admin/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()




[open_mBoxDoor]

exten => start,1,Noop(open_mBoxDoor from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode
	same => n, Set(LOCAL(UserType)=${ARG2})			; UserType
	same => n, Set(m_DoorContData=)				; // m_DoorContData 초기화

	; ----------------------------------------
	; 보관함 열기 위한 control Data 가져오기            
	; ----------------------------------------
	same => n, AGI(barobox/sbox_get_door_cont_data.php)

	same => n, Log(NOTICE, sbox_get_door_cont_data.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_BoxNumber=[${m_BoxNumber}] m_DoorContData=[${m_DoorContData}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?mbox_PlayErrMesg,start,1(DCD_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?OBD_get_DCD_succ)	; // OK
	same => n, GotoIf($["${RESULT}"="2222"]?OBD_get_DCD_fail)	; // 해당 LOCKNO에 대한 정보없음
	same => n, GotoIf($["${RESULT}"="3333"]?OBD_get_DCD_fail)	; // 비어있는 보관함이 아님
	same => n, GoSub(mbox_PlayErrMesg,start,1(DCD_not_define,SBOX_022,0))

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(OBD_get_DCD_fail), Set(ErrCode=OBD_get_DCD_fail)
	same => n, GoSub(mbox_PlayErrMesg,start,1(${ErrCode},SBOX_023,1))	; 서버로부터 사용 허가를 받지 못하여,
	                                                                 	; 서비스를 진행할 수 없습니다.
	same => n, Goto(magicbox-find,mbox_Finish,1)

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(OBD_get_DCD_succ), Set(ErrCode=OBD_get_DCD_succ)
	same => n, GoSub(open_mbox_door,start,1(${ErrCode},${MACADDR},${m_DoorContData},${m_BoxNumber}))  ; xx 번 보관함 문을 >열었습니다.

;	same => n, GotoIf($[${UserType}=3]?OBD_history)				; // 장기사용자 기간중 문열기
;	same => n, Return(0)

	; ----------------------------------------
	; 보관함 문개방 이력 정보 저장            
	; ----------------------------------------
	same => n(OBD_history), Noop(ODB_history)
	same => n, AGI(barobox/box_history_update_find.php)			; // AGI(barobox/sbox_open_ltu.php)
	same => n, Log(NOTICE, box_history_update_find.php [${CALLER}] : AGI=[${AGISTATUS}] m_BoxNumber=[${m_BoxNumber}] )
	same => n, Return(0)

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/open_mBoxDoor/mbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()
