; ********************************************************************************
; *                                                                              *
; * 바로서비스 자동 응답 시스템(Baro Serverice Auto-response System)             *
; *                                                                              *
; ********************************************************************************

[bsvc_main]

exten => _X.,1,Noop([bsvc_main] Recieving Call[${EXTEN}] From [${CHANNEL(peerip)}])

	same => n, Answer()

	; ----------------------------------------
	; invite head 정보에서 발신번호 찾기
	; ----------------------------------------
	same => n, Set(FromNum=${CUT(SIP_HEADER(From),:,2)})
	same => n, Set(GLOBAL(CALLER)=${CUT(FromNum,@,1)})

	; ----------------------------------------
	; invite head 정보에서 070 수신번호 찾기
	; ----------------------------------------
	same => n, Set(ToNum=${CUT(SIP_HEADER(To),:,2)})
	same => n, Set(GLOBAL(CALLEE)=${CUT(ToNum,@,1)})
	same => n, Set(PRE=${TONUM:3:4})
	same => n, Set(NUM=${TONUM:7:4})
	same => n, Set(NUM=${CALLEE:7:4})
	same => n, ExecIf($[${LEN(${CALLEE})}<11]?Set(NUM=${CALLEE}))

	same => n, Goto(bsvc_start,1)


exten => bsvc_start,1, Noop(bsvc_start)

	same => n, Set(baseDIR=bsvc)
	same => n, Set(agiDIR=bsvc)
	same => n, Set(agiPath=/var/lib/asterisk/agi-bin/${agiDIR})
	same => n, Set(recPath=/var/spool/asterisk/monitor)
	same => n, Set(emgDIR=EMGHDD)
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)


	; ================================================================================
	;                                                                                *
	; 1-1 단계 : 인사말 재생                                                         *
	;                                                                                *
	;                                                                                *
	; ================================================================================
	same => n(S11_main), Set(ErroeCode=S11_main)

	same => n, Set(m_MyWorkStep=110)
	same => n, Playback(${baseDIR}/BSVC_111)	; 안녕하세요.
	                                                ; 주식회사 바로 서비스입니다.



	; ================================================================================
	;                                                                                *
	; 2-1 단계 안내 멘트                                                             *
	;                                                                                *
	;      - '1' 입력시 : 바로 앱 관련 문의                                          *
	;      - '2' 입력시 : 바로 CRM 관련 문의                                         *
	;      - '3' 입력시 : 무인택배함 관련 문의                                       *
	;      - '4' 입력시 : 바로서비스 솔루션 데모                                     *
	;      - '5' 입력시 : 내선 번호 연결                                             *
	;      - '0' 입력시 : 안내 멘트 다시 듣기                                        *
	;      - 입력 오류 처리                                                          *
	;      - 미입력 처리                                                             *
	;                                                                                *
	; ================================================================================
	same => n(S21_main), Set(ErrorCode=S21_main)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(m_MyWorkStep=210)

	same => n(S21_recvDgt), Set(ErrorCode=S21_recvDgt)

	same => n, read(SELNUM,${baseDIR}/BSVC_212,1,n,1,3)	; 비대면 서비스 관련 문의는 1번.
	                                                   	; 바로 앱 관련 문의는 2번.
	                                                   	; 바로 CRM 관련 문의는 3번.
	                                                   	; 무인택배함 관련 문의는 4번.
	                                                   	; 바로서비스 솔루션 데모는 5번.
	                                                   	; 내선 번호 연결은 6번.
	                                                   	; 안내 멘트를 다시 들으려면 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S21_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="*"]?S21_wrong)		; // 입력 오류
	same => n, GotoIf($[${SELNUM}=0]?S21_recvDgt)		; // 안내멘트 다시 듣기

	same => n, GotoIf($[${SELNUM}=1]?S21_exec)
	same => n, GotoIf($[${SELNUM}=2]?S21_exec)
	same => n, GotoIf($[${SELNUM}=3]?S21_exec)
	same => n, GotoIf($[${SELNUM}=4]?S21_exec)
	same => n, GotoIf($[${SELNUM}=5]?S21_exec)
	same => n, GotoIf($[${SELNUM}=6]?S21_exec)


	; ----------------------------------------
	; 입력된 정보가 0,1,2,3,4,5 가 아닌 경우  
	; ----------------------------------------
	same => n(S21_wrong), Set(ErrorCode=S21_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S21_wrong_1:bsvc_GoodBye)

	same => n(S21_wrong_1), Playback(${baseDIR}/BSVC_E01)	; 잘못 눌렀습니다.
	same => n, Goto(S21_recvDgt)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S21_not_enter), Set(ErrorCode=S21_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S21_wrong_3:bsvc_GoodBye)

	same => n(S21_wrong_3), Playback(${baseDIR}/BSVC_E02)	; 입력된 정보가 없습니다.
	same => n, Goto(S21_recvDgt)


	; ----------------------------------------
	; 2-1 입력 정보에 의해 job 분기           
	; ----------------------------------------
	same => n(S21_exec), Set(ErrorCode=S21_exec)
	same => n, ExecIf($[${SELNUM}=1]?Set(m_MyWorkStep=216))
	same => n, ExecIf($[${SELNUM}=2]?Set(m_MyWorkStep=211))
	same => n, ExecIf($[${SELNUM}=3]?Set(m_MyWorkStep=212))
	same => n, ExecIf($[${SELNUM}=4]?Set(m_MyWorkStep=213))
	same => n, ExecIf($[${SELNUM}=5]?Set(m_MyWorkStep=214))
	same => n, ExecIf($[${SELNUM}=6]?Set(m_MyWorkStep=215))

	same => n, GotoIf($[${m_MyWorkStep}=216]?S30_main)
	same => n, GotoIf($[${m_MyWorkStep}=211]?S31_main)
	same => n, GotoIf($[${m_MyWorkStep}=212]?S32_main)
	same => n, GotoIf($[${m_MyWorkStep}=213]?S51_main)
	same => n, GotoIf($[${m_MyWorkStep}=214]?S33_main)
	same => n, GotoIf($[${m_MyWorkStep}=215]?S34_main:S21_wrong)


	; ================================================================================
	;                                                                                *
	; 2-2 단계 : 근무 시간이 아님                                                    *
	;                                                                                *
	; ================================================================================
	same => n(S22_main), Set(ErrorCode=S22_main)
	same => n, Set(m_MyWorkStep=220)
	same => n, Playback(${baseDIR}/BSVC_221)	; 지금은 근무 시간이 아닙니다.
	                                               	; 근무 요일은 월요일부터 금요일까지 이고,
	                                               	; 근무 시간은 오전 9시부터 오후 18시 30분까지 입니다.
	                                               	; 이용해 주셔서 감사합니다.
	same => n, Goto(bsvc_Finish)



	; ================================================================================
	;                                                                                *
	; 2-3 단계 : 근무일이 아님                                                       *
	;                                                                                *
	; ================================================================================
	same => n(S23_main), Set(ErrorCode=S23_main)
	same => n, Set(m_MyWorkStep=230)
	same => n, Playback(${baseDIR}/BSVC_231)	; 오늘은 휴무일입니다.
	                                               	; 이용해 주셔서 감사합니다.
	same => n, Goto(bsvc_Finish)


	; ================================================================================
	;                                                                                *
	; 3-0 단계 안내 멘트                                                             *
	;                                                                                *
	; ================================================================================
	same => n(S30_main), Set(ErrorCode=S30_main)
	same => n, Dial(SIP/${RDN}/07051483308,,M(entrance_answer))
	same => n, Hangup()

	; ================================================================================
	;                                                                                *
	; 3-1 단계 안내 멘트                                                             *
	;                                                                                *
	;      - '1' 입력 : 바로앱 영업 관련 문의                                        *
	;      - '2' 입력 : 키워드 관련 문의                                             *
	;      - '3' 입력 : 바로 앱 사용법 문의                                          *
	;      - '4' 입력 : 바로앱 추천인 문의                                           *
	;      - '5' 입력 : 바로앱 페이백 문의                                           *
	;      - '0' 입력 : 안내 멘트 재생                                               *
	;      - '*' 입력 : 이전 단계로 이동                                             *
	;      - 입력 오류 처리                                                          *
	;      - 미입력 처리                                                             *
	;                                                                                *
	; ================================================================================
	same => n(S31_main), Set(ErrorCode=S31_main)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(m_MyWorkStep=310)

	same => n(S31_recvDgt), Set(ErrorCode=S31_recvDgt)

	same => n, read(SELNUM,${baseDIR}/BSVC_311,1,n,1,3)	;
	                                                   	; 바로앱 영업 관련 문의는 1번.
	                                                   	; 키워드 관련 문의는 2번.
	                                                   	; 바로 앱 사용법 문의는 3번.
	                                                   	; 바로앱 추천인 문의는 4번.
	                                                   	; 바로앱 페이백 문의는 5번.
	                                                   	; 안내 멘트를 다시 들으려면 0번.
	                                                   	; 이전 단계로 이동하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S31_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="*"]?S21_main)		; // 이전 단계로 이동
	same => n, GotoIf($[${SELNUM}=0]?S31_recvDgt)		; // 안내멘트 다시 듣기

	same => n, GotoIf($[${SELNUM}=1]?S41_main)
	same => n, GotoIf($[${SELNUM}=2]?S31_exec)
	same => n, GotoIf($[${SELNUM}=3]?S31_exec)
	same => n, GotoIf($[${SELNUM}=4]?S31_exec)
	same => n, GotoIf($[${SELNUM}=5]?S31_exec)


	; ----------------------------------------
	; 입력된 정보가 *,0,1,2,3,4,5 가 아닌 경우     
	; ----------------------------------------
	same => n(S31_wrong), Set(ErrorCode=S31_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S31_wrong_1:bsvc_GoodBye)

	same => n(S31_wrong_1), Playback(${baseDIR}/BSVC_E01)	; 잘못 눌렀습니다.
	same => n, Goto(S31_recvDgt)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S31_not_enter), Set(ErrorCode=S31_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S31_wrong_3:bsvc_GoodBye)

	same => n(S31_wrong_3), Playback(${baseDIR}/BSVC_E02)	; 입력된 정보가 없습니다.
	same => n, Goto(S31_recvDgt)

	; ----------------------------------------
	; 3-1 입력 정보에 의해 job 분기             
	; ----------------------------------------
	same => n(S31_exec), Set(ErrorCode=S31_exec)
	same => n, ExecIf($[${SELNUM}=1]?Set(m_MyWorkStep=311))
	same => n, ExecIf($[${SELNUM}=2]?Set(m_MyWorkStep=312))
	same => n, ExecIf($[${SELNUM}=3]?Set(m_MyWorkStep=313))
	same => n, ExecIf($[${SELNUM}=4]?Set(m_MyWorkStep=314))
	same => n, ExecIf($[${SELNUM}=5]?Set(m_MyWorkStep=315))

	same => n, GotoIf($[${m_MyWorkStep}=311]?S41_main:S51_main)


	; ================================================================================
	;                                                                                *
	; 3-2 단계 안내 멘트                                                             *
	;                                                                                *
	;      - '1' 입력 : CRM 신규 신청                                                *
	;      - '2' 입력 : CRM 장애 신고                                                *
	;      - '3' 입력 : CRM 기타 문의                                                *
	;      - '0' 입력 : 안내 멘트 재생                                               *
	;      - '*' 입력 : 이전 단계 이동                                               *
	;      - 입력 오류 처리                                                          *
	;      - 미입력 처리                                                             *
	;                                                                                *
	; ================================================================================
	same => n(S32_main), Set(ErrorCode=S32_main)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(m_MyWorkStep=320)

	; ----------------------------------------
	; AGI를 이용하여 현재 CRM 운용 상태 체크  
	; ----------------------------------------
	same => n, AGI(${agiDIR}/bsvc_check_crm_service.php)
	same => n, Log(NOTICE, bsvc_check_crm_service.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?S32_agi_access_fail)
	same => n, GotoIf($["${RESULT}"="1111"]?S32_crm_status_ok)
	same => n, GotoIf($["${RESULT}"="2222"]?S32_web_server_ng)
	same => n, GotoIf($["${RESULT}"="8888"]?S32_db_server_ng:S32_crm_status_undef)

	same => n(S32_agi_access_fail), Set(ErrorCode=S32_agi_access_fail)
	same => n, Playback(${baseDIR}/BSVC_326)	; 외부 장치에 접속하지 못하여, 현재 CRM 상태를 확인할 수가 없습니다.
	same => n, Goto(S32_recvDgt)

	same => n(S32_crm_status_ok), Set(ErrorCode=S32_crm_status_ok)
	same => n, Playback(${baseDIR}/BSVC_322)	; 현재 CRM 상태는 정상 운영중 입니다.
	same => n, Goto(S32_recvDgt)

	same => n(S32_web_server_ng), Set(ErrorCode=S32_web_server_ng)
	same => n, Playback(${baseDIR}/BSVC_323)	; 현재 웹 서버에 장애가 있으며, 조치중 입니다.
	same => n, Goto(S32_recvDgt)

	same => n(S32_db_server_ng), Set(ErrorCode=S32_db_server_ng)
	same => n, Playback(${baseDIR}/BSVC_324)	; 현재 DB 서버에 장애가 있으며, 조치중 입니다.
	same => n, Goto(S32_recvDgt)

	same => n(S32_crm_status_undef), Set(ErrorCode=S32_crm_status_undef)
	same => n, Playback(${baseDIR}/BSVC_325)	; 확인되지 않은 CRM 상태가 감지되었습니다 . 즉시 조치하겠습니다.
	same => n, Goto(S32_recvDgt)


	; ----------------------------------------
	; 3-2단계 안내멘트 시작                   
	; ----------------------------------------
	same => n(S32_recvDgt), Set(ErrorCode=S32_recvDgt)

	same => n, read(SELNUM,${baseDIR}/BSVC_321,1,n,1,3)	; CRM 신규 신청은 1번.
	                                                   	; CRM 장애 신고는 2번.
	                                                   	; CRM 기타 문의는 3번.
	                                                   	; 안내 멘트를 다시 들으려면 0번.
	                                                   	; 이전 단계로 이동하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S32_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="*"]?S21_main)		; // 이전 단계로 이동
	same => n, GotoIf($[${SELNUM}=0]?S32_recvDgt)		; // 안내 멘트 다시 듣기

	same => n, GotoIf($[${SELNUM}=1]?S32_exec)
	same => n, GotoIf($[${SELNUM}=2]?S32_exec)
	same => n, GotoIf($[${SELNUM}=3]?S32_exec)


	; ----------------------------------------
	; 입력된 정보가 *,0,1,2,3 가 아닌 경우     
	; ----------------------------------------
	same => n(S32_wrong), Set(ErrorCode=S32_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S32_wrong_1:bsvc_GoodBye)

	same => n(S32_wrong_1), Playback(${baseDIR}/BSVC_E01)	; 잘못 눌렀습니다.
	same => n, Goto(S32_recvDgt)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S32_not_enter), Set(ErrorCode=S32_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S32_wrong_3:bsvc_GoodBye)

	same => n(S32_wrong_3), Playback(${baseDIR}/BSVC_E02)	; 입력된 정보가 없습니다.
	same => n, Goto(S32_recvDgt)


	; ----------------------------------------
	; 3-2 입력 정보에 의해 job 분기             
	; ----------------------------------------
	same => n(S32_exec), Set(ErrorCode=S32_exec)
	same => n, ExecIf($[${SELNUM}=1]?Set(m_MyWorkStep=321))
	same => n, ExecIf($[${SELNUM}=2]?Set(m_MyWorkStep=322))
	same => n, ExecIf($[${SELNUM}=3]?Set(m_MyWorkStep=323))
	same => n, Goto(S51_main)


	; ================================================================================
	;                                                                                *
	; 3-3 단계 안내 멘트                                                             *
	;                                                                                *
	;      - '1' 입력 : 보이는 ARS 연결                                              *
	;      - '2' 입력 : 녹취 및 ARS 주문 데모                                        *
	;      - '0' 입력 : 안내 멘트 다시 듣기                                          *
	;      - '*' 입력 : 이전 단계 이동                                               *
	;      - 입력 오류 처리                                                          *
	;      - 미입력 처리                                                             *
	;                                                                                *
	; ================================================================================
	same => n(S33_main), Set(ErrorCode=S33_main)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(m_MyWorkStep=330)

	same => n(S33_recvDgt), Set(ErrorCode=S33_recvDgt)

	same => n, read(SELNUM,${baseDIR}/BSVC_331,1,n,1,3)	; 보이는 ARS 연결은 1번.
	                                                   	; 녹취 및 ARS 주문 데모는 2번.
	                                                   	; 안내 멘트를 다시 들으려면 0번.
	                                                   	; 이전 단계로 이동하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S21_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="*"]?S21_main)		; // 이전 단계로 이동
	same => n, GotoIf($[${SELNUM}=0]?S33_recvDgt)		; // 안내 멘트 다시 듣기

	same => n, GotoIf($[${SELNUM}=1]?S331_main)	; 데모 번호 호출
	same => n, GotoIf($[${SELNUM}=2]?S332_main)	; 070-7540-1465 호출


	; ----------------------------------------
	; 입력된 정보가 *,0,1,2 가 아닌 경우     
	; ----------------------------------------
	same => n(S33_wrong), Set(ErrorCode=S33_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S33_wrong_1:bsvc_GoodBye)

	same => n(S33_wrong_1), Playback(${baseDIR}/BSVC_E01)	; 잘못 눌렀습니다.
	same => n, Goto(S33_recvDgt)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S33_not_enter), Set(ErrorCode=S33_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S33_wrong_3:bsvc_GoodBye)

	same => n(S33_wrong_3), Playback(${baseDIR}/BSVC_E02)	; 입력된 정보가 없습니다.
	same => n, Goto(S33_recvDgt)


	; ----------------------------------------
	; 보이는 ARS 데모 연결                    
	; ----------------------------------------
	same => n(S331_main), Set(ErrorCode=S331_main)
	same => n, Set(m_MyWorkStep=331)
	same => n, Set(TDN=07075401880)
	same => n, Goto(S3xx_dialing)
	same => n, Goto(bsvc_Finish)

	; ----------------------------------------
	; 070-7540-1465 호출                 
	; ----------------------------------------
	same => n(S332_main), Set(ErrorCode=S332_main)
	same => n, Set(m_MyWorkStep=332)
	same => n, Set(TDN=07075401465)

	same => n, Goto(S3xx_dialing)

;	same => n, Dial(Local/${CALLEE}@poas_main)	; // 실행 가능, 약간의 warning 발생함, 이상유무 검토 필요함
;	same => n, Goto(poas_main,poas_start,1)		; // 실행 가능
;	same => n, Goto(poas_main,${CALLEE},1)		; // 실행 가능
	same => n, Goto(bsvc_Finish)


	; ================================================================================
	;                                                                                *
	; 3-4 단계 안내 멘트 및 업무시간과 업무일인지 체크                               *
	;                                                                                *
	;      - '200' 입력 : 지정된 담당자 연결                                         *
	;      - '201' 입력 : 지정된 담당자 연결                                         *
	;      - '202' 입력 : 지정된 담당자 연결                                         *
	;      - '203' 입력 : 지정된 담당자 연결                                         *
	;      - '204' 입력 : 지정된 담당자 연결                                         *
	;      - '0'   입력 : 내선 번호                                                  *
	;      - '*'   입력 : 이전 단계 이동                                             *
	;      - 입력 오류 처리                                                          *
	;      - 미입력 처리                                                             *
	;                                                                                *
	; ================================================================================
	same => n(S34_main), Set(ErrorCode=S34_main)

	; ----------------------------------------
	; 현재가 휴일인지 및 근무 시간인지 체크   
	; ----------------------------------------
	same => n, AGI(${agiDIR}/bsvc_check_date_time.php)
	same => n, Log(NOTICE, bsvc_check_date_time.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?S34_aaf)		; // aaf=agi_access_fail
	same => n, GotoIf($["${RESULT}"="1111"]?S34_start)
	same => n, GotoIf($["${RESULT}"="2222"]?S22_main)
	same => n, GotoIf($["${RESULT}"="3333"]?S23_main:S34_aue)	; // aue=agi_unknown_error


	; ----------------------------------------
	; AGI access 실패시                       
	; ----------------------------------------
	same => n(S34_aaf), Noop(ErrorCode=${S34_aaf})
	same => n, Set(m_MyWorkStep=3401)
	same => n, Playback(${baseDIR}/BSVC_E11)	; 외부 장치에 접속하지 못하여, 서비스를 제공하지 못합니다.
	                                        	; 확인후 이용해 주세요.
	same => n, Goto(bsvc_Finish)


	; ----------------------------------------
	; AGI access 성공하였으나 결과가 미정의            
	; ----------------------------------------
	same => n(S34_aue), Noop(ErrorCode=${S34_aue})
	same => n, Set(m_MyWorkStep=3402)
	same => n, Playback(${baseDIR}/BSVC_E12)	; 알려지지 않은 오류가 발생하여, 서비스를 제공하지 못합니다.
	                                        	; 확인후 이용해 주세요.
	same => n, Goto(bsvc_Finish)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(S34_start), Set(ErrorCode=S34_start)
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(m_MyWorkStep=340)

	same => n(S34_recvDgt), Set(ErrorCode=S34_recvDgt)
	same => n, read(SELNUM,${baseDIR}/BSVC_341,3,n,1,5)	; 통화 하실  내선 번호를 누르거나,
	                                                   	; 내선 번호를 모르시면 0과 # 버튼을.
	                                                   	; 이전 단계로 이동하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S34_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="*"]?S21_main)		; // 이전 단계로 이동
	same => n, GotoIf($["${SELNUM}"="**"]?S21_main)		; // 이전 단계로 이동
	same => n, GotoIf($["${SELNUM}"="***"]?S21_main)	; // 이전 단계로 이동
	same => n, GotoIf($[${SELNUM}=0]?S34_anm)		; // 내선 번호를 모르는 경우

	same => n, Set(TDN=0)
	same => n, ExecIf($["${SELNUM}"="300"]?Set(TDN=07051483300))
	same => n, ExecIf($["${SELNUM}"="301"]?Set(TDN=07051483301))
	same => n, ExecIf($["${SELNUM}"="302"]?Set(TDN=07051483302))
	same => n, ExecIf($["${SELNUM}"="303"]?Set(TDN=07051483303))
	same => n, ExecIf($["${SELNUM}"="304"]?Set(TDN=07051483304))
	same => n, ExecIf($["${SELNUM}"="305"]?Set(TDN=07051483305))
	same => n, ExecIf($["${SELNUM}"="306"]?Set(TDN=07051483306))
	same => n, ExecIf($["${SELNUM}"="307"]?Set(TDN=07051483307))
	same => n, ExecIf($["${SELNUM}"="308"]?Set(TDN=07051483308))
	same => n, ExecIf($["${SELNUM}"="309"]?Set(TDN=07051483309))
	same => n, GotoIf($[${TDN}=0]?S34_wrong:S34_dialing)		; // 내선 번호를 모르는 경우

	; ----------------------------------------
	; 입력된 정보가 0,1,2,3,4,5 가 아닌 경우     
	; ----------------------------------------
	same => n(S34_wrong), Set(ErrorCode=S34_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 10]?S34_wrong_1:bsvc_GoodBye)

	same => n(S34_wrong_1), Playback(${baseDIR}/BSVC_E01)	; 잘못 눌렀습니다.
	same => n, Goto(S34_recvDgt)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S34_not_enter), Set(ErrorCode=S34_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S34_wrong_3:bsvc_GoodBye)

	same => n(S34_wrong_3), Playback(${baseDIR}/BSVC_E02)	; 입력된 정보가 없습니다.
	same => n, Goto(S34_recvDgt)


	; ----------------------------------------
	; 개별 담당자 전화 호출                        
	; ----------------------------------------
	same => n(S34_dialing), Set(ErrorCode=S34_dialing)
	same => n, Goto(S3xx_dialing)
	same => n, HangUp()


	; ----------------------------------------
	; 내선 번호 안내                            
	; ----------------------------------------
	same => n(S34_anm), Set(ErrorCode=S34_anm)

	same => n, Set(m_MyWorkStep=341)
	same => n, Set(TDN=07051483308)
	same => n, Goto(S3xx_dialing)
	same => n, HangUp()


	; ----------------------------------------
	; TDN 정보로 발신 시도                       
	; ----------------------------------------
	same => n(S3xx_dialing), Noop(S3xx_dialing)
;	same => n, Set(m_MyWorkStep=342)

	same => n, Dial(SIP/${RDN}/${TDN})

	same => n, Goto(bsvc_Finish)
	same => n, HangUp()


	; ================================================================================
	;                                                                                *
	; 4-1 단계 안내 멘트                                                             *
	;                                                                                *
	;      - '0' 입력시 : 안내 멘트 다시 듣기                                        *
	;      - 입력 오류 처리                                                          *
	;      - 미입력 처리                                                             *
	;                                                                                *
	; ================================================================================
	same => n(S41_main), Set(ErrorCode=S41_main)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(m_MyWorkStep=411)

	same => n(S41_recvDgt), Set(ErrorCode=S41_recvDgt)

;	same => n, read(SELNUM,${baseDIR}/BSVC_411,1,n,1,3)	; 412멘트 + "이용해 주셔서 감사합니다" 
	same => n, read(SELNUM,${baseDIR}/BSVC_412,1,n,1,3)	;
	                                                   	; 바로서비스 사업설명회 장소 안내입니다.
	                                                   	; 장소는 서울시 구로구 디지털로 34길 55, 
	                                                   	; 구로동 코오롱 싸이언스 밸리 2차 1009호 이고
	                                                   	; 설명회 시간은 
	                                                   	; 매일 오전 11시, 오후 2시 및 오후 4시에 있습니다.
	                                                   	; 자세한 안내는 전화번호  02 - 839 - 6667로 
	                                                   	; 연결하여 안내 받으시면 되겠습니다.
	                                                   	; 안내 멘트를 다시 들으려면 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?bsvc_GoodBye)		; // 미입력 혹은 #입력시
	same => n, GotoIf($["${SELNUM}"="*"]?bsvc_GoodBye)		; // '*' 입력
	same => n, GotoIf($[${SELNUM}=0]?S41_wrong:bsvc_GoodBye)	; // 안내 멘트 다시 듣기

	same => n(S41_wrong), Set(ErrorCode=S41_wrong)
	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S41_recvDgt)
	same => n, Goto(bsvc_GoodBye)


	; ================================================================================
	;                                                                                *
	; 5-1 단계                                                                       *
	;                                                                                *
	;                                                                                *
	; ================================================================================
	same => n(S51_main), Set(ErrorCode=S51_main)

	same => n, Goto(bsvc_record,start,1)


	; ================================================================================
	;                                                                                *
	; ================================================================================
	same => n(bsvc_GoodBye), Noop(bsvc_GoodBye)
	same => n, Log(NOTICE,[bsvc_GoodBye] [${CALLER} --> ${CALLEE}] ERR=[${ErrorCode}] STEP=[${m_MyWorkStep}] )

	same => n, Playback(${baseDIR}/BSVC_E03)	; 이용해 주셔서 감사합니다.
	same => n, Hangup()


	same => n(bsvc_Finish), Noop(bsvc_Finish)
	same => n, Log(NOTICE,[bsvc_Finish] [${CALLER} --> ${CALLEE}] ERR=[${ErrorCode}] STEP=[${m_MyWorkStep}] )

	same => n, Hangup()


exten => h,1, Noop(bsvc_Hangup)
	same => n, Log(NOTICE,[bsvc_Hangup] [${CALLER} --> ${CALLEE}] ERR=[${ErrorCode}] STEP=[${m_MyWorkStep}] )
	same => n, Hangup()


; ********************************************************************************
; *                                                                              *
; *                                                                              *
; *                                                                              *
; *                                                                              *
; *                                                                              *
; ********************************************************************************

[bsvc_record]
exten => start,1,Noop([bsvc_record] Recieving Call[${EXTEN}] From [${CHANNEL(peerip)}])

	same => n, Set(baseDIR=bsvc)
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(reg_sts=0)		; 0=init_sts 1=reg_start 2=reg_save 3=reg_cancel

	same => n, Goto(bstart,1)


	; ================================================================================
	;                                                                                *
	; 5-1단계 : 문의 사항 음성으로 남기기                                            *
	;                                                                                *
	; - 음성 안내 멘트 내용                                                          *
	;                                                                                *
	; ================================================================================

exten => bstart,1,Noop([bsvc_record] ${STRFTIME(${EPOCH},,%F %T)} [${CALLER}] --> [${CALLEE}])

	same => n, Set(reg_sts=0)			; init_sts

	same => n(S51_recvRecStep), Set(ErrorCode=S51_recvRecStep)

	same => n, read(SELNUM,${baseDIR}/BSVC_511,1,n,1,2)	;
	                                                  	; 문의 사항을 음성으로 남겨두면,
	                                                  	; 담당자에게 전달됩니다. 
	                                                  	; 삐- 소리를 들으신 후
	                                                  	; 문의 사항을 말씀하시고, 
	                                                  	; 녹음이 끝나면 #버튼을 누르세요. 
	                                                  	; 녹음중에 통화를 종료하면
	                                                  	; 문의 사항은 취소됩니다.
	                                                  	; 안내 멘트를 다시 들으려면 0번을.
	                                                  	; 이전 단계로 이동하려면 별표를 누르세요.


	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S51_record)

	same => n, GotoIf($["${SELNUM}"="*"]?S51_PreStep)
	same => n, GotoIf($[${SELNUM}=0]?S51_recvRecStep:S51_record)


	; ----------------------------------------
	; 이전 단계로 이동
	; ----------------------------------------
	same => n(S51_PreStep), Set(ErrorCode=S51_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Set(job_num=${MATH(${m_MyWorkStep}/10,int)})
	same => n, GotoIF($[${job_num} = 21]?bsvc_main,bsvc_start,S21_main)
	same => n, GotoIF($[${job_num} = 31]?bsvc_main,bsvc_start,S31_main)
	same => n, GotoIF($[${job_num} = 32]?bsvc_main,bsvc_start,S32_main)
	same => n, GotoIF($[${job_num} = 33]?bsvc_main,bsvc_start,S33_main)
	same => n, GotoIF($[${job_num} = 34]?bsvc_main,bsvc_start,S34_main)


	; ----------------------------------------
	; 녹취 시작                               
	; ----------------------------------------
	same => n(S51_record), Set(ErrorCode=S51_record)

	same => n, Playback(${baseDIR}/BSVC_BEEP)	; 삐~~~~

	same => n, Set(recFileName=${NUM}-${CALLER}_${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}.wav)
	same => n, Set(savFileName=${recFileName})
	same => n, Set(reg_sts=1)			; reg_start

	same => n, MixMonitor(${recFileName})		; // p:녹취 시작시 비프음을 보내줌

	same => n, WaitExten(120)


	; ================================================================================
	;                                                                                *
	; 고객이 # 버튼을 누르기를 기다리는 중                                           *
	; 3-1단계 : 음성 녹취중                                                          *
	;                                                                                *
	; ================================================================================

exten => waiting,1, Noop(waiting ~~~)
	same => n, ExecIf($[${reg_sts}=1]?WaitExten(120))
	same => n, Noop()

exten => 0,1, Goto(waiting,1)
exten => 1,1, Goto(waiting,1)
exten => 2,1, Goto(waiting,1)
exten => 3,1, Goto(waiting,1)
exten => 4,1, Goto(waiting,1)
exten => 5,1, Goto(waiting,1)
exten => 6,1, Goto(waiting,1)
exten => 7,1, Goto(waiting,1)
exten => 8,1, Goto(waiting,1)
exten => 9,1, Goto(waiting,1)
exten => *,1, Goto(waiting,1)

exten => #,1, Noop(Waiting # Button  MIXMONITOR_FILENAME=[${MIXMONITOR_FILENAME}])

	same => n, ExecIf($[${reg_sts}=1]?Noop():WaitExten(120))


	; ================================================================================
	;                                                                                *
	; 5-3 단계 : 음성 녹취 종료 및 다음 단계 진행                                    *
	;                                                                                *
	; ================================================================================
	same => n, StopMixMonitor()

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n(S53_recvRecStep), Set(ErrorCode=S53_recvRecStep)
	same => n, read(SELNUM,${baseDIR}/BSVC_531,1,n,1,5)	;
	                                                  	; 녹음 내용 확인은 1번.
	                                                  	; 녹음 내용 저장은 2번.
	                                                  	; 녹음 다시 하기는 3번.
	                                                  	; 녹음 내용 취소는 4번.
	                                                  	; 안내 멘트를 다시 들으려면 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S53_not_enter)
	same => n, GotoIf($["${SELNUM}"="*"]?S61_retry)		; // 녹취 파일 삭제후 이전 단계로 이동

	same => n, GotoIf($[${SELNUM}=0]?S53_recvRecStep)
	same => n, GotoIf($[${SELNUM}=1]?S61_main)		; // 6-1 단계로 이동
	same => n, GotoIf($[${SELNUM}=2]?S61_store)		; // 녹취 파일 저장후 종료
	same => n, GotoIf($[${SELNUM}=3]?S61_retry)		; // 녹취 파일 삭제후 이전 단계로 이동
	same => n, GotoIf($[${SELNUM}=4]?S61_cancel)		; // 녹음 취소후 종료


	; ----------------------------------------
	; 입력된 정보가 1,2,3,4,0,* 이 아닌 경우        
	; ----------------------------------------
	same => n(S53_wrong), Set(ErrorCode=S53_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S53_wrong_1:S53_wrong_2)

	same => n(S53_wrong_1), Playback(${baseDIR}/BSVC_E01)	; 잘못 눌렀습니다.
	same => n, Goto(S53_recvRecStep)


	; ----------------------------------------
	; 입력된 정보 없음
	; ----------------------------------------
	same => n(S53_not_enter), Set(ErrorCode=S53_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S41_wrong_3:S53_wrong_2)

	same => n(S41_wrong_3), Playback(${baseDIR}/BSVC_E02)	; 입력된 정보가 없습니다.
	same => n, Goto(S53_recvRecStep)


	; ----------------------------------------
	; 녹음 파일 삭제하기
	; ----------------------------------------
	same => n(S53_wrong_2), Noop(S53_wrong_2)
	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Goto(brec_GoodBye)



	; ================================================================================
	;                                                                                *
	; 6-1 단계 : 녹음된 내용을 들려주고 고객의 선택에 의해                           *
	;               1) 6-1 단계 안내 멘트 들려주기                                   *
	;               2) 녹음 파일 저장후 주문 완료                                    *
	;               3) 녹음 파일 삭제후 재 주문                                      *
	;               4) 녹음 파일 삭제후 주문 종료                                    *
	;                                                                                *
	; ================================================================================

	same => n(S61_main), Set(ErrorCode=S61_main)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(recFileName=${CUT(MIXMONITOR_FILENAME,.,1)})


	; ----------------------------------------
	; 주문 내용 다시 들려주기                 
	; ----------------------------------------
	same => n(S61_replay), Set(ErrorCode=S61_replay)

	same => n, read(SELNUM,${recFileName},1,n,1,1)		; // 녹음된 내용을 들려줌

	same => n, GotoIf($[${LEN(${SELNUM})}=1]?S61_recvSelNum)

	same => n, read(SELNUM,${baseDIR}/BSVC_611,1,n,1,1)	; 문의 내용을 확인하셨습니까?

	same => n, GotoIf($[${LEN(${SELNUM})}=1]?S61_recvSelNum2)

	same => n(S61_recvSelNum), Set(ErrorCode=S61_recvSelNum2)

	same => n, read(SELNUM,${baseDIR}/BSVC_612,1,n,1,5)	;
	                                                   	; 문의 내용 듣기는 1번.
	                                                   	; 문의 내용 저장은 2번.
	                                                   	; 문의 다시 하기는 3번.
	                                                   	; 문의 내용 취소는 4번.
	                                                   	; 안내 멘트를 다시 들으려면 0번을 누르세요.

	same => n(S61_recvSelNum2), Set(ErrorCode=S61_recvSelNum2)

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S61_not_enter)

	same => n, GotoIf($["${SELNUM}"="*"]?S61_wrong)		; // 입력 오류
	same => n, GotoIf($[${SELNUM}=0]?S61_recvSelNum)	; // 안내 멘트 다시 들려주기
	same => n, GotoIf($[${SELNUM}=1]?S61_replay)		; // 주문 내용 다시 들려주기
	same => n, GotoIf($[${SELNUM}=2]?S61_store)		; // 녹취 파일 저장후 종료
	same => n, GotoIf($[${SELNUM}=3]?S61_retry)		; // 녹취 파일 삭제후 이전 단계로 이동
	same => n, GotoIf($[${SELNUM}=4]?S61_cancel)		; // 녹취 파일 삭제후 통화 종료


	; ----------------------------------------
	; 입력된 정보가 1,2,3,0,* 이 아닌경우        
	; ----------------------------------------
	same => n(S61_wrong), Set(ErrorCode=S61_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S61_wrong_1:brec_GoodBye)

	same => n(S61_wrong_1), Playback(${baseDIR}/BSVC_E01)		; 잘못 눌렀습니다.
	same => n, Goto(S61_recvSelNum)


	; ----------------------------------------
	; 입력된 정보 없음
	; ----------------------------------------
	same => n(S61_not_enter), Set(ErrorCode=S61_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S61_wrong_3:brec_GoodBye)

	same => n(S61_wrong_3), Playback(${baseDIR}/BSVC_E02)		; 입력된 정보가 없습니다.
	same => n, Goto(S61_recvSelNum)


	; ================================================================================
	; 문의사항 녹취 내용 저장하고 종료하기                                           *
	; ================================================================================
	same => n(S61_store), Set(ErrorCode=S61_store)

	same => n, Set(PathDir=/var/spool/asterisk/monitor/RECHDD)
	same => n, Set(EmergencyDir=bsvc)

	same => n, Set(FileSize=${STAT(s,${MIXMONITOR_FILENAME})})
;	same => n, Noop(recFileName=${MIXMONITOR_FILENAME} savFileName=${savFileName} FileSize=${FileSize})

	same => n, AGI(${agiDIR}/bsvc_get_user_code.php)
	same => n, Log(NOTICE, bsvc_get_user_code.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}]) USERCODE=[${USERCODE}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?S61_agi_guc_access_fail)
	same => n, GotoIf($["${RESULT}"!="0000"]?S61_agi_guc_result_fail)
	same => n, GotoIf($[${LEN(${USERCODE})}=0]?S61_agi_guc_length_error);

	same => n, Set(RESULT1=****)
	same => n, AGI(${agiDIR}/bsvc_save_ars_record.php)
	same => n, Log(NOTICE, bsvc_save_ars_record.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?S61_agi_sar_access_fail)
	same => n, GotoIf($["${RESULT}"="0000"]?reg_user_succ:S61_agi_sar_result_fail)


	; ----------------------------------------
	; AGI 연동 실패시
	; ----------------------------------------
	same => n(S61_agi_guc_access_fail), Set(ErrorCode=S61_agi_guc_access_fail)
	same => n, Goto(S61_agi_order_fail)

	same => n(S61_agi_guc_result_fail), Set(ErrorCode=S61_agi_guc_result_fail)
	same => n, Goto(S61_agi_order_fail)

	same => n(S61_agi_guc_length_error), Set(ErrorCode=S61_agi_guc_length_error)
	same => n, Goto(S61_agi_order_fail)

	same => n(S61_agi_sar_access_fail), Set(ErrorCode=S61_agi_sar_access_fail)
	same => n, Goto(S61_agi_order_fail)

	same => n(S61_agi_sar_result_fail), Set(ErrorCode=S61_agi_sar_result_fail)
	same => n, Goto(S61_agi_order_fail)

	same => n(S61_agi_order_fail), Noop(ErrorCode=${ErrorCode})

	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Playback(${baseDIR}/BSVC_E13)	; 외부 장치에 접속하지 못하여, 문의사항을 접수하지 못합니다.
	                                        	; 확인후 이용해 주세요.

	same => n, Goto(brec_Finish)


	; ----------------------------------------
	; 입력된 정보 없음
	; ----------------------------------------
	same => n(end_on_reg_step), Set(ErrorCode=end_on_reg_step)

	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Goto(brec_GoodBye)


	; ----------------------------------------
	; 녹취 파일 저장 기본 위치 확인                          
	; ----------------------------------------
	same => n(reg_user_succ), Set(ErrorCode=reg_user_succ)

	same => n, Set(reg_sts=2)	; record_ok
	same => n, Set(record_data_Dir=${STAT(d,${PathDir}/record_data)})
	same => n, GotoIf($[${record_data_Dir}=0]?record_dir_not_exist)

	; ----------------------------------------
	; 녹취 파일 저장 위치 디렉토리 생성                     
	; ----------------------------------------
	same => n, System(/var/lib/asterisk/agi-bin/bsvc/bsvc.sh  ${PathDir} record_data ${USERCODE} ${CALLEE})
	same => n, Log(NOTICE, [mkdir] SYSTEMSTATUS=${SYSTEMSTATUS})
	same => n, GotoIf($["${SYSTEMSTATUS}"!="SUCCESS"]?make_rec_dir_fail)


	; ----------------------------------------
	; 녹취 파일 위치 이동                             
	; ----------------------------------------
	same => n, System(/bin/mv ${MIXMONITOR_FILENAME} ${PathDir}/record_data/${USERCODE}/${CALLEE}/.)
	same => n, Log(NOTICE, [UserCode_mv] SYSTEMSTATUS=${SYSTEMSTATUS})
	same => n, GotoIf($["${SYSTEMSTATUS}"!="SUCCESS"]?move_rec_file_fail)


	same => n, Playback(${baseDIR}/BSVC_621)	; 문의 사항을 저장되었습니다.
	                                         	; 이용해 주셔서 감사합니다.
	same => n, Goto(brec_Finish)


	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(record_dir_not_exist), Set(ErrorCode=record_dir_not_exist)
	same => n, Goto(emergency_file_store)

	same => n(make_rec_dir_fail), Set(ErrorCode=make_rec_dir_fail)
	same => n, Goto(emergency_file_store)

	same => n(move_rec_file_fail), Set(ErrorCode=move_rec_file_fail)
	same => n, Goto(emergency_file_store)


	; ----------------------------------------
	; 녹음 파일을 전송하지 못하는 경우
	; ----------------------------------------
	same => n(emergency_file_store), Set(ErrorCode=${ErrorCode})

	same => n, System(${agiPath}/bsvc_emer_recdir.sh ${recPath} ${emgDIR} ${USERCODE} )
	same => n, System(/bin/mv ${MIXMONITOR_FILENAME} ${recPath}/${emgDIR}/${USERCODE}/.)

	same => n, Log(NOTICE, [USERCODE_mv] SYSTEMSTATUS=${SYSTEMSTATUS})
	same => n, Playback(${baseDIR}/BSVC_E14)	;
	                                         	; 문의 사항 즉시 전송하지 못하여
	                                         	; 문의 사항 처리가 지연될 수 있음을 알려 드립니다.
	same => n, Playback(${baseDIR}/BSVC_E03)	; 이용해 주셔서 감사합니다.

	same => n, Goto(brec_Finish)


	; ================================================================================
	; 문의사항 녹음 취소하고 다시 녹음하기                                           *
	; ================================================================================
	same => n(S61_retry), Set(ErrorCode=S61_retry)

	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Goto(bstart,1)


	; ================================================================================
	; 문의사항 녹음 취소하고 종료하기                                                *
	; ================================================================================
	same => n(S61_cancel),Set(ErrorCode=S61_cancel)

	same => n, Playback(${baseDIR}/BSVC_631)		; 녹음을 취소하였습니다.
	                                        		; 이용해 주셔서 감사합니다.
	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Set(reg_sts=3)				; reg_cancel

	same => n, Goto(brec_Finish)


	; ================================================================================
	;                                                                                *
	; ================================================================================
	same => n(brec_GoodBye), Noop(brec_GoodBye)
	same => n, Log(NOTICE,[brec_GoodBye] [${CALLER} --> ${CALLEE}] : ERR=[${ErrorCode}] STEP=[${m_MyWorkStep}] )
	same => n, Playback(${baseDIR}/BSVC_E03)	; 이용해 주셔서 감사합니다.
	same => n, Hangup()


	same => n(brec_Finish), Noop(brec_Finish)
	same => n, Log(NOTICE,[brec_Finish] [${CALLER} --> ${CALLEE}] : ERR=[${ErrorCode}] STEP=[${m_MyWorkStep}] )
	same => n, Hangup()


exten => h,1, Noop(reg_sts=[${reg_sts}] MIXMONITOR_FILENAME=[${MIXMONITOR_FILENAME}] The_Caller_HangUp_Recording)

	same => n, Log(NOTICE,[bsvc_hangup] [${CALLER}] : reg_sts=${reg_sts}/MIXMONITOR_FILENAME=[${MIXMONITOR_FILENAME}]/The_Caller_HangUp_Recoding STEP=[${m_MyWorkStep}] )

	same => n, GotoIf($[${LEN(${MIXMONITOR_FILENAME})}=0]?reg_goodbye);

	same => n, ExecIf($[${reg_sts}=1]?System(/bin/rm ${MIXMONITOR_FILENAME}))

	same => n(reg_goodbye), Hangup()





; ********************************************************************************
; *                                                                              *
; *                                                                              *
; *                                                                              *
; ********************************************************************************
[macro-entrance_answer]
exten => s,1,Playback(bsvc/BSVC_112)
