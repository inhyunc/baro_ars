; ********************************************************************************
; *                                                                              *
; * 물품 보관함 서비스                                                           *
; *                                                                              *
; ********************************************************************************

[sbox_main]

exten => _X.,1, Noop([sbox_main] Recv Call [${CALLERID(ANI)} --> ${CALLERID(DNID)}] From [${CHANNEL(peerip)}])

	same => n, Answer()
	same => n, Set(CALLER=${CALLERID(ANI)})
	same => n, Set(CALLEE=${CALLERID(DNID)})

	same => n, Goto(sbox_start,1)


exten => sbox_start,1, Noop(sbox_start)

	same => n, Set(CHANNEL(language)=kr)
	same => n, Set(m_CompanyID=0)	; 1=바로서비스, 2=이마트24, 3=피비글로발, 0=미정의
	same => n, Set(wavDIR=sbox)
	same => n, Set(agiDIR=sbox)
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(agiPath=/var/lib/asterisk/agi-bin/${agiDIR})
	same => n, Set(m_AuthCode=)
	same => n, Set(m_PhoneNumber=)
	same => n, Set(m_BoxNumber=0)
	same => n, Set(m_UserType=0)	; // 1=일반고객, 2=택배기사 문열기, 3=장기사용고객


	; ********************************************************************************
	;                                                                                *
	; 0-0 Greeting Message(인사말)                                                   *
	;                                                                                *
	; ********************************************************************************
	same => n(S00_greeting), Set(ErrorCode=S00_greeting)
	same => n, GoSub(GreetingMessage,start,1(${ErrorCode},1))
	same => n, Set(m_CompanyID=${GOSUB_RETVAL})


	; ********************************************************************************
	;                                                                                *
	; 0-1 다우 050 매개 번호 정보 검색                                               *
	;                                                                                *
	; ********************************************************************************
	same => n(S01_get_dau_050), Set(ErrorCode=S01_get_dau_050)
	same => n, GoSub(Get_Daou050Number,start,1(${ErrorCode},1))
	same => n, Set(DAOU050NUMBER=${GOSUB_RETVAL})
	same => n, GotoIf($[${DAOU050NUMBER} = 0]?sbox_Finish,1)


	; ********************************************************************************
	;                                                                                *
	; 0-4 다우 050 번호로 결제 방식 설정                                             *
	;   - output: (1) m_PayType : 1=GmPOS, 2=cider_pay                               *
	;             (2) RESULT : 1111=OK                                               *
	;                                                                                *
	; ********************************************************************************
	same => n(S04_check_pay_type), Set(ErrorCode=S04_check_pay_type)

	same => n, Set(RESULT=)						; // RESULT 초기화
	same => n, Set(m_PayType=1)					; // m_PayType=GmPOS

	same => n, AGI(${agiDIR}/sbox_check_ciderpay.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_check_ciderpay.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_PayType=[${m_PayType}])

	same => n, Goto(S02_get_mac_inform)



	; ********************************************************************************
	;                                                                                *
	; 0-2 BU의 MAC Address 정보 검색                                                 *
	;                                                                                *
	; ********************************************************************************
	same => n(S02_get_mac_inform), Set(ErrorCode=S02_get_mac_inform)
	same => n, GoSub(Get_BuMacInform,start,1(${ErrorCode}))
	same => n, Set(m_MacAddr=${GOSUB_RETVAL})
	same => n, GotoIf($[${m_MacAddr} = 0]?sbox_Finish,1)
	same => n, ExecIf($["${GROUPNO}"="0128700001"]?Set(m_CompanyID=2))


	; ********************************************************************************
	;                                                                                *
	; 0-3 물품 보관함 내의 소형,중형,대형 크기별로 설정되어 있는 갯수 검색           *
	;                                                                                *
	; ********************************************************************************
	same => n(S03_get_box_style), Set(ErrorCode=S03_get_box_style)
	same => n, GoSub(Get_BoxStyle,start,1(${ErrorCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM} = 0]?sbox_Finish,1)
	same => n, Goto(S21_main)


	; ********************************************************************************
	;                                                                                *
	; 1-1 인사말                                                                     *
	;                                                                                *
	; ********************************************************************************
	same => n(S11_greeting), Set(ErrorCode=S11_greeting)

	same => n, Set(FN=${SPRINTF(SBOX_001)})					; 안녕하세요. 물품 보관함 입니다.
	same => n, ExecIf($[${m_CompanyID} = 2]?Set(FN=${SPRINTF(SBOX_101)}))	; 이마트24. 물품 보관함 입니다.

	same => n, Playback(${wavDIR}/${FN})




	; ********************************************************************************
	;                                                                                *
	; 2-1 서비스 타입 결정                                                           *
	;                                                                                *
	; ********************************************************************************
	same => n(S21_main), Set(ErrorCode=S21_main)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))

	same => n(S21_recvDgt), Set(ErrorCode=S21_recvDgt)

	; ----------------------------------------
	; 메인 메뉴                               
	; ----------------------------------------
	same => n, Read(SELNUM,${wavDIR}/SBOX_002,1,n,1,5)		; 보관은 1번.
	                                                  		; 찾기는 2번.
	                                                  		; 장기 사용은 3번.
	                                                  		; 택배 기사는 9번.
	                                                  		; 관리자 모드는 4번
	                                                  		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S21_not_enter)		; // 미입력

	same => n, GotoIf($["${SELNUM}"="1"]?S31_main)			; // 보관 서비스 선택
	same => n, GotoIf($["${SELNUM}"="2"]?S32_main)			; // 찾기 서비스 선택
	same => n, GotoIf($["${SELNUM}"="3"]?S34_main)			; // 장기 사용 서비스 선택
	same => n, GotoIf($["${SELNUM}"="9"]?S33_main)			; // 택배 기사 보관 서비스 선택
	same => n, GotoIf($["${SELNUM}"="4"]?S35_main)			; // 관리자 모드
	same => n, GotoIf($["${SELNUM}"="0"]?S21_recvDgt)		; // 다시 듣기 선택

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(S21_wrong), Set(ErrorCode=S21_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S21_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(S21_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S21_not_enter), Set(ErrorCode=S21_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S21_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(S21_recvDgt)


	; ----------------------------------------
	; 서비스 준비중입니다.                      
	; ----------------------------------------
;	same => n(S21_not_service), Set(ErrorCode=S21_not_service)
;	same => n, Playback(${wavDIR}/SBOX_C12)					; 서비스 준비중입니다.
;	same => n, Goto(S21_recvDgt)





	; ********************************************************************************
	;                                                                                *
	; 3-1 보관 서비스 사용 가능 여부 확인                                            *
	;                                                                                *
	; ********************************************************************************
	same => n(S31_main), Set(ErrorCode=S31_main)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))

	; ----------------------------------------
	; 비어 있는 보관함 갯수 검색                  
	; ----------------------------------------
	same => n, GoSub(check_EmptyLocker,start,1(${ErrorCode}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}!=1111]?sbox_GoodBye,1)

	; ----------------------------------------
	; 보관함 크기 동일시 보관함 크기 선택 메뉴 skip  
	; ----------------------------------------
	same => n(S31_GetBoxSize), Set(ErrorCode=S31_GetBoxSize)

	same => n, GotoIf($[${m_BoxStyle}>1]?S31_GetBoxType)
	same => n, GoSub(GetStyleEmptyLocker,start,1(${ErrorCode}))
	same => n, Goto(S41_main)

	; ----------------------------------------
	; 보관함 크기 선택                        
	; ----------------------------------------
	same => n(S31_GetBoxType), Noop(S31_GetBoxType)
	same => n, GoSub(sbox_GetBoxType,start,1(${ErrorCode}))	; 보관함 크기를 선택하세요.
	                                                      	; 소형은 1번.
	                                                      	; 중형은 2번.
	                                                      	; 대형은 3번.
	                                                      	; 이전 단계는 별표.
	                                                      	; 다시 듣기는 0번을 누르세요.
	same => n, Set(RESULT=${GOSUB_RETVAL})

	same => n, GotoIf($[${RESULT}=4444]?S21_main)		; // 이전 단계 --> 2-1 단계로 이동
	same => n, GotoIf($[${RESULT}=2222]?S31_GetBoxSize)	; // 비어 있는 보관함 없음 -> 재선택
	same => n, Goto(S41_main)				; // 다믐 단계로 이동




	; ********************************************************************************
	;                                                                                *
	; 4-1 보관 서비스                                                                *
	;     - 보관함 사용 여부 확인                                                    *
	;       1=사용, 2=다음보관함확인, 3=보관함크기변경, 4=이전단계                   *
	;       0=다시 듣기                                                              *
	;                                                                                *
	; ********************************************************************************
	same => n(S41_main), Set(ErrorCode=S41_main)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))
	same => n, GoSub(sbox_SelBoxNumber,start,1(S41_recvDgt,1))	; 사용 가능한 보관함은 xx 번 입니다.
	                                                        	; 이 보관함 사용은 1번.
	                                                     		; 다른 보관함으로 변경은 2번.
	                                                        	; 보관함 크기 변경은 3번.
	                                                        	; 이전 단계는 별표.
	                                                        	; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})

	same => n, GotoIf($[${SELNUM}=1]?S51_main) 			; // 현재 보관함 사용 확정                   
	same => n, GotoIf($[${SELNUM}=3]?S31_GetBoxSize)		; // 보관함 크기 변경                      
	same => n, GotoIf($[${SELNUM}=4]?S21_main)			; // 이전 단계 -> 2-1 단계로 이동
	same => n, Goto(sbox_GoodBye,1)					; // 리턴값 오류시 종료






	; ********************************************************************************
	;                                                                                *
	; 5-1 보관료 통지 및 서비스 종료                                                 *
	;   - 고객이 선택한 보관함 정보를 서버에 저장하고 기본요금 정보를 수집한다.      *
	;   - sbox_reserve_using_locker.php                                              *
	;   - input : (1) 고객전화번호                                                   *
	;           : (2) m_BoxNumber : 사용할 보관함 번호                               *
	;   - output: (1) RESULT(1111=OK, 9999=NOK)                                      *
	;             (2) m_BasicFee : 해당 보관함의 기본 요금                           *
	;   - 참고사항 : m_BasicFee가 0이면 AGI에서 결제가 된것으로 표시하기로 함        *
	;                ARS에서는 즉시 문을 열어 주도록 함(2020.02.20)                  *
	;                                                                                *
	; ********************************************************************************
	same => n(S51_main), Set(ErrorCode=S51_main)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, AGI(${agiDIR}/sbox_reserve_using_locker.php)
	same => n, Log(NOTICE, sbox_reserve_using_locker.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] FEE=[${m_BasicFee}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(S51_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?S51_succ)
	same => n, GotoIf($["${RESULT}"="9999"]?S51_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S51_not_define,SBOX_022,1))

	; ----------------------------------------
	; AGI 에서 NOK 수신시                      
	; ----------------------------------------
	same => n(S51_fail), Set(ErrorCode=S51_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S51_fail,SBOX_023,0))	; 서버로부터 사용 허가를 받지 못하여,
	                                       				; 서비스를 진행할 수 없습니다.

	; ----------------------------------------
	; DB에 정보 저장 실패                        
	; ----------------------------------------
	same => n(S51_error), Set(ErrorCode=S51_error)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S51_error,SBOX_024,1)); 서버로부터 추가 정보를 가져오지 못하여, 
	                                       				; 서비스를 진행할 수 없습니다.

	; ----------------------------------------
	; 보관 서비스 정보 저장 후 종료                   
	; ----------------------------------------
	same => n(S51_succ), Set(ErrorCode=S51_succ)

	same => n, GotoIf($[${LEN(${m_BasicFee})}=0]?S51_error)		; // 기본 요금 정보 미 수신시
	same => n, GotoIF($[${m_BasicFee}=0]?S51_openDoor)		; // 기본 요금이 0원 경우

	same => n, Playback(${wavDIR}/SBOX_010)				; 사용하실 보관함의 기본요금은 
	same => n, GoSub(read_Number,start,1(${m_BasicFee},W))		; xx 원
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.

	same => n, GotoIF($[${m_PayType}=2]?S51_ciderpay)		; // CiderPay 결제

	same => n, ExecIf($[${m_BasicFee}>50000]?Playback(${wavDIR}/SBOX_074))	; // 5만원 이상이면 분리 결제 알림

	same => n, Playback(${wavDIR}/SBOX_011)				; 결재기에서 결재를 하시면 해당 보관함이 열립니다. 
	same => n, Goto(sbox_GoodBye,1)

	; ----------------------------------------
	; CiderPay 결제 문자 요청               
	; ----------------------------------------
	same => n(S51_ciderpay), Set(ErrorCode=S51_ciderpay)
	same => n, GoSub(procCiderPay,start,1(${CALLER},${m_BasicFee},${m_MacAddr},${ErrorCode}))
	same => n, Goto(sbox_GoodBye,1)

	; ----------------------------------------
	; 결제요금=0 경우 ARS에서 직접 문 개방             
	; ----------------------------------------
	same => n(S51_openDoor), Set(ErrorCode=S51_openDoor)
	same => n, Set(m_UserType=1)					; // 1=일반고객, 2=택배기사 문열기, 3=장기사용고객
	same => n, GoSub(OpenBoxDoor,start,1(${ErrorCode},1))		; xx번 보관함 문을 열었습니다.
	same => n, Goto(sbox_GoodBye,1)



	; ********************************************************************************
	;                                                                                *
	; 3-2 찾기 서비스 보관된 물품 존재 여부 확인                                     *
	;   - 고객이 보관 중인 물품이 있는지 확인                                        *
	;   - sbox_check_using_locker.php                                                *
	;   - input : (1) 고객 전화번호                                                  *
	;   - output: (1) RESULT(1111=사용중인 보관함 있음                               *
	;                        2222=사용중인 보관함 없음                               *
	;                        3333=미결재 정보 있음)                                  *
	;             (2) m_UsingCount : 사용 갯수,최대값 20까지                         *
	;             (3) LN0, LN1 ..... LN19, LN20 : 사용중인 보관함 번호               *
	;                                             최대 20개까지만 통지 가능          *
	;                                                                                *
	; ********************************************************************************
	same => n(S32_main), Set(ErrorCode=S32_main)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))

	same => n, AGI(${agiDIR}/sbox_check_using_locker.php)
	same => n, Log(NOTICE, sbox_check_using_locker.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_UsingCount=[${m_UsingCount}])

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(S32_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?S32_using_sts)		; // 보관중인 물품 있슴
	same => n, GotoIf($["${RESULT}"="2222"]?S32_not_using)		; // 보관중인 물품 없슴
	same => n, GotoIf($["${RESULT}"="3333"]?S32_unpaid)		; // 미결제 정보
	same => n, GoSub(sbox_PlayErrMesg,start,1(S32_not_define,SBOX_022,0))

	; ----------------------------------------
	; 미결재 정보 있음                        
	; ----------------------------------------
	same => n(S32_unpaid), Set(ErrorCode=S32_unpaid)
	same => n, Playback(${wavDIR}/SBOX_019)				; 대기중인 결제 정보가 있습니다.결제후 이용해 주세요.
	same => n, Goto(sbox_GoodBye,1)

	; ----------------------------------------
	; 보관중인 물품 없음                   
	; ----------------------------------------
	same => n(S32_not_using), Set(ErrorCode=S32_not_using)
	same => n, Playback(${wavDIR}/SBOX_005)				; 고객님께서 사용중인 보관함은 없습니다.
	same => n, Goto(sbox_GoodBye,1)

	; ----------------------------------------
	; 보관중인 물품 있음                   
	; ----------------------------------------
	same => n(S32_using_sts), Set(ErrorCode=S32_using_sts)
	same => n, GotoIf($[${LEN(${m_UsingCount})}=0]?S32_not_using)	; // 보관 물품 갯수 정보 미 수신시
	same => n, GotoIF($[${m_UsingCount}=0]?S32_not_using)		; // 보관 물품 갯수가 0 인 경우
	same => n, ExecIf($[${m_UsingCount} > 20]?Set(m_UsingCount=20)

	; ----------------------------------------
	; 찾기 서비스                       
	; ----------------------------------------
	same => n(S32_checkUcount), Set(ErrorCode=S32_checkUcount)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))
	same => n, Set(countLOOP=1)
	same => n, Set(m_BoxNumber=${LN0})
	same => n, GoSub(play_Count,start,1(${ErrorCode},${m_UsingCount},1))	; 고객님께서 보관중인 물품이 xx 개 있습니다.
	same => n, Wait(1)
	same => n, Set(m_EmptyCount=${m_UsingCount})

	; ----------------------------------------
	; 번호 입력 대기                          
	; ----------------------------------------
	same => n, Set(ErrorCode=S32_recvDgt)
	same => n, GoSub(get_YourBoxNumber,start,1(${ErrorCode}))	; 보관함 xx 번에 있는 물품을 찾으시겠습니까?
	                                                        	; 찾기는 1번.
	                                                        	; 다른 보관함의 물품 찾기는 2번.
	                                                        	; 이전 단계는 별표.
	                                                        	; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})

	same => n, GotoIf($[${SELNUM}=1]?S42_main)			; // 찾기(다음 단계) --> 4-2단계로 이동
	same => n, GotoIf($[${SELNUM}=2]?S21_main)			; // 이전 단계 --> 2-1 단계로 이동
	same => n, Goto(sbox_Finish,1)					; // 원인없이 종료





	; ********************************************************************************
	;                                                                                *
	; 4-2 찾기 서비스                                                                *
	;   - 추가요금정보과 BU에게 송신할 보관함 번호                                   *
	;   - sbox_check_surcharge.php                                                   *
	;   - input : m_BoxNumber                                                        *
	;   - output: RESULT(1111=추가요금있슴, 2222=추가요금없음, 9999=추가요금 검색 실패)*
	;             m_AddFee : 추가요금                                                *
	;             m_DoorContData : BU에서 인식 가능한 보관함 번호                    *
	;                                                                                *
	; ********************************************************************************
	same => n(S42_main), Set(ErrorCode=S42_main)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))

	same => n, AGI(${agiDIR}/sbox_check_surcharge.php)
	same => n, Log(NOTICE, sbox_check_surcharge.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_AddFee=[${m_AddFee}] m_DoorContData=[${m_DoorContData}])

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(S42_agi_fail,SBOX_021,0))

	same => n, GotoIf($["${RESULT}"="1111"]?S42_much_fee)	; // 추가요금있슴
	same => n, GotoIf($["${RESULT}"="2222"]?S42_none_fee)	; // 추가요금없음
	same => n, GotoIf($["${RESULT}"="9999"]?S42_fee_fail)	; // 추가요금 검색 실패

	same => n, GoSub(sbox_PlayErrMesg,start,1(S42_not_define,SBOX_022,0))

	; ----------------------------------------
	; AGI로부터 추가요금 정보 가져오지 못함              
	; ----------------------------------------
	same => n(S42_fee_fail), Set(ErrorCode=S42_fee_fail)
	same => n, Playback(${wavDIR}/SBOX_024)				; 서버로부터 추가 정보를 가져오지 못하여,
	                                       				; 서비스를 진행할 수 없습니다.
	same => n, Goto(sbox_GoodBye,1)

	; ----------------------------------------
	; 추가요금 안내후 종료                         
	; ----------------------------------------
	same => n(S42_much_fee), Set(ErrorCode=S42_much_fee)

	same => n, GotoIf($[${LEN(${m_DoorContData})}=0]?S42_fee_fail)	; // 미입력
	same => n, GotoIf($[${LEN(${m_AddFee})}=0]?S42_fee_fail)	; // 미입력
	same => n, GotoIF($[${m_AddFee} = 0]?S42_none_fee)		; // 추가 요금 없음

	same => n, Playback(${wavDIR}/SBOX_015)				; 추가 요금이
	same => n, GoSub(read_Number,start,1(${m_AddFee},W))		; xx 원
	same => n, Playback(${wavDIR}/SBOX_C06)				; 있습니다.
	same => n, Playback(${wavDIR}/SBOX_016)				; 물품을 찾으시려면 결제를 하여야 합니다.

	same => n, GotoIF($[${m_PayType}=2]?S42_ciderpay)		; // CiderPay 결제

	same => n, ExecIf($[${m_AddFee}>50000]?Playback(${wavDIR}/SBOX_074))	; // 5만원 이상이면 분리 결제 알림

	same => n, Playback(${wavDIR}/SBOX_011)				; 결제기에서 결제를 하시면 해당 보관함이 열립니다.
	same => n, Goto(sbox_GoodBye,1)


	; ----------------------------------------
	; 추가요금 없음으로 보관함 문 열기                  
	; ----------------------------------------
	same => n(S42_none_fee), Set(ErrorCode=S42_none_fee)
	same => n, GotoIf($[${LEN(${m_DoorContData})}=0]?S42_fee_fail)	; // 미입력
	same => n, Goto(S52_main)

	; ----------------------------------------
	; CiderPay 결제 문자 요청               
	; ----------------------------------------
	same => n(S42_ciderpay), Set(ErrorCode=S42_ciderpay)
	same => n, GoSub(procCiderPay,start,1(${CALLER},${m_AddFee},${m_MacAddr},${ErrorCode}))
	same => n, Goto(sbox_GoodBye,1)


	; ********************************************************************************
	; 5-2 보관함 열기                                                                *
	; ********************************************************************************
	same => n(S52_main), Set(ErrorCode=S52_main)
	same => n, Set(m_UserType=1)					; // 1=일반고객, 2=택배기사 문열기, 3=장기사용고객
	same => n, GoSub(OpenBoxDoor,start,1(${ErrorCode},1))		; xx번 보관함 문을 열었습니다.
	same => n, Goto(sbox_GoodBye,1)





	; ********************************************************************************
	;                                                                                *
	; 3-3 택배 기사 보관 첫 음성안내                                                 *
	;                                                                                *
	; ********************************************************************************
	same => n(S33_main), Set(ErrorCode=S33_main)

	same => n, Playback(${wavDIR}/SBOX_037)				; 택배 기사 물품 보관 서비스입니다.

	same => n, Goto(S43_main)					; // 보관함 선택 단계로 이동


	; ********************************************************************************
	;                                                                                *
	; 4-3 보관함 크기 지정 및 함번호 할당,                                           *
	;   - 고객이 ARS 멘트를 듣고 보관함 크기 선택                                    *
	;   - m_BoxType : 보관함 타입                                                    *
	;                                                                                *
	; ********************************************************************************
	same => n(S43_main), Set(ErrorCode=S43_main)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))

	; ----------------------------------------
	; 보관함 크기 동일 크기시 아래 메뉴 SKIP         
	; ----------------------------------------
	same => n, GotoIf($[${m_BoxStyle}>1]?S43_GetBoxType)
	same => n, GoSub(GetStyleEmptyLocker,start,1(${ErrorCode}))
	same => n, Goto(S432_main)


	; ----------------------------------------
	; 보관함 크기 선택                              
	; ----------------------------------------
	same => n(S43_GetBoxType), Noop(S43_GetBoxType)
	same => n, GoSub(sbox_GetBoxType,start,1(${ErrorCode}))		; 보관함 크기를 선택하세요.
	                                                      		; 소형은 1번.
	                                                      		; 중형은 2번.
	                                                      		; 대형은 3번.
	                                                      		; 이전 단계는 별표.
	                                                      		; 다시 듣기는 0번을 누르세요.
	same => n, Set(RESULT=${GOSUB_RETVAL})

	same => n, GotoIf($[${RESULT}=4444]?S21_main)			; // 이전 단계 --> 2-1 단계로 이동
	same => n, GotoIf($[${RESULT}=2222]?S43_main)			; // 비어 있는 보관함 없음 -> 재선택
	same => n, Goto(S432_main)



	; ********************************************************************************
	;                                                                                *
	; 4-3-2 사용할 보관함 번호 확정                                                  *
	;   -  m_BoxNumber                                                               *
	;                                                                                *
	; ********************************************************************************
	same => n(S432_main), Set(ErrorCode=S432_main)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))
	same => n, GoSub(sbox_SelBoxNumber,start,1(S432_recvDgt,1))	; 사용 가능한 보관함은 xx 번 입니다.
	                                                        	; 이 보관함 사용은 1번.
	                                                     		; 다른 보관함으로 변경은 2번.
	                                                        	; 보관함 크기 변경은 3번.
	                                                        	; 이전 단계는 별표.
	                                                        	; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})

	same => n, GotoIf($[${SELNUM}=1]?S53_main) 			; // 고객 핸드폰 입력 단계로 이동         
	same => n, GotoIf($[${SELNUM}=3]?S43_main)			; // 보관함 크기 변경                      
	same => n, GotoIf($[${SELNUM}=4]?S21_main)			; // 이전 단계 -> 2-1 단계로 이동            
	same => n, Goto(sbox_GoodBye,1)					; // 리턴값 오류시 종료



	; ********************************************************************************
	;                                                                                *
	; 5-3 물품 수령자 핸드폰 번호 입력                                               *
	;   - m_PhoneNumber : 물품 수령자 핸드폰 번호                                    *
	;                                                                                *
	; ********************************************************************************
	same => n(S53_main), Set(ErrorCode=S53_main)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))

	; -----------------------------------------------------
	; 핸드폰 번호 입력                                    
	; -----------------------------------------------------
	same => n(S531_PhoneNum), Set(ErrorCode=S531_PhoneNum)
	same => n, Read(m_PhoneNumber,${wavDIR}/SBOX_030,11,n,1,10)	; 물품을 수령하실 고객님의 휴대폰 번호를 입력하세요.

	same => n, GotoIf($[${LEN(${m_PhoneNumber})}=0]?S531_not_enter)
	same => n, GotoIf($[${LEN(${m_PhoneNumber})}<10]?S531_wrong:S532_ChkDgt)

	; -----------------------------------------------------
	; 입력된 정보 없음                                    
	; -----------------------------------------------------
	same => n(S531_not_enter), Set(ErrorCode=S531_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S531_not_enter,SBOX_C02,3))
	same => n, Goto(S531_PhoneNum)

	; -----------------------------------------------------
	; 고객 전화번호를 10자리 미만으로 입력하는 경우        
	; -----------------------------------------------------
	same => n(S531_wrong), Set(ErrorCode=S531_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S531_wrong,SBOX_C09,2))	; 입력 정보의 자릿수가 맞지 않습니다.
	same => n, Goto(S531_PhoneNum)

	; -----------------------------------------------------
	; 고객 전화번호를 10~ 11자리 입력,택배 기사 전화번호와 동일 여부 체크
	; -----------------------------------------------------
	same => n(S532_ChkDgt), Set(ErrorCode=S532_ChkDgt)
	same => n, GotoIf($["${CALLER}"!="${m_PhoneNumber}"]?S532_rcvDgt)
	same => n, Playback(${wavDIR}/SBOX_075)				; 택배 기사님의 휴대폰 번호를, 
	                                       				; 고객님의 휴대폰 번호로 사용할 수 없습니다.
	                                       				; 다시 입력하여야 합니다.
	same => n, Goto(S531_PhoneNum)


	same => n(S532_rcvDgt), Set(ErrorCode=S532_rcvDgt)
	same => n, Playback(${wavDIR}/SBOX_031)				; 입력하신 휴대폰 번호는
	same => n, SayDigits(${m_PhoneNumber})				; xxxxxxxx
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.

	same => n, Read(SELNUM,${wavDIR}/SBOX_032,1,n,1,3)		; 맞으면 1번.
	                                                 		; 변경은 2번.
	                                                 		; 이전 단계는 별표.
	                                                 		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S532_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="1"]?S63_main)			; // 택배 기사 문열기
	same => n, GotoIf($["${SELNUM}"="2"]?S53_main)			; // 변경 선택
	same => n, GotoIf($["${SELNUM}"="*"]?S43_main)			; // 이전 단계 --> 보관함 크기 선택
	same => n, GotoIf($["${SELNUM}"="0"]?S532_rcvDgt)		; // 다시 듣기 선택

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(S532_wrong), Set(ErrorCode=S532_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S532_wrong,SBOX_C01,2))
	same => n, Goto(S532_rcvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S532_not_enter), Set(ErrorCode=S532_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S532_not_enter,SBOX_C02,3))
	same => n, Goto(S532_rcvDgt)




	; ********************************************************************************
	;                                                                                *
	; 6-3 사용할 보관함 개방하기 위한 정보 획득                                      *
	;   - sbox_get_door_data.php                                                     *
	;                                                                                *
	; ********************************************************************************
	same => n(S63_main), Set(ErrorCode=S63_main)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))

	same => n(S63_recvDgt), Noop(S63_recvDgt)

	same => n, Read(SELNUM,${wavDIR}/SBOX_033,1,n,1,3)		; 보관함 열기는 1번.
	                                                 		; 보관함 변경은 2번.
	                                                 		; 고객님 핸드폰 번호 변경은 3번.
	                                                 		; 처음부터 다시 하려면 4번.
	                                                 		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S63_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="1"]?S73_main)			; // 보관함 열기      --> 7-3 단계로 이동
	same => n, GotoIf($["${SELNUM}"="2"]?S43_main)			; // 보관함 크기 변경 --> 5-3 단계로 이동
	same => n, GotoIf($["${SELNUM}"="3"]?S53_main)			; // 핸드폰 번호 변경 --> 4-3 단계로 이동
	same => n, GotoIf($["${SELNUM}"="4"]?S11_greeting)		; // 처음부터 다시    --> 2-1 단계로 이동
	same => n, GotoIf($["${SELNUM}"="0"]?S63_recvDgt)		; // 다시듣기 선택

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(S63_wrong), Set(ErrorCode=S63_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S63_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(S63_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S63_not_enter), Set(ErrorCode=S63_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S63_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(S63_recvDgt)





	; ********************************************************************************
	;                                                                                *
	; 7-3 DB에 수령자 번화번호와 보관함 번호 등록후 보관함 열기                      *
	;   - sbox_delivery_using_locker.php                                             *
	;     INPUT = m_BoxNumber, m_PhoneNumber                                         *
	;                                                                                *
	; ********************************************************************************
	same => n(S73_main), Noop(S73_main)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))

	same => n, AGI(${agiDIR}/sbox_delivery_using_locker.php)
	same => n, Log(NOTICE, sbox_delivery_using_locker.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_BoxNumber=[${m_BoxNumber}] m_PhoneNumber=[${m_PhoneNumber}])

	; ----------------------------------------
	;                                  
	; ----------------------------------------
	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(S73_agi_fail,SBOX_021,0))

	same => n, GotoIf($["${RESULT}"="1111"]?S73_reg_succ)
	same => n, GotoIf($["${RESULT}"="2222"]?S73_reg_fail)

	same => n, GoSub(sbox_PlayErrMesg,start,1(S73_not_define,SBOX_022,0))

	; ----------------------------------------
	; SBOX_023 : 서버로부터 사용 허가를 받지 못하여, 서비스>를 진행할 수 없습니다.
	; SBOX_024 : 서버로부터 추가 정보를 가져오지 못하여, 서>비스를 진행할 수 없습니다.
	; ----------------------------------------
	same => n(S73_reg_fail), Set(ErrorCode=S73_reg_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S73_reg_fail,SBOX_023,1))	; // SBOX_023 or SBOX_024
	same => n, Goto(sbox_Finish,1)

	; ----------------------------------------
	;                                  
	; ----------------------------------------
	same => n(S73_reg_succ), Set(ErrorCode=S73_reg_succ)
	same => n, Set(m_UserType=2)				; // 1=일반고객, 2=택배기사 문열기, 3=장기사용고객
	same => n, GoSub(OpenBoxDoor,start,1(${ErrorCode},2))	; xx번 보관함 문을 열었습니다.

	; ----------------------------------------
	;                                 
	; ----------------------------------------
	same => n, Read(SELNUM,${wavDIR}/SBOX_035,1,n,1,1)	; 물품 보관을 계속해서 더 하시려면 1번을 누르시면 됩니다.

	same => n, GotoIf($["${SELNUM}"="1"]?S73_go_retry)

	same => n, Read(SELNUM,${wavDIR}/SBOX_BGM,1,n,1,2)	; // 대기 음악
	same => n, GotoIf($["${SELNUM}"="1"]?S73_go_retry)

	same => n, Goto(sbox_GoodBye,1)

	; ----------------------------------------
	;                                  
	; ----------------------------------------
	same => n(S73_go_retry), Set(ErrorCode=S73_go_retry)

	same => n, Set(m_BoxNumber=0)		; // m_BoxNumber 초기화
	same => n, Set(m_PhoneNumber=)		; // m_PhoneNumber 초기화
	same => n, Set(m_DoorContData=)		; // m_DoorContData 초기화

	same => n, Goto(S43_main)		; // 보관함 선택 단계로 이동





	; ********************************************************************************
	;                                                                                *
	; 3-4 장기 사용자 서비스 메인 메뉴                                               *
	;                                                                                *
	; ********************************************************************************
	same => n(S34_main), Set(ErrorCode=S34_main)

;=======2019.08.26   시험후 삭제할것=======================================================================================
;	same => n, AGI(${agiDIR}/sbox_check_dau_050.php)
;	same => n, Log(NOTICE, sbox_check_dau_050.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] DAOU050NUMBER=[${DAOU050NUMBER}])

;	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(S34_agi_fail,SBOX_021,0))
;	same => n, GotoIf($["${RESULT}"="1111"]?S34_rcvDgt)
;	same => n, GoSub(sbox_PlayErrMesg,start,1(S11_not_define,SBOX_C12,0))	; // 서비스 준비중 입니다.
;==========================================================================================================================

	same => n(S34_rcvDgt), Set(ErrorCode=S34_rcvDgt)
	same => n, Read(SELNUM,${wavDIR}/SBOX_040,1,n,1,5)		; 내 보관함 열기는 1번.
	                                                  		; 장기 사용 등록은 2번.
	                                                  		; 장기 사용 해지는 3번.
	                                                  		; 이전 단계는 별표를.
	                                                  		; 다시 듣기는 0번을 누르세요.

	; ----------------------------------------
	; 선택 번호 기능 분기                             
	; ----------------------------------------
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S34_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="0"]?S34_main)			; // 메뉴 다시 듣기
	same => n, GotoIf($["${SELNUM}"="1"]?S44_main)			; // 장기 사용 보관함 열기
	same => n, GotoIf($["${SELNUM}"="2"]?S45_main)			; // 장기 사용 등록
	same => n, GotoIf($["${SELNUM}"="3"]?S47_main)			; // 장기 사용 해지
	same => n, GotoIf($["${SELNUM}"="*"]?S21_main)			; // 처음부터 다시 


	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(S34_wrong), Set(ErrorCode=S34_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S34_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(S34_rcvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S34_not_enter), Set(ErrorCode=S34_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(S34_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(S34_rcvDgt)


	; ********************************************************************************
	;                                                                                *
	; 4-4 장기 고객 보관함 문 열기                                                   *
	;                                                                                *
	; ********************************************************************************
	same => n(S44_main), Set(ErrorCode=S44_main)

	; ----------------------------------------
	; 장기 사용 등록 고객 여부 확인 및 장기 사용중인 보관함 정보 가져오기                     
	; ----------------------------------------
	same => n, GoSub(GetLtuLockNumber,start,1(${ErrorCode},${CALLER},1))
	same => n, Set(RESULT=${GOSUB_RETVAL})

	same => n, GotoIf($[${RESULT}=1111]?S44_selBoxNumber)		; // 장기 사용 등록자
	same => n, Goto(sbox_Finish,1)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(S44_selBoxNumber), Set(ErrorCode=S44_selBoxNumber)
	same => n, Set(countLOOP=1)
	same => n, Set(m_BoxNumber=${LN0})
	same => n, GotoIf($[${m_UsingCount}=1]?S44_LTU_succ)

	same => n, GoSub(play_Count,start,1(${ErrorCode},${m_UsingCount},1))	; 고객님께서 보관중인 물품이 xx 개 있습니다.
	same => n, Wait(1)
	same => n, Set(m_EmptyCount=${m_UsingCount})

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, Set(ErrorCode=S44_rcvDgt)
	same => n, GoSub(get_YourBoxNumber,start,1(${ErrorCode}))	; 보관함 xx 번에 있는 물품을 찾으시겠습니까?
	                                                         	; 찾기는 1번.
	                                                         	; 다른 보관함의 물품을 찾기는 2번.
	                                                         	; 이전 단계는 별표.
	                                                         	; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})

	same => n, GotoIf($[${SELNUM}=1]?S44_LTU_succ)			; // 열기
	same => n, GotoIf($[${SELNUM}=2]?S34_main)			; // 이전 단계 --> 3-4 단계로 이동
	same => n, Goto(sbox_Finish,1)					; // 원인없이 종료



	; ----------------------------------------
	; 특정 보관함 정보 가져오기(만료여부, 만료 날짜, 추가요금)            
	; ----------------------------------------
	same => n(S44_LTU_succ), Set(ErrorCode=S44_LTU_succ)
	same => n, GoSub(GetLtuLockInfo,start,1(${ErrorCode},${m_BoxNumber}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}=1111]?S44_openBox)		; // 사용 기간중
	same => n, GotoIf($[${RESULT}=2222]?S54_main)			; // 사용 기간 만료

	same => n(S44_openBox), Set(ErrorCode=S44_openBox)
	same => n, Set(m_UserType=3)					; // 1=일반고객, 2=택배기사 문열기, 3=장기사용고객
	same => n, GoSub(OpenBoxDoor,start,1(${ErrorCode},3))		; xx번 보관함 문을 열었습니다.
	same => n, Goto(sbox_GoodBye,1)					; // 원인없이 종료


	; ********************************************************************************
	;                                                                                *
	; 5-4 장기 사용 기간 만료 안내                                                   *
	;                                                                                *
	; ********************************************************************************
	same => n(S54_main), Set(ErrorCode=S54_main)

	same => n, GoSub(check_ExpireUsing,start,1(${ErrorCode},${m_BoxNumber},${m_Month},${m_Day},${m_AddFee},1))
	                                                        ; xx 번 보관함의
	                                                        ; 장기 사용 기간이 xx 월 xx 일로 만료되었으며
	                                                        ; 추가 요금 xxxx 원이 발생하였습니다.
	                                                        ; 결제는 1번.
	                                                        ; 이전 단계는 별표.
	                                                        ; 다시 듣기는 0번을 누르세요.

	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?S64_main)		; // 추가 요금 지불
	same => n, GotoIf($[${SELNUM}=0]?S44_main)		; // 장기 사용 메인 메뉴, 이전 단계
	same => n, Goto(sbox_GoodBye,1)				; // 원인없이 종료

	; ********************************************************************************
	;                                                                                *
	; 6-4 장기 사용 추가 요금 지불                                                   *
	;                                                                                *
	; ********************************************************************************
	same => n(S64_main), Set(ErrorCode=S64_main)

	same => n, GoSub(pay_ExtraFee,start,1(${ErrorCode},${m_BoxNumber},${m_AddFee},1,${m_PayType}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?S54_main)		; // 이전 단계 --> 장기 사용 메인 메뉴
	same => n, GotoIf($[${SELNUM}=1]?S64_paySucc)		; // 추가 요금 결제 요청 성공 --> 서비스 종료
	same => n, GotoIf($[${SELNUM}=2]?S64_payFail)		; // 추가 요금 결제 요청 실패 --> 서비스 종료
	same => n, Goto(sbox_GoodBye,1)				; // 원인없이 종료

	; ----------------------------------------
	; 추가 요금 결제 요청 및 서비스 종료              
	; ----------------------------------------
	same => n(S64_paySucc), Set(ErrorCode=S64_paySucc)
	same => n, GotoIF($[${m_PayType}=2]?S64_ciderpay)		; // CiderPay 결제
	same => n, Goto(sbox_GoodBye,1)
	same => n(S64_payFail), Set(ErrorCode=S64_payFail)
	same => n, Goto(sbox_GoodBye,1)

	; ----------------------------------------
	; CiderPay 결제 문자 요청               
	; ----------------------------------------
	same => n(S64_ciderpay), Set(ErrorCode=S64_ciderpay)
	same => n, GoSub(procCiderPay,start,1(${CALLER},${m_AddFee},${m_MacAddr},${ErrorCode}))
	same => n, Goto(sbox_GoodBye,1)


	; ********************************************************************************
	;                                                                                *
	; 4-5 장기 사용 등록                                                             *
	;                                                                                *
	; ********************************************************************************
	same => n(S45_main), Set(ErrorCode=S45_main)

	same => n, GoSub(init_Data,start,1(${ErrorCode}))
	same => n, Playback(${wavDIR}/SBOX_042)			; 장기 사용 등록 단계입니다.

	; ----------------------------------------
	; 비어 있는 보관함 갯수 검색                  
	; ----------------------------------------
	same => n, GoSub(check_EmptyLocker,start,1(${ErrorCode}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}!=1111]?sbox_GoodBye,1)

	; ********************************************************************************
	; 4-5-1 보관함 크기 선택                        
	; ********************************************************************************
	same => n(S451_GetBoxSize), Set(ErrorCode=S451_GetBoxSize)

	; ----------------------------------------
	; 보관함 크기 동일 크기시 아래 메뉴 SKIP         
	; ----------------------------------------
	same => n, GotoIf($[${m_BoxStyle}>1]?S451_GetBoxType)
	same => n, GoSub(GetStyleEmptyLocker,start,1(${ErrorCode}))
	same => n, Goto(S452_main)

	; ----------------------------------------
	; 보관함 크기 선택                               
	; ----------------------------------------
	same => n(S451_GetBoxType), Noop(S451_GetBoxType)
	same => n, GoSub(sbox_GetBoxType,start,1(${ErrorCode}))	; 보관함 크기를 선택하세요.
	                                                      	; 소형은 1번.
	                                                      	; 중형은 2번.
	                                                      	; 대형은 3번.
	                                                      	; 이전 단계는 별표.
	                                                      	; 다시 듣기는 0번을 누르세요.
	same => n, Set(RESULT=${GOSUB_RETVAL})

	same => n, GotoIf($[${RESULT}=4444]?S34_main)		; // 이전 단계 -> 3-4 단계로 이동
	same => n, GotoIf($[${RESULT}=2222]?S451_GetBoxSize)	; // 비어 있는 보관함 없음 -> 재선택
	same => n, Goto(S452_main)


	; ********************************************************************************
	; 4-5-2 선택한 보관함 크기별로 비어 있는 보관함 갯수 검색                        *
	; ********************************************************************************
	same => n(S452_main), Set(ErrorCode=S452_main)


	same => n, GoSub(init_Data,start,1(${ErrorCode}))
	same => n, GoSub(sbox_SelBoxNumber,start,1(S452_recvDgt,1))
	                                                       	; 사용 가능한 보관함은 xx 번 입니다.
                                                        	; 이 보관함 사용은 1번.
                                                     		; 다른 보관함으로 변경은 2번.
                                                        	; 보관함 크기 변경은 3번.
                                                        	; 이전 단계는 별표.
                                                        	; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})

	same => n, GotoIf($[${SELNUM}=1]?S55_main) 		; // 현재 보관함 사용 확정 -> 5-5 단계로 이동
	same => n, GotoIf($[${SELNUM}=3]?S451_GetBoxSize)	; // 보관함 크기 변경                      
	same => n, GotoIf($[${SELNUM}=4]?S34_main)		; // 이전 단계 -> 3-4 단계로 이동
	same => n, Goto(sbox_Finish,1)



	; ********************************************************************************
	; 5-5 장기 사용 날짜 선택                                                        *
	; ********************************************************************************
	same => n(S55_main), Set(ErrorCode=S55_main)

	same => n, Set(m_TermType=3)				; // 한달 사용으로 고정(2019-08-23)
	same => n, Set(m_Month=1)				; // 1개월로 고정

	; ********************************************************************************
	;                                                                                *
	; 6-5 장기 사용 등록 및 결제                                                     *
	;                                                                                *
	; ********************************************************************************
	same => n(S65_main), Set(ErrorCode=S65_main)

	same => n, GoSub(RegLTU,start,1(${ErrorCode},1,${m_PayType}))
	                                                	; 사용하실 보관함은 xx번이고,
	                                                    	; 사용 기간은 오늘부터 x월 xx일까지 xx일 입니다.
	                                                    	; 사용 요금은 xxxx원 입니다.
								; // 5만원 이상은 분리 결제 안내 고지~~~~~
	                                                    	; 결제기에서 결제를 하시면 오늘부터 사용할 수 있습니다.
	                                                    	; 사용 기간이 지나면 사용 연장을 하거나,
	                                                    	; 추가 요금을 지불후에 보관함을 열 수 있습니다.

	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?S65_chk_ciderpay)
	same => n, Goto(sbox_GoodBye,1)

	same => n(S65_chk_ciderpay), Set(ErrorCode=S65_chk_ciderpay)
	same => n, GotoIF($[${m_PayType}=2]?S65_ciderpay)		; // 사이다 페이 결제
	same => n, Goto(sbox_GoodBye,1)

	; ----------------------------------------
	; 사이다페이 결제 문자 요청               
	; ----------------------------------------
	same => n(S65_ciderpay), Set(ErrorCode=S65_ciderpay)
	same => n, GoSub(procCiderPay,start,1(${CALLER},${m_BasicFee},${m_MacAddr},${ErrorCode}))
	same => n, Goto(sbox_GoodBye,1)


	; ********************************************************************************
	;                                                                                *
	; 4-7 장기 사용 해지                                                             *
	;                                                                                *
	; ********************************************************************************
	same => n(S47_main), Set(ErrorCode=S47_main)

	same => n, GoSub(init_Data,start,1(${ErrCode}))

	; ----------------------------------------
	; 장기 사용 등록 고객 여부 확인 및 장기 사용중인 보관함 정보 가져오기                     
	; ----------------------------------------
	same => n, GoSub(GetLtuLockNumber,start,1(${ErrorCode},${CALLER},1))
	same => n, Set(RESULT=${GOSUB_RETVAL})

	same => n, GotoIf($[${RESULT}=1111]?S47_menu)		; // 장기 사용 등록자
	same => n, Goto(sbox_Finish,1)

	; ----------------------------------------
	; 장기 사용 해지시 정보 소개 및 해지 의사 확인
	; ----------------------------------------
	same => n(S47_menu), Set(ErrorCode=S47_menu)
	same => n, Set(countLOOP=1)
	same => n, Set(m_BoxNumber=${LN0})
	same => n, GoSub(terminateLtuMenu,start,1(${ErrorCode})); 장기 사용 해지 단계 입니다.
	                                                        ; 장기 사용 기간 중에 해지를 하면 남은 일수에 대한
	                                                        ; 잔여 금액은 반환하지 않고, 사용 중인 보관함만 열립니다.
	                                                        ; 장기 사용 기간이 지난후에 해지를 하면 미납 요금이 있는
	                                                        ; 것으로 추정하여 보관함은 열리지 않습니다.
	                                                        ; 해지는 1번.
	                                                        ; 이전 단계는 별표.
	                                                        ; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?S57_getLTUinfo)	; // 해지 하기 --> 해지 고객 정보 가져오기
	same => n, GotoIf($[${SELNUM}=2]?S34_main)		; // 이전 단계 --> 3-4 단계로 이동
	same => n, Goto(sbox_Finish,1)				; // 원인없이 종료

	; ----------------------------------------
	; 5-7-0 특정 보관함 정보 가져오기(만료여부, 만료 날짜, 추가요금)            
	; ----------------------------------------
	same => n(S57_getLTUinfo), Set(ErrorCode=S57_getLTUinfo)
	same => n, GoSub(GetLtuLockInfo,start,1(${ErrorCode},${m_BoxNumber}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}=1111]?S57_UnregLTU)	; // 사용 기간중    --> 해지 가능
	same => n, GotoIf($[${RESULT}=2222]?S57_checkFee)	; // 사용 기간 만료 --> 추가 비용 결재 필요
	same => n, Goto(sbox_Finish,1)				; // 원인없이 종료

	; ----------------------------------------
	; 5-7-1 장기 사용 해지(삭제) 및 보관함 문열기          
	; ----------------------------------------
	same => n(S57_UnregLTU), Set(ErrorCode=S57_UnregLTU)
	same => n, GoSub(UnregLTU,start,1(${ErrorCode},${m_BoxNumber}))
	                                                        ; xx 번 보관함의 
	                                                        ; 장기 사용 해지는 1번.
	                                                        ; 다른 보관함 장기 사용 해지는 2번.
	                                                        ; 이전 단계는 별표.
	                                                        ; 다시 듣기는 0번을 누르세요.
	same => n, Set(RESULT=${GOSUB_RETVAL})

	same => n, GotoIf($[${RESULT}=0]?S47_main)		; // 이전 단계
	same => n, GotoIf($[${RESULT}=1]?S57_unregSucc)		; // 해지 등록 성공
	same => n, GotoIf($[${RESULT}=2]?S67_nextBox)		; // 다른 보관함 해지
	same => n, Goto(sbox_GoodBye,1)				;

	same => n(S57_unregSucc), Set(ErrorCode=S57_unregSucc)
	same => n, Set(m_UserType=3)				; // 1=일반고객, 2=택배기사 문열기, 3=장기사용고객
	same => n, GoSub(OpenBoxDoor,start,1(${ErrorCode},4))	; xx번 보관함 문을 열었습니다.
	same => n, Goto(sbox_GoodBye,1)				;


	; ----------------------------------------
	; 5-7-2 추가 요금 결제 안내                 
	; ----------------------------------------
	same => n(S57_checkFee), Set(ErrorCode=S57_checkFee)
	same => n, GoSub(check_ExpireUsing,start,1(${ErrorCode},${m_BoxNumber},${m_Month},${m_Day},${m_AddFee},2))
	                                                        ; xx 번; 보관함의 장기 사용 기간이 xx 월 xx 일로 만료되었으며
	                                                        ; 추가 요금 xxxx 원이 발생하였습니다.
	                                                        ; 장기 사용 해지는 1번.
	                                                        ; 다른 보관함을 해지하려면 2번.
	                                                        ; 이전 단계는 별표를.
	                                                        ; 다시 듣기는 0번을 누르세요.


	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?S67_payFee)		; // 장기 사용 해지
	same => n, GotoIf($[${SELNUM}=2]?S67_nextBox)		; // 다른 보관함 해지
	same => n, GotoIf($[${SELNUM}=0]?S47_main)		; // 장기 사용 메인 메뉴, 이전단계
	same => n, Goto(sbox_GoodBye,1)				; // 원인없이 종료

	; ----------------------------------------
	; 6-7-1 추가 요금 결제
	; ----------------------------------------
	same => n(S67_payFee), Set(ErrorCode=S67_payFee)
	same => n, GoSub(pay_ExtraFee,start,1(${ErrorCode},${m_BoxNumber},${m_AddFee},2,${m_PayType}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?S57_checkFee)		; // 이전 단계 --> 5-7 단계
	same => n, GotoIf($[${SELNUM}=1]?S67_paySucc)		; // 추가 요금 결제 요청 성공 --> 서비스 종료
	same => n, GotoIf($[${SELNUM}=2]?S67_payFail)		; // 추가 요금 결제 요청 실패 --> 서비스 종료
	same => n, Goto(sbox_GoodBye,1)				; // 원인없이 종료

	same => n(S67_paySucc), Set(ErrorCode=S67_paySucc)
	same => n, GotoIF($[${m_PayType}=2]?S67_ciderpay)	; // 사이다페이 결제
	same => n, Goto(sbox_GoodBye,1)				; // 원인없이 종료
	same => n(S67_payFail), Set(ErrorCode=S67_payFail)
	same => n, Goto(sbox_GoodBye,1)				; // 원인없이 종료

	; ----------------------------------------
	; 다른 보관함으로 변경                    
	; ----------------------------------------
	same => n(S67_nextBox), Set(ErrorCode=S67_nextBox)
	same => n, GoSub(sbox_GetNextBox,start,1(${m_UsingCount},${ErrorCode}))	; // 다음 보관함 번호 가져오기
;	same => n, GoSub(play_Count,start,1(${ErrorCode},${m_BoxNumber},3))	; 장기 사용을 해지하려고 하는 보관함은
;	                                                                   	; xx번 입니다.
	same => n, Goto(S57_getLTUinfo)						;

	; ----------------------------------------
	; 사이다페이 결제 문자 요청               
	; ----------------------------------------
	same => n(S67_ciderpay), Set(ErrorCode=S67_ciderpay)
	same => n, GoSub(procCiderPay,start,1(${CALLER},${m_AddFee},${m_MacAddr},${ErrorCode}))
	same => n, Goto(sbox_GoodBye,1)


	; ********************************************************************************
	;                                                                                *
	; 3-5 관리자 모드                                                                *
	;                                                                                *
	; ********************************************************************************
	same => n(S35_main), Set(ErrorCode=S35_main)

	same => n, GoSub(Get_OpenBoxNumber,start,1(${ErrorCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM} = 0]?S11_greeting)		; // 이전 단계
	same => n, Goto(sbox_GoodBye,1)


	; ********************************************************************************
	;                                                                                *
	; 물품 보관함 서비스 종료                                                        *
	;                                                                                *
	;                                                                                *
	; ********************************************************************************
exten => sbox_GoodBye, 1, Noop(sbox_GoodBye)
	same => n, Log(NOTICE,[${CALLER} --> ${CALLEE}] [sbox_GoodBye] ERR=[${ErrorCode}])
	same => n, Playback(${wavDIR}/SBOX_C04)				; 이용해 주셔서 감사합니다.
	same => n, Hangup()

exten => sbox_Finish, 1, Noop(sbox_Finish)
	same => n, Log(NOTICE,[${CALLER} --> ${CALLEE}] [sbox_Finish] ERR=[${ErrorCode}])
	same => n, Hangup()

exten => h,1, Noop(sbox_Hangup)
	same => n, Log(NOTICE,[${CALLER} --> ${CALLEE}] [sbox_Hangup] ERR=[${ErrorCode}])
	same => n, Hangup()


; ********************************************************************************
;                                                                                *
; Greeting Message(인사말)                                                       *
;   1) input para                                                                *
;      - ErrCode : 호출 위치 정보                                                *
;      - GrtType : 장기보관함=5, 물품보관함=1                                    *
;   2) sbox_get_dnid.php                                                         *
;      - input : (1) 착신번호                                                    *
;      - output: (1) RESULT(1111=OK)                                             *
;                (2) m_CompanyID : 1=바로서비스,2=이마트,3=피비글로벌,0=미정의   *
;                                  5=장기보관함                                  *
; ********************************************************************************

[GreetingMessage]
exten => start,1,Noop(GreetingMessage from [${ARG1} ${ARG2}] )

	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode
	same => n, Set(LOCAL(GrtType)=${ARG2})			; GrtType

	same => n, GotoIf($[${GrtType} = 5]?GM_greeting_5)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, AGI(${agiDIR}/sbox_get_dnid.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_get_dnid.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_CompanyID=[${m_CompanyID}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?GM_greeting_1)
	same => n, GotoIf($[${m_CompanyID} = 1]?GM_greeting_1)
	same => n, GotoIf($[${m_CompanyID} = 2]?GM_greeting_2)
	same => n, GotoIf($[${m_CompanyID} = 3]?GM_greeting_3)
	same => n, Goto(GM_greeting_0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(GM_greeting_0), Playback(${wavDIR}/SBOX_001)		; // 배경 음원
	same => n, Return(0)

	same => n(GM_greeting_1), Playback(${wavDIR}/SBOX_001)		; 안녕하세요. 물품 보관함 입니다.
	same => n, Return(1)

	same => n(GM_greeting_2), Playback(${wavDIR}/SBOX_101)		; 이마트24. 물품 보관함 입니다.
	same => n, Return(2)

	same => n(GM_greeting_3), Playback(${wavDIR}/SBOX_001)		; 안녕하세요. 물품 보관함 입니다.
	same => n, Return(3)

	same => n(GM_greeting_5), Playback(${wavDIR}/SBOX_200)		; 안녕하세요. 장기 보관함 서비스입니다.
	same => n, Return(5)


exten => h,1, Log(NOTICE,[${CALLER}] GreetingMessage/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; 다우 050 매개 번호 정보 검색                                                   *
;   - sbox_get_dau_050.php                                                       *
;   - input : (1) 착신번호                                                       *
;   - output: (1) RESULT(1111=OK, 9999:NOK)                                      *
;             (2) DAOU050NUMBER : 050 매개번호, 길이가 5자 이상인 경우에만 유효  *
;                                                                                *
; ********************************************************************************

[Get_Daou050Number]
exten => start,1,Noop(Get_Daou050Number from [${ARG1}/${ARG2}] )

	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode
	same => n, Set(LOCAL(AnmType)=${ARG2})			; AnmType(1=yes,2=no)
	same => n, Set(countWRONG=0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(GDN_get_dau_050), Set(ErrCode=GDN_get_dau_050)
	same => n, AGI(${agiDIR}/sbox_get_dau_050.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_get_dau_050.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] DAOU050NUMBER=[${DAOU050NUMBER}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(GDN_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?GDN_succ)
	same => n, GotoIf($["${RESULT}"="9999"]?GDN_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(GDN_not_define,SBOX_022,0))

	; ----------------------------------------
	; 050 번호 검색 실패                      
	; ----------------------------------------
	same => n(GDN_fail), Set(ErrCode=GDN_fail)
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, Wait(1)
	same => n, GotoIF($[${countWRONG} < 3]?GDN_get_dau_050)
	same => n, ExecIf($[${AnmType} = 1]?Playback(${wavDIR}/SBOX_003))			; 지금거신 전화번호는 서비스를 받을 수 있는 번호가 아닙니다.
	same => n, Return(0)

	; ----------------------------------------
	; 050 번호 검색 성공                      
	; ----------------------------------------
	same => n(GDN_succ), Set(ErrCode=GDN_succ)
	same => n, GotoIf($[${LEN(${DAOU050NUMBER})}<5]?GDN_fail)		; // 050번호 길이가 5 이상인 경우에만 유효
	same => n, Return(${DAOU050NUMBER})


exten => h,1, Log(NOTICE,[${CALLER}] Get_Daou050Number/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; BU의 MAC Address 정보 검색                                                     *
;   - sbox_get_mac_inform.php                                                    *
;   - input : (1) DAOU050NUMBER                                                  *
;   - output: (1) RESULT(1111=MAC정보있음, 9999=MAC정보없음)                     *
;             (2) m_MacAddr : 보관함 관리장치(BU)의 MAC 주소                     *
;                             MAC정보 크기가 0인 경우 오류 처리함                *
;             (3) GROUPNO                                                        *
;                                                                                *
; ********************************************************************************

[Get_BuMacInform]
exten => start,1,Noop(Get_BuMacInform from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode
	same => n, Set(RESULT=)						; // RESULT 초기화

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, AGI(${agiDIR}/sbox_get_mac_inform.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_get_mac_inform.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_MacAddr=[${m_MacAddr}] GROUPNO=[${GROUPNO}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(GBMI_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?GBMI_mac_succ)
	same => n, GotoIf($["${RESULT}"="9999"]?GBMI_mac_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(GBMI_not_define,SBOX_022,0))

	; ----------------------------------------
	; 착신전화번호에 보관함이 지정되어 있지 않음 경우          
	; ----------------------------------------
	same => n(GBMI_mac_fail), Set(ErrCode=GBMI_mac_fail)
	same => n, Playback(${wavDIR}/SBOX_018)				; 지금거신 전화번호는 서비스를 받을 수가 없습니다.
	                                       				; 시스템 관리자에게 문의하시기 바랍니다.
	same => n, Return(0)						; // 종료하기

	; ----------------------------------------
	; DB에 저장되어 있는 MAC 정보 있음        
	; ----------------------------------------
	same => n(GBMI_mac_succ), Set(ErrCode=GBMI_mac_succ)
	same => n, GotoIf($[${LEN(${m_MacAddr})}=0]?GBMI_mac_fail)	; // MAC 주소 없음으로 오류 처리
	same => n, Return(${m_MacAddr})


exten => h,1, Log(NOTICE,[${CALLER}] Get_BuMacInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; 물품 보관함 내의 소형,중형,대형 크기별로 설정되어 있는 갯수 검색               *
;   - sbox_get_box_style.php                                                     *
;   - input : (1) DAOU050NUMBER                                                  *
;   - output: (1) RESULT(1111=OK, 9999=NOK)                                      *
;             (2) m_S_TypeCount : 소형 갯수                                      *
;                 m_M_TypeCount : 중형 갯수                                      *
;                 m_L_TypeCount : 대형 갯수                                      *
;                                                                                *
; ********************************************************************************

[Get_BoxStyle]
exten => start,1,Noop(Get_BoxStyle from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})
	same => n, Set(RESULT=)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, AGI(${agiDIR}/sbox_get_box_style.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_get_box_style.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_S_TypeCount=[${m_S_TypeCount}] m_M_TypeCount=[${m_M_TypeCount}] m_L_TypeCount=[${m_L_TypeCount}])

	same => n, GotoIf($["${AGISTATUS}"="SUCCESS"]?:GBS_agi_fail)
	same => n, GotoIf($["${RESULT}"="1111"]?:GBS_agi_fail)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(GBS_agi_succ), Set(ErrCode=GBS_agi_succ)
	same => n, ExecIf($[${m_S_TypeCount}>1]?Set(m_S_TypeCount=1))
	same => n, ExecIf($[${m_M_TypeCount}>1]?Set(m_M_TypeCount=1))
	same => n, ExecIf($[${m_L_TypeCount}>1]?Set(m_L_TypeCount=1))
	same => n, Goto(GBS_CheckStyle)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(GBS_agi_fail), Set(ErrCode=GBS_agi_fail)
	same => n, Set(m_S_TypeCount=1)					; // 소형함 있음
	same => n, Set(m_M_TypeCount=1)					; // 중형함 있음
	same => n, Set(m_L_TypeCount=1)					; // 대형함 있음
	same => n, Goto(GBS_CheckStyle)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(GBS_CheckStyle), Set(ErrCode=GBS_CheckStyle)
	same => n, Set(m_BoxStyle=$[${m_S_TypeCount}+${m_M_TypeCount}+${m_L_TypeCount}])
	same => n, GotoIf($[${m_BoxStyle}>0]?GBS_nextStep)
	same => n, Playback(${wavDIR}/SBOX_018)				; 지금 거신 전화번호는 서비스를 받을 수가 없습니다.
	                                       				; 시스템 관리자에게 문의하시기 바랍니다.
	same => n, Return(0)	; // 종료하기

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(GBS_nextStep), Set(ErrCode=GBS_nextStep)
	same => n, Return(1)	; // 다음 단계


exten => h,1, Log(NOTICE,[${CALLER}] Get_BoxStyle/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()



; ********************************************************************************
; *                                                                              *
; * 보관함 열기 위한 하드웨어 문번호 정보 가져오기(DB에서 정의되어 있음)         *
; *  - input : (1) m_BoxNumber                                                   *
; *            (2) m_UserType                                                    *
; *  - output: (1) m_DoorContData                                                *
; *            (2) RESULT(1111=OK                                                *
; *                       2222=해당 LOCKNO에 대한 정보없음                       *
; *                       3333=비어있는 보관함이 아님)                           *
; *                                                                              *
; ********************************************************************************

[GetDoorContData]
exten => start,1,Noop(GetDoorContData from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})		; ErrCode
	same => n, Set(RESULT=)				; // RESULT 초기화
	same => n, Set(m_DoorContData=)			; // m_DoorContData 초기화

	; ----------------------------------------
	; 보관함 열기 위한 control Data 가져오기            
	; ----------------------------------------
	same => n, AGI(${agiDIR}/sbox_get_door_cont_data.php)
	same => n, Log(NOTICE, sbox_get_door_cont_data.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_BoxNumber=[${m_BoxNumber}] m_DoorContData=[${m_DoorContData}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?GDCD_0)
	same => n, GotoIf($["${RESULT}"="0000"]?GDCD_0)		; // AGI fail
	same => n, GotoIf($["${RESULT}"="1111"]?GDCD_1)		; // OK
	same => n, GotoIf($["${RESULT}"="2222"]?GDCD_2)		; // 해당 LOCKNO에 대한 정보없음
	same => n, GotoIf($["${RESULT}"="3333"]?GDCD_3)		; // 비어있는 보관함이 아님
	same => n, Goto(GDCD_9) 				; // not_define

	same => n(GDCD_0), Return(0000)		; // AGI fail
	same => n(GDCD_1), Return(1111)		; // OK 
	same => n(GDCD_2), Return(2222)		; // 해당 LOCKNO에 대한 정보없음
	same => n(GDCD_3), Return(3333)		; // 비어있는 보관함이 아님
	same => n(GDCD_9), Return(9999)		; // not_define

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/GetDoorContData/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()


; ********************************************************************************
; *                                                                              *
; * 보관함 문열기(AGI)                                                           *
; *                                                                              *
; ********************************************************************************

[open_box_door]
exten => start,1,Noop(open_box_door from ${ARG1},${ARG2})
	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode
	same => n, Set(LOCAL(m_Method)=${ARG2})			; Method

;	same => n, AGI(agi://218.232.94.161:8200,${m_Method},${m_MacAddr},${m_DoorContData})
	same => n, AGI(agi://box.baro.so:8200,${m_Method},${m_MacAddr},${m_DoorContData})
	same => n, Log(NOTICE, AGI://box.baro.so [${CALLER} -> ${DAOU050NUMBER}] : AGI=[${AGISTATUS}] METHOD=[${m_Method}] MAC=[${m_MacAddr}] BOX=[${m_BoxNumber}] DATA=[${m_DoorContData}])

	same => n, GotoIf($["${m_Method}"="ciderpay"]?OBD_rte)

	same => n, GoSub(read_Number,start,1(${m_BoxNumber},B))			; xx 번
	same => n, Playback(${wavDIR}/SBOX_017)					; 보관함 문을 열었습니다.

	same => n(OBD_rte), Return(0)

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/open_box_door/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()



; ********************************************************************************
; *                                                                              *
; * 보관함 문열기                                                                *
; *                                                                              *
; ********************************************************************************

[OpenBoxDoor]
exten => start,1,Noop(OpenBoxDoor from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode
	same => n, Set(LOCAL(UserType)=${ARG2})			; UserType
	same => n, Set(m_DoorContData=)				; // m_DoorContData 초기화

	; ----------------------------------------
	; 보관함 열기 위한 control Data 가져오기            
	; ----------------------------------------
	same => n, GoSub(GetDoorContData,start,1(pd_OpenBoxDoor))
	same => n, Set(RESULT=${GOSUB_RETVAL})

	same => n, GoSubIf($[${RESULT}=0000]?sbox_PlayErrMesg,start,1(DCD_agi_fail,SBOX_021,0))
	same => n, GotoIf($[${RESULT}=1111]?OBD_get_DCD_succ)	; // OK
	same => n, GotoIf($[${RESULT}=2222]?OBD_get_DCD_fail)	; // 해당 LOCKNO에 대한 정보없음
	same => n, GotoIf($[${RESULT}=3333]?OBD_get_DCD_fail)	; // 비어있는 보관함이 아님
	same => n, GoSub(sbox_PlayErrMesg,start,1(DCD_not_define,SBOX_022,0))

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(OBD_get_DCD_fail), Set(ErrCode=OBD_get_DCD_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(${ErrCode},SBOX_023,1))	; 서버로부터 사용 허가를 받지 못하여,
	                                                                 	; 서비스를 진행할 수 없습니다.
	same => n, Goto(sbox_main,sbox_Finish,1)

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(OBD_get_DCD_succ), Set(ErrCode=OBD_get_DCD_succ)
	same => n, GoSub(open_box_door,start,1(${ErrCode},open))		; xx 번 보관함 문을 열었습니다.

	same => n, GotoIf($[${UserType}=3]?OBD_history)				; // 장기사용자 기간중 문열기
	same => n, Return(0)

	; ----------------------------------------
	; 보관함 문개방 이력 정보 저장                       
	; ----------------------------------------
	same => n(OBD_history), Noop(ODB_history)
	same => n, AGI(${agiDIR}/sbox_open_ltu.php)
	same => n, Log(NOTICE, sbox_open_ltu.php [${CALLER}] : AGI=[${AGISTATUS}] m_BoxNumber=[${m_BoxNumber}] )
	same => n, Return(0)

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/OpenBoxDoor/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()



; ********************************************************************************
; *                                                                              *
; * 시스템 관리자에 의한 물품 보관함 개방                                        *
; *                                                                              *
; ********************************************************************************

[OpenBoxDoor_by_Admin]
exten => start,1,Noop(OpenBoxDoor_by_Admin from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode
	same => n, Set(LOCAL(UserType)=${ARG2})			; UserType
	same => n, Set(m_DoorContData=)				; // m_DoorContData 초기화

	; ----------------------------------------
	; 보관함 열기 위한 control Data 가져오기            
	; ----------------------------------------
	same => n, GoSub(GetDoorContData,start,1(pd_OpenBoDoor_by_Admin))
	same => n, Set(RESULT=${GOSUB_RETVAL})

	same => n, GotoIf($[${RESULT}=0000]?CBD_0000)	; // AGI_not_succ
	same => n, GotoIf($[${RESULT}=1111]?CBD_1111)	; // OK
	same => n, GotoIf($[${RESULT}=2222]?CBD_2222)	; // 해당 LOCKNO에 대한 정보없음
	same => n, GotoIf($[${RESULT}=3333]?CBD_3333)	; // 비어있는 보관함이 아님
	same => n, Goto(CBD_9999)

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(CBD_1111), Set(ErrCode=CBD_1111)
	same => n, GoSub(open_box_door,start,1(${ErrCode},open))	; xx 번 보관함 문을 열었습니다.
	same => n, Return(111)

	same => n(CBD_2222), Set(ErrCode=CBD_2222)
	same => n, Playback(${wavDIR}/SBOX_T03)			; 선택하신 보관함 정보가 없습니다.
	same => n, Return(2222)

	same => n(CBD_3333), Set(ErrCode=CBD_3333)
	same => n, Playback(${wavDIR}/SBOX_T04)			; 비어 있는 보관함이 아닙니다.
	same => n, Return(3333)

	same => n(CBD_9999), Set(ErrCode=CBD_9999)
	same => n, Playback(${wavDIR}/SBOX_T05)			; 알수 없는 원인으로 문을 열수 없습니다.
	same => n, Return(9999)

	same => n(CBD_0000), Set(ErrCode=CBD_0000)
	same => n, Playback(${wavDIR}/SBOX_T06)			; 서버와 연결이 되지 않았습니다.
	same => n, Return(9999)

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/OpenBoxDoor_by_Admin/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; 관리자에 의한 보관함 번호 선택                                                 *
;                                                                                *
; ********************************************************************************

[Get_OpenBoxNumber]
exten => start, 1, Noop(Get_OpenBoxNumber from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, AGI(${agiDIR}/sbox_check_admin.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_check_admin.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] )

	same => n, GotoIf($["${AGISTATUS}"="SUCCESS"]?GABN_AgiSucc)
	same => n, Playback(${wavDIR}/SBOX_T01)				; 서버 연결이 어렵습니다.
	                                       				; 서비스 관리자에게 확인하세요.
	same => n, Goto(GABN_1)						; // 종료

	same => n(GABN_AgiSucc), Set(ErrCode=GABN_AgiSucc)
	same => n, GotoIf($["${RESULT}"="1111"]?GABN_recvDgt)
	same => n, Playback(${wavDIR}/SBOX_T02)				; 관리자 전화번호가 아닙니다.
	                                       				; 서비스 관리자에게 확인하고 이용하세요.
	same => n, Goto(GABN_1)						; // 종료

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(GABN_recvDgt), Set(ErrCode=GABN_recvDgt)
	same => n, Read(m_BoxNumber,${wavDIR}/SBOX_T00,3,n,1,5)		; 보관함 번호를 입력하세요.
	                                                       		; 이전 단계로 이동은 별표입니다.

	same => n, GotoIf($[${LEN(${m_BoxNumber})}=0]?GABN_recvDgt)	; // 미입력
	same => n, GotoIf($["${m_BoxNumber:0:1}"="*"]?GABN_0)		; // 이전 메뉴로 이동
	same => n, GotoIf($["${m_BoxNumber:1:1}"="*"]?GABN_0)		; // 이전 메뉴로 이동
	same => n, GotoIf($["${m_BoxNumber:2:1}"="*"]?GABN_0)		; // 이전 메뉴로 이동

	same => n, Set(m_UserType=4)			; // 1=일반고객, 2=택배기사 문열기, 3=장기사용고객 4=관리자 모드
	same => n, GoSub(OpenBoxDoor_by_Admin,start,1(${ErrCode},4))	; xx번 보관함 문을 열었습니다.
	same => n, Goto(GABN_recvDgt)					; // 종료


	same => n(GABN_0), Return(0)					; // 이전단계
	same => n(GABN_1), Return(1)					; // 종료

exten => h,1, Log(NOTICE,[${CALLER} Get_OpenBoxNumber/Hangup] ERR=[${ErrorCode} ${ErrCode} )
	same => n, Hangup()



; ********************************************************************************
; *                                                                              *
; * 공통 데이타 초기화                                                           *
; *                                                                              *
; ********************************************************************************

[init_Data]

exten => start,1,Noop(init_Data from ${ARG1})

	same => n, Set(RESULT=)		; // RESULT 초기화
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(countAUTH=0)

	same => n, Return(0)





; ********************************************************************************
; *                                                                              *
; * 숫자 읽기                                                                    *
; *      - 범위 :  0 ~ 99,999,999                                                *
; *                                                                              *
; ********************************************************************************

[read_Number]

exten => start,1,Noop(read_Number)
	same => n,Set(LOCAL(Count)=${ARG1})
	same => n,Set(LOCAL(TYxx)=${ARG2})
	same => n,Set(T1=${TYxx})

	; ----------------------------------------
	; 기본 음원 파일 구성
	; ----------------------------------------
	same => n, Set(CM=${SPRINTF(${wavDIR}/SBOX_DD)})

	same => n, Set(C1=${SPRINTF(${wavDIR}/SBOX_DD)})
	same => n, Set(C2=${SPRINTF(${wavDIR}/SBOX_DD)})
	same => n, Set(C3=${SPRINTF(${wavDIR}/SBOX_DD)})
	same => n, Set(C4=${SPRINTF(${wavDIR}/SBOX_DD)})


	; ----------------------------------------
	; 숫자 단위별로 구분
	; ----------------------------------------
	same => n, Set(Mx000=${MATH($[${Count}/10000000]%10,int)})	; // 천만단위
	same => n, Set(M0x00=${MATH($[${Count}/1000000]%10,int)})	; // 백만단위
	same => n, Set(M00x0=${MATH($[${Count}/100000]%10,int)})	; // 십만단위
	same => n, Set(M000x=${MATH($[${Count}/10000]%10,int)})		; // 만단위

	same => n, Set(zx000=${MATH($[${Count}/1000]%10,int)})		; // 천단위
	same => n, Set(z0x00=${MATH($[${Count}/100]%10,int)})		; // 백단위
	same => n, Set(z00x0=${MATH($[${Count}/10]%10,int)})		; // 십단위
	same => n, Set(z000x=${MATH(${Count}%10,int)})			; // 단단위

	same => n, GotoIf($[${Count} < 10000]?Cxxxx:Mxxxx)

	; ----------------------------------------
	; 만단위 이상                                   
	; ----------------------------------------
	same => n(Mxxxx), Noop(Mxxxx)

	same => n, Set(M1=${SPRINTF(${wavDIR}/SBOX_DD)})		; // 묵음
	same => n, Set(M2=${SPRINTF(${wavDIR}/SBOX_DD)})		; // 묵음
	same => n, Set(M3=${SPRINTF(${wavDIR}/SBOX_DD)})		; // 묵음
	same => n, Set(M4=${SPRINTF(${wavDIR}/SBOX_D10T)})		; // "만"

	same => n, ExecIf($[${Mx000} = 0]?Noop():Set(M1=${SPRINTF(${wavDIR}/SBOX_D%d000,${Mx000})}))
	same => n, ExecIf($[${M0x00} = 0]?Noop():Set(M2=${SPRINTF(${wavDIR}/SBOX_D%d00,${M0x00})}))
	same => n, ExecIf($[${M00x0} = 0]?Noop():Set(M3=${SPRINTF(${wavDIR}/SBOX_D%d0,${M00x0})}))
	same => n, ExecIf($[${M000x} = 0]?Noop():Set(M4=${SPRINTF(${wavDIR}/SBOX_D%d0000,${M000x})}))

	same => n, Set(CM=${SPRINTF(%s&%s&%s&%s,${M1},${M2},${M3},${M4})})


	; ----------------------------------------
	; 천단위 이하                                   
	; ----------------------------------------
	same => n(Cxxxx), Noop(Cxxxx)

	same => n, ExecIf($[${Count} = 0]?Set(C4=${SPRINTF(${wavDIR}/SBOX_D0)}))

	same => n, ExecIf($[${zx000} = 0]?Noop():Set(C1=${SPRINTF(${wavDIR}/SBOX_D%d000,${zx000})}))
	same => n, ExecIf($[${z0x00} = 0]?Noop():Set(C2=${SPRINTF(${wavDIR}/SBOX_D%d00,${z0x00})}))
	same => n, ExecIf($[${z00x0} = 0]?Noop():Set(C3=${SPRINTF(${wavDIR}/SBOX_D%d0,${z00x0})}))
	same => n, ExecIf($[${z000x} = 0]?Noop():Set(C4=${SPRINTF(${wavDIR}/SBOX_D%d,${z000x})}))

	same => n, Set(CC=${SPRINTF(%s&%s&%s&%s,${C1},${C2},${C3},${C4})})


	; ----------------------------------------
	; 전체 음원 구성                                 
	; ----------------------------------------
	same => n, Set(CN=${SPRINTF(%s&%s,${CM},${CC})})


	; ----------------------------------------
	;                                          
	; ----------------------------------------
	same => n, Playback(${CN})

	same => n, ExecIf($[${T1} = B]?Playback(${wavDIR}/SBOX_BEON))
	same => n, ExecIf($[${T1} = G]?Playback(${wavDIR}/SBOX_GAE))
	same => n, ExecIf($[${T1} = W]?Playback(${wavDIR}/SBOX_WON))
	same => n, ExecIf($[${T1} = M]?Playback(${wavDIR}/SBOX_MONTH))
	same => n, ExecIf($[${T1} = D]?Playback(${wavDIR}/SBOX_DAY))
	same => n, ExecIf($[${T1} = m]?Playback(${wavDIR}/SBOX_MM))
	same => n, ExecIf($[${T1} = P]?Playback(${wavDIR}/SBOX_MYEONG))

	same => n, Return(0)





; ********************************************************************************
; *                                                                              *
; * 갯수 세기                                                                    *
; *      - 범위 :  0 ~ 99,999,999                                                *
; *                                                                              *
; ********************************************************************************

[read_Count]

exten => start,1,Noop(read_Count)
	same => n,Set(LOCAL(Count)=${ARG1})

	; ----------------------------------------
	; 기본 음원 파일 구성
	; ----------------------------------------
	same => n, Set(CM=${SPRINTF(${wavDIR}/SBOX_DD)})

	same => n, Set(C1=${SPRINTF(${wavDIR}/SBOX_DD)})
	same => n, Set(C2=${SPRINTF(${wavDIR}/SBOX_DD)})
	same => n, Set(C3=${SPRINTF(${wavDIR}/SBOX_DD)})
	same => n, Set(C4=${SPRINTF(${wavDIR}/SBOX_GAE)})


	; ----------------------------------------
	; 숫자 단위별로 구분
	; ----------------------------------------
	same => n, Set(Mx000=${MATH($[${Count}/10000000]%10,int)})	; // 천만단위
	same => n, Set(M0x00=${MATH($[${Count}/1000000]%10,int)})	; // 백만단위
	same => n, Set(M00x0=${MATH($[${Count}/100000]%10,int)})	; // 십만단위
	same => n, Set(M000x=${MATH($[${Count}/10000]%10,int)})		; // 만단위

	same => n, Set(zx000=${MATH($[${Count}/1000]%10,int)})		; // 천단위
	same => n, Set(z0x00=${MATH($[${Count}/100]%10,int)})		; // 백단위
	same => n, Set(z00x0=${MATH($[${Count}/10]%10,int)})		; // 십단위
	same => n, Set(z000x=${MATH(${Count}%10,int)})			; // 단단위

	same => n, Set(z00xx=${MATH(${Count}%100,int)})		; // 십단위 + 단단위

	same => n, GotoIf($[${Count} < 10000]?Cxxxx:Mxxxx)

	; ----------------------------------------
	; 만단위 이상                                   
	; ----------------------------------------
	same => n(Mxxxx), Noop(Mxxxx)

	same => n, Set(M1=${SPRINTF(${wavDIR}/SBOX_DD)})
	same => n, Set(M2=${SPRINTF(${wavDIR}/SBOX_DD)})
	same => n, Set(M3=${SPRINTF(${wavDIR}/SBOX_DD)})
	same => n, Set(M4=${SPRINTF(${wavDIR}/SBOX_D10000)})

	same => n, ExecIf($[${Mx000} = 0]?Noop():Set(M1=${SPRINTF(${wavDIR}/SBOX_D%d000,${Mx000})}))
	same => n, ExecIf($[${M0x00} = 0]?Noop():Set(M2=${SPRINTF(${wavDIR}/SBOX_D%d00,${M0x00})}))
	same => n, ExecIf($[${M00x0} = 0]?Noop():Set(M3=${SPRINTF(${wavDIR}/SBOX_D%d0,${M00x0})}))
	same => n, ExecIf($[${M000x} = 0]?Noop():Set(M4=${SPRINTF(${wavDIR}/SBOX_D%d0000,${M000x})}))

	same => n, Set(CM=${SPRINTF(%s&%s&%s&%s,${M1},${M2},${M3},${M4})})


	; ----------------------------------------
	; 천단위 이하                                   
	; ----------------------------------------
	same => n(Cxxxx), Noop(Cxxxx)

	same => n, ExecIf($[${Count} = 0]?Set(C4=${SPRINTF(${wavDIR}/SBOX_D0)}))

	same => n, ExecIf($[${zx000} = 0]?Noop():Set(C1=${SPRINTF(${wavDIR}/SBOX_D%d000,${zx000})}))
	same => n, ExecIf($[${z0x00} = 0]?Noop():Set(C2=${SPRINTF(${wavDIR}/SBOX_D%d00,${z0x00})}))
	same => n, ExecIf($[${z00x0} = 0]?Noop():Set(C3=${SPRINTF(${wavDIR}/SBOX_D%d0,${z00x0})}))
	same => n, ExecIf($[${z000x} = 0]?Noop():Set(C4=${SPRINTF(${wavDIR}/SBOX_G%d,${z000x})}))

	same => n, ExecIf($[${z00x0} = 1]?Set(C3=${SPRINTF(${wavDIR}/SBOX_GT)}))	; // 열

	same => n, ExecIf($[${z00xx} = 10]?Set(C3=${SPRINTF(${wavDIR}/SBOX_G10)}))	; // 열개
	same => n, ExecIf($[${z00xx} = 10]?Set(C4=${SPRINTF(${wavDIR}/SBOX_DD)}))	; // 묵음

	same => n, Set(CC=${SPRINTF(%s&%s&%s&%s,${C1},${C2},${C3},${C4})})


	; ----------------------------------------
	;                                          
	; ----------------------------------------
	same => n, Set(CN=${SPRINTF(%s&%s,${CM},${CC})})

	same => n, Playback(${CN})


	same => n, Return(0)





; ********************************************************************************
; *                                                                              *
; * 파라미터에 의한 음원 파일 구동                                               *
; *                                                                              *
; ********************************************************************************

[play_Count]

exten => start,1,Noop(play_Count from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; // ErrCode
	same => n, Set(LOCAL(YourCount)=${ARG2})			; // 사용중인 갯수
	same => n, Set(LOCAL(PlayType)=${ARG3})				; // 음원 타입

	same => n, GotoIf($[${PlayType}=1]?PYC_1)
	same => n, GotoIf($[${PlayType}=2]?PYC_2)
	same => n, GotoIf($[${PlayType}=3]?PYC_3)
	same => n, Return(0)

	same => n(PYC_1), Set(ErrCode=PYC_1)
	same => n, Playback(${wavDIR}/SBOX_012)				; 고객님께서 보관중인 물품이
	same => n, GoSub(read_Count,start,1(${YourCount},G))		; xx 개
	same => n, Playback(${wavDIR}/SBOX_C06)				; 있습니다.
	same => n, Return(1)

	same => n(PYC_2), Set(ErrCode=PYC_2)
	same => n, Playback(${wavDIR}/SBOX_058)				; 장기 사용 연장을 해야 하는 보관함은
	same => n, GoSub(read_Number,start,1(${YourCount},B))		; xx 번
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.
	same => n, Return(2)

	same => n(PYC_3), Set(ErrCode=PYC_3)
	same => n, Playback(${wavDIR}/SBOX_073)				; 장기 사용을 해지하려고 하는 보관함은
	same => n, GoSub(read_Number,start,1(${YourCount},B))		; xx 번
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.
	same => n, Return(3)

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/play_Count/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; * 보관함 크기 선택하기(3-1,5-3,4-5-1)                                          *
; *      - 1번 선택 = 소형                                                       *
; *      - 2번 선택 = 중형                                                       *
; *      - 3번 선택 = 대형                                                       *
; *      - *번 선택 = 이전 단계                                                  *
; *      - 그외번호 = 3회 재시도후 서비스 종료                                   *
; *      - 미선택   = 3회 재시도후 서비스 종료                                   *
; *                                                                              *
; ********************************************************************************

[sbox_GetBoxType]

exten => start,1,Noop(sbox_GetBoxType from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	; ----------------------------------------
	; 보관함 선택 및 번호 수집                
	; ----------------------------------------
	same => n(GBS_recvDgt), Set(ErrCode=GBS_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/SBOX_006,1,n,1,5)		; 보관함 크기를 선택하세요.
	                                                  		; 소형은 1번.
	                                                  		; 중형은 2번.
	                                                  		; 대형은 3번.
	                                                  		; 이전 단계는 별표.
	                                                  		; 다시 듣기는 0번을 누르세요.

	; ----------------------------------------
	; 선택 번호 기능 분기                             
	; ----------------------------------------
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?GBS_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="0"]?GBS_recvDgt)		; // 메뉴 다시 듣기
	same => n, GotoIf($["${SELNUM}"="1"]?GBS_1)			; // 소형 선택
	same => n, GotoIf($["${SELNUM}"="2"]?GBS_2)			; // 중형 선택
	same => n, GotoIf($["${SELNUM}"="3"]?GBS_3)			; // 대형 선택
	same => n, GotoIf($["${SELNUM}"="*"]?GBS_4)			; // 이전 단계


	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(GBS_wrong), Set(ErrCode=GBS_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(GBS_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(GBS_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(GBS_not_enter), Set(ErrCode=GBS_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(GBS_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(GBS_recvDgt)

	; ----------------------------------------
	;                                  
	; ----------------------------------------
	same => n(GBS_1), Set(m_BoxType=1)	; 1번 선택
	same => n, Goto(GBS_get_empty_locker)

	same => n(GBS_2), Set(m_BoxType=2)	; 2번 선택
	same => n, Goto(GBS_get_empty_locker)

	same => n(GBS_3), Set(m_BoxType=3)	; 3번 선택
	same => n, Goto(GBS_get_empty_locker)

	same => n(GBS_4), Return(4444)		; *번 선택 : 이전 단계로 이동

	; ----------------------------------------
	; 선택한 보관함 크기의 비어 있는 함 갯수 검색
	; ----------------------------------------
	same => n(GBS_get_empty_locker), Noop(GBS_get_empty_locker)
	same => n, GoSub(sbox_GetEmptyLocker,start,1(1,${ErrCode}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, Return(${RESULT})


exten => h,1, Noop(sbox_GetBoxType/Hangup)
	same => n, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/sbox_GetBoxType/sbox_Hangup] ERR=${ErrCode}])
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; * 보관함 번호 선택하기                                                         *
; *      - 1 번 : 사용 확정                                                      *
; *      - 2 번 : 보관함 번호 변경                                               *
; *      - 3 번 : 보관함 크기 다시 선택                                          *
; *      - 0 번 : 다시 듣기                                                      *
; *      - 그외 : 3회 재시도후 서비스 종료                                       *
; *      - 미선택 : 3회 재시도후 서비스 종료                                     *
; *                                                                              *
; ********************************************************************************

[sbox_SelBoxNumber]

exten => start,1,Noop(sbox_SelBoxNumber from ${ARG1},${ARG2})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; // ErrCode
	same => n, Set(LOCAL(MonthFee)=${ARG2})				; // MonthFee : 1=물품보관함인 경우임
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(countLOOP=1)

	same => n, Set(m_BoxNumber=${LN0})

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SBN_recvDgt), Set(ErrCode=SBN_recvDgt)

	same => n, Playback(${wavDIR}/SBOX_008)				; 사용 가능한 보관함은
	same => n, GoSub(read_Number,start,1(${m_BoxNumber},B))		; xx 번

	same => n, GotoIf($[${MonthFee}=1]?SBN_skip_monthFee)		;
	same => n, Playback(${wavDIR}/SBOX_C23)				; 이며,
	same => n, Playback(${wavDIR}/SBOX_233)				; 1개월 사용료는
	same => n, GoSub(read_Number,start,1(${MonthFee},W))		; xxxx 원

	same => n(SBN_skip_monthFee), Playback(${wavDIR}/SBOX_C05)	; 입니다.

	same => n, Read(SELNUM,${wavDIR}/SBOX_009,1,n,1,5)		; 이 보관함 사용은 1번. 
	                                                     		; 다른 보관함으로 변경은 2번.
	                                                     		; 보관함 크기 변경은 3번.
	                                                     		; 이전 단계는 별표.
	                                                     		; 다시 듣기는 0번을 누르세요.

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?SBN_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="0"]?SBN_recvDgt)		; // 다시 듣기
	same => n, GotoIf($["${SELNUM}"="1"]?SBN_1) 			; // 현재 보관함 사용 확정
	same => n, GotoIf($["${SELNUM}"="2"]?SBN_nextBox)		; // 다른 보관함으로 변경
	same => n, GotoIf($["${SELNUM}"="3"]?SBN_chgSize)		; // 보관함 크기 변경
	same => n, GotoIf($["${SELNUM}"="*"]?SBN_4)			; // 이전 단계 이동


	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(SBN_wrong), Set(ErrCode=SBN_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(SBN_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(SBN_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(SBN_not_enter), Set(ErrCode=SBN_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(SBN_wrong,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(SBN_recvDgt)


	; ----------------------------------------
	; 다른 보관함으로 변경                    
	; ----------------------------------------
	same => n(SBN_nextBox), Set(ErrorCode=SBN_nextBox)
	same => n, GoSub(sbox_GetNextBox,start,1(${m_EmptyCount},${ErrorCode}))
	same => n, Goto(SBN_recvDgt)


	; ----------------------------------------
	; 단일 크기로 구성하는 경우에는 보관함 크기 선택은 입력정보 오류로 변경
	; ----------------------------------------
	same => n(SBN_chgSize), Set(ErrorCode=SBN_chgSize)
	same => n, GotoIf($[${m_BoxStyle}!=1]?SBN_3)
	same => n, GoSub(sbox_PlayErrMesg,start,1(SBN_wrong,SBOX_027,5))	; 동일 크기로 구성되어 있어서,
	                                                                	; 보관함 크기를 변경할 수는 없습니다.
	same => n, Goto(SBN_recvDgt)


	same => n(SBN_1), Return(1)
	same => n(SBN_3), Return(3)
	same => n(SBN_4), Return(4)
	same => n(SBN_0), Return(0)

exten => h,1, Noop(sbox_SelBoxNumber/Hangup)
	same => n, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/sbox_SelBoxNumber/sbox_Hangup] ERR=${ErrCode}])
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; * 다음 보관함 번호 가져오기                                                    *
; *                                                                              *
; ********************************************************************************

[sbox_GetNextBox]

exten => start,1,Noop(sbox_GetNextBox from ${ARG2})

	same => n, Set(LOCAL(MaxCount)=${ARG1})
	same => n, Set(countLOOP=$[${countLOOP}+1])

	same => n, ExecIf($[${countLOOP}>20]?Set(countLOOP=1))
	same => n, ExecIf($[${countLOOP}>${MaxCount}]?Set(countLOOP=1))

	same => n, ExecIf($[${countLOOP} = 1]?Set(m_BoxNumber=${LN0}))
	same => n, ExecIf($[${countLOOP} = 2]?Set(m_BoxNumber=${LN1}))
	same => n, ExecIf($[${countLOOP} = 3]?Set(m_BoxNumber=${LN2}))
	same => n, ExecIf($[${countLOOP} = 4]?Set(m_BoxNumber=${LN3}))
	same => n, ExecIf($[${countLOOP} = 5]?Set(m_BoxNumber=${LN4}))
	same => n, ExecIf($[${countLOOP} = 6]?Set(m_BoxNumber=${LN5}))
	same => n, ExecIf($[${countLOOP} = 7]?Set(m_BoxNumber=${LN6}))
	same => n, ExecIf($[${countLOOP} = 8]?Set(m_BoxNumber=${LN7}))
	same => n, ExecIf($[${countLOOP} = 9]?Set(m_BoxNumber=${LN8}))
	same => n, ExecIf($[${countLOOP} = 10]?Set(m_BoxNumber=${LN9}))

	same => n, ExecIf($[${countLOOP} = 11]?Set(m_BoxNumber=${LN10}))
	same => n, ExecIf($[${countLOOP} = 12]?Set(m_BoxNumber=${LN11}))
	same => n, ExecIf($[${countLOOP} = 13]?Set(m_BoxNumber=${LN12}))
	same => n, ExecIf($[${countLOOP} = 14]?Set(m_BoxNumber=${LN13}))
	same => n, ExecIf($[${countLOOP} = 15]?Set(m_BoxNumber=${LN14}))
	same => n, ExecIf($[${countLOOP} = 16]?Set(m_BoxNumber=${LN15}))
	same => n, ExecIf($[${countLOOP} = 17]?Set(m_BoxNumber=${LN16}))
	same => n, ExecIf($[${countLOOP} = 18]?Set(m_BoxNumber=${LN17}))
	same => n, ExecIf($[${countLOOP} = 19]?Set(m_BoxNumber=${LN18}))
	same => n, ExecIf($[${countLOOP} = 10]?Set(m_BoxNumber=${LN19}))

	same => n, Return(0)





; ********************************************************************************
; *                                                                              *
; * 에라 메세지 음원 파일 동작                                                   *
; *                                                                              *
; ********************************************************************************

[sbox_PlayErrMesg]

exten => start,1,Noop(sbox_PlayErrMesg from ${ARG1})
	same => n, Set(LOCAL(ErrCode)=${ARG1})	; ErrorCode
	same => n, Set(LOCAL(FN)=${ARG2})	; 음원 파일 이름
	same => n, Set(LOCAL(EM)=${ARG3})	; 0/1=최종 멘트(0=없음,1=있음)  --> 음원 플레이후 서비스 종료
	                                 	; 2=버튼 잘못 누름              --> 에라 횟수 이상이면 서비스 종료
	                                 	; 3=버튼 누르지 않음            --> 에라 횟수 이상이면 서비스 종료
	                                 	; 4=인증 오류                   --> 에라 횟수 이상이면 서비스 종료
	                                 	; 5=음원 동작                   --> 음원 플레이후 복귀


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GotoIf($[${EM}==0]?SPEM_endSvc)
	same => n, GotoIf($[${EM}==1]?SPEM_endSvc)
	same => n, GotoIf($[${EM}==2]?SPEM_ErrWrong)
	same => n, GotoIf($[${EM}==3]?SPEM_ErrNoEnt)
	same => n, GotoIf($[${EM}==4]?SPEM_ErrAuth)
	same => n, GotoIf($[${EM}==5]?SPEM_retSvc)
	same => n, Hangup()

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SPEM_ErrWrong), Set(ErrCode=SPEM_ErrWrong)
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 6]?:SPEM_GoodBye)
	same => n, Playback(${wavDIR}/${FN})
	same => n, Return(0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SPEM_ErrNoEnt), Set(ErrCode=SPEM_ErrNoEnt)
	same => n, Set(countENTER=$[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?:SPEM_GoodBye)
	same => n, Playback(${wavDIR}/${FN})
	same => n, Return(0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SPEM_ErrAuth), Set(ErrCode=SPEM_ErrAuth)
	same => n, Set(countAUTH=$[${countAUTH}+1])
	same => n, GotoIF($[${countAUTH} < 3]?:SPEM_GoodBye)
	same => n, Playback(${wavDIR}/${FN})
	same => n, Return(0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SPEM_retSvc), Noop(ErrCode=SPEM_retSvc)
	same => n, Playback(${wavDIR}/${FN})
	same => n, Return(0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SPEM_endSvc), Noop(ErrCode=SPEM_endSvc)
	same => n, Playback(${wavDIR}/${FN})
	same => n, GotoIf($[${EM}==1]?SPEM_GoodBye)
	same => n, Hangup()

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SPEM_GoodBye), Noop(ErrCode=SPEM_GoodBye)
	same => n, Playback(${wavDIR}/SBOX_C04)			; 이용해 주셔서 감사합니다.
	same => n, Hangup()


exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/sbox_PlayErrMesg/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; * 보관함 전체에 대한 비어있는 보관함 갯수 확인 (3-1, 4-5)                      *
; *  - 보관하기 위해 사용 가능한 보관함이 있는지 여부 확인                       *
; *  - 3-1, 4-5 단계에서 호출                                                    *
; *  - sbox_check_empty_locker.php                                               *
; *  - input : 없음                                                              *
; *  - output: (1) RESULT(1111=비어있는 보관함 있음                              *
; *                       2222=비어있는 보관함 없음                              *
; *                       3333=미결재 정보 있음)                                 *
; *                                                                              *
; ********************************************************************************

[check_EmptyLocker]

exten => start,1,Noop(check_EmptyLocker from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})		; ErrCode

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, AGI(${agiDIR}/sbox_check_empty_locker.php)

	same => n, Log(NOTICE, sbox_check_empty_locker.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] )

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(CEL_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?CEL_GetBoxSize)		; // 비어 있는 보관함 있음 -> 보관함 크기 선택
	same => n, GotoIf($["${RESULT}"="2222"]?CEL_not_empty)		; // 비어 있는 보관함 없음 
	same => n, GotoIf($["${RESULT}"="3333"]?CEL_unpaid)		; // 미결재 정보 있음
	same => n, GoSub(sbox_PlayErrMesg,start,1(CEL_not_define,SBOX_022,0))

	; ----------------------------------------
	; 미결재 정보 있음                        
	; ----------------------------------------
	same => n(CEL_unpaid), Set(ErrCode=CEL_unpaid)
	same => n, Playback(${wavDIR}/SBOX_019)			; 대기중인 결재 정보가 있습니다. 결재후 이용해 주세요.
	same => n, Goto(sbox_main,sbox_GoodBye,1)

	; ----------------------------------------
	; 비어 있는 보관함 없음                   
	; ----------------------------------------
	same => n(CEL_not_empty), Set(ErrCode=CEL_not_empty)
	same => n, Playback(${wavDIR}/SBOX_004)			; 지금은 비어 있는 보관함이 없습니다. 다음에 이용해 주세요.
	same => n, Goto(sbox_main,sbox_GoodBye,1)

	; ----------------------------------------
	; 비이 있는 보관함 있음               
	; ----------------------------------------
	same => n(CEL_GetBoxSize), Return(1111)


exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/check_EmptyLocker/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; * 선택한 보관함 크기별로 비어있는 보관함 갯수 확인                             *
; *  - 3-1  5-3  4-5-5                                                           *
; *  - 고객이 선택한 박스 타입에 사용 가능한 보관함이 있는지 확인                *
; *  - sbox_get_empty_locker.php                                                 *
; *  - input : (1) m_BoxType(1=소형,2=중형,3=대형,4=전부)                        *
; *  - output: (1) RESULT(1111=OK, 2222=NOK)                                     *
; *            (2) m_EmptyCount : 비어 있는 보관함 갯수, 0 ~ 20                  *
; *            (3) LN0,LN1, ..... LN19, LN20 : 비어있는 보관함 번호              *
; *                                                                              *
; ********************************************************************************

[sbox_GetEmptyLocker]

exten => start,1,Noop(sbox_GetEmptyLocker from ${ARG1} ${ARG2})

	same => n, Set(LOCAL(BoxStyle)=${ARG1})	; 1=단일 타입, 2=복합 타입
	same => n, Set(LOCAL(ErrCode)=${ARG2})
	same => n, Set(m_EmptyCount=)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, AGI(${agiDIR}/sbox_get_empty_locker.php)

	same => n, Log(NOTICE, sbox_get_empty_locker.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_EmptyCount=[${m_EmptyCount}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(GEL_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?GEL_many_empty)		; // 비어 있는 보관함 있음
	same => n, GotoIf($["${RESULT}"="2222"]?GEL_none_empty)		; // 비어 있는 보관함 없음
	same => n, GoSub(sbox_PlayErrMesg,start,1(S312_not_define,SBOX_022,0))

	; ----------------------------------------
	; 사용 가능한 보관함 갯수가 0 인 경우     
	; ----------------------------------------
	same => n(GEL_not_using), Set(Err=GEL_not_using)
	same => n, Playback(${wavDIR}/SBOX_004)			; 지금은 비어 있는 보관함이 없습니다. 다음에 이용해 주세요.
	same => n, Goto(sbox_main,sbox_GoodBye,1)

	; ----------------------------------------
	; 비어 있는 보관함 없음                   
	; ----------------------------------------
	same => n(GEL_none_empty), Set(Err=GEL_none_empty)
	same => n, GotoIf($[${BoxStyle}=2]?GEL_not_using)
	same => n, Playback(${wavDIR}/SBOX_007)			; 선택하신 타입에는 비어 있는 보관함이 없습니다.
	                                       			; 다른 타입을 선택하세요.
	same => n, Return(2222)

	; ----------------------------------------
	; 비어 있는 보관함 있음                   
	; ----------------------------------------
	same => n(GEL_many_empty), Set(ErrCode=GEL_many_empty)
	same => n, GotoIf($[${LEN(${m_EmptyCount})}=0]?GEL_not_using)	; // 갯수 정보 미 수신시
	same => n, GotoIf($[${m_EmptyCount}=0]?GEL_none_empty)		; // 갯수가 0 인 경우
	same => n, ExecIf($[${m_EmptyCount}>20]?Set(m_EmptyCount=20))	; // 20초과시 20으로 설정
	same => n, Return(1111)


exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/sbox_GetEmptyLocker/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; *                                                                              *
; *                                                                              *
; ********************************************************************************

[get_YourBoxNumber]

exten => start,1,Noop(get_YourBoxNumber from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})					; ErrCode

	same => n(CBN_rcvDgt), Set(ErrCode=CBN_rcvDgt)

	same => n, ExecIf($[${m_UsingCount} = 1]?Set(F1=13):Set(F1=14))
	same => n, Set(FN=${SPRINTF(${wavDIR}/SBOX_0%d,${F1})})

	same => n, Playback(${wavDIR}/SBOX_C11)				; 보관함.
	same => n, GoSub(read_Number,start,1(${m_BoxNumber},B));	; xx 번
	same => n, Read(SELNUM,${FN},1,n,1,5)				; 에 있는 물품을 찾으시겠습니까? 
	                                                  		; 찾기는 1번.
	                                                  		; 다른 보관함의 물품 찾기는 2번. 
	                                                  		; 이전 단계는 별표.
	                                                  		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?CBN_not_enter)		; // 미입력

	same => n, GotoIf($[${m_UsingCount} > 1]?CBN_chkDgt)
	same => n, ExecIf($[${SELNUM}=2]?Set(SELNUM=4))			; // 물품 갯수가 1인경우 입력번호가 2이면 4로 설정

	same => n(CBN_chkDgt), Set(ErrCode=CBN_chkDgt)

	same => n, GotoIf($["${SELNUM}"="0"]?CBN_rcvDgt)		; // 다시 듣기
	same => n, GotoIf($["${SELNUM}"="1"]?CBN_1)			; // 찾기(다음 단계) --> 4-2단계로 이동
	same => n, GotoIf($["${SELNUM}"="2"]?CBN_nextBox)		; // 다른 보관함
	same => n, GotoIf($["${SELNUM}"="*"]?CBN_2)			; // 이전 단계 --> 2-1 단계로 이동

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(CBN_wrong), Set(ErrCode=CBN_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(CBN_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(CBN_rcvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(CBN_not_enter), Set(ErrCode=CBN_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(CBN_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(CBN_rcvDgt)

	; ----------------------------------------
	; 다음 보관함 번호로 선택                    
	; ----------------------------------------
	same => n(CBN_nextBox), Set(ErrCode=CBN_nextBox)
	same => n, GoSub(sbox_GetNextBox,start,1(${m_UsingCount},${ErrorCode}))	; // 다음 보관함 번호 가져오기
	same => n, Goto(CBN_rcvDgt)

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(CBN_1), Return(1)	; // 찾기
	same => n(CBN_2), Return(2)	; // 이전 단계

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/get_YourBoxNumber/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; * 5-4 5-7                                                                      *
; *                                                                              *
; ********************************************************************************

[check_ExpireUsing]

exten => start,1,Noop(check_ExpireUsing from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})		; ErrCode

	same => n, Set(LOCAL(m_box)=${ARG2})		; box number
	same => n, Set(LOCAL(m_mon)=${ARG3})		; month
	same => n, Set(LOCAL(m_day)=${ARG4})		; day
	same => n, Set(LOCAL(m_fee)=${ARG5})		; add fee
	same => n, Set(LOCAL(m_req)=${ARG6})		; request type(1=장시사용기간만료안내(5-4), 2=장기사용해지(7-1)

	same => n(CEU_playInfo), Set(ErrCode=CEU_playInfo)

	same => n, GoSub(read_Number,start,1(${m_box},B))		; xx 번
	same => n, Playback(${wavDIR}/SBOX_063)				; 보관함의
	same => n, Playback(${wavDIR}/SBOX_064)				; 장기 사용 기간이 
	same => n, GoSub(read_Number,start,1(${m_mon},M))		; xx 월
	same => n, GoSub(read_Number,start,1(${m_day},D))		; xx 일
	same => n, Playback(${wavDIR}/SBOX_065)				; 로 만료되었으며
	same => n, Playback(${wavDIR}/SBOX_C18)				; 추가 요금
	same => n, GoSub(read_Number,start,1(${m_fee},KW))		; xxxx
	same => n, Playback(${wavDIR}/SBOX_C19)				; 원이 발생하였습니다.

	same => n(CEU_rcvDgt), Set(ErrCode=CEU_rcvDgt)

	same => n, Set(C1=${SPRINTF(${wavDIR}/SBOX_067)})		; 추가 요금을 결제하면,
	                                       				; 해당 보관함의 장기 사용 등록은 자동 해지됩니다.

	same => n, GotoIf($[${m_req}=1]?CEU_recvDgt_1)			; // 장기 사용중 기간 만료로 고객이 해지
	same => n, GotoIf($[${m_req}=2]?CEU_recvDgt_2)			; // 고객이 장기 사용 해지 신청을 하는 경우

	; ----------------------------------------
	; 장기 사용 연장 메뉴                      
	; ----------------------------------------
	same => n(CEU_recvDgt_1), Set(ErrCode=CEU_recvDgt_1)

	same => n, Read(SELNUM,${C1}&${wavDIR}/SBOX_068,1,n,1,5)	; 결제는 1번.
	                                                  		; 이전 단계는 별표.
	                                                  		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?CEU_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="0"]?CEU_playInfo)		; // 다시 듣기
	same => n, GotoIf($["${SELNUM}"="1"]?CEU_1)			; // 추가 요금 지불
	same => n, GotoIf($["${SELNUM}"="*"]?CEU_0)			; // 이전 단계
	same => n, Goto(CEU_wrong)

	; ----------------------------------------
	; 장기 사용 해지 메뉴                      
	; ----------------------------------------
	same => n(CEU_recvDgt_2), Set(ErrCode=CEU_recvDgt_2)
	same => n, Read(SELNUM,${C1}&${wavDIR}/SBOX_071,1,n,1,5)	; 장기 사용 해지는 1번.
	                                                  		; 다른 보관함 장기 사용 해지는 2번.
	                                                  		; 이전 단계는 별표.
	                                                  		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?CEU_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="0"]?CEU_playInfo)		; // 다시 듣기
	same => n, GotoIf($["${SELNUM}"="1"]?CEU_1)			; // 사용 해제
	same => n, GotoIf($["${SELNUM}"="2"]?CEU_2)			; // 다른 보관함 해지
	same => n, GotoIf($["${SELNUM}"="*"]?CEU_0)			; // 이전 단계
	same => n, Goto(CEU_wrong)

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(CEU_wrong), Set(ErrCode=CEU_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(CEU_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(CEU_rcvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(CEU_not_enter), Set(ErrCode=CEU_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(CEU_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(CEU_rcvDgt)


	same => n(CEU_0), Return(0)		; // 이전단계
	same => n(CEU_1), Return(1)
	same => n(CEU_2), Return(2)
	same => n(CEU_3), Return(3)

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/check_ExpireUsing/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; * 6-4 추가 요금 지불후 장기 사용 해지                                          *
; * 4-7 장기 사용 해지 추가 요금 지불                                            *
; *                                                                              *
; ********************************************************************************

[pay_ExtraFee]

exten => start,1,Noop(pay_ExtraFee from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})		; ErrCode
	same => n, Set(LOCAL(m_box)=${ARG2})		; box number
	same => n, Set(LOCAL(m_fee)=${ARG3})		; add fee
	same => n, Set(LOCAL(m_type)=${ARG4})		; request type(1=장기사용추가요금지불(6-4), 2=장기사용해지(4-7)
	same => n, Set(LOCAL(m_cider)=${ARG5})		; 결제방식: 1=GmPOS, 2=cider_pay

	same => n(PEF_playInfo), Set(ErrCode=PEF_playInfo)

	same => n(PEF_rcvDgt), Set(ErrCode=PEF_rcvDgt)

	same => n, GotoIf($[${m_type}=1]?PEF_recvDgt_1)
	same => n, GotoIf($[${m_type}=2]?PEF_recvDgt_2)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PEF_recvDgt_1), Set(ErrCode=PEF_recvDgt_1)
	same => n, Goto(PEF_payAddFee)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PEF_recvDgt_2), Set(ErrCode=PEF_recvDgt_2)

	same => n, Read(SELNUM,${wavDIR}/SBOX_070,1,n,1,5)		; 지금 결제 하시겠습니까?
	                                                  		; 결제는 1번.
	                                                  		; 이전 단계는 별표를.
	                                                  		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?PEF_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="0"]?PEF_playInfo)		; // 다시 듣기
	same => n, GotoIf($["${SELNUM}"="1"]?PEF_payAddFee)		; // 결제
	same => n, GotoIf($["${SELNUM}"="*"]?PEF_0)			; // 이전 단계
	same => n, Goto(PEF_wrong)

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(PEF_wrong), Set(ErrCode=PEF_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(PEF_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(PEF_rcvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(PEF_not_enter), Set(ErrCode=PEF_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(PEF_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(PEF_rcvDgt)


	same => n(PEF_0), Return(0)
	same => n(PEF_1), return(1)
	same => n(PEF_2), Return(2)


	; ----------------------------------------
	; 추가 요금 결제 요청                       
	; ----------------------------------------
	same => n(PEF_payAddFee), Set(ErrCode=PEF_payAddFee)

	same => n, AGI(${agiDIR}/sbox_check_ltu_surcharge.php)
	same => n, Log(NOTICE, sbox_check_ltu_surcharge.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_BoxNumber=[${m_BoxNumber}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(PEF_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?PEF_paySucc)
	same => n, GotoIf($["${RESULT}"="2222"]?PEF_payFail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(PEF_not_define,SBOX_022,0))

	; ----------------------------------------
	; 장기 사용 해지 등록 성공                    
	; ----------------------------------------
	same => n(PEF_paySucc), Set(ErrCode=PEF_paySucc)

	same => n, GotoIF($[${m_cider}=2]?PEF_ret)		; // 사이다페이 결제

	same => n, ExecIf($[${m_fee}>50000]?Playback(${wavDIR}/SBOX_074))	; // 5만원 이상이면 분리 결제 알림
	same => n, Playback(${wavDIR}/SBOX_011)			; 결제기에서 결제를 하시면 해당 보관함이 열립니다. 
	same => n, Goto(PEF_1)

	same => n(PEF_ret), Return(1)

	; ----------------------------------------
	; 장기 사용 해지 등록 실패                    
	; ----------------------------------------
	same => n(PEF_payFail), Set(ErrCode=PEF_payFail)
	same => n, Playback(${wavDIR}/SBOX_023)			; 서버로부터 사용 허가를 받지 못하여,
	                                       			; 서비스를 진행할 수 없습니다.
	same => n, Playback(${wavDIR}/SBOX_025)			; 관리자에게 문의하시기 바랍니다.
	same => n, Goto(PEF_2)


exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/pay_ExtraFee/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; *  보관함이 단일 크기 운영시 설치된 보관함 갯수 가져오기                       *
; *  - input : (1) m_S_TypeCount                                                 *
; *            (2) m_M_TypeCount                                                 *
; *            (3) m_L_TypeCount                                                 *
; *                                                                              *
; ********************************************************************************

[GetStyleEmptyLocker]

exten => start,1,Noop(GetStyleEmptyLocker from ${ARG1})
	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode

	same => n, ExecIf($[${m_S_TypeCount} = 1]?Set(m_BoxType=1))
	same => n, ExecIf($[${m_M_TypeCount} = 1]?Set(m_BoxType=2))
	same => n, ExecIf($[${m_L_TypeCount} = 1]?Set(m_BoxType=3))

	same => n, GoSub(sbox_GetEmptyLocker,start,1(2,${ErrCode}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}=1111]?GSEL_1111)
	same => n, Goto(sbox_GoodBye,1)

	same => n(GSEL_1111), Return

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/GetStyleEmptyLocker/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; *  장기 사용 등록 고객인지 여부 확인 및                                        *
; *  장기 사용중으로 등록된 보관함 정보 가져오기 (4-4, 4-6, 4-7)                 *
; *  - input : (1) 착신번호                                                      *
; *  - output: (1) RESULT(1111=장기 사용자 & 사용중인 보관함 있슴                *
; *                       2222=장기 사용자 & 사용중인 보관함 없슴                *
; *                       3333=장기 사용자 & 등록후 미결재 상태임                *
; *                       9999=장기 사용자 아님)                                 *
; *            (2) m_UsingCount : 장기 사용중인 보관함 갯수                      *
; *            (3) LN0 ~ LN19   : 장기 사용중인 보관함 번호                      *
; *                                                                              *
; ********************************************************************************

[GetLtuLockNumber]

exten => start,1,Noop(GetLtuLockNumber from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})
	same => n, Set(LOCAL(BoxType)=${ARG3})		; // 1=물품보관함, 2=장기보관함

	same => n, AGI(${agiDIR}/sbox_get_ltu_LockNumber.php)
	same => n, Log(NOTICE, sbox_get_ltu_LockNumber.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_UsingCount=[${m_UsingCount}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(GLLN_agi_fail,SBOX_021,0))

	same => n, GotoIf($["${RESULT}"="1111"]?GLLN_succ)		; // 장기 사용자
	same => n, GotoIf($["${RESULT}"="2222"]?GLLN_2222)		; // 사용중인 보관함 없음
	same => n, GotoIf($["${RESULT}"="3333"]?GLLN_3333)		; // 장기 사용자 & 등록후 미결재 상태임
	same => n, GotoIf($["${RESULT}"="9999"]?GLLN_9999)		; // 장기 사용자 아님

	same => n, GoSub(sbox_PlayErrMesg,start,1(GLLN_not_define,SBOX_022,0))

	same => n(GLLN_succ), Set(ErrCode=GLLN_succ)
	same => n, GotoIf($[${m_UsingCount}=0]?GLLN_2222:GLLN_1111)	; // 사용중인 보관함 없슴

	same => n(GLLN_1111), Return(1111)

	same => n(GLLN_2222), Noop(2222)
	same => n, GotoIf($[${BoxType}=2]?GLLN_2200)				; // 장기 보관함에서 호출하는 경우
	same => n, GoSub(sbox_PlayErrMesg,start,1(GLLN_2222,SBOX_062,0))	; 사용중인 보관함 정보가 없습니다.
	                                                                	; 관리자에게 확인후 이용해 주세요.
	same => n(GLLN_3333), Noop(3333)
	same => n, GoSub(sbox_PlayErrMesg,start,1(GLLN_3333,SBOX_019,0))	; 대기중인 결제 정보가 있습니다.
	                                                                	; 결제후 이용해 주세요.
	same => n(GLLN_9999), Noop(9999)
	same => n, GotoIf($[${BoxType}=2]?GLLN_9900)				; // 장기 보관함에서 호출하는 경우
	same => n, GoSub(sbox_PlayErrMesg,start,1(GLLN_9999,SBOX_041,0))	; 장기 사용 등록 고객님이 아닙니다.
	                                                                	; 확인후 이용해 주세요.
	same => n, Return(9999)

	same => n(GLLN_2200), Return(3333)	; // 장기보관함 : 대기중인 결제 정보 있음
	same => n(GLLN_9900), Return(9999)	; // 장기보관함 : 미등록 가입자


exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/GetLtuLockNumber/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; * 특정 보관함 정보 가져오기(만료여부, 만료 날짜, 추가요금) (4-4, 4-6, 5-7)     *
; * - input : (1) 고객 전화 번호                                                 *
; *           (2) m_BoxNumber : 장기 사용중인 보관함 번호                        *
; * - output: (1) RESULT      : 1111=사용 기간중임, 2222=사용 기간 만료          *
; *           (2) m_AddFee    : 추가 요금(장기 사용 만료시 시간 계산)            *
; *           (3) m_Month     : 장기 사용 만료일중 월 정보                       *
; *           (4) m_Day       : 장기 사용 만료일중 일 정보                       *
; *           (5) m_PassDate  : 장기 사용 만료일부터 지나간 날짜                 *
; *                                                                              *
; *                                                                              *
; ********************************************************************************

[GetLtuLockInfo]

exten => start,1,Noop(GetLtuLockInfo from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode

	same => n, AGI(${agiDIR}/sbox_get_ltu_LockInfo.php)
	same => n, Log(NOTICE, sbox_get_ltu_LockInfo.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_BoxNumber=[${m_BoxNumber}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(GLLI_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?GLLI_1)		; // 시용 기간중
	same => n, GotoIf($["${RESULT}"="2222"]?GLLI_2)		; // 사용 기간 만료
	same => n, GoSub(sbox_PlayErrMesg,start,1(GLLI_not_define,SBOX_022,0))

	same => n(GLLI_1), Return(1111)
	same => n(GLLI_2), Return(2222)


exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/GetLtuLockInfo/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; *  RegLTU(6-5, 6-6)                                                            *
; *  - input : (1) m_BoxNumber: 보관함 번호                                      *
; *            (2) m_TermType : 1=일주일,2=10일,3=한달,4=종료일지정              *
; *            (3) m_Month    : 고객이 입력한 종료월 정보                        *
; *            (5) m_Day      : 고객이 입력한 종료일 정보                        *
; *  - output: (1) RESULT     : 1111=SUCC, 2222=FAIL                             *
; *            (2) m_month    : 장기 사용 만료일이 속한 월 정보                  *
; *            (3) m_day      : 장기 사용 만료일이 속한 일 정보                  *
; *            (4) m_PassDate : 장기 사용 만료일까지 일수                        *
; *            (5) m_BasicFee : 장기 사용 결제 요금                              *
; *                                                                              *
; ********************************************************************************

[RegLTU]

exten => start,1,Noop(RegLTU from POS=${ARG1} RegType=${ARG2} PayType=${ARG3})

	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode
	same => n, Set(LOCAL(RegType)=${ARG2})			; 1=등록, 2=연장
	same => n, Set(LOCAL(PayType)=${ARG3})			; 1=GmPOS, 2=CiderPay

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, AGI(${agiDIR}/sbox_get_ltu_info.php)
	same => n, Log(NOTICE, sbox_get_ltu_info.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] BOX=[${m_BoxNumber}] TERM=[${m_TermType}] FEE=[${m_BasicFee}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(GLI_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?GLI_succ)
	same => n, GotoIf($["${RESULT}"="9999"]?GLI_fail)

	same => n, GoSub(sbox_PlayErrMesg,start,1(GLI_not_define,SBOX_022,1))
	same => n, Goto(sbox_main,sbox_Finish,1)		; // 원인없이 종료

	same => n(GLI_fail), Set(ErrCode=GLI_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(GLI_reg_fail,SBOX_023,1))
	same => n, Goto(sbox_main,sbox_Finish,1)		; // 원인없이 종료

	same => n(GLI_succ), Set(ErrCode=GLI_succ)
	same => n, Playback(${wavDIR}/SBOX_052)			; 사용하실 보관함은
	same => n, GoSub(read_Number,start,1(${m_BoxNumber},B))	; xx 번
	same => n, Playback(${wavDIR}/SBOX_C15)			; 이고.

	same => n, Playback(${wavDIR}/SBOX_053)			; 사용 기간은 오늘부터
	same => n, GoSub(read_Number,start,1(${m_month},M))	; xx 월
	same => n, GoSub(read_Number,start,1(${m_day},D))	; xx 일
	same => n, Playback(${wavDIR}/SBOX_C16)			; 까지  
	same => n, GoSub(read_Number,start,1(${m_PassDate},D))	; xx 일
	same => n, Playback(${wavDIR}/SBOX_C05)			; 입니다.

	same => n, Playback(${wavDIR}/SBOX_054)			; 사용 요금은
	same => n, GoSub(read_Number,start,1(${m_BasicFee},W))	; xxxx 원
	same => n, Playback(${wavDIR}/SBOX_C05)			; 입니다.

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, AGI(${agiDIR}/sbox_reg_ltu.php)
	same => n, Log(NOTICE, sbox_reg_ltu.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] BOX=[${m_BoxNumber}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(RLI_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?RLI_succ)
	same => n, GotoIf($["${RESULT}"="9999"]?RLI_fail)

	same => n, GoSub(sbox_PlayErrMesg,start,1(RLI_not_define,SBOX_022,1))
	same => n, Goto(sbox_main,sbox_Finish,1)		; // 원인없이 종료

	same => n(RLI_fail), Set(ErrCode=RLI_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(RLI_reg_fail,SBOX_023,1))
	same => n, Goto(sbox_main,sbox_Finish,1)		; // 원인없이 종료

	same => n(RLI_succ), Set(ErrCode=RLI_succ)

	same => n, GotoIf($[${PayType}=2]?RLI_rte)

	same => n, ExecIf($[${m_BasicFee}>50000]?Playback(${wavDIR}/SBOX_074))	; // 5만원 이상이면 분리 결제 알림

	same => n, Playback(${wavDIR}/SBOX_055)			; 결제기에서 결제를 하시면 오늘부터 사용할 수 있습니다.
	same => n, Playback(${wavDIR}/SBOX_056)			; 사용 기간이 지나면 
	                                       			; 추가 요금을 지불후에 보관함을 열 수 있습니다.
	same => n, Return(0)

	same => n(RLI_rte), Return(0)

exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/RegLTU/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; *                                                                              *
; *                                                                              *
; ********************************************************************************

[terminateLtuMenu]

exten => start,1,Noop(terminateLtuMenu from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Playback(${wavDIR}/SBOX_059)			; 장기 사용 해지 단계 입니다.

	same => n(SLTU_info), Set(ErrCode=SLTU_info)
	same => n, Playback(${wavDIR}/SBOX_060)			; 장기 사용 기간 중에 해지를 하면 남은 일수에 대한 
	                                       			; 잔여 금액은 반환하지 않고, 사용 중인 보관함만 열립니다.
	                                       			; 장기 사용 기간이 지난후에 해지를 하면 미납 요금이 있는
	                                       			; 것으로 추정하여 보관함은 열리지 않습니다.

	same => n(SLTU_rcvDgt), Set(ErrCode=SLTU_rcvDgt)
	same => n, Read(SELNUM,${wavDIR}/SBOX_061,1,n,1,5)	; 해지는 1번.
	                                                  	; 이전 단계는 별표.
	                                                  	; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?SLTU_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="0"]?SLTU_info)			; // 다시 듣기
	same => n, GotoIf($["${SELNUM}"="1"]?SLTU_1)			; // 해지
	same => n, GotoIf($["${SELNUM}"="*"]?SLTU_2)			; // 이전 단계

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(SLTU_wrong), Set(ErrCode=SLTU_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(${ErrCode},SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(SLTU_rcvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(SLTU_not_enter), Set(ErrCode=SLTU_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(${ErrCode},SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(SLTU_rcvDgt)

	same => n(SLTU_1), Return(1)
	same => n(SLTU_2), Return(2)

exten => h,1, Noop(terminateLtuMenu/Hangup)
	same => n, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/terminateLtuMenu/sbox_Hangup] ERR=${ErrCode}])
	same => n, Hangup()





; ********************************************************************************
; *                                                                              *
; *  장기 사용 고객 정보 삭제 하기(5-7)                                          *
; *  - input : (1) 착신번호                                                      *
; *            (2) m_BoxNumber : 추가 요금(장기 사용 만료시 시간 계산)           *
; *  - output: (1) RESULT(1111=장기사용자 & 사용중인 보관함 있슴                 *
; *                                                                              *
; ********************************************************************************

[UnregLTU]

exten => start,1,Noop(UnregLTU from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode

	same => n(URLTU_rcvDgt), Set(ErrCode=URLTU_rcvDgt)
	same => n, GoSub(read_Number,start,1(${m_BoxNumber},B))		; xx 번
	same => n, Read(SELNUM,${wavDIR}/SBOX_072,1,n,1,5)		; 보관함의 장기 사용 해지는 1번.
	                                       				; 다른 보관함 장기 사용 해지는 2번.
	                                       				; 이전 단계는 별표.
	                                       				; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?URLTU_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="0"]?URLTU_rcvDgt)		; // 다시 듣기
	same => n, GotoIf($["${SELNUM}"="1"]?URLTU_1)			; // 해지
	same => n, GotoIf($["${SELNUM}"="2"]?URLTU_2)			; // 다른 보관함
	same => n, GotoIf($["${SELNUM}"="*"]?URLTU_0)			; // 이전 단계

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(URLTU_wrong), Set(ErrCode=URLTU_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(${ErrCode},SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(URLTU_rcvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(URLTU_not_enter), Set(ErrCode=URLTU_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(${ErrCode},SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(URLTU_rcvDgt)

	same => n(URLTU_1), Goto(URLTU_ready)
	same => n(URLTU_2), Return(2)		; // 다른 보관함
	same => n(URLTU_0), Return(0)		; // 이전 단계


	; ----------------------------------------
	; 장기 사용 해지 등록                       
	; ----------------------------------------
	same => n(URLTU_ready), Set(ErrCode=URLTU_ready)

	same => n, AGI(${agiDIR}/sbox_unreg_ltu.php)
	same => n, Log(NOTICE, sbox_unreg_ltu.php [${CALLER}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] BOX=[${m_BoxNumber}] )

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(RLTU_agi_fail,SBOX_021,1))
	same => n, GotoIf($["${RESULT}"="1111"]?RLTU_1111)	; // success
	same => n, GotoIf($["${RESULT}"="9999"]?RLTU_9999)	; // fail
	same => n, GoSub(sbox_PlayErrMesg,start,1(RLTU_not_define,SBOX_022,1))

	same => n(RLTU_9999), Set(ErrorCode=RLTU_9999)
	same => n, Playback(${wavDIR}/SBOX_026)			; 알려지지 않은 원인으로 장기 사용 해지가 실패하였습니다.
	same => n, Playback(${wavDIR}/SBOX_025)			; 관리자에게 문의하시기 바랍니다.
	same => n, Return(9)

	same => n(RLTU_1111), Return(1)


exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/UnregLTU/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()



; ********************************************************************************
; *                                                                              *
; *  사이다페이 결제 요청 문자 보내기                                           *
; *  - input : (1) 착신번호                                                      *
; *            (2) m_BoxNumber : 추가 요금(장기 사용 만료시 시간 계산)           *
; *  - output: (1) RESULT(1111=장기사용자 & 사용중인 보관함 있슴                 *
; *                                                                              *
; ********************************************************************************

[procCiderPay]

exten => start,1,Noop(----------------------------- procCiderPay from ${ARG1},${ARG2},${ARG3},${ARG4} --------------------)

	same => n, Set(RESULT=)					; // RESULT 초기화
	same => n, Set(LOCAL(Caller)=${ARG1})			; // Caller
	same => n, Set(LOCAL(m_Fee)=${ARG2})			; // m_Fee
	same => n, Set(LOCAL(m_Mac)=${ARG3})			; // m_Mac
	same => n, Set(LOCAL(ErrCode)=${ARG4})			; // ErrCode

	; ----------------------------------------
	; 보관함 열기 위한 제어데이타 가져오기              
	; ----------------------------------------
	same => n, GoSub(GetDoorContData,start,1(CiderPay}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GoSubIf($[${RESULT}=0000]?sbox_PlayErrMesg,start,1(PCP_agi_fail,SBOX_021,0))
	same => n, GotoIf($[${RESULT}=1111]?PCP_get_DCD_succ)	; // OK
	same => n, GotoIf($[${RESULT}=2222]?PCP_rlt_fail)	; // 해당 LOCKNO에 대한 정보없음
	same => n, GotoIf($[${RESULT}=3333]?PCP_rlt_fail)	; // 비어있는 보관함이 아님
	same => n, GoSub(sbox_PlayErrMesg,start,1(PCP_not_define,SBOX_022,0))


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCP_get_DCD_succ), Set(ErrCode=PCP_get_DCD_succ)
	same => n, Set(RESULT=)					; // RESULT 초기화
	same => n, AGI(${agiDIR}/sbox_send_ciderpay_sms.php)
	same => n, Log(NOTICE, sbox_send_ciderpay_sms.php [${Caller}] : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_Fee=[${m_Fee}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(PCP_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?PCP_rlt_succ:PCP_rlt_fail)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCP_rlt_succ), Set(ErrCode=PCP_rlt_succ)
	same => n, GoSub(open_box_door,start,1(${ErrCode},ciderpay))

	same => n, Playback(${wavDIR}/SBOX_090)			; 고객님의 핸드폰으로 결제 요청 문자를 보냈습니다. 
	same => n, Playback(${wavDIR}/SBOX_091)			; 받으신 문자에서 URL을 클릭하시면,
	                                       			; 핸드폰에서 결제를 할 수 있습니다.
	same => n, Playback(${wavDIR}/SBOX_092)			; 사이다페이 앱 화면에서 신용 카드 번호를 입력하시면,
	                                       			; 결재가 진행됩니다.
	same => n, Goto(PCP_succ)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCP_rlt_fail), Set(ErrCode=PCP_rlt_fail)
	same => n, Playback(${wavDIR}/SBOX_093)			; 결제 요청 문자를 보내는데 실패하였습니다.
	same => n, Playback(${wavDIR}/SBOX_094)			; 결제를 하시려면, 관리자에게 문의하십시요.
	same => n, Goto(PCP_fail)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCP_succ), Return(1)
	same => n(PCP_fail), Return(2)


exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [${ErrorCode}/procCiderPay/sbox_Hangup] ERR=${ErrCode} )
	same => n, Hangup()

