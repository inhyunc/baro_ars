; ********************************************************************************
; *                                                                              *
; * 사료 주문 서비스(FOAS : Feed Order Auto-response System)                     *
; *                                                                              *
; ********************************************************************************

[foas_main]

exten => _X.,1,Noop([foas_main] Recieving Call[${EXTEN}] From [${CHANNEL(peerip)}])

	same => n, Answer()

	; ----------------------------------------
	; INVITE HEAD 정보에서 발신번호 찾기
	; ----------------------------------------
	same => n, Set(FromNum=${CUT(SIP_HEADER(From),:,2)})
	same => n, Set(GLOBAL(CALLER)=${CUT(FromNum,@,1)})

	; ----------------------------------------
	; INVITE HEAD 정보에서 070 수신번호 찾기
	; ----------------------------------------
	same => n, Set(ToNum=${CUT(SIP_HEADER(To),:,2)})
	same => n, Set(GLOBAL(CALLEE)=${CUT(ToNum,@,1)})
	same => n, Set(PRE=${TONUM:3:4})
	same => n, Set(NUM=${TONUM:7:4})
	same => n, Set(NUM=${CALLEE:7:4})
	same => n, ExecIf($[${LEN(${CALLEE})}<11]?Set(NUM=${CALLEE}))

	same => n, Goto(foas_start,1)


exten => foas_start,1, Noop(foas_start)

	same => n, Set(baseDIR=sunjin)
	same => n, Set(agiDIR=crm)
	same => n, Set(agiPath=/var/lib/asterisk/agi-bin/${agiDIR})
	same => n, Set(recPath=/var/spool/asterisk/monitor)
	same => n, Set(emgDIR=EMGHDD)
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	; ================================================================================
	;                                                                                *
	; 1단계 안내 멘트                                                                *
	;                                                                                *
	;      - '0' 입력시 : 안내 멘트 다시 듣기                                        *
	;      - '1' 입력시 : 음성으로 사료 주문하기                                     *
	;      - '2' 입력시 : 버튼으로 사료 주문하기                                     *
	;      - 입력 오류 처리                                                          *
	;      - 미입력 처리                                                             *
	;                                                                                *
	; ================================================================================
	same => n(S1_recvSvcType), Set(ErrorCode=S1_recvSvcType)

	same => n, read(SELNUM,${baseDIR}/FOAS_011,1,n,1,3)	;
	                                                     	; 안녕하세요.
	                                                     	; 선진 한마을 사료 주문 서비스 입니다.
	                                                     	; 사료 주문을 음성으로 남기려면 1번을.
	                                                     	; 전화 버튼으로 사료 주문을 하려면 2번을. 
	                                                     	; 안내 멘트를 다시 들으시려면 0번을 누르면 됩니다.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S1_not_enter)
	same => n, GotoIf($["${SELNUM}"="*"]?S1_wrong)

	same => n, GotoIf($[${SELNUM}=0]?S1_recvSvcType)
	same => n, GotoIf($[${SELNUM}=1]?foas_record,start,1)
	same => n, GotoIf($[${SELNUM}=2]?foas_order,start,1)


	; ----------------------------------------
	; 입력된 정보가 0,1,2가 아닌 경우     
	; ----------------------------------------
	same => n(S1_wrong), Set(ErrorCode=S1_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S1_wrong_1:S1_GoodBye,1)

	same => n(S1_wrong_1), Playback(${baseDIR}/FOAS_C07)	; 잘못 눌렀습니다.
	same => n, Goto(S1_recvSvcType)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S1_not_enter), Set(ErrorCode=S1_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S1_wrong_3:S1_GoodBye,1)

	same => n(S1_wrong_3), Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.
	same => n, Goto(S1_recvSvcType)



exten => S1_GoodBye,1, Noop(S1_GoodBye)
	same => n, Playback(${baseDIR}/FOAS_C06)		; 이용해 주셔서 감사합니다.
	same => n, Log(NOTICE,[S1_GoodBye] [${CALLER} --> ${CALLEE}] : ERR=[${ErrorCode}] )
	same => n, Hangup()






; ********************************************************************************
; *                                                                              *
; * 고객이 안내멘트 순서에 따라 전화 버튼을 눌러 주문한다.                       *
; *    1. 요일 정보  : 월,화,수,목,금,토                                         *
; *    2. 시간 정보  : 첫차,오전,오후,도착시간관계없음                           *
; *    3. 사료를 하차할 장소 정보 : 농장동 번호( 1동 ~ 19동)                     *
; *    4. 주문할 사료의 양 정보 : 1톤 ~ 15톤                                     *
; *                                                                              *
; ********************************************************************************

[foas_order]


exten => start,1,Noop([foas_order] ${STRFTIME(${EPOCH},,%F %T)} [${CALLER}] --> [${CALLEE}])

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	; ================================================================================
	;                                                                                *
	; 2-2 단계 : 주문 사료 도착 요일 정보 입력                                       *
	;                                                                                *
	; - 음성 안내 멘트 내용(FOAS_022)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S22_recvDate), Set(ErrorCode=S22_recvDate})

	same => n, read(RecvDate,${baseDIR}/FOAS_022,1,n,1,3)	;
	                                                ; 주문하는 사료를, 수령하고자 하는 요일. 시간. 농장동 위치.
	                                                ; 주문 수량을 음성 안내에 따라 입력하면 됩니다.
	                                                ; 사료를 받고자 하는 요일 정보를 입력하세요.
	                                                ; 주문 요일은 월요일부터 토요일까지 가능하고 일요일은 불가능합니다.
	                                                ; 월요일에 받고 싶으면 1번을.
	                                                ; 화요일에 받고 싶으면 2번을.
	                                                ; 수요일에 받고 싶으면 3번을.
	                                                ; 목요일에 받고 싶으면 4번을.
	                                                ; 금요일에 받고 싶으면 5번을.
	                                                ; 토요일에 받고 싶으면 6번을.
	                                                ; 안내 멘트를 다시 들으시려면 0번을.
	                                                ; 전 단계로 이동하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${RecvDate})}=0]?S22_not_enter)

	same => n, GotoIf($["${RecvDate}"="*"]?S22_PreStep)
	same => n, GotoIf($[${RecvDate}=0]?S22_recvDate)
	same => n, GotoIf($[${RecvDate}=1]?S22_normal)
	same => n, GotoIf($[${RecvDate}=2]?S22_normal)
	same => n, GotoIf($[${RecvDate}=3]?S22_normal)
	same => n, GotoIf($[${RecvDate}=4]?S22_normal)
	same => n, GotoIf($[${RecvDate}=5]?S22_normal)
	same => n, GotoIf($[${RecvDate}=6]?S22_normal)


	; ----------------------------------------
	; 입력된 정보가 7,8,9인 경우                
	; ----------------------------------------
	same => n(S22_wrong), Set(ErrorCode=S22_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S22_wrong_1:order_GoodBye,1)

	same => n(S22_wrong_1), Playback(${baseDIR}/FOAS_C07)	; 잘못 눌렀습니다.
	same => n, Goto(S22_recvDate)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S22_not_enter), Set(ErrorCode=S22_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S22_wrong_3:order_GoodBye,1)

	same => n(S22_wrong_3), Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.
	same => n, Goto(S22_recvDate)


	; ----------------------------------------
	; 이전 단계로 이동                
	; ----------------------------------------
	same => n(S22_PreStep), Set(ErrorCode=S22_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(foas_main,foas_start,1)


	; ----------------------------------------
	; 입력 정보 정상시                
	; ----------------------------------------
	same => n(S22_normal), Set(ErrorCode=S22_normal)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S32_recvTime)



	; ================================================================================
	;                                                                                *
	; 3-2단계 : 주문 사료 도착 시간 정보 입력                                        *
	;                                                                                *
	; - 음성 안내 멘트 내용(FOAS_021)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S32_recvTime), Set(ErrorCode=S32_recvTime)

	same => n, read(RecvTime,${baseDIR}/FOAS_032,1,n,1,3)	;
	                                                     	; 사료 도착 시간을 입력하세요.
	                                                     	; 첫 차로 받으려면 1번을.
	                                                     	; 오전 시간에 받으려면 2번을.
	                                                     	; 오후 시간에 받으려면 3번을.
	                                                     	; 도착 시간이 관계 없으면 4번을.
	                                                     	; 안내 멘트를 다시 들으시려면 0번을.
	                                                     	; 전 단계로 이동하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${RecvTime})}=0]?S32_not_enter)

	same => n, GotoIf($["${RecvTime}"="*"]?S32_PreStep)

	same => n, GotoIf($[${RecvTime}=0]?S32_recvTime)
	same => n, GotoIf($[${RecvTime}=1]?S32_normal)
	same => n, GotoIf($[${RecvTime}=2]?S32_normal)
	same => n, GotoIf($[${RecvTime}=3]?S32_normal)
	same => n, GotoIf($[${RecvTime}=4]?S32_normal)


	; ----------------------------------------
	; 입력된 정보가 0,1,2,3,4이 아닌 경우     
	; ----------------------------------------
	same => n(S32_wrong), Set(ErrorCode=S32_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S32_wrong_1:order_GoodBye,1)

	same => n(S32_wrong_1), Playback(${baseDIR}/FOAS_C07)	; 잘못 눌렀습니다.
	same => n, Goto(S32_recvTime)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S32_not_enter), Set(ErrorCode=S32_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S32_wrong_3:order_GoodBye,1)

	same => n(S32_wrong_3), Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.
	same => n, Goto(S32_recvTime)


	; ----------------------------------------
	; 이전 단계로 이동                
	; ----------------------------------------
	same => n(S32_PreStep), Set(ErrorCode=S32_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S22_recvDate)


	; ----------------------------------------
	; 입력 정보 정상시                
	; ----------------------------------------
	same => n(S32_normal), Set(ErrorCode=S32_normal)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S42_HowManyPlaceGetOff)



	; ================================================================================
	;                                                                                *
	; 4-2단계 : 사료를 하차할 농장동 위치가 한곳인지 여러곳인지 확인                 *
	;                                                                                *
	; - 음성 안내 멘트 내용(FOAS_042)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S42_HowManyPlaceGetOff), Set(ErrorCode=S42_HowManyPlaceGetOff)


	same => n, read(RecvGetOffType,${baseDIR}/FOAS_042,1,n,1,3)	;
	                                                   	; 사료를 내려~ 놓을 농장동이 한 곳이면 1번을.
	                                                   	; 사료를 내려~ 놓을 농장동이 여러 곳이면 2번을.
	                                                   	; 안내 멘트를 다시 들으시려면 0번을.
	                                                   	; 전 단계로 이동하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${RecvGetOffType})}=0]?S42_not_enter)

	same => n, GotoIf($["${RecvGetOffType}"="*"]?S42_PreStep)

	same => n, GotoIf($[${RecvGetOffType}=0]?S42_HowManyPlaceGetOff)
	same => n, GotoIf($[${RecvGetOffType}=1]?S42_normal)
	same => n, GotoIf($[${RecvGetOffType}=2]?S42_normal)


	; ----------------------------------------
	; 입력된 정보가 0,1,2,*이 아닌 경우     
	; ----------------------------------------
	same => n(S42_wrong), Set(ErrorCode=S42_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S42_wrong_1:order_GoodBye,1)

	same => n(S42_wrong_1), Playback(${baseDIR}/FOAS_C07)	; 잘못 눌렀습니다.
	same => n, Goto(S42_HowManyPlaceGetOff)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S42_not_enter), Set(ErrorCode=S42_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S42_wrong_3:order_GoodBye,1)

	same => n(S42_wrong_3), Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.
	same => n, Goto(S42_HowManyPlaceGetOff)


	; ----------------------------------------
	; 이전 단계로 이동                
	; ----------------------------------------
	same => n(S42_PreStep), Set(ErrorCode=S42_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S32_recvTime)


	; ----------------------------------------
	; 입력 정보 정상시                
	; ----------------------------------------
	same => n(S42_normal), Set(ErrorCode=S42_normal)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, GoSub(foas_init,start,1)

	same => n, GotoIf($[${RecvGetOffType}=1]?S52_PlaceGetOff)
	same => n, GotoIf($[${RecvGetOffType}=2]?S53_PlaceGetOff)

	same => n, Set(ErrorCode=S42_undefined_error)
	same => n, Goto(order_GoodBye,1)



	; ================================================================================
	;                                                                                *
	; 5-2단계 : 사료를 하차할 농장동 위치 정보 입력                                  *
	;                                                                                *
	; - 음성 안내 멘트 내용(FOAS_052)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S52_PlaceGetOff), Set(ErrorCode=S52_PlaceGetOff)

	same => n, read(BN,${baseDIR}/FOAS_052,3,n,1,3)	;
	                                                   	; 사료를 내려~ 놓을 농장동 번호를 입력하세요.
	                                                   	; 농장동은 1동부터 19동까지 입력할 수 있습니다.
	                                                   	; 농장동 번호와 #버튼을 누르세요.
	                                                   	; 안내 멘트를 다시 들으시려면 0번을.
	                                                   	; 전 단계로 이동하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${BN})}=0]?S52_not_enter)

	same => n, GotoIf($["${BN}"="***"]?S52_PreStep)
	same => n, GotoIf($["${BN}"="**"]?S52_PreStep)
	same => n, GotoIf($["${BN}"="*"]?S52_PreStep)

	same => n, GotoIf($[${BN}=0]?S52_PlaceGetOff)
	same => n, GotoIf($[${BN}<=19]?S52_normal)


	; ----------------------------------------
	; 입력된 정보가 0,1~19,*이 아닌 경우     
	; ----------------------------------------
	same => n(S52_wrong), Set(ErrorCode=S52_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S52_wrong_1:order_GoodBye,1)

	same => n(S52_wrong_1), Playback(${baseDIR}/FOAS_C07)	; 잘못 눌렀습니다.
	same => n, Goto(S52_PlaceGetOff)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S52_not_enter), Set(ErrorCode=S52_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S52_wrong_3:order_GoodBye,1)

	same => n(S52_wrong_3), Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.
	same => n, Goto(S52_PlaceGetOff)


	; ----------------------------------------
	; 이전 단계로 이동                
	; ----------------------------------------
	same => n(S52_PreStep), Set(ErrorCode=S52_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S42_HowManyPlaceGetOff)


	; ----------------------------------------
	; 입력 정보 정상시                
	; ----------------------------------------
	same => n(S52_normal), Set(ErrorCode=S52_normal)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S62_recvQuantity)



	; ================================================================================
	;                                                                                *
	; 6-2단계 : 주문 수량 정보 입력                                                  *
	;                                                                                *
	; - 음성 안내 멘트 내용(FOAS_062)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S62_recvQuantity), Set(ErrorCode=S62_recvQuantity)

	same => n, read(QT,${baseDIR}/FOAS_062,3,n,1,3)	;
	                                               	; 주문하실 수량을 입력하세요.
	                                               	; 수량은 1톤부터 15톤까지 주문할 수 있습니다.
	                                               	; 수량과  #버튼을 누르세요.
	                                               	; 안내 멘트를 다시 들으시려면 0번을.
	                                               	; 전 단계로 이동하려면 별표를 누르세요.
	same => n, GotoIf($[${LEN(${QT})}=0]?S62_not_enter)

	same => n, GotoIf($["${QT}"="***"]?S62_PreStep)
	same => n, GotoIf($["${QT}"="**"]?S62_PreStep)
	same => n, GotoIf($["${QT}"="*"]?S62_PreStep)

	same => n, GotoIf($[${QT}=0]?S62_recvQuantity)
	same => n, GotoIf($[${QT}<=15]?S62_normal)


	; ----------------------------------------
	; 입력된 정보가 0,1~15,*이 아닌 경우     
	; ----------------------------------------
	same => n(S62_wrong), Set(ErrorCode=S62_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S62_wrong_1:order_GoodBye,1)

	same => n(S62_wrong_1), Playback(${baseDIR}/FOAS_C07)	; 잘못 눌렀습니다.
	same => n, Goto(S62_recvQuantity)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S62_not_enter), Set(ErrorCode=S62_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S62_wrong_3:order_GoodBye,1)

	same => n(S62_wrong_3), Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.
	same => n, Goto(S62_recvQuantity)

	; ----------------------------------------
	; 이전 단계로 이동                
	; ----------------------------------------
	same => n(S62_PreStep), Set(ErrorCode=S62_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S52_PlaceGetOff)


	; ----------------------------------------
	; 입력 정보 정상시                
	; ----------------------------------------
	same => n(S62_normal), Set(ErrorCode=S62_normal)

	same => n, GoSub(foas_SetQT,start,1(${BN},${QT}))

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S72_checkOrderInfo)



	; ================================================================================
	;                                                                                *
	; 7-2단계 : 주문 정보 확인                                                       *
	;                                                                                *
	; - 음성 안내 멘트 내용(FOAS_072)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S72_checkOrderInfo), Set(ErrorCode=S72_checkOrderInfo)

	same => n, Playback(${baseDIR}/FOAS_0721)		; 주문이 완료 되었습니다.
;	same => n, read(SELNUM,${baseDIR}/FOAS_0721,1,n,1,1)	; 주문이 완료 되었습니다.
;	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S72_checkOrderInfo2)
;	same => n, GotoIf($["${SELNUM}"="*"]?S62_recvQuantity)
;	same => n, GotoIf($[${SELNUM}=0]?S72_checkOrderInfo2)
;	same => n, GotoIf($[${SELNUM}=1]?S72_listen_OrderInfo)
;	same => n, GotoIf($[${SELNUM}=2]?S72_confrm_OrderInfo)
;	same => n, GotoIf($[${SELNUM}=3]?S72_cancel_OrderInfo:S72_wrong)

	same => n(S72_checkOrderInfo2), Set(ErrorCode=S72_checkOrderInfo2)

	same => n, read(SELNUM,${baseDIR}/FOAS_0722,1,n,1,3)	;
	                                                   	; 주문 내역을 확인 하고자 하는 경우에는 1번을.
	                                                   	; 주문 내역 확인 없이 주문 서비스를 확정하려면 2번을. 
	                                                   	; 주문을 취소하려면 3번을 누르거나 통화를 종료하면 됩니다.
	                                                   	; 안내 멘트를 다시 들으시려면 0번을.
	                                                   	; 전 단계로 이동하려면 별표를 누르세요. 

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S72_not_enter)

	same => n, GotoIf($["${SELNUM}"="*"]?S72_PreStep)

	same => n, GotoIf($[${SELNUM}=0]?S72_checkOrderInfo2)
	same => n, GotoIf($[${SELNUM}=1]?S72_listen_OrderInfo)
	same => n, GotoIf($[${SELNUM}=2]?S72_confirmOrderInfo)
	same => n, GotoIf($[${SELNUM}=3]?S72_cancel_OrderInfo)



	; ----------------------------------------
	; 입력된 정보가 0,1,2,3,*이 아닌 경우     
	; ----------------------------------------
	same => n(S72_wrong), Set(ErrorCode=S72_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S72_wrong_1:order_GoodBye,1)

	same => n(S72_wrong_1), Playback(${baseDIR}/FOAS_C07)	; 잘못 눌렀습니다.
	same => n, Goto(S72_checkOrderInfo2)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S72_not_enter), Set(ErrorCode=S72_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S72_wrong_3:order_GoodBye,1)

	same => n(S72_wrong_3), Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.
	same => n, Goto(S72_checkOrderInfo2)


	; ----------------------------------------
	; 이전 단계로 이동                
	; ----------------------------------------
	same => n(S72_PreStep), Set(ErrorCode=S72_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, GotoIF($[${RecvGetOffType} = 1]?S62_recvQuantity)
	same => n, GotoIF($[${RecvGetOffType} = 2]?S53_PlaceGetOff)
	same => n, Hangup()


	; ----------------------------------------
	; 주문 정보 내역 듣기              
	; ----------------------------------------
	same => n(S72_listen_OrderInfo), Set(ErrorCode=S72_listen_OrderInfo)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S82_listen_OrderInfo)


	; ----------------------------------------
	; 주문 정보 확정하기               
	; ----------------------------------------
	same => n(S72_confirmOrderInfo), Set(ErrorCode=S72_confirmOrderInfo)

	same => n, Goto(S82_confirmOrderInfo)



	; ----------------------------------------
	; 주문 정보 취소하고 종료하기          
	; ----------------------------------------
	same => n(S72_cancel_OrderInfo), Set(ErrorCode=S72_cancel_OrderInfo)

	same => n, Playback(${baseDIR}/FOAS_C05)	; 주문을 취소하였습니다.
	                                        	; 이용해 주셔서 감사합니다.
	same => n, Goto(order_Finish,1)




	; ================================================================================
	;                                                                                *
	; 8-2단계 : 주문 정보 확인                                                       *
	;                                                                                *
	; - 음성 안내 멘트 내용(FOAS_082)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S82_listen_OrderInfo), Set(ErrorCode=S82_listen_OrderInfo})

	same => n, Playback(${baseDIR}/FOAS_0821)		; 고객님의 주문 내역입니다.

;--------------------------------------------------------------------------------------------------------
	same => n, Playback(${baseDIR}/FOAS_C101)				; 주문하신 제품이 도착하는 날은.
	same => n, ExecIf($[${RecvDate} = 1]?Playback(${baseDIR}/FOAS_D01))
	same => n, ExecIf($[${RecvDate} = 2]?Playback(${baseDIR}/FOAS_D02))
	same => n, ExecIf($[${RecvDate} = 3]?Playback(${baseDIR}/FOAS_D03))
	same => n, ExecIf($[${RecvDate} = 4]?Playback(${baseDIR}/FOAS_D04))
	same => n, ExecIf($[${RecvDate} = 5]?Playback(${baseDIR}/FOAS_D05))
	same => n, ExecIf($[${RecvDate} = 6]?Playback(${baseDIR}/FOAS_D06))

	same => n, Playback(${baseDIR}/FOAS_C11)				; 도착 시간대는.
	same => n, ExecIf($[${RecvTime} = 1]?Playback(${baseDIR}/FOAS_T01))
	same => n, ExecIf($[${RecvTime} = 2]?Playback(${baseDIR}/FOAS_T02))
	same => n, ExecIf($[${RecvTime} = 3]?Playback(${baseDIR}/FOAS_T03))
	same => n, ExecIf($[${RecvTime} = 4]?Playback(${baseDIR}/FOAS_T04))
	same => n, Playback(${baseDIR}/FOAS_C12)				; 입니다.

	same => n, Playback(${baseDIR}/FOAS_C131)				; 제품을 하차할 장소는.

	same => n, ExecIf($[${QT01} > 0]?GoSub(foas_read,start,1( 1,${QT01})))
	same => n, ExecIf($[${QT02} > 0]?GoSub(foas_read,start,1( 2,${QT02})))
	same => n, ExecIf($[${QT03} > 0]?GoSub(foas_read,start,1( 3,${QT03})))
	same => n, ExecIf($[${QT04} > 0]?GoSub(foas_read,start,1( 4,${QT04})))
	same => n, ExecIf($[${QT05} > 0]?GoSub(foas_read,start,1( 5,${QT05})))
	same => n, ExecIf($[${QT06} > 0]?GoSub(foas_read,start,1( 6,${QT06})))
	same => n, ExecIf($[${QT07} > 0]?GoSub(foas_read,start,1( 7,${QT07})))
	same => n, ExecIf($[${QT08} > 0]?GoSub(foas_read,start,1( 8,${QT08})))
	same => n, ExecIf($[${QT09} > 0]?GoSub(foas_read,start,1( 9,${QT09})))
	same => n, ExecIf($[${QT10} > 0]?GoSub(foas_read,start,1(10,${QT10})))
	same => n, ExecIf($[${QT11} > 0]?GoSub(foas_read,start,1(11,${QT11})))
	same => n, ExecIf($[${QT12} > 0]?GoSub(foas_read,start,1(12,${QT12})))
	same => n, ExecIf($[${QT13} > 0]?GoSub(foas_read,start,1(13,${QT13})))
	same => n, ExecIf($[${QT14} > 0]?GoSub(foas_read,start,1(14,${QT14})))
	same => n, ExecIf($[${QT15} > 0]?GoSub(foas_read,start,1(15,${QT15})))
	same => n, ExecIf($[${QT16} > 0]?GoSub(foas_read,start,1(16,${QT16})))
	same => n, ExecIf($[${QT17} > 0]?GoSub(foas_read,start,1(17,${QT17})))
	same => n, ExecIf($[${QT18} > 0]?GoSub(foas_read,start,1(18,${QT18})))
	same => n, ExecIf($[${QT19} > 0]?GoSub(foas_read,start,1(19,${QT19})))

	same => n, Playback(${baseDIR}/FOAS_C12)				; 입니다.

;--------------------------------------------------------------------------------------------------------

	same => n(S82_recvSelNum), Set(ErrorCode=S82_recvSelNum})

	same => n, read(SELNUM,${baseDIR}/FOAS_0822,1,n,1,3)	;
	                                                    	; 주문 내용이 맞으면 1번을.
	                                                    	; 다시 입력 하려면 2번을.
	                                                    	; 취소 하려면 3번을.
	                                                    	; 안내 멘트를 다시 들으시려면 0번을 누르세요.
	                                                    	; 통화를 종료하면 주문은 취소됩니다.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S82_not_enter)
	same => n, GotoIf($["${SELNUM}"="*"]?S82_wrong)

	same => n, GotoIf($[${SELNUM}=0]?S82_listen_OrderInfo)
	same => n, GotoIf($[${SELNUM}=1]?S82_confirmOrderInfo)
	same => n, GotoIf($[${SELNUM}=2]?S82_reEnterOrderInfo)
	same => n, GotoIf($[${SELNUM}=3]?S82_cancel_OrderInfo)


	; ----------------------------------------
	; 입력된 정보가 0,1,2,3,*이 아닌 경우     
	; ----------------------------------------
	same => n(S82_wrong), Set(ErrorCode=S82_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 10]?S82_wrong_1:order_GoodBye,1)

	same => n(S82_wrong_1), Playback(${baseDIR}/FOAS_C07)	; 잘못 눌렀습니다.
	same => n, Goto(S82_recvSelNum)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S82_not_enter), Set(ErrorCode=S82_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 10]?S82_wrong_3:order_GoodBye,1)

	same => n(S82_wrong_3), Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.
	same => n, Goto(S82_recvSelNum)


	; ----------------------------------------
	; 주문 정보 확정하기               
	; ----------------------------------------
	same => n(S82_confirmOrderInfo), Set(ErrorCode=S82_confirmOrderInfo)

	same => n, AGI(${agiDIR}/crm_save_ars_button.php)
	same => n, Log(NOTICE, crm_save_ars_button.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?agi_sab_access_fail)
	same => n, GotoIf($["${RESULT}"!="0000"]?agi_sab_result_fail)

	same => n, Playback(${baseDIR}/FOAS_C03)	; 주문 내용을 저장하였습니다.
	                                        	; 이용해 주셔서 감사합니다.
	same => n, Goto(order_Finish,1)


	; ----------------------------------------
	; AGI 연동 실패시           
	; ----------------------------------------
	same => n(agi_sab_access_fail), Set(ErrorCode=agi_sab_access_fail)
	same => n, Goto(agi_insert_fail)

	same => n(agi_sab_result_fail), Set(ErrorCode=agi_sab_result_fail)
	same => n, Goto(agi_insert_fail)

	same => n(agi_insert_fail), Noop(ErrorCode=${ErrorCode})
	same => n, Playback(${baseDIR}/FOAS_C16)	; 외부 장치에 접속하지 못하여, 주문이 취소되었습니다.
	                                        	; 확인후 이용해 주세요.
	same => n, Goto(order_Finish,1)


	; ----------------------------------------
	; 주문 정보 처음부터 재 입력하기        
	; ----------------------------------------
	same => n(S82_reEnterOrderInfo), Set(ErrorCode=S82_reEnterOrderInfo)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S22_recvDate)


	; ----------------------------------------
	; 주문 정보 취소하고 종료하기          
	; ----------------------------------------
	same => n(S82_cancel_OrderInfo), Set(ErrorCode=S82_cancel_OrderInfo)

	same => n, Playback(${baseDIR}/FOAS_C04)	; 주문 내용을 취소하였습니다.
	                                        	; 이용해 주셔서 감사합니다.
	same => n, Goto(order_Finish,1)




	; ================================================================================
	;                                                                                *
	; 5-3단계 : 사료를 하차할 농장동 위치 정보 입력                                  *
	;                                                                                *
	; - 음성 안내 멘트 내용(FOAS_053)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S53_PlaceGetOff), Set(ErrorCode=S53_PlaceGetOff})

	same => n, read(BN,${baseDIR}/FOAS_053,3,n,1,3)	;
	                                                   	; 사료를 내려~ 놓을 농장동 번호를 입력하세요.
	                                                   	; 농장동은 1동부터 19동까지 입력할 수 있습니다.
	                                                   	; 농장동 번호와 #버튼을 누르세요.
	                                                   	; 농장동 번호 입력을 종료하려면 99번을.
	                                                   	; 안내 멘트를 다시 들으시려면 0번을.
	                                                   	; 전 단계로 이동하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${BN})}=0]?S53_not_enter)

	same => n, GotoIf($["${BN}"="***"]?S53_PreStep)
	same => n, GotoIf($["${BN}"="**"]?S53_PreStep)
	same => n, GotoIf($["${BN}"="*"]?S53_PreStep)

	same => n, GotoIf($[${BN}=0]?S53_PlaceGetOff)
	same => n, GotoIf($[${BN}<20]?S53_normal)
	same => n, GotoIf($[${BN}=99]?S53_NextStep)


	; ----------------------------------------
	; 입력된 정보가 0,1,2,*이 아닌 경우     
	; ----------------------------------------
	same => n(S53_wrong), Set(ErrorCode=S53_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S53_wrong_1:order_GoodBye,1)

	same => n(S53_wrong_1), Playback(${baseDIR}/FOAS_C07)	; 잘못 눌렀습니다.
	same => n, Goto(S53_PlaceGetOff)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S53_not_enter), Set(ErrorCode=S53_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S53_wrong_3:order_GoodBye,1)

	same => n(S53_wrong_3), Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.
	same => n, Goto(S53_PlaceGetOff)


	; ----------------------------------------
	; 이전 단계로 이동                
	; ----------------------------------------
	same => n(S53_PreStep), Set(ErrorCode=S53_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S42_HowManyPlaceGetOff)


	; ----------------------------------------
	; 입력 정보 정상시                
	; ----------------------------------------
	same => n(S53_normal), Set(ErrorCode=S53_normal)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(countBN=[${countBN}+1])

	same => n, Goto(S63_recvQuantity)


	; ----------------------------------------
	; 농장동 입력 완료시               
	; ----------------------------------------
	same => n(S53_NextStep), Set(ErrorCode=S53_NextStep)

	same => n, GotoIF($[${countBN} > 0]?S72_checkOrderInfo)

	same => n, Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.
	same => n, Goto(S53_PlaceGetOff)




	; ================================================================================
	;                                                                                *
	; 6-3단계 : 주문 수량 정보 입력                                                  *
	;                                                                                *
	; - 음성 안내 멘트 내용(FOAS_063)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S63_recvQuantity), Set(ErrorCode=S63_recvQuantity})

	same => n, read(QT,${baseDIR}/FOAS_063,3,n,1,3)	;
	                                               	; 주문하실 수량을 입력하세요.
	                                               	; 수량은 1톤부터 15톤까지 주문할 수 있습니다.
	                                               	; 수량과  #버튼을 누르세요.
	                                               	; 안내 멘트를 다시 들으시려면 0번을.
	                                               	; 수량 입력을 종료하려면 99번과 #버튼을.
	                                               	; 전 단계로 이동하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${QT})}=0]?S63_not_enter)

	same => n, GotoIf($["${QT}"="***"]?S53_PlaceGetOff)
	same => n, GotoIf($["${QT}"="**"]?S53_PlaceGetOff)
	same => n, GotoIf($["${QT}"="*"]?S53_PlaceGetOff)

	same => n, GotoIf($[${QT}=0]?S63_recvQuantity)
	same => n, GotoIf($[${QT}<=15]?S63_normal)
	same => n, GotoIf($[${QT}=99]?S63_NextStep)

	; ----------------------------------------
	; 입력된 정보가 0,1~15,*이 아닌 경우     
	; ----------------------------------------
	same => n(S63_wrong), Set(ErrorCode=S63_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S63_wrong_1:order_GoodBye,1)

	same => n(S63_wrong_1), Playback(${baseDIR}/FOAS_C07)	; 잘못 눌렀습니다.
	same => n, Goto(S63_recvQuantity)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S63_not_enter), Set(ErrorCode=S63_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S63_wrong_3:order_GoodBye,1)

	same => n(S63_wrong_3), Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.
	same => n, Goto(S63_recvQuantity)


	; ----------------------------------------
	; 이전 단계로 이동                
	; ----------------------------------------
;	same => n(S63_PreStep), Set(ErrorCode=S63_PreStep)
;
;	same => n, Set(countWRONG=0)
;	same => n, Set(countENTER=0)
;
;	same => n, Goto(S53_PlaceGetOff)


	; ----------------------------------------
	; 입력 정보 정상시                
	; ----------------------------------------
	same => n(S63_normal), Set(ErrorCode=S63_normal)

	same => n, GoSub(foas_SetQT,start,1(${BN},${QT}))

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(countQT=[${countQT}+1])

	same => n, Goto(S53_PlaceGetOff)


	; ----------------------------------------
	; 주문 사료량  입력 완료시               
	; ----------------------------------------
	same => n(S63_NextStep), Set(ErrorCode=S53_NextStep)

	same => n, GotoIF($[${countQT} > 0]?S72_checkOrderInfo)

	same => n, Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.

	same => n, Goto(S63_recvQuantity)




	; ================================================================================
	;                                                                                *
	; ================================================================================
exten => order_GoodBye,1, Noop(order_GoodBye)
	same => n, Log(NOTICE,[order_GoodBye] [${CALLER} --> ${CALLEE}] ERR=[${ErrorCode}] )
	same => n, Playback(${baseDIR}/FOAS_C06)	; 이용해 주셔서 감사합니다.

	same => n, Hangup()


exten => order_Finish,1, Noop(order_Finish)
	same => n, Log(NOTICE,[order_Finish] [${CALLER} --> ${CALLEE}] ERR=[${ErrorCode}] )

	same => n, Hangup()






; ********************************************************************************
; *                                                                              *
; * 농장동별로 사료 주문량을 초기화                                              *
; *                                                                              *
; ********************************************************************************

[foas_init]
exten => start,1,Noop(foas_init)

	same => n, Set(countBN=0)
	same => n, Set(countQT=0)

	same => n, Set(QT01=0)
	same => n, Set(QT02=0)
	same => n, Set(QT03=0)
	same => n, Set(QT04=0)
	same => n, Set(QT05=0)
	same => n, Set(QT06=0)
	same => n, Set(QT07=0)
	same => n, Set(QT08=0)
	same => n, Set(QT09=0)
	same => n, Set(QT10=0)
	same => n, Set(QT11=0)
	same => n, Set(QT12=0)
	same => n, Set(QT13=0)
	same => n, Set(QT14=0)
	same => n, Set(QT15=0)
	same => n, Set(QT16=0)
	same => n, Set(QT17=0)
	same => n, Set(QT18=0)
	same => n, Set(QT19=0)

	same => n, Return(0)





; ********************************************************************************
; *                                                                              *
; * 농장동 정보와 주문량 정보를 각 변수에 저장                                   *
; *                                                                              *
; ********************************************************************************

[foas_SetQT]
exten => start,1,Noop(foas_SetQT)
	same => n, Set(LOCAL(BN)=${ARG1})
	same => n, Set(LOCAL(QT)=${ARG2})

	same => n, ExecIf($[${BN} = 1]?Set(QT01=${QT}))
	same => n, ExecIf($[${BN} = 2]?Set(QT02=${QT}))
	same => n, ExecIf($[${BN} = 3]?Set(QT03=${QT}))
	same => n, ExecIf($[${BN} = 4]?Set(QT04=${QT}))
	same => n, ExecIf($[${BN} = 5]?Set(QT05=${QT}))
	same => n, ExecIf($[${BN} = 6]?Set(QT06=${QT}))
	same => n, ExecIf($[${BN} = 7]?Set(QT07=${QT}))
	same => n, ExecIf($[${BN} = 8]?Set(QT08=${QT}))
	same => n, ExecIf($[${BN} = 9]?Set(QT09=${QT}))
	same => n, ExecIf($[${BN} =10]?Set(QT10=${QT}))
	same => n, ExecIf($[${BN} =11]?Set(QT11=${QT}))
	same => n, ExecIf($[${BN} =12]?Set(QT12=${QT}))
	same => n, ExecIf($[${BN} =13]?Set(QT13=${QT}))
	same => n, ExecIf($[${BN} =14]?Set(QT14=${QT}))
	same => n, ExecIf($[${BN} =15]?Set(QT15=${QT}))
	same => n, ExecIf($[${BN} =16]?Set(QT16=${QT}))
	same => n, ExecIf($[${BN} =17]?Set(QT17=${QT}))
	same => n, ExecIf($[${BN} =18]?Set(QT18=${QT}))
	same => n, ExecIf($[${BN} =19]?Set(QT19=${QT}))

	same => n, Return(0)





; ********************************************************************************
; *                                                                              *
; * 농장동 번호와 주문 수량을 음성으로 안내                                      *
; *                                                                              *
; ********************************************************************************

[foas_read]
exten => start,1,Noop(foas_read)
	same => n,Set(LOCAL(BNxx)=${ARG1})
	same => n,Set(LOCAL(QTxx)=${ARG2})

	same => n, ExecIf($[${QTxx} <10]?Set(F1=${SPRINTF(FOAS_ton0%d,${QTxx})}))
	same => n, ExecIf($[${QTxx} > 9]?Set(F1=${SPRINTF(FOAS_ton%d,${QTxx})}))

;	same => n, Playback(${baseDIR}/FOAS_C14)				; 농장동.

	same => n, ExecIf($[${BNxx} = 1]?Playback(${baseDIR}/FOAS_dong01))
	same => n, ExecIf($[${BNxx} = 2]?Playback(${baseDIR}/FOAS_dong02))
	same => n, ExecIf($[${BNxx} = 3]?Playback(${baseDIR}/FOAS_dong03))
	same => n, ExecIf($[${BNxx} = 4]?Playback(${baseDIR}/FOAS_dong04))
	same => n, ExecIf($[${BNxx} = 5]?Playback(${baseDIR}/FOAS_dong05))
	same => n, ExecIf($[${BNxx} = 6]?Playback(${baseDIR}/FOAS_dong06))
	same => n, ExecIf($[${BNxx} = 7]?Playback(${baseDIR}/FOAS_dong07))
	same => n, ExecIf($[${BNxx} = 8]?Playback(${baseDIR}/FOAS_dong08))
	same => n, ExecIf($[${BNxx} = 9]?Playback(${baseDIR}/FOAS_dong09))
	same => n, ExecIf($[${BNxx} =10]?Playback(${baseDIR}/FOAS_dong10))
	same => n, ExecIf($[${BNxx} =11]?Playback(${baseDIR}/FOAS_dong11))
	same => n, ExecIf($[${BNxx} =12]?Playback(${baseDIR}/FOAS_dong12))
	same => n, ExecIf($[${BNxx} =13]?Playback(${baseDIR}/FOAS_dong13))
	same => n, ExecIf($[${BNxx} =14]?Playback(${baseDIR}/FOAS_dong14))
	same => n, ExecIf($[${BNxx} =15]?Playback(${baseDIR}/FOAS_dong15))
	same => n, ExecIf($[${BNxx} =16]?Playback(${baseDIR}/FOAS_dong16))
	same => n, ExecIf($[${BNxx} =17]?Playback(${baseDIR}/FOAS_dong17))
	same => n, ExecIf($[${BNxx} =18]?Playback(${baseDIR}/FOAS_dong18))
	same => n, ExecIf($[${BNxx} =19]?Playback(${baseDIR}/FOAS_dong19))

	same => n, Playback(${baseDIR}/FOAS_C15)				; 수량은.

	same => n, Playback(${baseDIR}/${F1})

	same => n, Return(0)





; ********************************************************************************
; *                                                                              *
; * 고객에게 사료 주문을 음성으로 남기도록 하고 음성 파일을 저장                 *
; *    - 2-1단계 : 음성으로 주문하기                                             *
; *    -                                                                         *
; *                                                                              *
; ********************************************************************************

[foas_record]
exten => start,1,Noop([foas_rec] Recieving Call[${EXTEN}] From [${CHANNEL(peerip)}])

	same => n, Set(baseDIR=sunjin)
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(reg_sts=0)		; 0=init_sts 1=reg_start 2=reg_save 3=reg_cancel

	same => n, Goto(bstart,1)


	; ================================================================================
	;                                                                                *
	; 2-1단계 : 사료 주문 내역을 음성으로 남기기                                     *
	;                                                                                *
	; - 음성 안내 멘트 내용(FOAS_0211 or FOAS_0212)                                  *
	;                                                                                *
	; ================================================================================

exten => bstart,1,Noop([foas_rec] ${STRFTIME(${EPOCH},,%F %T)} [${CALLER}] --> [${CALLEE}])

	same => n, Set(reg_sts=0)			; init_sts

	same => n(S21_recvRecStep), Set(ErrorCode=S21_recvRecStep)

;	same => n, read(SELNUM,${baseDIR}/FOAS_0211,1,n,1,2)	;
	same => n, read(SELNUM,${baseDIR}/FOAS_0212,1,n,1,2)	;
	                                        	; 음성으로 주문하면 주문 정보는 담당자에게 전달 됩니다.
	                                        	; 삐 소리를 들으신 후 제품을 받고자 하는 요일. 도착 시간.
	                                        	; 제품을 내려놓을 농장동 장소. 주문 수량을, 말해 주시고.
	                                        	; 녹음이 끝나면 #버튼을 눌러 주세요.
	                                        	; 녹음중에 통화를 종료하면 주문이 취소됩니다.
	                                                ; 안내 멘트를 다시 들으시려면 0번을.
	                                                ; 전 단계로 이동하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?S21_normal)
	same => n, GotoIf($["${SELNUM}"="*"]?S21_PreStep)

	same => n, GotoIf($[${SELNUM}=0]?S21_recvRecStep)
	same => n, Goto(S21_normal)


	; ----------------------------------------
	; 이전 단계로 이동
	; ----------------------------------------
	same => n(S21_PreStep), Set(ErrorCode=S21_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(foas_main,foas_start,1)


	; ----------------------------------------
	; 입력된 정보 없음
	; ----------------------------------------
	same => n(S21_normal), Set(ErrorCode=S21_normal)

	same => n, Playback(${baseDIR}/FOAS_031)	; 삐~~~~

	same => n, Set(recFileName=${NUM}-${CALLER}_${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}.wav)
	same => n, Set(savFileName=${recFileName})
	same => n, Set(reg_sts=1)			; reg_start

;	same => n, MixMonitor(${recFileName},p)		; // p:녹취 시작시 비프음을 보내줌
	same => n, MixMonitor(${recFileName})		; // p:녹취 시작시 비프음을 보내줌

	same => n, WaitExten(120)



	; ================================================================================
	;                                                                                *
	; 고객이 다이얼 버튼을 누르기를 기다리는 중 시스템에서 hangup이 발생하는 경우    *
	;                                                                                *
	; ================================================================================

exten => waiting,1, Noop(waiting ~~~)
	same => n, ExecIf($[${reg_sts}=1]?WaitExten(120))
	same => n, Noop()

exten => 0,1, Goto(waiting,1)
exten => 1,1, Goto(waiting,1)
exten => 2,1, Goto(waiting,1)
exten => 3,1, Goto(waiting,1)
exten => 4,1, Goto(waiting,1)
exten => 5,1, Goto(waiting,1)
exten => 6,1, Goto(waiting,1)
exten => 7,1, Goto(waiting,1)
exten => 8,1, Goto(waiting,1)
exten => 9,1, Goto(waiting,1)
exten => *,1, Goto(waiting,1)

exten => #,1, Noop(Waiting # Button  MIXMONITOR_FILENAME=[${MIXMONITOR_FILENAME}])

	same => n, ExecIf($[${reg_sts}=1]?Noop():WaitExten(120))

	; ----------------------------------------------------------------------
	; 음성 녹취 종료                                                       *
	; ----------------------------------------------------------------------
	same => n, StopMixMonitor()

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n(S41_recvSelNum), Set(ErrorCode=S41_recvSelNum)
	same => n, read(SELNUM,${baseDIR}/FOAS_041,1,n,1,9)	;
	                                                  	; 녹음된 주문 내용을 확인하려면 1번을.
	                                                  	; 녹음 내용을 저장하려면 2번을.
	                                                  	; 다시 녹음을 하려면 3번을.
	                                                  	; 녹음을 취소하려면 4번을.
	                                                  	; 안내 멘트를 다시 들으시려면 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S41_not_enter)
	same => n, GotoIf($["${SELNUM}"="*"]?S51_rerec)		; // 녹취 파일 삭제후 이전 단계로 이동

	same => n, GotoIf($[${SELNUM}=0]?S41_recvSelNum)
	same => n, GotoIf($[${SELNUM}=1]?S51_confirm)
	same => n, GotoIf($[${SELNUM}=2]?S41_store)
	same => n, GotoIf($[${SELNUM}=3]?S51_rerec)		; // 녹취 파일 삭제후 이전 단계로 이동
	same => n, GotoIf($[${SELNUM}=4]?S51_discard)



	; ----------------------------------------
	; 입력된 정보가 1,2,3,4,0,* 이 아닌 경우        
	; ----------------------------------------
	same => n(S41_wrong), Set(ErrorCode=S41_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S41_Error_1:S41_Error_2)

	same => n(S41_Error_1), Playback(${baseDIR}/FOAS_C07)	; 잘못 눌렀습니다.
	same => n, Goto(S41_recvSelNum)

	same => n(S41_Error_2), Playback(${baseDIR}/FOAS_C06)	;  이용해 주셔서 감사합니다.
	same => n, Goto(rec_Finish,1)


	; ----------------------------------------
	; 입력된 정보 없음
	; ----------------------------------------
	same => n(S41_not_enter), Set(ErrorCode=S41_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S41_Error_3:S41_Error_4)

	same => n(S41_Error_3), Playback(${baseDIR}/FOAS_C08)	; 입력된 정보가 없습니다.
	same => n, Goto(S41_recvSelNum)

	same => n(S41_Error_4), Playback(${baseDIR}/FOAS_C06)	;  이용해 주셔서 감사합니다.
	same => n, Goto(rec_Finish,1)

	; ----------------------------------------
	; 녹음 파일 저장하기
	; ----------------------------------------
	same => n(S41_store), Set(ErrorCode=S41_store)
	same => n, Goto(S51_store)




	; ================================================================================
	; 5-1 단계 : 녹음된 내용을 들려주고 고객의 선택에 의해                           *
	;               1) 녹음 파일 저장후 주문 완료                                    *
	;               2) 녹음 파일 삭제후 재 주문                                      *
	;               3) 녹음 파일 삭제후 주문 종료                                    *
	;               4) 5-1 단계 안내 멘트 들려주기                                   *
	; ================================================================================

	same => n(S51_confirm), Set(ErrorCode=S51_confirm)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(recFileName=${CUT(MIXMONITOR_FILENAME,.,1)})


	; ----------------------------------------
	; 주문 내용 다시 들려주기                 
	; ----------------------------------------
	same => n(S51_replayRec), Set(ErrorCode=S51_replayRec)

	same => n, Playback(${recFileName})			; // 녹음 내용을 들려줌
	same => n, Playback(${baseDIR}/FOAS_0511)		; 주문 내용을 확인하셨습니까?


	same => n(S51_recvSelNum), Set(ErrorCode=S51_recvSelNum)

	same => n, read(SELNUM,${baseDIR}/FOAS_0512,1,n,1,5)	;
	                                                   	; 주문 내용을 저장하려면 1번을.
	                                                   	; 다시 녹음하려면 2번을.
	                                                   	; 취소하려면 3번을.
	                                                   	; 안내 멘트를 다시 들으시려면 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S51_not_enter)
	same => n, GotoIf($["${SELNUM}"="*"]?S51_rerec)		; // 녹취 파일 삭제후 이전 단계로 이동

	same => n, GotoIf($[${SELNUM}=0]?S51_replayRec)		; // 주문 내용 다시 들려주기

	same => n, GotoIf($[${SELNUM}=1]?S51_store)
	same => n, GotoIf($[${SELNUM}=2]?S51_rerec)		; // 녹취 파일 삭제후 이전 단계로 이동
	same => n, GotoIf($[${SELNUM}=3]?S51_discard)		; // 녹취 파일 삭제후 통화 종료



	; ----------------------------------------
	; 입력된 정보가 1,2,3,0,* 이 아닌경우        
	; ----------------------------------------
	same => n(S51_wrong), Set(ErrorCode=S51_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S51_wrong_1:S51_wrong_2)

	same => n(S51_wrong_1), Playback(${baseDIR}/FOAS_C07)		; 잘못 눌렀습니다.
	same => n, Goto(S51_recvSelNum)

	same => n(S51_wrong_2), Playback(${baseDIR}/FOAS_C06)		; 이용해주셔서 감사합니다.
	same => n, Goto(rec_Finish,1)


	; ----------------------------------------
	; 입력된 정보 없음
	; ----------------------------------------
	same => n(S51_not_enter), Set(ErrorCode=S51_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S51_wrong_3:S51_wrong_4)

	same => n(S51_wrong_3), Playback(${baseDIR}/FOAS_C08)		; 입력된 정보가 없습니다.
	same => n, Goto(S51_recvSelNum)

	same => n(S51_wrong_4), Playback(${baseDIR}/FOAS_C06)		; 이용해주셔서 감사합니다.
	same => n, Goto(rec_Finish,1)

	same => n, Hangup()


	; ================================================================================
	; 사료 주문 녹취 내용 저장하고 주문 끝내기                                       *
	; ================================================================================
	same => n(S51_store), Set(ErrorCode=S51_store)

	same => n, Set(PathDir=/var/spool/asterisk/monitor/RECHDD)
	same => n, Set(EmergencyDir=bc2000)

	same => n, Set(FileSize=${STAT(s,${MIXMONITOR_FILENAME})})
;	same => n, Noop(recFileName=${MIXMONITOR_FILENAME} savFileName=${savFileName} FileSize=${FileSize})

	same => n, AGI(${agiDIR}/crm_get_user_code.php)
	same => n, Log(NOTICE, crm_get_user_code.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}]) USERCODE=[${USERCODE}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?agi_guc_access_fail)
	same => n, GotoIf($["${RESULT}"!="0000"]?agi_guc_result_fail)
	same => n, GotoIf($[${LEN(${USERCODE})}=0]?agi_guc_length_error);

	same => n, Set(RESULT1=****)
	same => n, AGI(${agiDIR}/crm_save_ars_record.php)
	same => n, Log(NOTICE, crm_save_ars_record.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?agi_sar_access_fail)
	same => n, GotoIf($["${RESULT}"="0000"]?reg_user_succ:agi_sar_result_fail)


	; ----------------------------------------
	; AGI 연동 실패시
	; ----------------------------------------
	same => n(agi_guc_access_fail), Set(ErrorCode=agi_guc_access_fail)
	same => n, Goto(agi_order_fail)

	same => n(agi_guc_result_fail), Set(ErrorCode=agi_guc_result_fail)
	same => n, Goto(agi_order_fail)

	same => n(agi_guc_length_error), Set(ErrorCode=agi_guc_length_error)
	same => n, Goto(agi_order_fail)

	same => n(agi_sar_access_fail), Set(ErrorCode=agi_sar_access_fail)
	same => n, Goto(agi_order_fail)

	same => n(agi_sar_result_fail), Set(ErrorCode=agi_sar_result_fail)
	same => n, Goto(agi_order_fail)

	same => n(agi_order_fail), Noop(ErrorCode=${ErrorCode})

	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Playback(${baseDIR}/FOAS_C16)	; 외부 장치에 접속하지 못하여, 주문이 취소되었습니다.
	                                        	; 확인후 이용해 주세요.

	same => n, Goto(rec_Finish,1)


	; ----------------------------------------
	; 입력된 정보 없음
	; ----------------------------------------
	same => n(end_on_reg_step), Set(ErrorCode=end_on_reg_step)

	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Goto(rec_GoodBye,1)


	; ----------------------------------------
	; 주문 정보를 DB에 저장하고 녹취 파일을 저장
	; ----------------------------------------
	same => n(reg_user_succ), Set(ErrorCode=reg_user_succ)

	same => n, Set(reg_sts=2)	; record_ok
	same => n, Set(record_data_Dir=${STAT(d,${PathDir}/record_data)})
	same => n, GotoIf($[${record_data_Dir}=0]?record_dir_not_exist)

	same => n, System(/var/lib/asterisk/agi-bin/crm/sunjin_foas.sh  ${PathDir} record_data ${USERCODE} ${CALLEE})
	same => n, Log(NOTICE, [mkdir] SYSTEMSTATUS=${SYSTEMSTATUS})
	same => n, GotoIf($["${SYSTEMSTATUS}"!="SUCCESS"]?make_rec_dir_fail)


	same => n, System(/bin/mv ${MIXMONITOR_FILENAME} ${PathDir}/record_data/${USERCODE}/${CALLEE}/.)
	same => n, Log(NOTICE, [UserCode_mv] SYSTEMSTATUS=${SYSTEMSTATUS})
	same => n, GotoIf($["${SYSTEMSTATUS}"!="SUCCESS"]?move_rec_file_fail)


	same => n, Playback(${baseDIR}/FOAS_C02)	; 주문 정보가 저장되었습니다.
	                                         	; 이용해 주셔서 감사합니다.
	same => n, Goto(rec_Finish,1)


	same => n(record_dir_not_exist), Set(ErrorCode=record_dir_not_exist)
	same => n, Goto(emergency_file_store)

	same => n(make_rec_dir_fail), Set(ErrorCode=make_rec_dir_fail)
	same => n, Goto(emergency_file_store)

	same => n(move_rec_file_fail), Set(ErrorCode=move_rec_file_fail)
	same => n, Goto(emergency_file_store)

	same => n(emergency_file_store), Set(ErrorCode=${ErrorCode})

	same => n, System(${agiPath}/poas_emer_recdir.sh ${recPath} ${emgDIR} ${USERCODE} )
	same => n, System(/bin/mv ${MIXMONITOR_FILENAME} ${recPath}/${emgDIR}/${USERCODE}/.)
;	same => n, System(/bin/mv ${MIXMONITOR_FILENAME} /var/spool/asterisk/monitor/.)

	same => n, Log(NOTICE, [EmergencyDir_mv] SYSTEMSTATUS=${SYSTEMSTATUS})
	same => n, Playback(${baseDIR}/FOAS_C17)	; 사료 주문 녹음 파일을,
	                                         	; 즉시 전송하지 못하여 주문이 지연될 수 있습니다. 
	                                         	; 주문 상태를 확인해 주세요.
	same => n, Playback(${baseDIR}/FOAS_C06)	; 이용해 주셔서 감사합니다.

	same => n, Goto(rec_Finish,1)


	; ================================================================================
	; 사료 주문 취소하고 재 주문하기                                                 *
	; ================================================================================
	same => n(S51_rerec), Set(ErrorCode=S51_rerec)

	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Goto(bstart,1)


	; ================================================================================
	; 사료 주문 취소하고 종료하기                                                    *
	; ================================================================================
	same => n(S51_discard),Set(ErrorCode=S51_discard)

	same => n, Playback(${baseDIR}/FOAS_C04)		; 주문 내용을 취소하였습니다.
	                                        		; 이용해 주셔서 감사합니다.
	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Set(reg_sts=3)				; reg_cancel

	same => n, Goto(rec_Finish,1)






exten => h,1, Noop(reg_sts=[${reg_sts}] MIXMONITOR_FILENAME=[${MIXMONITOR_FILENAME}] The_Caller_HangsUp_Recording)

	same => n, Log(NOTICE,[foas_hangup] [${CALLER}] : reg_sts=${reg_sts}/MIXMONITOR_FILENAME=[${MIXMONITOR_FILENAME}]/The_Caller_HangUp_Recoding)

	same => n, GotoIf($[${LEN(${MIXMONITOR_FILENAME})}=0]?reg_goodbye);

	same => n, ExecIf($[${reg_sts}=1]?System(/bin/rm ${MIXMONITOR_FILENAME}))

	same => n(reg_goodbye), Hangup()





	; ================================================================================
	;                                                                                *
	; ================================================================================
exten => rec_GoodBye,1, Noop(rec_GoodBye)
	same => n, Playback(${baseDIR}/FOAS_C06)	; 이용해 주셔서 감사합니다.
	same => n, Log(NOTICE,[rec_GoodBye] [${CALLER} --> ${CALLEE}] : ERR=[${ErrorCode}] )

	same => n, Hangup()


exten => rec_Finish,1, Noop(rec_Finish)
	same => n, Log(NOTICE,[rec_Finish] [${CALLER} --> ${CALLEE}] : ERR=[${ErrorCode}] )
	same => n, Hangup()
