; ********************************************************************************
; *                                                                              *
; * 제품 주문 서비스(POAS : Product Order Auto-response System)                  *
; *                                                                              *
; ********************************************************************************

[poas_main]

exten => _X.,1,Noop([poas_main] Recieving Call[${EXTEN}] From [${CHANNEL(peerip)}])

	same => n, Answer()

	; ----------------------------------------
	; INVITE HEAD 정보에서 발신번호 찾기
	; ----------------------------------------
	same => n, Set(FromNum=${CUT(SIP_HEADER(From),:,2)})
	same => n, Set(GLOBAL(CALLER)=${CUT(FromNum,@,1)})

	; ----------------------------------------
	; INVITE HEAD 정보에서 070 수신번호 찾기
	; ----------------------------------------
	same => n, Set(ToNum=${CUT(SIP_HEADER(To),:,2)})
	same => n, Set(GLOBAL(CALLEE)=${CUT(ToNum,@,1)})
	same => n, Set(PRE=${TONUM:3:4})
	same => n, Set(NUM=${TONUM:7:4})
	same => n, Set(NUM=${CALLEE:7:4})
	same => n, ExecIf($[${LEN(${CALLEE})}<11]?Set(NUM=${CALLEE}))

	same => n, Goto(poas_start,1)


exten => poas_start,1, Noop(poas_start)

	same => n, Set(baseDIR=poas)
	same => n, Set(agiDIR=crm)
	same => n, Set(agiPath=/var/lib/asterisk/agi-bin/${agiDIR})
	same => n, Set(recPath=/var/spool/asterisk/monitor)
	same => n, Set(emgDIR=EMGHDD)
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)


	; ================================================================================
	;                                                                                *
	; 1단계 안내 멘트                                                                *
	;                                                                                *
	;      - '0' 입력시 : 안내 멘트 다시 듣기                                        *
	;      - '1' 입력시 : 음성으로 제품 주문하기                                     *
	;      - '2' 입력시 : 버튼으로 제품 주문하기                                     *
	;      - 입력 오류 처리                                                          *
	;      - 미입력 처리                                                             *
	;                                                                                *
	; ================================================================================
	same => n(S1_recvSvcType), Set(ErrorCode=S1_recvSvcType)

	same => n, read(SELNUM,${baseDIR}/POAS_111,1,n,1,3)	;
	                                                   	; 안녕하세요.
	                                                   	; 주식회사 바로 서비스의 제품 주문 솔루션입니다.
	                                                   	; 음성으로 제품 주문을 하려면 1번을.
	                                                   	; 버튼으로 제품 주문을 하려면 2번을.
	                                                   	; 안내 멘트를 다시 들으려면 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S1_not_enter)
	same => n, GotoIf($["${SELNUM}"="*"]?S1_wrong)

	same => n, GotoIf($[${SELNUM}=0]?S1_recvSvcType)
	same => n, GotoIf($[${SELNUM}=1]?poas_record,start,1)
	same => n, GotoIf($[${SELNUM}=2]?poas_order,start,1)


	; ----------------------------------------
	; 입력된 정보가 0,1,2가 아닌 경우     
	; ----------------------------------------
	same => n(S1_wrong), Set(ErrorCode=S1_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S1_wrong_1:S1_GoodBye,1)

	same => n(S1_wrong_1), Playback(${baseDIR}/POAS_C13)	; 잘못 눌렀습니다.
	same => n, Goto(S1_recvSvcType)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S1_not_enter), Set(ErrorCode=S1_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S1_wrong_3:S1_GoodBye,1)

	same => n(S1_wrong_3), Playback(${baseDIR}/POAS_C14)	; 입력된 정보가 없습니다.
	same => n, Goto(S1_recvSvcType)



exten => S1_GoodBye,1, Noop(S1_GoodBye)
	same => n, Playback(${baseDIR}/POAS_C15)		; 이용해 주셔서 감사합니다.
	same => n, Log(NOTICE,[S1_GoodBye] [${CALLER} --> ${CALLEE}] : ERR=[${ErrorCode}] )
	same => n, Hangup()






; ********************************************************************************
; *                                                                              *
; * 고객이 안내멘트 순서에 따라 전화 버튼을 눌러 주문한다.                       *
; *    1. 날짜 정보 : 제품 받은 날짜를 MMDD 형태로 수신                          *
; *    2. 제품 코드 : 등록된 제품 코드 정보를 수신                               *
; *    3. 주문 수량 :                                                            *
; *                                                                              *
; ********************************************************************************

[poas_order]


exten => start,1,Noop([poas_order] ${STRFTIME(${EPOCH},,%F %T)} [${CALLER}] --> [${CALLEE}])

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	; ================================================================================
	;                                                                                *
	; 2-2 단계 : 제품 수령 날짜 정보 입력                                            *
	;                                                                                *
	; - 음성 안내 멘트 내용(POAS_221)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S22_recvDate), Set(ErrorCode=S22_recvDate})

	same => n, read(RecvDate,${baseDIR}/POAS_221,4,n,1,5)	;
	                                                    	; 주문한 제품을 받길 원하는 날짜 정보를 입력하세요.
	                                                    	; 날짜 정보는 4자리로 입력합니다.
	                                                    	; 6월 3일에 제품을 받으려면, 0, 6, 0, 3을.
	                                                    	; 12월 25일에 받으려면, 1, 2, 2, 5를 누르시면 됩니다.
	                                                    	; 안내 멘트를 다시 들으려면 0번과 #버튼을.
	                                                    	; 이전 단계로 이동하려면 별표와 #버튼을 누르세요.

	same => n, GotoIf($[${LEN(${RecvDate})}=0]?S22_not_enter)

	same => n, GotoIf($["${RecvDate}"="*"]?S22_PreStep)
	same => n, GotoIf($["${RecvDate}"="**"]?S22_PreStep)
	same => n, GotoIf($["${RecvDate}"="***"]?S22_PreStep)
	same => n, GotoIf($["${RecvDate}"="****"]?S22_PreStep)

	same => n, GotoIf($["${RecvDate}"="0"]?S22_recvDate)
	same => n, GotoIf($["${RecvDate}"="00"]?S22_recvDate)
	same => n, GotoIf($["${RecvDate}"="000"]?S22_recvDate)
	same => n, GotoIf($["${RecvDate}"="0000"]?S22_recvDate)

	same => n, Set(MM=${MATH(${RecvDate}/100,int)})
	same => n, Set(DD=${MATH(${RecvDate}%100,int)})

	same => n, GoSub(poas_date,start,1(${MM},${DD}))
	same => n, GotoIf($[${GOSUB_RETVAL} = 1]?S22_normal:S22_wrong)

	; ----------------------------------------
	; 입력된 월과 날짜에 오류가 있는 경우 
	; ----------------------------------------
	same => n(S22_wrong), Set(ErrorCode=S22_wrong)

	same => n, ExecIf($[${GOSUB_RETVAL} = 0]?Set(F1=${SPRINTF(${baseDIR}/POAS_C13)}))	; 잘못 눌렀습니다.
	same => n, ExecIf($[${GOSUB_RETVAL} = 2]?Set(F1=${SPRINTF(${baseDIR}/POAS_E01)}))	; 월 정보 입력 오류 입니다.
	same => n, ExecIf($[${GOSUB_RETVAL} = 3]?Set(F1=${SPRINTF(${baseDIR}/POAS_E02)}))	; 날짜 입력 오류 입니다.
	same => n, ExecIf($[${GOSUB_RETVAL} = 4]?Set(F1=${SPRINTF(${baseDIR}/POAS_E03)}))	; 금년 2월 29일은 없습니다.
	same => n, ExecIf($[${GOSUB_RETVAL} = 5]?Set(F1=${SPRINTF(${baseDIR}/POAS_E04)}))	; 내년 2월 29일은 없습니다.
	same => n, ExecIf($[${GOSUB_RETVAL} = 6]?Set(F1=${SPRINTF(${baseDIR}/POAS_E05)}))	; 지나간 달을 선택했습니다.
	same => n, ExecIf($[${GOSUB_RETVAL} = 7]?Set(F1=${SPRINTF(${baseDIR}/POAS_E06)}))	; 지나간 날짜를 선택했습니다.
	same => n, ExecIf($[${GOSUB_RETVAL} = 8]?Set(F1=${SPRINTF(${baseDIR}/POAS_E07)}))	; 당일 배송은 불가능합니다.
	same => n, ExecIf($[${GOSUB_RETVAL} = 9]?Set(F1=${SPRINTF(${baseDIR}/POAS_E08)}))	; 주문일부터 제품 도착은
	                                                                                  	; 최대 1개월 이내입니다.
	same => n, Playback(${F1})

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 6]?S22_wrong_1:order_GoodBye,1)

	same => n(S22_wrong_1), Noop(S22_wring_1)
	same => n, Goto(S22_recvDate)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S22_not_enter), Set(ErrorCode=S22_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S22_wrong_3:order_GoodBye,1)

	same => n(S22_wrong_3), Playback(${baseDIR}/POAS_C14)		; 입력된 정보가 없습니다.
	same => n, Goto(S22_recvDate)


	; ----------------------------------------
	; 이전 단계로 이동                
	; ----------------------------------------
	same => n(S22_PreStep), Set(ErrorCode=S22_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(poas_main,poas_start,1)


	; ----------------------------------------
	; 입력 정보 정상시                
	; ----------------------------------------
	same => n(S22_normal), Set(ErrorCode=S22_normal)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S32_recvCode)



	; ================================================================================
	;                                                                                *
	; 3-2단계 : 제품 코드 입력                                                       *
	;                                                                                *
	; - 음성 안내 멘트 내용(POAS_321)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S32_recvCode), Set(ErrorCode=S32_recvCode)

	same => n, read(RecvCode,${baseDIR}/POAS_321,2,n,1,5)	;
	                                                     	; 제품 코드를 입력하세요.
	                                                     	; 제품 코드는 01번부터 99번까지 2자리로 입력하시면 됩니다.
	                                                     	; 제품 안내를 들으려면 00번을.
	                                                     	; 안내 멘트를 다시 들으려면 0번과 #버튼을.
	                                                     	; 이전 단계로 이동하려면 별표를 누르세요.

	same => n(S32_checkCode), Noop(S32_checkCode)

	same => n, GotoIf($[${LEN(${RecvCode})}=0]?S32_not_enter)

	same => n, GotoIf($["${RecvCode}"="*"]?S32_PreStep)
	same => n, GotoIf($["${RecvCode}"="**"]?S32_PreStep)

	same => n, GotoIf($["${RecvCode}"="0"]?S32_recvCode)
	same => n, GotoIf($["${RecvCode}"="00"]?S32_PlayProductCode)

	same => n, AGI(${agiDIR}/crm_check_product_code.php)
	same => n, Log(NOTICE, crm_check_product_code.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?S32_agi_cpc_access_fail)
	same => n, GotoIf($["${RESULT}"="0000"]?S32_normal:S32_wrong)

	; ----------------------------------------
	; AGI 연동 실패시           
	; ----------------------------------------
	same => n(S32_agi_cpc_access_fail), Set(ErrorCode=32_agi_cpc_access_fail)
	same => n, Goto(S32_agi_check_fail)

	same => n(S32_agi_cpc_result_fail), Set(ErrorCode=32_agi_cpc_result_fail)
	same => n, Goto(S32_agi_check_fail)

	same => n(S32_agi_check_fail), Noop(ErrorCode=${ErrorCode})
	same => n, Playback(${baseDIR}/POAS_C16)	; 외부 장치에 접속하지 못하여, 주문이 취소되었습니다.
	                                        	; 확인후 이용해 주세요.
	same => n, Goto(order_Finish,1)


	; ----------------------------------------
	; 제품 코드가 없는 경우
	; ----------------------------------------
	same => n(S32_wrong), Set(ErrorCode=S32_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 6]?S32_wrong_1:order_GoodBye,1)

	same => n(S32_wrong_1), Playback(${baseDIR}/POAS_C18)	; 등록되지 않은 제품 코드입니다.
	same => n, Goto(S32_recvCode)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S32_not_enter), Set(ErrorCode=S32_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S32_wrong_3:order_GoodBye,1)

	same => n(S32_wrong_3), Playback(${baseDIR}/POAS_C14)	; 입력된 정보가 없습니다.
	same => n, Goto(S32_recvCode)


	; ----------------------------------------
	; 이전 단계로 이동                
	; ----------------------------------------
	same => n(S32_PreStep), Set(ErrorCode=S32_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S22_recvDate)

	; ----------------------------------------
	; 제품 코드 안내                 
	; ----------------------------------------
	same => n(S32_PlayProductCode), Set(ErrorCode=S32_PlayProductCode)
	same => n, read(RecvCode,${baseDIR}/POAS_322,2,n,1,5)	;
	                                                     	; 제품 코드 안내입니다.
	                                                     	; 지갑은 07번. 넥타이는 12번. 손수건은 13번.
	                                                     	; 모자는 24번. 벨트는 35번. 우산은 46번.
	                                                     	; 양산은 57번. 양말은 68번. 장갑은 79번.
	                                                     	; 스카프는 80번입니다.
	same => n, GotoIf($[${LEN(${RecvCode})}=0]?S32_recvCode:S32_checkCode)

	; ----------------------------------------
	; 입력 정보 정상시                
	; ----------------------------------------
	same => n(S32_normal), Set(ErrorCode=S32_normal)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S42_recvCount)



	; ================================================================================
	;                                                                                *
	; 4-2단계 : 주문 수량 받기                                                       *
	; - 주문 수량 : 1 ~ 999                                                          *
	; - 음성 안내 멘트 내용(POAS_421)                                                *
	;                                                                                *
	;                                                                                *
	; ================================================================================

	same => n(S42_recvCount), Set(ErrorCode=S42_recvCount)


	same => n, read(RecvCount,${baseDIR}/POAS_421,3,n,1,3)	;
	                                                       	; 주문 수량을 입력하세요.
	                                                       	; 주문 수량은 1개부터 999개까지 주문할 수 있습니다.
	                                                       	; 입력 방법은 주문 수량과 #버튼을 입력하면 됩니다.
	                                                       	; 안내 멘트를 다시 들으려면 0번과 #버튼을.
	                                                       	; 이전 단계로 이동하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${RecvCount})}=0]?S42_not_enter)

	same => n, GotoIf($["${RecvCount}"="*"]?S42_PreStep)
	same => n, GotoIf($["${RecvCount}"="**"]?S42_PreStep)
	same => n, GotoIf($["${RecvCount}"="***"]?S42_PreStep)

	same => n, GotoIf($[${RecvCount}=0]?S42_recvCount:S42_normal)


	; ----------------------------------------
	; 입력된 정보가 1 ~ 999가 아닌 경우     
	; ----------------------------------------
	same => n(S42_wrong), Set(ErrorCode=S42_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S42_wrong_1:order_GoodBye,1)

	same => n(S42_wrong_1), Playback(${baseDIR}/POAS_C13)	; 잘못 눌렀습니다.
	same => n, Goto(S42_recvCount)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S42_not_enter), Set(ErrorCode=S42_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S42_wrong_3:order_GoodBye,1)

	same => n(S42_wrong_3), Playback(${baseDIR}/POAS_C14)	; 입력된 정보가 없습니다.
	same => n, Goto(S42_recvCount)


	; ----------------------------------------
	; 이전 단계로 이동                
	; ----------------------------------------
	same => n(S42_PreStep), Set(ErrorCode=S42_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S32_recvCode)


	; ----------------------------------------
	; 입력 정보 정상시                
	; ----------------------------------------
	same => n(S42_normal), Set(ErrorCode=S42_normal)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S52_checkOrderInfo)



	; ================================================================================
	;                                                                                *
	; 5-2단계 : 주문 정보 확인                                                       *
	;                                                                                *
	; - 음성 안내 멘트 내용(POAS_521)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S52_checkOrderInfo), Set(ErrorCode=S52_checkOrderInfo)

	same => n, read(SELNUM,${baseDIR}/POAS_521,1,n,1,1)	; 주문이 완료 되었습니다.
	same => n, GotoIf($[${LEN(${SELNUM})}=1]?S52_checkOrderInfo3)

	same => n(S52_checkOrderInfo2), Set(ErrorCode=S52_checkOrderInfo2)
	same => n, read(SELNUM,${baseDIR}/POAS_522,1,n,1,3)	;
	                                                   	; 주문 내역 확인은 1번을.
	                                                   	; 주문 확정은 2번을. 
	                                                   	; 주문 취소는 3번을.
	                                                   	; 안내 멘트를 다시 들으려면 0번을.
	                                                   	; 이전 단계로 이동하려면 별표를 누르세요. 

	same => n(S52_checkOrderInfo3), Set(ErrorCode=S52_checkOrderInfo3)
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S52_not_enter)

	same => n, GotoIf($["${SELNUM}"="*"]?S52_PreStep)

	same => n, GotoIf($[${SELNUM}=0]?S52_checkOrderInfo2)
	same => n, GotoIf($[${SELNUM}=1]?S52_listen_OrderInfo)
	same => n, GotoIf($[${SELNUM}=2]?S52_confirmOrderInfo)
	same => n, GotoIf($[${SELNUM}=3]?S52_cancel_OrderInfo)



	; ----------------------------------------
	; 입력된 정보가 0,1,2,3,*이 아닌 경우     
	; ----------------------------------------
	same => n(S52_wrong), Set(ErrorCode=S52_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S52_wrong_1:order_GoodBye,1)

	same => n(S52_wrong_1), Playback(${baseDIR}/POAS_C13)	; 잘못 눌렀습니다.
	same => n, Goto(S52_checkOrderInfo2)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S52_not_enter), Set(ErrorCode=S52_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S52_wrong_3:order_GoodBye,1)

	same => n(S52_wrong_3), Playback(${baseDIR}/POAS_C14)	; 입력된 정보가 없습니다.
	same => n, Goto(S52_checkOrderInfo2)


	; ----------------------------------------
	; 이전 단계로 이동                
	; ----------------------------------------
	same => n(S52_PreStep), Set(ErrorCode=S52_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S42_recvCount)


	; ----------------------------------------
	; 주문 정보 내역 듣기              
	; ----------------------------------------
	same => n(S52_listen_OrderInfo), Set(ErrorCode=S52_listen_OrderInfo)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S62_listen_OrderInfo)


	; ----------------------------------------
	; 주문 정보 확정하기               
	; ----------------------------------------
	same => n(S52_confirmOrderInfo), Set(ErrorCode=S52_confirmOrderInfo)

	same => n, Goto(S62_confirmOrderInfo)



	; ----------------------------------------
	; 주문 정보 취소하고 종료하기          
	; ----------------------------------------
	same => n(S52_cancel_OrderInfo), Set(ErrorCode=S52_cancel_OrderInfo)

	same => n, Playback(${baseDIR}/POAS_C12)	; 주문을 취소하였습니다.
	                                        	; 이용해 주셔서 감사합니다.
	same => n, Goto(order_Finish,1)




	; ================================================================================
	;                                                                                *
	; 6-2단계 : 주문 정보 확인                                                       *
	;                                                                                *
	; - 음성 안내 멘트 내용(POAS_082)                                                *
	;                                                                                *
	; ================================================================================

	same => n(S62_listen_OrderInfo), Set(ErrorCode=S62_listen_OrderInfo})

	same => n, Playback(${baseDIR}/POAS_621)		; 고객님의 주문 내역입니다.

;--------------------------------------------------------------------------------------------------------

	same => n(S62_listen_OrderInfo2), Set(ErrorCode=S62_listen_OrderInfo2})

	same => n, GoSub(poas_listen,start,1(${MM},${DD},${RecvCode},${RecvCount}))


;--------------------------------------------------------------------------------------------------------

	same => n(S62_recvSelNum), Set(ErrorCode=S62_recvSelNum})

	same => n, read(SELNUM,${baseDIR}/POAS_622,1,n,1,3)	;
	                                                    	; 주문 내용 다시 듣기는 1번을.
	                                                    	; 주문 내용이 맞으면 2번을.
	                                                    	; 주문 취소는 3번을.
	                                                    	; 다시 입력 하려면 4번을.
	                                                    	; 안내 멘트를 다시 들으려면 0번을 누르세요.
	                                                    	; 통화를 종료하면 주문은 취소됩니다.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S62_not_enter)
	same => n, GotoIf($["${SELNUM}"="*"]?S62_wrong)

	same => n, GotoIf($[${SELNUM}=0]?S62_recvSelNum)
	same => n, GotoIf($[${SELNUM}=1]?S62_listen_OrderInfo2)
	same => n, GotoIf($[${SELNUM}=2]?S62_confirmOrderInfo)
	same => n, GotoIf($[${SELNUM}=3]?S62_cancel_OrderInfo)
	same => n, GotoIf($[${SELNUM}=4]?S62_reEnterOrderInfo)


	; ----------------------------------------
	; 입력된 정보가 0,1,2,3,4,*이 아닌 경우     
	; ----------------------------------------
	same => n(S62_wrong), Set(ErrorCode=S62_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 10]?S62_wrong_1:order_GoodBye,1)

	same => n(S62_wrong_1), Playback(${baseDIR}/POAS_C13)	; 잘못 눌렀습니다.
	same => n, Goto(S62_recvSelNum)


	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(S62_not_enter), Set(ErrorCode=S62_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 10]?S62_wrong_3:order_GoodBye,1)

	same => n(S62_wrong_3), Playback(${baseDIR}/POAS_C14)	; 입력된 정보가 없습니다.
	same => n, Goto(S62_recvSelNum)


	; ----------------------------------------
	; 주문 정보 확정하기               
	; ----------------------------------------
	same => n(S62_confirmOrderInfo), Set(ErrorCode=S62_confirmOrderInfo)

	same => n, AGI(${agiDIR}/crm_save_ars_button_demo.php)
	same => n, Log(NOTICE, crm_save_ars_button_demo.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?S62_agi_sab_access_fail)
	same => n, GotoIf($["${RESULT}"!="0000"]?S62_agi_sab_result_fail)

	same => n, Playback(${baseDIR}/POAS_C11)	; 주문 내용을 저장하였습니다.
	                                        	; 이용해 주셔서 감사합니다.
	same => n, Goto(order_Finish,1)


	; ----------------------------------------
	; AGI 연동 실패시           
	; ----------------------------------------
	same => n(S62_agi_sab_access_fail), Set(ErrorCode=S62_agi_sab_access_fail)
	same => n, Goto(S62_agi_insert_fail)

	same => n(S62_agi_sab_result_fail), Set(ErrorCode=S62_agi_sab_result_fail)
	same => n, Goto(S62_agi_insert_fail)

	same => n(S62_agi_insert_fail), Noop(ErrorCode=${ErrorCode})
	same => n, Playback(${baseDIR}/POAS_C16)	; 외부 장치에 접속하지 못하여, 주문이 취소되었습니다.
	                                        	; 확인후 이용해 주세요.
	same => n, Goto(order_Finish,1)


	; ----------------------------------------
	; 주문 정보 처음부터 재 입력하기        
	; ----------------------------------------
	same => n(S62_reEnterOrderInfo), Set(ErrorCode=S62_reEnterOrderInfo)

	same => n, Playback(${baseDIR}/POAS_C19)	; 주문 정보를 다시 입력하겠습니다.

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(S22_recvDate)


	; ----------------------------------------
	; 주문 정보 취소하고 종료하기          
	; ----------------------------------------
	same => n(S62_cancel_OrderInfo), Set(ErrorCode=S62_cancel_OrderInfo)

	same => n, Playback(${baseDIR}/POAS_C12)	; 주문 내용을 취소하였습니다.
	                                        	; 이용해 주셔서 감사합니다.
	same => n, Goto(order_Finish,1)



	; ================================================================================
	;                                                                                *
	; ================================================================================
exten => order_GoodBye,1, Noop(order_GoodBye)
	same => n, Log(NOTICE,[order_GoodBye] [${CALLER} --> ${CALLEE}] ERR=[${ErrorCode}] )
	same => n, Playback(${baseDIR}/POAS_C15)	; 이용해 주셔서 감사합니다.

	same => n, Hangup()


exten => order_Finish,1, Noop(order_Finish)
	same => n, Log(NOTICE,[order_Finish] [${CALLER} --> ${CALLEE}] ERR=[${ErrorCode}] )

	same => n, Hangup()






; ********************************************************************************
; *                                                                              *
; * 입력된 날짜가 정상인지 여부를 체크한다.                                      *
; * 1) 입력된 월 정보가 올바른지 여부 : 1 ~ 12                                   *
; * 1) 입력된 달의 날짜가 맞는지 여부 : 1 ~ 31                                   *
; *    -  1,3,5,7,8,10,12월 : 1~31체크                                           *
; *    -  4,6,9,11월 : 1 ~ 30 체크                                               *
; *    -  2월 : 평년인지 윤년인지 여부 확인                                      *
; *                                                                              *
; ********************************************************************************
[poas_date]
exten => start,1,Noop(poas_date)
	same => n, Set(LOCAL(YEAR)=${STRFTIME(${EPOCH},,%m%d%Y-%H:%M:%S)})
	same => n, Set(LOCAL(YEAR)=${CUT(STRFTIME(${EPOCH},,%m%d%Y-%H:%M:%S),-,1)})
	same => n, Set(LOCAL(YEAR)=${MATH(${YEAR}%10000,int)})

	same => n, Set(LOCAL(MD)=${MATH($[${CUT(STRFTIME(${EPOCH},,%m%d%Y-%H:%M:%S),-,1)}]/10000,int)} )

	same => n, Set(LOCAL(YEAR)=${MATH($[${CUT(STRFTIME(${EPOCH},,%m%d%Y-%H:%M:%S),-,1)}]%10000,int)} )
	same => n, Set(LOCAL(MONTH)=${MATH(${MD}/100,int)})
	same => n, Set(LOCAL(DATE)=${MATH(${MD}%100,int)})

	same => n, Set(LOCAL(MM)=${ARG1})
	same => n, Set(LOCAL(DD)=${ARG2})

	; ----------------------------------------
	; 월 입력 정보 체크 : 1 ~ 12이면 정상
	; ----------------------------------------
	same => n, GotoIf($[${MM}=0]?rte_falseMonth)
	same => n, GotoIf($[${MM}>12]?rte_falseMonth)

	; ----------------------------------------
	; 일자 입력 정보 체크 : 1 ~ 31이면 정상
	; ----------------------------------------
	same => n, GotoIf($[${DD}=0]?rte_falseDay)
	same => n, GotoIf($[${DD}>31]?rte_falseDay)


	; ----------------------------------------
	; 각 달별로 입력 정보 체크
	; ----------------------------------------
	same => n, GotoIf($[${MM}=2]?year_checkFEB)

	same => n, GotoIf($[${MM}=4]?year_checkDay30)
	same => n, GotoIf($[${MM}=6]?year_checkDay30)
	same => n, GotoIf($[${MM}=9]?year_checkDay30)
	same => n, GotoIf($[${MM}=11]?year_checkDay30:year_checkDay31)


	same => n(year_checkDay30), Noop(year_checkDay30)
	same => n, GotoIf($[${DD}>30]?rte_falseDay:rte_true)

	same => n(year_checkDay31), Noop(year_checkDay31)
	same => n, Goto(rte_true)


	; ----------------------------------------
	; 2월달 체크
	; ----------------------------------------
	same => n(year_checkFEB), Noop(year_checkFEB)
	same => n, GotoIf($[${DD}>29]?rte_falseDay:rte_true)
;	same => n, GotoIf($[${DD}<29]?rte_true)

	; ----------------------------------------
	; 2월 29일 체크 : 윤년이면 TRUE                 
	; ----------------------------------------
	same => n(check_leaf), Noop(check_leaf)
	same => n, GotoIf($[$[{${YEAR} %   4] = 0]?:none_this29)
	same => n, GotoIf($[$[{${YEAR} % 100] = 0]?:rte_OK)
	same => n, GotoIf($[$[{${YEAR} % 400] = 0]?rte_true:none_this29)


	; ----------------------------------------
	; 입력 날짜 정보 오류시
	; ----------------------------------------
	same => n(rte_false), Noop(rte_false)
	same => n, Return(0)

	; ----------------------------------------
	; 입력 날짜 정보 정상시
	; ----------------------------------------
	same => n(rte_true), Noop(rte_true)

;	same => n, GotoIf($[${MM}<${MONTH}]?rte_LastMonth)
	same => n, GotoIf($[${MM}>${MONTH}]?check_0229)

;	same => n, GotoIf($[${DD}<${DATE}]?rte_LastDay)
	same => n, GotoIf($[${DD}>${DATE}]?check_0229)
;	same => n, GotoIf($[${DD}=${DATE}]?rte_today)

	same => n(check_0229), Noop(check_0229)
	same => n, GotoIf($[${MM}=2]?:rte_OK)
	same => n, GotoIf($[${DD}=29]?check_leaf:rte_OK)


	same => n(rte_OK), Noop(rte_OK)
	same => n, Return(1)

	; ----------------------------------------
	; 입력 월 정보 오류시
	; ----------------------------------------
	same => n(rte_falseMonth), Noop(rte_falseMonth)
	same => n, Return(2)

	; ----------------------------------------
	; 입력 날짜 정보 오류시
	; ----------------------------------------
	same => n(rte_falseDay), Noop(rte_falseDay)
	same => n, Return(3)

	; ----------------------------------------
	; 금년 2월 29일 정보 오류시
	; ----------------------------------------
	same => n(none_this29), Noop(none_this29)
	same => n, Return(4)

	; ----------------------------------------
	; 내년 2월 29일 정보 오류시
	; ----------------------------------------
	same => n(rte_Next29), Noop(rte_Next29)
	same => n, Return(5)

	; ----------------------------------------
	; 지난 달을 입력할 시
	; ----------------------------------------
	same => n(rte_LastMonth), Noop(rte_LastMonth)
	same => n, Return(6)

	; ----------------------------------------
	; 지난 날짜를 입력할 시
	; ----------------------------------------
	same => n(rte_LastDay), Noop(rte_LastDay)
	same => n, Return(7)

	; ----------------------------------------
	; 당일 날짜를 입력할 시
	; ----------------------------------------
	same => n(rte_today), Noop(rte_today)
	same => n, Return(8)

	; ----------------------------------------
	; 입력 날짜가 금일부터 1개월 초과시
	; ----------------------------------------
	same => n(rte_pass30), Noop(rte_pass30)
	same => n, Return(9)




; ********************************************************************************
; *                                                                              *
; * 제품 코드와 주문 수량을 음성으로 안내                                        *
; *                                                                              *
; ********************************************************************************

[poas_listen]
exten => start,1,Noop(poas_listen)
	same => n,Set(LOCAL(MM)=${ARG1})
	same => n,Set(LOCAL(DD)=${ARG2})
	same => n,Set(LOCAL(Code)=${ARG3})
	same => n,Set(LOCAL(Count)=${ARG4})

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, ExecIf($[${MM} < 10]?Set(D1=${SPRINTF(${baseDIR}/POAS_M0%d,${MM})}))
	same => n, ExecIf($[${MM} >  9]?Set(D1=${SPRINTF(${baseDIR}/POAS_M%d,${MM})}))

	same => n, ExecIf($[${DD} < 10]?Set(D2=${SPRINTF(${baseDIR}/POAS_D0%d,${DD})}))
	same => n, ExecIf($[${DD} >  9]?Set(D2=${SPRINTF(${baseDIR}/POAS_D%d,${DD})}))

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, ExecIf($[${Code} < 10]?Set(P1=${SPRINTF(${baseDIR}/POAS_P0%d,${Code})}))
	same => n, ExecIf($[${Code} >  9]?Set(P1=${SPRINTF(${baseDIR}/POAS_P%d,${Code})}))

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, Set(zx000=${MATH($[${Count}/1000]%10,int)})
	same => n, Set(z0x00=${MATH($[${Count}/100]%10,int)})
	same => n, Set(z00x0=${MATH($[${Count}/10]%10,int)})
	same => n, Set(z000x=${MATH(${Count}%10,int)})

	; ----------------------------------------
	; 1 ~ 9 인 경우                              
	; ----------------------------------------
	same => n, Gotoif(${zx000}>0?sxxxx)
	same => n, Gotoif(${z0x00}>0?s0xxx)
	same => n, Gotoif(${z00x0}>0?s00xx)
	same => n, Set(CN=${SPRINTF(${baseDIR}/POAS_G0%d,${z000x})})
	same => n, Goto(sEnd)

	; ----------------------------------------
	; 10 ~ 99 인 경우                              
	; ----------------------------------------
	same => n(s00xx), Noop(s00xx)
	same => n, Set(C1=${SPRINTF(${baseDIR}/POAS_ZS%d,${z00x0})})
	same => n, Set(C2=${SPRINTF(${baseDIR}/POAS_G0%d,${z000x})})
	same => n, Set(CN=${SPRINTF(%s&%s,${C1},${C2})})

	same => n, ExecIf($[${z000x} = 0]?Set(CN=${SPRINTF(${baseDIR}/POAS_GS%d,${z00x0})}))
	same => n, Goto(sEnd)

	; ----------------------------------------
	; 100 ~ 999 인 경우                              
	; ----------------------------------------
	same => n(s0xxx), Noop(s0xxx)
	same => n, Set(C1=${SPRINTF(${baseDIR}/POAS_ZB%d,${z0x00})})
	same => n, Set(C2=${SPRINTF(${baseDIR}/POAS_ZS%d,${z00x0})})
	same => n, Set(C3=${SPRINTF(${baseDIR}/POAS_G0%d,${z000x})})

	same => n, Set(CN=${SPRINTF(%s&%s&%s,${C1},${C2},${C3})})
	same => n, ExecIf($[${z00x0} = 0]?Set(CN=${SPRINTF(%s&%s,${C1},${C3})})

	same => n, GotoIf($[${z000x} = 0]?s1xxx:sEnd)

	same => n(s1xxx), Noop(s1xxx)
	same => n, Set(C2=${SPRINTF(${baseDIR}/POAS_GS%d,${z00x0})})
	same => n, Set(CN=${SPRINTF(%s&%s,${C1},${C2})})
	same => n, ExecIf($[${z00x0} = 0]?Set(CN=${SPRINTF(${baseDIR}/POAS_GB%d,${z0x00})}))
	same => n, Goto(sEnd)

	; ----------------------------------------
	; 1000 ~ 9999 인 경우                              
	; ----------------------------------------
	same => n(sxxxx), Noop(sxxxx)
	same => n, Set(z0xx0=${MATH($[${Count}/10]%100,int)})

	same => n, Set(C1=${SPRINTF(${baseDIR}/POAS_ZC%d,${zx000})})
	same => n, Set(C2=${SPRINTF(${baseDIR}/POAS_ZB%d,${z0x00})})
	same => n, Set(C3=${SPRINTF(${baseDIR}/POAS_ZS%d,${z00x0})})
	same => n, Set(C4=${SPRINTF(${baseDIR}/POAS_G0%d,${z000x})})

	same => n, Set(CN=${SPRINTF(%s&%s&%s&%s,${C1},${C2},${C3},${C4})})
	same => n, ExecIf($[${z0x00} = 0]?Set(CN=${SPRINTF(%s&%s&%s,${C1},${C3},${C4})})
	same => n, ExecIf($[${z00x0} = 0]?Set(CN=${SPRINTF(%s&%s&%s,${C1},${C2},${C4})})
	same => n, ExecIf($[${z0xx0} = 0]?Set(CN=${SPRINTF(%s&%s,${C1},${C4})})

	same => n, GotoIf($[${z000x} = 0]?s2xxx:sEnd)

	same => n(s2xxx), Noop(s2xxx)
	same => n, Set(C3=${SPRINTF(${baseDIR}/POAS_GS%d,${z00x0})})
	same => n, Set(CN=${SPRINTF(%s&%s&%s,${C1},${C2},${C3})})

	same => n, GotoIf($[${z00x0} = 0]?s21xx)
	same => n, Goto(sEnd)

	same => n(s21xx), Noop(s21xx)
	same => n, Set(C2=${SPRINTF(${baseDIR}/POAS_GB%d,${z0x00})})
	same => n, Set(CN=${SPRINTF(%s&%s,${C1},${C2})})
	same => n, ExecIf($[${z0x00} = 0]?Set(CN=${SPRINTF(${baseDIR}/POAS_GC%d,${zx000})})
	same => n, Goto(sEnd)


	same => n(sEnd), Noop(sEnd)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, Playback(${baseDIR}/POAS_623)				; 주문하신 제품이 도착하는 날은.
	same => n, Playback(${D1}&${D2})					; X월 X일
	same => n, Playback(${baseDIR}/POAS_6243)				; 입니다.

	same => n, Playback(${baseDIR}/POAS_6241)				; 주문하신 제품은.
	same => n, Playback(${P1})						; [제품명]
	same => n, Playback(${baseDIR}/POAS_6245)				; 이고

	same => n, Playback(${baseDIR}/POAS_6242)				; 주문 수량은. 
	same => n, Playback(${CN})						; [XXX] 개
	same => n, Playback(${baseDIR}/POAS_6243)				; 입니다.

	same => n, Return(0)





; ********************************************************************************
; *                                                                              *
; * 고객에게 제품 주문을 음성으로 남기도록 하고 음성 파일을 저장                 *
; *    - 2-1단계 : 음성으로 주문하기                                             *
; *    -                                                                         *
; *                                                                              *
; ********************************************************************************

[poas_record]
exten => start,1,Noop([poas_record] Recieving Call[${EXTEN}] From [${CHANNEL(peerip)}])

	same => n, Set(baseDIR=poas)
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(reg_sts=0)		; 0=init_sts 1=reg_start 2=reg_save 3=reg_cancel

	same => n, Goto(bstart,1)


	; ================================================================================
	;                                                                                *
	; 2-1단계 : 제품 주문 내역을 음성으로 남기기                                     *
	;                                                                                *
	; - 음성 안내 멘트 내용(POAS_0211 or POAS_0212)                                  *
	;                                                                                *
	; ================================================================================

exten => bstart,1,Noop([poas_rec] ${STRFTIME(${EPOCH},,%F %T)} [${CALLER}] --> [${CALLEE}])

	same => n, Set(reg_sts=0)			; init_sts

	same => n(S21_recvRecStep), Set(ErrorCode=S21_recvRecStep)

	same => n, read(SELNUM,${baseDIR}/POAS_211,1,n,1,2)	;
	                                                  	; 음성으로 주문하면 주문 정보는 담당자에게 전달 됩니다.
	                                                  	; 삐 소리를 들으신 후 제품을 받고자 하는
	                                                  	; 날짜. 제품 코드. 주문 수량을 말하고. 
	                                                  	; 녹음이 끝나면 #버튼을 누르세요.
	                                                  	; 녹음 중에 통화를 종료하면 주문은 취소됩니다.
	                                                  	; 안내 멘트를 다시 들으려면 0번을.
	                                                  	; 이전 단계로 이동 하려면 별표를 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?S21_normal)
	same => n, GotoIf($["${SELNUM}" = "*"]?S21_PreStep)

	same => n, GotoIf($[${SELNUM}=0]?S21_recvRecStep)
	same => n, Goto(S21_normal)


	; ----------------------------------------
	; 이전 단계로 이동
	; ----------------------------------------
	same => n(S21_PreStep), Set(ErrorCode=S21_PreStep)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Goto(poas_main,poas_start,1)


	; ----------------------------------------
	; 입력된 정보 없음
	; ----------------------------------------
	same => n(S21_normal), Set(ErrorCode=S21_normal)

	same => n, Playback(${baseDIR}/POAS_311)	; 삐~~~~

	same => n, Set(recFileName=${NUM}-${CALLER}_${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}.wav)
	same => n, Set(savFileName=${recFileName})
	same => n, Set(reg_sts=1)			; reg_start

;	same => n, MixMonitor(${recFileName},p)		; // p:녹취 시작시 비프음을 보내줌
	same => n, MixMonitor(${recFileName})		; // p:녹취 시작시 비프음을 보내줌

	same => n, WaitExten(120)


	; ================================================================================
	;                                                                                *
	; 고객이 # 버튼을 누르기를 기다리는 중                                           *
	; 3-1단계 : 음성 녹취중                                                          *
	;                                                                                *
	; ================================================================================

exten => waiting,1, Noop(waiting ~~~)
	same => n, ExecIf($[${reg_sts}=1]?WaitExten(120))
	same => n, Noop()

exten => 0,1, Goto(waiting,1)
exten => 1,1, Goto(waiting,1)
exten => 2,1, Goto(waiting,1)
exten => 3,1, Goto(waiting,1)
exten => 4,1, Goto(waiting,1)
exten => 5,1, Goto(waiting,1)
exten => 6,1, Goto(waiting,1)
exten => 7,1, Goto(waiting,1)
exten => 8,1, Goto(waiting,1)
exten => 9,1, Goto(waiting,1)
exten => *,1, Goto(waiting,1)

exten => #,1, Noop(Waiting # Button  MIXMONITOR_FILENAME=[${MIXMONITOR_FILENAME}])

	same => n, ExecIf($[${reg_sts}=1]?Noop():WaitExten(120))


	; ================================================================================
	;                                                                                *
	; 4-1단계 : 음성 녹취 종료 및 다음 단계 진행                                     *
	;                                                                                *
	; ================================================================================
	same => n, StopMixMonitor()

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n(S41_recvSelNum), Set(ErrorCode=S41_recvSelNum)
	same => n, read(SELNUM,${baseDIR}/POAS_411,1,n,1,9)	;
	                                                  	; 녹음 내용 듣기는 1번을.
	                                                  	; 녹음 내용 저장은 2번을.
	                                                  	; 녹음 다시 하기는 3번을.
	                                                  	; 녹음 취소는 4번을.
	                                                  	; 안내 멘트를 다시 들으려면 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S41_not_enter)
	same => n, GotoIf($["${SELNUM}"="*"]?S51_rerec)		; // 녹취 파일 삭제후 이전 단계로 이동

	same => n, GotoIf($[${SELNUM}=0]?S41_recvSelNum)
	same => n, GotoIf($[${SELNUM}=1]?S51_confirm)		; // 5-1 단계로 이동
	same => n, GotoIf($[${SELNUM}=2]?S41_store)
	same => n, GotoIf($[${SELNUM}=3]?S51_rerec)		; // 녹취 파일 삭제후 이전 단계로 이동
	same => n, GotoIf($[${SELNUM}=4]?S51_discard)



	; ----------------------------------------
	; 입력된 정보가 1,2,3,4,0,* 이 아닌 경우        
	; ----------------------------------------
	same => n(S41_wrong), Set(ErrorCode=S41_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S41_Error_1:S41_Error_2)

	same => n(S41_Error_1), Playback(${baseDIR}/POAS_C13)	; 잘못 눌렀습니다.
	same => n, Goto(S41_recvSelNum)

	same => n(S41_Error_2), Playback(${baseDIR}/POAS_C15)	;  이용해 주셔서 감사합니다.
	same => n, Goto(rec_Finish,1)


	; ----------------------------------------
	; 입력된 정보 없음
	; ----------------------------------------
	same => n(S41_not_enter), Set(ErrorCode=S41_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S41_Error_3:S41_Error_4)

	same => n(S41_Error_3), Playback(${baseDIR}/POAS_C14)	; 입력된 정보가 없습니다.
	same => n, Goto(S41_recvSelNum)

	same => n(S41_Error_4), Playback(${baseDIR}/POAS_C15)	;  이용해 주셔서 감사합니다.
	same => n, Goto(rec_Finish,1)

	; ----------------------------------------
	; 녹음 파일 저장하기
	; ----------------------------------------
	same => n(S41_store), Set(ErrorCode=S41_store)
	same => n, Goto(S51_store)




	; ================================================================================
	; 5-1 단계 : 녹음된 내용을 들려주고 고객의 선택에 의해                           *
	;               1) 5-1 단계 안내 멘트 들려주기                                   *
	;               2) 녹음 파일 저장후 주문 완료                                    *
	;               3) 녹음 파일 삭제후 재 주문                                      *
	;               4) 녹음 파일 삭제후 주문 종료                                    *
	; ================================================================================

	same => n(S51_confirm), Set(ErrorCode=S51_confirm)

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(recFileName=${CUT(MIXMONITOR_FILENAME,.,1)})


	; ----------------------------------------
	; 주문 내용 다시 들려주기                 
	; ----------------------------------------
	same => n(S51_replayRec), Set(ErrorCode=S51_replayRec)

	same => n, read(SELNUM,${recFileName},1,n,1,1)		; // 녹음된 내용을 들려줌

	same => n, GotoIf($[${LEN(${SELNUM})}=1]?S51_recvSelNum)

	same => n, read(SELNUM,${baseDIR}/POAS_511,1,n,1,1)	; 주문 내용을 확인하셨습니까?

	same => n, GotoIf($[${LEN(${SELNUM})}=1]?S51_recvSelNum2)

	same => n(S51_recvSelNum), Set(ErrorCode=S51_recvSelNum)

	same => n, read(SELNUM,${baseDIR}/POAS_512,1,n,1,5)	;
	                                                   	; 주문 내용 듣기는 1번을.
	                                                   	; 주문 내용 저장은 2번을.
	                                                   	; 주문 다시 하기는 3번을.
	                                                   	; 주문 취소는 4번을.
	                                                   	; 안내 멘트를 다시 들으려면 0번을 누르세요.

	same => n(S51_recvSelNum2), Set(ErrorCode=S51_recvSelNum2)

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S51_not_enter)
	same => n, GotoIf($["${SELNUM}"="*"]?S51_rerec)		; // 녹취 파일 삭제후 이전 단계로 이동

	same => n, GotoIf($[${SELNUM}=0]?S51_recvSelNum)	; // 안내 멘트 다시 들려주기

	same => n, GotoIf($[${SELNUM}=1]?S51_replayRec)		; // 주문 내용 다시 들려주기
	same => n, GotoIf($[${SELNUM}=2]?S51_store)
	same => n, GotoIf($[${SELNUM}=3]?S51_rerec)		; // 녹취 파일 삭제후 이전 단계로 이동
	same => n, GotoIf($[${SELNUM}=4]?S51_discard)		; // 녹취 파일 삭제후 통화 종료



	; ----------------------------------------
	; 입력된 정보가 1,2,3,0,* 이 아닌경우        
	; ----------------------------------------
	same => n(S51_wrong), Set(ErrorCode=S51_wrong)

	same => n, Set(countWRONG=[${countWRONG}+1])
	same => n, GotoIF($[${countWRONG} < 3]?S51_wrong_1:S51_wrong_2)

	same => n(S51_wrong_1), Playback(${baseDIR}/POAS_C13)		; 잘못 눌렀습니다.
	same => n, Goto(S51_recvSelNum)

	same => n(S51_wrong_2), Playback(${baseDIR}/POAS_C15)		; 이용해주셔서 감사합니다.
	same => n, Goto(rec_Finish,1)


	; ----------------------------------------
	; 입력된 정보 없음
	; ----------------------------------------
	same => n(S51_not_enter), Set(ErrorCode=S51_not_enter)

	same => n, Set(countENTER=[${countENTER}+1])
	same => n, GotoIF($[${countENTER} < 3]?S51_wrong_3:S51_wrong_4)

	same => n(S51_wrong_3), Playback(${baseDIR}/POAS_C14)		; 입력된 정보가 없습니다.
	same => n, Goto(S51_recvSelNum)

	same => n(S51_wrong_4), Playback(${baseDIR}/POAS_C15)		; 이용해주셔서 감사합니다.
	same => n, Goto(rec_Finish,1)

	same => n, Hangup()


	; ================================================================================
	; 제품 주문 녹취 내용 저장하고 주문 끝내기                                       *
	; ================================================================================
	same => n(S51_store), Set(ErrorCode=S51_store)

	same => n, Set(PathDir=/var/spool/asterisk/monitor/RECHDD)
	same => n, Set(EmergencyDir=poas)

	same => n, Set(FileSize=${STAT(s,${MIXMONITOR_FILENAME})})
;	same => n, Noop(recFileName=${MIXMONITOR_FILENAME} savFileName=${savFileName} FileSize=${FileSize})

	same => n, AGI(${agiDIR}/crm_get_user_code.php)
	same => n, Log(NOTICE, crm_get_user_code.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}]) USERCODE=[${USERCODE}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?S51_agi_guc_access_fail)
	same => n, GotoIf($["${RESULT}"!="0000"]?S51_agi_guc_result_fail)
	same => n, GotoIf($[${LEN(${USERCODE})}=0]?S51_agi_guc_length_error);

	same => n, Set(RESULT1=****)
	same => n, AGI(${agiDIR}/crm_save_ars_record.php)
	same => n, Log(NOTICE, crm_save_ars_record.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?S51_agi_sar_access_fail)
	same => n, GotoIf($["${RESULT}"="0000"]?reg_user_succ:S51_agi_sar_result_fail)


	; ----------------------------------------
	; AGI 연동 실패시
	; ----------------------------------------
	same => n(S51_agi_guc_access_fail), Set(ErrorCode=S51_agi_guc_access_fail)
	same => n, Goto(S51_agi_order_fail)

	same => n(S51_agi_guc_result_fail), Set(ErrorCode=S51_agi_guc_result_fail)
	same => n, Goto(S51_agi_order_fail)

	same => n(S51_agi_guc_length_error), Set(ErrorCode=S51_agi_guc_length_error)
	same => n, Goto(S51_agi_order_fail)

	same => n(S51_agi_sar_access_fail), Set(ErrorCode=S51_agi_sar_access_fail)
	same => n, Goto(S51_agi_order_fail)

	same => n(S51_agi_sar_result_fail), Set(ErrorCode=S51_agi_sar_result_fail)
	same => n, Goto(S51_agi_order_fail)

	same => n(S51_agi_order_fail), Noop(ErrorCode=${ErrorCode})

	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Playback(${baseDIR}/POAS_C16)	; 외부 장치에 접속하지 못하여, 주문이 취소되었습니다.
	                                        	; 확인후 이용해 주세요.

	same => n, Goto(rec_Finish,1)


	; ----------------------------------------
	; 입력된 정보 없음
	; ----------------------------------------
	same => n(end_on_reg_step), Set(ErrorCode=end_on_reg_step)

	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Goto(rec_GoodBye,1)


	; ----------------------------------------
	; 주문 정보를 DB에 저장하고 녹취 파일을 저장
	; ----------------------------------------
	same => n(reg_user_succ), Set(ErrorCode=reg_user_succ)

	same => n, Set(reg_sts=2)	; record_ok
	same => n, Set(record_data_Dir=${STAT(d,${PathDir}/record_data)})
	same => n, GotoIf($[${record_data_Dir}=0]?record_dir_not_exist)

	same => n, System(${agiPath}/poas_norm_recdir.sh  ${PathDir} record_data ${USERCODE} ${CALLEE})
	same => n, Log(NOTICE, [mkdir] SYSTEMSTATUS=${SYSTEMSTATUS})
	same => n, GotoIf($["${SYSTEMSTATUS}"!="SUCCESS"]?make_rec_dir_fail)


	same => n, System(/bin/mv ${MIXMONITOR_FILENAME} ${PathDir}/record_data/${USERCODE}/${CALLEE}/.)
	same => n, Log(NOTICE, [UserCode_mv] SYSTEMSTATUS=${SYSTEMSTATUS})
	same => n, GotoIf($["${SYSTEMSTATUS}"!="SUCCESS"]?move_rec_file_fail)


	same => n, Playback(${baseDIR}/POAS_C11)	; 주문 정보가 저장되었습니다.
	                                         	; 이용해 주셔서 감사합니다.
	same => n, Goto(rec_Finish,1)


	same => n(record_dir_not_exist), Set(ErrorCode=record_dir_not_exist)
	same => n, Goto(emergency_file_store)

	same => n(make_rec_dir_fail), Set(ErrorCode=make_rec_dir_fail)
	same => n, Goto(emergency_file_store)

	same => n(move_rec_file_fail), Set(ErrorCode=move_rec_file_fail)
	same => n, Goto(emergency_file_store)

	same => n(emergency_file_store), Set(ErrorCode=${ErrorCode})

	same => n, System(${agiPath}/poas_emer_recdir.sh ${recPath} ${emgDIR} ${USERCODE} )
	same => n, System(/bin/mv ${MIXMONITOR_FILENAME} ${recPath}/${emgDIR}/${USERCODE}/.)

	same => n, Log(NOTICE, [USERCODE_mv] SYSTEMSTATUS=${SYSTEMSTATUS})
	same => n, Playback(${baseDIR}/POAS_C17)	; 음성 주문 녹음 파일을,
	                                         	; 즉시 전송하지 못하여 주문이 지연될 수 있습니다.
	                                         	; 통화 종료후, 담당자에게 주~문 상태를 확인하시기 바랍니다.
	same => n, Playback(${baseDIR}/POAS_C15)	; 이용해 주셔서 감사합니다.

	same => n, Goto(rec_Finish,1)


	; ================================================================================
	; 제품 주문 취소하고 재 주문하기                                                 *
	; ================================================================================
	same => n(S51_rerec), Set(ErrorCode=S51_rerec)

	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Goto(bstart,1)


	; ================================================================================
	; 제품 주문 취소하고 종료하기                                                    *
	; ================================================================================
	same => n(S51_discard),Set(ErrorCode=S51_discard)

	same => n, Playback(${baseDIR}/POAS_C12)		; 주문 내용을 취소하였습니다.
	                                        		; 이용해 주셔서 감사합니다.
	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Set(reg_sts=3)				; reg_cancel

	same => n, Goto(rec_Finish,1)






exten => h,1, Noop(reg_sts=[${reg_sts}] MIXMONITOR_FILENAME=[${MIXMONITOR_FILENAME}] The_Caller_HangsUp_Recording)

	same => n, Log(NOTICE,[poas_hangup] [${CALLER}] : reg_sts=${reg_sts}/MIXMONITOR_FILENAME=[${MIXMONITOR_FILENAME}]/The_Caller_HangUp_Recoding)

	same => n, GotoIf($[${LEN(${MIXMONITOR_FILENAME})}=0]?reg_goodbye);

	same => n, ExecIf($[${reg_sts}=1]?System(/bin/rm ${MIXMONITOR_FILENAME}))

	same => n(reg_goodbye), Hangup()





	; ================================================================================
	;                                                                                *
	; ================================================================================
exten => rec_GoodBye,1, Noop(rec_GoodBye)
	same => n, Playback(${baseDIR}/POAS_C15)	; 이용해 주셔서 감사합니다.
	same => n, Log(NOTICE,[rec_GoodBye] [${CALLER} --> ${CALLEE}] : ERR=[${ErrorCode}] )

	same => n, Hangup()


exten => rec_Finish,1, Noop(rec_Finish)
	same => n, Log(NOTICE,[rec_Finish] [${CALLER} --> ${CALLEE}] : ERR=[${ErrorCode}] )
	same => n, Hangup()
