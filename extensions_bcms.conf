; ********************************************************************************
; *                                                                              *
; * 바로서비스 전자 동의 자동 응답 서비스                                        *
; *                                                                              *
; ********************************************************************************

[bcms_main]

exten => _X.,1,Noop([bcms_main] Recieving Call[${EXTEN}] From [${CHANNEL(peerip)}])

	same => n, Ringing()

	same => n, Set(m_CALLER=${CALLERID(ANI)})
	same => n, Set(m_CALLEE=${CALLERID(DNID)})
	same => n, Set(NUM=${m_CALLEE})
	same => n, ExecIf($[${LEN(${m_CALLEE})}>10]?Set(NUM=${m_CALLEE:7:4}))


	same => n, Set(ErrorCode=bcms_start)

	same => n, Set(CHANNEL(language)=kr)
	same => n, Set(comDIR=comm)
	same => n, Set(wavDIR=bcms)
	same => n, Set(agiDIR=bcms)
	same => n, Set(ttsDIR=TTS)
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(agiPath=/var/lib/asterisk/agi-bin/${agiDIR})
	same => n, Set(ttsPath=/var/lib/asterisk/agi-bin/${ttsDIR})
	same => n, Set(recPath=/var/spool/asterisk/monitor)
	same => n, Set(PathDir=${recPath}/RECHDD)
	same => n, Set(emgDIR=EMGHDD)
	same => n, Set(m_RecSave=0)		; // m_RecSave status 0=not_record,1=rec_start, 2=rec_stop

	same => n, Answer()

	; ---------------------------------------------------------
	; 구글 TTS 옵션 항목 변경시에 풀고 사용하면 유용함.        
	; ---------------------------------------------------------
;	same => n, GoSub(bcms_checkGoogleTTS,s,1(${ErrorCode}))
;	same => n, Goto(bcms_Finish,1)

	; ---------------------------------------------------------
	; 착신번호애 대한 서비스 타입 정보 검색                   
	; ---------------------------------------------------------
	same => n, GoSub(bcms_AgiGetBcmsType,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 1111]?S12_checkBcmsType)
	same => n, GoSub(bcms_PlayAnm,s,1(${ErrorCode},${RESULT}))
	same => n, Goto(bcms_Finish,1)

	same => n(S12_checkBcmsType), Set(ErrorCode=S12_checkBcmsType)
	same => n, GotoIf($[${m_BcmsType} = 0]?anm_rpt)
	same => n, GotoIf($[${m_BcmsType} < 6]?S21_get_usercode)
	same => n(anm_rpt), GoSub(bcms_PlayAnm,s,1(${ErrorCode},7400))
	same => n, Goto(bcms_Finish,1)

	; ================================================================================
	;                                                                                *
	; 2-1 착신번호에 대한 코드 정보 검색                                             *
	;     - USERCODE 없을시 출금동의 서비스 제공하지 않는다.                         *
	;     - RESULT가 "0000"인 경우에만 서비스 진행한다.                              *
	;                                                                                *
	; ================================================================================
	same => n(S21_get_usercode), Set(ErrorCode=S21_get_usercode)
	same => n, GoSub(bcms_GetUserCodeInform,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 1]?S22_checkBcmsType)
	same => n, Goto(bcms_Finish,1)

	same => n(S22_checkBcmsType), Set(ErrorCode=S22_checkBcmsType)
	same => n, GotoIf($[${m_BcmsType} = 1]?S31_check_account)
	same => n, GotoIf($[${m_BcmsType} = 2]?a2p_mldw_tronrich,s,1)
	same => n, GotoIf($[${m_BcmsType} = 3]?a2p_mldw_joeuntech,s,1)
	same => n, GotoIf($[${m_BcmsType} = 4]?a2p_mldw_jeongnwoo,s,1)
	same => n, GotoIf($[${m_BcmsType} = 5]?a2p_mldw_goodrichclub,s,1)
;	same => n, GotoIf($[${m_BcmsType} = 6]?a2p_mldw_ezcompany,s,1)
	same => n, Goto(bcms_Finish,1)


	; ================================================================================
	; 3-1 출금 동의 계좌 체크                                                        *
	; ================================================================================
	same => n(S31_check_account), Set(ErrorCode=S31_check_account)

	same => n, GoSub(bcms_CheckAccount,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 1]?S31_conn_gcp)
	same => n, Goto(bcms_Finish,1)



	; ----------------------------------------
	; AGI로부터 정보를 수신하는 경우
	; ----------------------------------------
	same => n(S31_conn_gcp), Set(ErrorCode=S31_conn_gcp)

	same => n, GoSub(bcms_MakeTtsFile,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 1]?S41_main)
	same => n, Goto(bcms_Finish,1)


	; ================================================================================
	;                                                                                *
	; 4-1 출금 동의 고지                                                             *
	;     - 출금 동의 멘트 구성                                                      *
	;     - 녹취 시작 : 녹취 파일 이름 구성                                          *
	;                                                                                *
	; ================================================================================

	same => n(S41_main), Set(ErrorCode=S41_main)

	same => n, GoSub(bcms_AgreeWithdrawlREQ,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 1]?S51_store)
	same => n, Goto(bcms_Finish,1)


	; ================================================================================
	; 출금 동의 녹취 내용 저장하고 종료하기                                          *
	; ================================================================================
	same => n(S51_store), Set(ErrorCode=S51_store)
	same => n, GoSub(bcms_moveWAV2MP3_RecFile,s,1(${ErrCode}))

	; ================================================================================
	;                                                                                *
	; ================================================================================
	same => n, Set(ErrorCode=reg_user_succ)

	; ----------------------------------------
	; 출금 동의 결과 DB 저장                          
	; ----------------------------------------
	same => n, Set(RESULT=****)
	same => n, AGI(${agiDIR}/bcms_account_agree.php)
	same => n, Log(NOTICE, bcms_account_agree.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}]) )

	; ----------------------------------------
	; 녹취 파일 저장                        
	; ----------------------------------------
	same => n, GoSub(bcms_saveRecFile,s,1(${ErrCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 1]?bcms_Finish,1)	; // save_succ



	; ================================================================================
	;                                                                                *
	; ================================================================================
exten => bcms_GoodBye, 1, Log(NOTICE,[bcms_GoodBye] [${m_CALLER} --> ${m_CALLEE}] ERR=[${ErrorCode}] )
	same => n, Playback(${wavDIR}/BCMS_012)		; 이용해 주셔서 감사합니다.
	same => n, Hangup()

exten => bcms_Finish, 1, Log(NOTICE,[bcms_Finish] [${m_CALLER} --> ${m_CALLEE}] ERR=[${ErrorCode}] )
	same => n, Hangup()

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] bcms_main/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GoSub(bcms_DeleteRecFile,s,1(bcms_main_hangup))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; bcms_AgiGetBcmsType                                                            *
;   전자 동의 서비스 타입 정보 가져오기                                          *
;   1) input  : 착신번호                                                         *
;   2) output :                                                                  *
;      - m_BcmsType : 1=출금동의, 2=MLDW, 0=미정의                               *
;      - RESULT     : 1111=OK                                                    *
;                                                                                *
; ********************************************************************************

[bcms_AgiGetBcmsType]
exten => s, 1, Noop(bcms_AgiGetBcmsType from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})				; // ErrCode
	same => n, Set(RESULT=)
	same => n, Set(m_BcmsType=0)					; // 0=none

	same => n, AGI(${agiDIR}/bcms_get_svc_type.php)
	same => n, Log(NOTICE,[${m_CALLER}] bcms_get_svc_type.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_BcmsType=[${m_BcmsType}] )
	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.
	same => n, Return(${RESULT})						; // AGI로부터 수신된 결과 


exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] bcms_AgiGetBcmsType/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; bcms_checkGoogleTTS                                                            *
;   구글에서 TTS음원 들어보기 시험                                               *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[bcms_checkGoogleTTS]
exten => s, 1, Noop(bcms_checkGoogleTTS from ${ARG1})
	same => n, Set(m_CustomerName="우리나라 대한민국");
	same => n, Set(ttsFileName=${m_CALLER}.mp3)
	same => n, AGI(${ttsDIR}/gcp_text2speech.php)
	same => n, Log(NOTICE, gcp_text2speech.php : AGISTATUS=${AGISTATUS}  RESULT=${RESULT})
	same => n, MP3Player(/tmp/${ttsFileName})
	same => n, Return()

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] bcms_checkGoogleTTS/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_PlayAnm(AGI 수행 결과에 대한 안내 멘트)                                    *
;                                                                                *
; ********************************************************************************

[bcms_PlayAnm]
exten => s, 1, Noop(psn_AnmforAgifail [${ARG1} / ${ARG2}] )

	same => n, Set(LOCAL(ErrCode)=${ARG1})			; // ErrCode
	same => n, Set(LOCAL(rlt)=${ARG2})			; // agi_result
	same => n, Set(LOCAL(FN)=BCMS_000)			; // 1초 묵음: 알려지지 않은 에라발생시

	same => n, ExecIf($[${rlt} < 7000]?Set(rlt=9092)	; undefined_error
	same => n, GotoIf($[${rlt} >= 9000]?msg_err)

	same => n(msg_0), GotoIf($[${rlt} > 7000]?msg_1)
	same => n, Playback(${wavDIR}/BCMS_001_1)		; 안녕하세요. (주)바로서비스의 전자 동의 접수 시스템입니다.
	same => n, Playback(${wavDIR}/BCMS_E14)			; 서버 접속이 원할하지 않아, 전자 동의를 접수하지 못합니다.
	same => n, Playback(${wavDIR}/BCMS_013)			; 확인후 이용해 주세요.
	same => n, Return()

	same => n(msg_1), GotoIf($[${rlt} > 7001]?msg_2)
	same => n, Playback(${wavDIR}/BCMS_001_1)		; 안녕하세요. (주)바로서비스의 전자 동의 접수 시스템입니다.
	same => n, Playback(${wavDIR}/BCMS_E15)			; 서버로부터 서비스 코드를 수신하지 못하여,
	                                        		; 출금동의를 접수하지 못합니다. 
	same => n, Playback(${wavDIR}/BCMS_012)         	; 이용해 주셔서 감사합니다.
	same => n, Return()

	same => n(msg_2), GotoIf($[${rlt} > 7100]?msg_3)
	same => n, Playback(${wavDIR}/BCMS_001)			; 안녕하세요. (주)바로서비스의 출금동의 접수 시스템입니다.
	same => n, Playback(${wavDIR}/BCMS_E11)			; 인증 시스템에 접속하지 못하여,
	                                               		; 출금 동의를 위한 계좌 정보를 가져오지 못했습니다.
	same => n, Playback(${wavDIR}/BCMS_E07)			; 확인후 이용하세요.
	same => n, Playback(${wavDIR}/BCMS_012)         	; 이용해 주셔서 감사합니다.
	same => n, Return()

	same => n(msg_3), GotoIf($[${rlt} > 7101]?msg_4)
	same => n, Playback(${wavDIR}/BCMS_001)			; 안녕하세요. (주)바로서비스의 출금동의 접수 시스템입니다.
	same => n, Playback(${wavDIR}/BCMS_E17)			; 고객님께서 출금 동의를 하기 위하여,
	                                        		; 등록하신 계좌 정보가 없습니다.
	same => n, Playback(${wavDIR}/BCMS_012)         	; 이용해 주셔서 감사합니다.
	same => n, Return()

	same => n(msg_4), GotoIf($[${rlt} > 7102]?msg_5)
	same => n, Playback(${wavDIR}/BCMS_001)			; 안녕하세요. (주)바로서비스의 출금동의 접수 시스템입니다.
	same => n, Playback(${wavDIR}/BCMS_E12)			; 고객님께서 출금 동의를 하기 위하여,
	                                        		; 등록하신 계좌는 조회가 되지 않습니다.
	same => n, Playback(${wavDIR}/BCMS_012)         	; 이용해 주셔서 감사합니다.
	same => n, Return()

	same => n(msg_5), GotoIf($[${rlt} > 7103]?msg_6)
	same => n, Playback(${wavDIR}/BCMS_001)			; 안녕하세요. (주)바로서비스의 출금동의 접수 시스템입니다.
	same => n, Playback(${wavDIR}/BCMS_E13)			; 고객님께서 출금 동의를 하기 위하여,
	                                        		; 등록하신 계좌는 유효하지 않습니다.
	same => n, Playback(${wavDIR}/BCMS_012)         	; 이용해 주셔서 감사합니다.
	same => n, Return()

	same => n(msg_6), GotoIf($[${rlt} > 7104]?msg_7)
	same => n, Playback(${wavDIR}/BCMS_001)			; 안녕하세요. (주)바로서비스의 출금동의 접수 시스템입니다.
	same => n, Playback(${wavDIR}/BCMS_E18)			; 서버로부터 정의되지 않은 정보를 수신하여,
	                                        		; 출금 동의 서비스를 제공하지 못합니다.
	same => n, Playback(${wavDIR}/BCMS_E07)			; 확인후 이용하세요.
	same => n, Playback(${wavDIR}/BCMS_012)         	; 이용해 주셔서 감사합니다.
	same => n, Return()

	same => n(msg_7), GotoIf($[${rlt} > 7200]?msg_8)
	same => n, Playback(${wavDIR}/BCMS_001)			; 안녕하세요. (주)바로서비스의 출금동의 접수 시스템입니다.
	same => n, Playback(${wavDIR}/BCMS_E19)			; 출금 동의 서비스를 제공할 수 없는 상태입니다.
	same => n, Playback(${wavDIR}/BCMS_E07)			; 확인후 이용하세요.
	same => n, Playback(${wavDIR}/BCMS_012)         	; 이용해 주셔서 감사합니다.
	same => n, Return()

	same => n(msg_8), GotoIf($[${rlt} > 7300]?msg_9)
	same => n, Playback(${wavDIR}/BCMS_011)			; 1번을 선택하지 않았습니다.
	                                        		; 자동결제에 동의하지 않았습니다.
	same => n, Playback(${wavDIR}/BCMS_012)         	; 이용해 주셔서 감사합니다.
	same => n, Return()

	same => n(msg_9), GotoIf($[${rlt} > 7301]?msg_10)
	same => n, Playback(${wavDIR}/BCMS_010)			; 1번을 선택하셨습니다.
	                                        		; 자동결제동의가 완료되었습니다.
	same => n, Playback(${wavDIR}/BCMS_012)			; 이용해 주셔서 감사합니다.
	same => n, Return()

	same => n(msg_10), GotoIf($[${rlt} > 7302]?msg_11)
	same => n, Playback(${wavDIR}/BCMS_E16)			; 출금동의 접수 정보를 즉시 전송하지 못하여
	                                         		; 처리가 지연될 수 있음을 알려 드립니다.
	same => n, Playback(${wavDIR}/BCMS_012)         	; 이용해 주셔서 감사합니다.
	same => n, Return()

	same => n(msg_11), GotoIf($[${rlt} > 7400]?msg_12)
	same => n, Playback(${wavDIR}/BCMS_E20)			; 고객님이 누르신 번호는 전자 동의 서비스를 받을 수 있는 번호가 아닙니다.
	same => n, Return()

	same => n(msg_12), Return()

	same => n(msg_err), Set(FN=COMM_000)			; // 1초 묵음: 알려지지 않은 에라발생시
	same => n, ExecIf($[${rlt} = 8888]?Set(FN=COMM_901))	; 외부장치와 접속이 원할하지 않아,서비스를 진행할수없습니다.
	same => n, ExecIf($[${rlt} = 9999]?Set(FN=COMM_902))	; 알려지지 않은 장애가 발생하여, 서비스가 중단되었습니다.
	same => n, ExecIf($[${rlt} = 9092]?Set(FN=COMM_903))	; 서버로부터 알 수 없는 정보를 수신하여, 서비스가 중단되었습니다.
	same => n, ExecIf($[${rlt} = 9093]?Set(FN=COMM_900))	; 외부 장치에 접속하지 못하여, 서비스를 진행할 수 없습니다.
	same => n, ExecIf($[${rlt} = 9084]?Set(FN=COMM_004))	; 서비스 준비중입니다. 다음에 이용해 주세요.
	same => n, Playback(${comDIR}/${FN})
	same => n, Return

	; ----------------------------------------
	;
	; ----------------------------------------
	same => n(play), Playback(${wavDIR}/${FN})
	same => n, Return


exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] bcms_PlayAnm/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; bcms_moveWAV2MP3_RecFile                                                       *
;   녹취 파일 형식을 wav에서 mp3로 변경, 녹취 원본 wav파일은 삭제                *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[bcms_moveWAV2MP3_RecFile]
exten => s, 1, Noop(bcms_moveWAV2MP3_RecFile from ${ARG1})

	same => n, Set(PathDir=${recPath}/RECHDD)

	same => n, Set(FileSize=${STAT(s,${MIXMONITOR_FILENAME})})
	same => n, Noop(recFileName=${MIXMONITOR_FILENAME} savFileName=${savFileName} FileSize=${FileSize})

	; ----------------------------------------
	; wav파일을 mp3파일로 변환
	; ----------------------------------------
	same => n, System(${agiPath}/wav2mp3.sh   ${MIXMONITOR_FILENAME} ${recPath}/${mp3FileName})
;	same => n, System(/usr/bin/lame -h -b 128 ${MIXMONITOR_FILENAME} ${recPath}/${mp3FileName})

	; ----------------------------------------
	; 녹취 원본 파일(wav 파일) 삭제
	; ----------------------------------------
	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Return()
exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] bcms_moveWAV2MP3_RecFile/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; bcms_saveRecFile                                                               *
;   녹취 파일을 약속된 장소에 저장                                               *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[bcms_saveRecFile]
exten => s, 1, Noop(bcms_saveRecFile from ${ARG1})

	; ----------------------------------------
	; 녹취 파일 저장 위치 확인                          
	; ----------------------------------------
	same => n, Set(record_data_Dir=${STAT(d,${PathDir}/record_data)})
	same => n, GotoIf($[${record_data_Dir}=0]?bcms_rec_dir_not_exist)

	; ----------------------------------------
	; 녹취 파일 저장 위치 디렉토리 생성                     
	; ----------------------------------------
	same => n, Set(FileSize=${STAT(s,${agiPath}/bcms_make_dir.sh)})
	same => n, GotoIf($[${FileSize}=0]?bcms_make_rec_dir_fail)

	same => n, System(${agiPath}/bcms_make_dir.sh ${PathDir} record_data ${USERCODE} ${m_CALLEE})
	same => n, Log(NOTICE, [mkdir] SYSTEMSTATUS=${SYSTEMSTATUS})
	same => n, GotoIf($["${SYSTEMSTATUS}"!="SUCCESS"]?bcms_make_rec_dir_fail)

	; ----------------------------------------
	; 녹취 파일 위치 이동                     
	; ----------------------------------------
	same => n, Set(FileSize=${STAT(s,${recPath}/${mp3FileName})})
;	same => n, System(/bin/mv ${MIXMONITOR_FILENAME}    ${PathDir}/record_data/${USERCODE}/${m_CALLEE}/.)
	same => n, System(/bin/mv ${recPath}/${mp3FileName} ${PathDir}/record_data/${USERCODE}/${m_CALLEE}/.)

	same => n, Log(NOTICE, [UserCode_mv] SYSTEMSTATUS=${SYSTEMSTATUS})
	same => n, GotoIf($["${SYSTEMSTATUS}"!="SUCCESS"]?bcms_move_rec_file_fail)

	same => n, Return(1)	; // 녹취파일 저장=OK, bcms_Finish

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(bcms_rec_dir_not_exist), Set(ErrorCode=bcms_rec_dir_not_exist)
	same => n, Goto(bcms_emg_file_store)

	same => n(bcms_make_rec_dir_fail), Set(ErrorCode=bcms_make_rec_dir_fail)
	same => n, Goto(bcms_emg_file_store)

	same => n(bcms_move_rec_file_fail), Set(ErrorCode=bcms_move_rec_file_fail)
	same => n, Goto(bcms_emg_file_store)

	; ----------------------------------------
	; 녹음 파일을 약정된 위치로 전송하지 못하는 경우
	; ----------------------------------------
	same => n(bcms_emg_file_store), Set(ErrorCode=${ErrorCode})

	; ----------------------------------------
	; 녹취 파일을 저장할 장소를 만드는 쉘파일이 있는지 체크
	; ----------------------------------------
	same => n, Set(FileSize=${STAT(s,${agiPath}/bcms_emer_dir.sh)})
	same => n, GotoIf($[${FileSize}=0]?bcms_make_emer_dir_fail)

	same => n, System(${agiPath}/bcms_emer_dir.sh ${recPath} ${emgDIR} ${USERCODE})
	same => n, Log(NOTICE, [bcms_emer_dir.sh] SYSTEMSTATUS=${SYSTEMSTATUS})

	; ----------------------------------------
	; 녹취 파일을 저장할 장소가 있는지 체크
	; ----------------------------------------
	same => n, Set(FileSize=${STAT(s,${recPath}/${emgDIR}/${USERCODE})})
	same => n, GotoIf($[${FileSize}=0]?bcms_make_emer_dir_fail)

	same => n, Set(FileSize=${STAT(s,${recPath}/${mp3FileName})})
;	same => n, System(/bin/mv ${MIXMONITOR_FILENAME}    ${recPath}/${USERCODE})
	same => n, System(/bin/mv ${recPath}/${mp3FileName} ${recPath}/${emgDIR}/${USERCODE})


	same => n(bcms_make_emer_dir_fail), Noop(bcms_make_emer_dir_fail)
	same => n, GoSub(bcms_PlayAnm,s,1(${ErrorCode},7302))
	same => n, Return(2)

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] bcms_saveRecFile/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; bcms_DeleteRecFile                                                             *
;   음원 파일 삭제하기                                                           *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[bcms_DeleteRecFile]
exten => s, 1, Noop(bcms_DeleteRecFile from ${ARG1})
	; ----------------------------------------
	; 출금 동의 녹취 파일 삭제 : 미동의, 녹취중 종료
	; ----------------------------------------
	same => n, Set(FileSize=${STAT(s,${MIXMONITOR_FILENAME})})
	same => n, ExecIf($[${FileSize}>0]?System(/bin/rm ${MIXMONITOR_FILENAME}))

	; ----------------------------------------
	; 구글 TTS 음성 파일 삭제                 
	; ----------------------------------------
	same => n, Set(FileSize=${STAT(s,/tmp/${ttsFileName})})
	same => n, ExecIf($[${FileSize}>0]?System(/bin/rm /tmp/${ttsFileName}))
	same => n, Return()

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] bcms_DeleteRecFile/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; bcms_GetUserCodeInform                                                         *
;   녹취 파일 저장을 위한 착신번호에 부여된 USERCODE 정보 가져오기               *
;   - USERCODE 없을시 출금동의 서비스 제공하지 않는다.                           *
;   - RESULT가 "0000"인 경우에만 서비스 진행한다.                                *
;   1) input  : 발신번호, 착신번호                                               *
;   2) output : - RESULT : 0000=OK,                                              *
;                          8888=db connect error                                 *
;                          8999=ARS번호에 대한 USER정보 없음                     *
;                          9999=undefined_error
;               - USERCODE : 길이가 1자리 이상이면 유효                          *
;                                                                                *
; ********************************************************************************

[bcms_GetUserCodeInform]
exten => s, 1, Noop(bcms_GetUserCodeInform from ${ARG1})

	same => n, AGI(${agiDIR}/bcms_get_user_code.php)
	same => n, Log(NOTICE, bcms_get_user_code.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}]) USERCODE=[${USERCODE}] m_SvcType=[${m_SvcType}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?S21_agi_guc_access_fail)
	same => n, GotoIf($["${RESULT}"!="0000"]?S21_agi_guc_result_fail)
	same => n, GotoIf($[${LEN(${USERCODE})}=0]?S21_agi_guc_length_error)

	same => n, Return(1)	; // OK

	; ----------------------------------------
	; AGI 연동 실패시
	; ----------------------------------------
	same => n(S21_agi_guc_access_fail), Set(ErrorCode=S21_agi_guc_access_fail)
	same => n, Goto(S21_agi_order_fail)

	same => n(S21_agi_guc_result_fail), Set(ErrorCode=S21_agi_guc_result_fail)
	same => n, Goto(S21_agi_order_fail)

	same => n(S21_agi_guc_length_error), Set(ErrorCode=S21_agi_guc_length_error)
	same => n, Goto(S21_agi_code_fail)


	same => n(S21_agi_order_fail), Noop(ErrorCode=${ErrorCode})
	same => n, GoSub(bcms_PlayAnm,s,1(${ErrorCode},7000))
	same => n, Return(0)	; // Fail

	same => n(S21_agi_code_fail), Noop(ErrorCode=${ErrorCode})
	same => n, GoSub(bcms_PlayAnm,s,1(${ErrorCode},7001))
	same => n, Return(0)	; // Fail

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] bcms_GetUserCodeInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; bcms_CheckAccount                                                              *
;   출금동의 계좌 체크(고객이름,은행이름,은행코드,계좌번호)                      *
;   1) input  : 발신번호, 착신번호                                               *
;   2) output : - RESULT                                                         *
;               - m_BankName                                                     *
;               - m_BankCode                                                     *
;               - m_AccountNumber                                                *
;               - m_CustomerName                                                 *
;                                                                                *
; ********************************************************************************

[bcms_CheckAccount]
exten => s, 1, Noop(bcms_CheckAccount from ${ARG1})
	same => n, Set(m_CustomerName="");
	same => n, Set(m_BankName="");
	same => n, Set(m_BankCode=0);
	same => n, Set(m_AccountNumber=0);

	same => n, AGI(${agiDIR}/bcms_get_account_inform.php)
	same => n, Log(NOTICE, bcms_get_account_inform.php : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}] m_CustomerName=[${m_CustomerName}] m_BankName=[${m_BankName}] m_BankCode=[${m_BankCode}] m_AccountNumber=[${m_AccountNumber}])

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?S31_agi_access_fail)
	same => n, GotoIf($["${RESULT}"="1111"]?S31_conn_gcp)
	same => n, GotoIf($["${RESULT}"="2222"]?S31_fail_2222)
	same => n, GotoIf($["${RESULT}"="3333"]?S31_fail_3333)
	same => n, GotoIf($["${RESULT}"="3344"]?S31_fail_3344:S31_fail_33xx)

	; ----------------------------------------
	; AGI 접속 실패시 : 파일이 없는 경우, permittion error 나는 경우
	; ----------------------------------------
	same => n(S31_agi_access_fail), Set(ErrorCode=S31_agi_access_fail)
	same => n, GoSub(bcms_PlayAnm,s,1(${ErrorCode},7100))

	same => n, Return(0)


	same => n(S31_fail_2222), Set(ErrorCode=S31_fail_2222)
	same => n, GoSub(bcms_PlayAnm,s,1(${ErrorCode},7101))
	same => n, Return(0)


	same => n(S31_fail_3333), Set(ErrorCode=S31_fail_3333)
	same => n, GoSub(bcms_PlayAnm,s,1(${ErrorCode},7102))
	same => n, Return(0)


	same => n(S31_fail_3344), Set(ErrorCode=S31_fail_3344)
	same => n, GoSub(bcms_PlayAnm,s,1(${ErrorCode},7103))
	same => n, Return(0)


	same => n(S31_fail_33xx), Set(ErrorCode=S31_fail_33xx)
	same => n, GoSub(bcms_PlayAnm,s,1(${ErrorCode},7104))
	same => n, Return(0)

	same => n(S31_conn_gcp), Return(1)

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] bcms_CheckAccount/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; bcms_MakeTtsFile                                                               *
;   TTS 음원 파일 생성, 은행 코드 음원 만들기                                    *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[bcms_MakeTtsFile]
exten => s, 1, Noop(bcms_MakeTtsFile from ${ARG1})
	same => n, Set(ttsFileName=${m_CALLER}.mp3)
	same => n, AGI(${ttsDIR}/gcp_text2speech.php)
	same => n, Log(NOTICE, gcp_text2speech.php : AGISTATUS=${AGISTATUS}  RESULT=${RESULT})
	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?S31_gcp_fail)
	same => n, GotoIf($["${RESULT}"!="1111"]?S31_gcp_fail)


	same => n(S31_gcp_succ), Set(ErrorCode=S31_gcp_succ)
	same => n, Set(m_GcpTtsSts=1)	; succ
	same => n, Goto(S31_auth_succ)


	same => n(S31_gcp_fail), Set(ErrorCode=S31_gcp_fail)
	same => n, Set(m_GcpTtsSts=2)	; fail
	same => n, Set(FileSize=${STAT(s,${ttsPath}/googletts.agi)})
	same => n, GotoIf($[${FileSize}=0]?S31_tts_none)
	same => n, Goto(S31_auth_succ)


	same => n(S31_tts_none), Set(ErrorCode=S31_tts_none)
	same => n, GoSub(bcms_PlayAnm,s,1(${ErrorCode},7200))
	same => n, Return(0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(S31_auth_succ), Set(ErrorCode=S31_auth_succ)

;	same => n, Set(a1=${MATH(${m_AccountNumber}%10000,int)})
;	same => n, Set(a2=${MATH(${m_AccountNumber}%1000,int)})
;	same => n, Set(a3=${MATH(${m_AccountNumber}%100,int)})
;	same => n, Set(a4=${MATH(${m_AccountNumber}%10,int)})
;
;	same => n, Set(a1=${MATH(${a1}/1000,int)})
;	same => n, Set(a2=${MATH(${a2}/100,int)})
;	same => n, Set(a3=${MATH(${a3}/10,int)})
;
;	same => n, Set(A1=${SPRINTF(${wavDIR}/BCMS_D0%d,${a1})})
;	same => n, Set(A2=${SPRINTF(${wavDIR}/BCMS_D0%d,${a2})})
;	same => n, Set(A3=${SPRINTF(${wavDIR}/BCMS_D0%d,${a3})})
;	same => n, Set(A4=${SPRINTF(${wavDIR}/BCMS_D0%d,${a4})})

	same => n, Set(B1=${SPRINTF(${wavDIR}/BANK_%03d,${m_BankCode})})

	same => n, Return(1)

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] bcms_MakeTtsFile/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; bcms_AgreeWithdrawlREQ                                                         *
;   출금 신청 전자 동의 고지                                                     *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[bcms_AgreeWithdrawlREQ]
exten => s, 1, Noop(bcms_AgreeWithdrawlREQ from ${ARG1})

	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(countENTER=0)

	same => n(S41_record), Set(ErrorCode=S41_record)

	same => n, Set(mp3FileName=${NUM}-${m_CALLER}_${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}.mp3)
	same => n, Set(recFileName=${NUM}-${m_CALLER}_${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}.wav)
	same => n, Set(savFileName=${recFileName})

	same => n, MixMonitor(${recFileName})

	same => n, Playback(${wavDIR}/BCMS_003)			; 안녕하세요. 안심 자동결재신청 서비스 입니다.
	same => n, Playback(${wavDIR}/BCMS_004)			; 본서비스는 안전한 자동결제신청을 위해 제공 됩니다.

	same => n, ExecIf($[${m_GcpTtsSts}=1]?MP3Player(/tmp/${ttsFileName}):AGI(${ttsDIR}/googletts.agi, ${m_CustomerName}, ko))
	same => n, Playback(${wavDIR}/BCMS_005)			; 님의.

	same => n, ExecIf($[${m_BankCode}=999]?AGI(${ttsDIR}/googletts.agi, ${m_BankName}, ko):Playback(${B1})	; //은행이름

	same => n, Playback(${wavDIR}/BCMS_006)			; 끝자리.
;	same => n, AGI(${ttsDIR}/googletts.agi, ${m_AccountNumber}, ko);
;	same => n, Playback(${A1}&${A2}&${A3}&${A4})		; // 끝 네자리 번호
	same => n, SayDigits(${m_AccountNumber})
	same => n, Playback(${wavDIR}/BCMS_007)			; 계좌에서.

	same => n, Playback(${wavDIR}/BCMS_008)			; 바로서비스 사용료로 자동결제가 신청됩니다.
	same => n, read(SELNUM,${wavDIR}/BCMS_009,1,n,1,5)	; 동의하시면 1번을 입력하여 주세요.


	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S42_deny)	; // 미입력

	same => n, GotoIf($[${SELNUM}=1]?S42_agree:S42_deny)


	; ----------------------------------------
	; 동의하지 않은 경우(1번 입력하지 않거나 미입력시)
	; ----------------------------------------
	same => n(S42_deny), Set(ErrorCode=S42_deny)

	same => n, StopMixMonitor()
	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, System(/bin/rm /tmp/${ttsFileName})

	same => n, GoSub(bcms_PlayAnm,s,1(${ErrorCode},7300))
	same => n, Return(0)


	; ----------------------------------------
	; 출금 동의한 경우(1번 입력시)
	; ----------------------------------------
	same => n(S42_agree), Set(ErrorCode=S42_agree)

	same => n, GoSub(bcms_PlayAnm,s,1(${ErrorCode},7301))
	same => n, Wait(1)
	same => n, StopMixMonitor()
	same => n, Return(1)

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] bcms_AgreeWithdrawlREQ/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GoSub(bcms_DeleteRecFile,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; a2p_mldw_setRecFileName                                                        *
;   MLDW 전자 계약 동의 - 녹취 파일 이름 설정                                    *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[a2p_mldw_setRecFileName]
exten => s, 1, Set(mp3FileName=${NUM}-${m_CALLER}_${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}.mp3)
	same => n, Set(recFileName=${NUM}-${m_CALLER}_${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}.wav)
	same => n, Set(savFileName=${mp3FileName})

	same => n, Return()





; ********************************************************************************
;                                                                                *
; a2p_mldw_stop                                                                  *
;   MLDW 전자 계약 동의 - 녹취 작업 중지                                         *
;   1) input  : ErrCode,StopType(1=not_enter,2=deny),rcvDigit                    *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[a2p_mldw_stop]
exten => s, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] a2p_mldw_stop [${ARG1} / ${ARG2} / ${ARG3}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})
	same => n, Set(LOCAL(StopType)=${ARG2})
	same => n, Set(LOCAL(rcvDigit)=${ARG3})

	same => n, StopMixMonitor()
	same => n, System(/bin/rm ${MIXMONITOR_FILENAME})
	same => n, Set(m_RecSave=0)				; // m_RecSave status 0=not_record,1=rec_start, 2=rec_stop

	same => n, GotoIf($[${StopType} = 1]?:no_enter)
	same => n, GotoIf($[${StopType} = 2]?:usr_deny)
	same => n, Hangup()

	same => n(no_enter), Playback(${wavDIR}/BCMS_030)	; 고객님께서 전자 동의에 동의하지 않았음으로 서비스를 종료합니다.
	same => n, Hangup()

	same => n(usr_deny), Playback(kr/digits/${rcvDigit})
	same => n, Playback(${wavDIR}/BCMS_031)			; x 번을 누르지 않아, 전자동의 안내에 동의하지 않았습니다.
	same => n, Hangup()

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} -> ${m_CALLEE}] a2p_mldw_stop/Hangup ERR=[${ErrCode}] m_RecSave=[${m_RecSave}])
	same => n, GoSubIf($[${m_RecSave} != 0]?a2p_mldw_saveRecFile,s,1(${ErrCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; a2p_mldw_saveRecFile                                                           *
;   MLDW 전자 계약 동의 - 녹취 파일 저장                                         *
;   1) input  : ErrCode                                                          *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[a2p_mldw_saveRecFile]
exten => s, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] a2p_mldw_saveRecFile ERR=[${ARG1}] )

	same => n, GotoIf($[${m_RecSave} = 0]?end)
	same => n, GotoIf($[${m_RecSave} = 2]?finish)
	same => n, StopMixMonitor()
	same => n, Set(FileSize=${STAT(s,${MIXMONITOR_FILENAME})})
	same => n, ExecIf($[${FileSize}>0]?System(/bin/rm ${MIXMONITOR_FILENAME}))
	same => n, Goto(end)

	same => n(finish), System(${agiPath}/wav2mp3.sh   ${MIXMONITOR_FILENAME} ${recPath}/${mp3FileName})
	same => n, Set(FileSize=${STAT(s,${MIXMONITOR_FILENAME})})
	same => n, ExecIf($[${FileSize}>0]?System(/bin/rm ${MIXMONITOR_FILENAME}))
	same => n, GoSub(bcms_saveRecFile,s,1(${ErrCode}))
	same => n, AGI(${agiDIR}/bcms_save_mldw_rec.php)

	same => n(end), Return()





; ********************************************************************************
;                                                                                *
; a2p_mldw_ezcompany                                                             *
;   MLDW 서비스 계약동의 - 이지컴퍼니                                            *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

;[a2p_mldw_ezcompany]
;exten => s, 1, Noop(a2p_mldw_ezcompany)
;	same => n, Set(digit=0)
;
;	; ----------------------------------------
;	;                                        
;	; ----------------------------------------
;	same => n, GoSub(a2p_mldw_setRecFileName,s,1())
;	same => n, Set(m_RecSave=1)				; // m_RecSave status 0=not_record,1=rec_start, 2=rec_stop
;	same => n, MixMonitor(${recFileName})
;
;	; ----------------------------------------
;	;                                        
;	; ----------------------------------------
;	same => n, Playback(${wavDIR}/BCMS_020)			; 주식회사 이지컴퍼니입니다.
;
;	same => n, SayDigits(${m_CALLER})
;	same => n, Playback(${wavDIR}/BCMS_034)			; 고객님의.
;
;	same => n, Set(digit=1)
;	same => n, read(SELNUM,${wavDIR}/BCMS_021,1,n,3,5)	; 가상화폐 트론 판매 및 구매대행을 이지컴퍼니에게
;	                                                  	; 맡기시는데 동의하시면 1번을 누르세요.
;	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S61_not_enter)	; // 미입력
;	same => n, GotoIf($[${SELNUM} = 1]?:S61_deny)
;	same => n, SayDigits(${SELNUM})
;	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.
;
;	; ----------------------------------------
;	;                                        
;	; ----------------------------------------
;	same => n, Set(digit=9)
;	same => n, read(SELNUM,${wavDIR}/BCMS_022,1,n,3,5)	; 구매한 트론으로 만선지갑에 등록 및 계정추가, 레벨업 등 
;	                                                  	; 전산관리를 이지컴퍼니가 대행해 드리는 비용으로 1회 5만원 
;	                                                  	; 지불하는 것에 동의하시면 9번을 누르세요.
;	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S61_not_enter)	; // 미입력
;	same => n, GotoIf($[${SELNUM} = 9]?:S61_deny)
;	same => n, SayDigits(${SELNUM})
;	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.
;
;	; ----------------------------------------
;	;                                        
;	; ----------------------------------------
;	same => n, Set(digit=5)
;	same => n, read(SELNUM,${wavDIR}/BCMS_023,1,n,3,5)	; 도네이션수익의 50%를 기부하시는데 
;	                                                  	; 동의하시면  5번을 누르세요.
;	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S61_not_enter)	; // 미입력
;	same => n, GotoIf($[${SELNUM} = 5]?:S61_deny)
;	same => n, SayDigits(${SELNUM})
;	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.
;
;	; ----------------------------------------
;	;                                        
;	; ----------------------------------------
;	same => n, Set(digit=8)
;	same => n, read(SELNUM,${wavDIR}/BCMS_024,1,n,3,5)	; 입금하신 금액에서 전산관리비 5만원을 제외한 금액으로 
;	                                                  	; 트론을 구매하여 본인의 만선지갑에 넣어드립니다. 
;	                                                  	; 전체 내용을 이해하시고 동의하시면 8번을 누르세요.  
;	                                                  	; 감사합니다.
;	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S61_not_enter)	; // 미입력
;	same => n, GotoIf($[${SELNUM} = 8]?:S61_deny)
;	same => n, SayDigits(${SELNUM})
;	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.
;	same => n, Set(m_RecSave=2)				; // m_RecSave status 0=not_record,1=rec_start, 2=rec_stop
;
;	same => n, Playback(${wavDIR}/BCMS_033)			; 고객님께서는 전자 동의를 완성하였습니다. 
;	same => n, Playback(${wavDIR}/BCMS_012)			; 이용해 주셔서 감사합니다.
;	same => n, StopMixMonitor()
;	same => n, Hangup()
;
;	; ----------------------------------------
;	;                                        
;	; ----------------------------------------
;	same => n(S61_not_enter), Set(ErrorCode=S61_not_enter)
;	same => n, GoSub(a2p_mldw_stop,s,1(${ErrorCode},1,${digit}))
;	same => n, Hangup()
;
;	same => n(S61_deny), Set(ErrorCode=S61_deny)
;	same => n, GoSub(a2p_mldw_stop,s,1(${ErrorCode},2,${digit}))
;	same => n, Hangup()
;
;exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] a2p_mldw_ezcompany/Hangup ERR=[${ErrorCode} ${ErrCode}] )
;	same => n, GoSubIf($[${m_RecSave} != 0]?a2p_mldw_saveRecFile,s,1(a2p_mldw_ezcompany_hanup))
;	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; a2p_mldw_tronrich                                                              *
;   MLDW 서비스 계약동의 - 트론리치                                              *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[a2p_mldw_tronrich]
exten => s, 1, Noop(a2p_mldw_tronrich)
	same => n, Set(digit=0)

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, GoSub(a2p_mldw_setRecFileName,s,1())
	same => n, Set(m_RecSave=1)				; // m_RecSave status 0=not_record,1=rec_start, 2=rec_stop
	same => n, MixMonitor(${recFileName})

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Playback(${wavDIR}/BCMS_040)			; 주식회사 트론리치 입니다.

	same => n, SayDigits(${m_CALLER})
	same => n, Playback(${wavDIR}/BCMS_034)			; 고객님의.

	same => n, Set(digit=1)
	same => n, read(SELNUM,${wavDIR}/BCMS_041,1,n,3,5)	; 가상화폐 트론구매 및 판매대행에 동의하시면 1번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S62_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = 1]?:S62_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=9)
	same => n, read(SELNUM,${wavDIR}/BCMS_042,1,n,3,5)	; 구매한 트론을 ML지갑에 전송, 등록, 계정추가, 레벨업등 
	                                                  	; 전산관리 업무 대행에 동의하시면 9번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S62_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = 9]?:S62_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=2)
	same => n, read(SELNUM,${wavDIR}/BCMS_043,1,n,3,5)	; 계정 추가시마다 전산관리비용 5만원을 지불하는 것에 
	                                                  	; 동의하시면 2번을 누르세요. 
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S62_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = 2]?:S62_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=5)
	same => n, read(SELNUM,${wavDIR}/BCMS_044,1,n,3,5)	; 계정 6개에서 총 7만원을 기부하는 것에 
	                                                  	; 동의하시면 5번을 누르세요. 
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S62_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = 5]?:S62_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=7)
	same => n, read(SELNUM,${wavDIR}/BCMS_045,1,n,3,5)	; 도네이션수익의 50%를 기부하시는데 
	                                                  	; 동의하시면  7번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S62_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = 7]?:S62_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=8)
	same => n, read(SELNUM,${wavDIR}/BCMS_046,1,n,3,5)	; 전체 내용을 이해하시고 동의하시면  8번을 누르세요. 
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S62_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = 8]?:S62_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.
	same => n, Set(m_RecSave=2)				; // m_RecSave status 0=not_record,1=rec_start, 2=rec_stop

	same => n, Playback(${wavDIR}/BCMS_033)			; 고객님께서는 전자 동의를 완성하였습니다. 
	same => n, Playback(${wavDIR}/BCMS_047)			; 감사합니다.
	same => n, StopMixMonitor()

	same => n, Hangup()

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(S62_not_enter), Set(ErrorCode=S62_not_enter)
	same => n, GoSub(a2p_mldw_stop,s,1(${ErrorCode},1,${digit}))
	same => n, Hangup()

	same => n(S62_deny), Set(ErrorCode=S62_deny)
	same => n, GoSub(a2p_mldw_stop,s,1(${ErrorCode},2,${digit}))
	same => n, Hangup()

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] a2p_mldw_tronrich/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GoSubIf($[${m_RecSave} != 0]?a2p_mldw_saveRecFile,s,1(a2p_mldw_tronrich_hanup))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; a2p_mldw_joeuntech                                                             *
;   MLDW 서비스 계약동의 - 조은테크                                              *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[a2p_mldw_joeuntech]
exten => s, 1, Noop(a2p_mldw_joeuntech)
	same => n, Set(digit=0)

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, GoSub(a2p_mldw_setRecFileName,s,1())
	same => n, Set(m_RecSave=1)				; // m_RecSave status 0=not_record,1=rec_start, 2=rec_stop
	same => n, MixMonitor(${recFileName})

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Playback(${wavDIR}/BCMS_050)			; 가상화페 구매 및 판매를 대행해 드리는 조은테크입니다.

	same => n, SayDigits(${m_CALLER})
	same => n, Playback(${wavDIR}/BCMS_034)			; 고객님의.

	same => n, Set(digit=1)
	same => n, read(SELNUM,${wavDIR}/BCMS_051,1,n,3,5)	; 가상화폐 트론 구매 및 판매를 대행해 드리는데 
	                                                  	; 동의하시면 1번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S63_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = ${digit}]?:S63_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=3)
	same => n, read(SELNUM,${wavDIR}/BCMS_052,1,n,3,5)	; 구매한 트론으로 만선지갑에 전송, 등록, 계정추가,
	                                                  	; 레벨업 등 전산관리를 대행해 드리는데 
	                                                  	; 동의하시면 3번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S63_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = ${digit}]?:S63_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=5)
	same => n, read(SELNUM,${wavDIR}/BCMS_053,1,n,3,5)	; 계정추가시 전산관리 비용으로 300트론을 지불하는 것에 
	                                                  	; 동의하시면 5번을 누르세요. 
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S63_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = ${digit}]?:S63_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.

	same => n, Playback(${wavDIR}/BCMS_054)			; 저희 조은테크에서는 입금하신 금액으로 트론을 구매하여 
	                                       			; 거래소 수수료와 송금수수료를 제외한 트론을 본인의 
	                                       			; 만선지갑에 넣어드립니다. 
	                                       			; 저희는 일정액의 수수료를 받고 회원 가입 및 전산관리를 
	                                       			; 대행해 드리기만 할 뿐 이므로 한번 등록한 계정은 철회가 
	                                       			; 불가합니다. 
	                                       			; 부득이하게 철회시에는 본인이 양수자를 구하여 
	                                       			; 양도 하셔야 합니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=9)
	same => n, read(SELNUM,${wavDIR}/BCMS_055,1,n,3,5)	; 전체 내용을 이해하시고 동의하시면 9번을 누르세요. 
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S63_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = ${digit}]?:S63_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.
	same => n, Set(m_RecSave=2)				; // m_RecSave status 0=not_record,1=rec_start, 2=rec_stop

	same => n, Playback(${wavDIR}/BCMS_056)			; 모든 절차가 완료 되었음을 알려드립니다. 감사합니다.

	same => n, StopMixMonitor()
	same => n, Hangup()

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(S63_not_enter), Set(ErrorCode=S63_not_enter)
	same => n, GoSub(a2p_mldw_stop,s,1(${ErrorCode},1,${digit}))
	same => n, Hangup()

	same => n(S63_deny), Set(ErrorCode=S63_deny)
	same => n, GoSub(a2p_mldw_stop,s,1(${ErrorCode},2,${digit}))
	same => n, Hangup()

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] a2p_mldw_joeuntech/Hangup ERR=[${ErrorCode}] )
	same => n, GoSubIf($[${m_RecSave} != 0]?a2p_mldw_saveRecFile,s,1(a2p_mldw_joeuntech_hanup))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; a2p_mldw_jeongnwoo                                                             *
;   MLDW 서비스 계약동의 - 정앤우                                                *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[a2p_mldw_jeongnwoo]
exten => s, 1, Noop(a2p_mldw_jeongnwoo)
	same => n, Set(digit=0)

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, GoSub(a2p_mldw_setRecFileName,s,1())
	same => n, Set(m_RecSave=1)				; // m_RecSave status 0=not_record,1=rec_start, 2=rec_stop
	same => n, MixMonitor(${recFileName})

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Playback(${wavDIR}/BCMS_060)			; 주식회사 정앤우입니다.

	same => n, SayDigits(${m_CALLER})
	same => n, Playback(${wavDIR}/BCMS_034)			; 고객님의.

	same => n, Set(digit=1)
	same => n, read(SELNUM,${wavDIR}/BCMS_061,1,n,3,5)	; 가상화폐 트론구매 및 판매대행에 동의하시면 1번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S64_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = ${digit}]?:S64_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=7)
	same => n, Playback(${wavDIR}/BCMS_062)			; 구매한 트론을 고객께서 원하시는 가상화폐 지갑에 전송해
	                                       			; 드립니다.
	same => n, Playback(${wavDIR}/BCMS_063)			; 주식회사 정앤우는 가상화폐 구매 및 판매대행만 해드릴뿐
	                                       			; 이므로 원하시는 가상화폐 지갑으로 전송이 완료된 경우 
	                                       			; 환불 및 취소 등에 전혀 책임이 없음을 알려 드립니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=8)
	same => n, read(SELNUM,${wavDIR}/BCMS_064,1,n,3,5)	; 전체 내용을 이해하시고 동의하시면 8번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S64_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = ${digit}]?:S64_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.
	same => n, Set(m_RecSave=2)				; // m_RecSave status 0=not_record,1=rec_start, 2=rec_stop

	same => n, Playback(${wavDIR}/BCMS_065)			; 완료되었습니다. 감사합니다.

	same => n, StopMixMonitor()
	same => n, Hangup()

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(S64_not_enter), Set(ErrorCode=S64_not_enter)
	same => n, GoSub(a2p_mldw_stop,s,1(${ErrorCode},1,${digit}))
	same => n, Hangup()

	same => n(S64_deny), Set(ErrorCode=S64_deny)
	same => n, GoSub(a2p_mldw_stop,s,1(${ErrorCode},2,${digit}))

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] a2p_mldw_jeongnwoo/Hangup ERR=[${ErrorCode}] )
	same => n, GoSubIf($[${m_RecSave} != 0]?a2p_mldw_saveRecFile,s,1(a2p_mldw_jeongnwoo_hanup))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; a2p_mldw_goodrichclub                                                          *
;   MLDW 서비스 계약동의 - 선한부자클럽                                          *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[a2p_mldw_goodrichclub]
exten => s, 1, Noop(a2p_mldw_goodrichclub)
	same => n, Set(digit=0)

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, GoSub(a2p_mldw_setRecFileName,s,1())
	same => n, Set(m_RecSave=1)				; // m_RecSave status 0=not_record,1=rec_start, 2=rec_stop
	same => n, MixMonitor(${recFileName})

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Playback(${wavDIR}/BCMS_070)			; 가상화페 구매 및 판매를 대행해드리는 선한 부자클럽 입니다.

	same => n, SayDigits(${m_CALLER})
	same => n, Playback(${wavDIR}/BCMS_034)			; 고객님의.

	same => n, Set(digit=1)
	same => n, read(SELNUM,${wavDIR}/BCMS_071,1,n,3,5)	; 가상화폐 구매 및 판매업무를 대행해드리는 것에
	                                                  	; 동의하시면 1번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S65_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = ${digit}]?:S65_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=3)
	same => n, read(SELNUM,${wavDIR}/BCMS_072,1,n,3,5)	; 구매한 트론으로 만선지갑에 전송, 및 등록, 계정추가,레벨업
	                                       			; 등 전산관리를 대행해드리는데 동의하시면 3번을 누르세요 
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S65_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = ${digit}]?:S65_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=5)
	same => n, read(SELNUM,${wavDIR}/BCMS_073,1,n,3,5)	; 계정 추가시 전산관리 비용으로 계정당 트론코인 15개를
	                                       			; 지급하는 것에 동의하시면 5번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S65_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = ${digit}]?:S65_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Playback(${wavDIR}/BCMS_074)			; 저희 선한 부자클럽에서는 입금하신 금액으로 트론을 
	                                       			; 구매하여 거래소 수수료와 송금 수수료를 제외한 트론을
	                                       			; 만선지갑에 넣어드립니다. 

	same => n, Playback(${wavDIR}/BCMS_075)			; 저희는 일정액의 수수료를 받고 회원 가입 및 전산 관리를 
	                                       			; 대행해 드리기만 할 뿐이므로 한번 등록한 계정은 철회가 
	                                       			; 불가합니다.
	                                       			; 부득이하게 철회 시에는 본인이 양수자를 구하여 양도하셔야 
	                                       			; 합니다.

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n, Set(digit=9)
	same => n, read(SELNUM,${wavDIR}/BCMS_076,1,n,3,5)	; 전체 내용을 이해하시고 동의하시면 9번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?S65_not_enter)	; // 미입력
	same => n, GotoIf($[${SELNUM} = ${digit}]?:S65_deny)
	same => n, SayDigits(${SELNUM})
	same => n, Playback(${wavDIR}/BCMS_032)			; x 번을 눌러 동의하였습니다.
	same => n, Set(m_RecSave=2)				; // m_RecSave status 0=not_record,1=rec_start, 2=rec_stop

	same => n, Playback(${wavDIR}/BCMS_077)			; 모든 절차가 완료 되었음을 알려드립니다. 감사합니다.

	same => n, StopMixMonitor()
	same => n, Hangup()

	; ----------------------------------------
	;                                        
	; ----------------------------------------
	same => n(S65_not_enter), Set(ErrorCode=S65_not_enter)
	same => n, GoSub(a2p_mldw_stop,s,1(${ErrorCode},1,${digit}))
	same => n, Hangup()

	same => n(S65_deny), Set(ErrorCode=S65_deny)
	same => n, GoSub(a2p_mldw_stop,s,1(${ErrorCode},2,${digit}))

exten => h, 1, Log(NOTICE,BCMS [${m_CALLER} --> ${m_CALLEE}] a2p_mldw_goodrichclub/Hangup ERR=[${ErrorCode}] )
	same => n, GoSubIf($[${m_RecSave} != 0]?a2p_mldw_saveRecFile,s,1(a2p_mldw_goodrichclub))
	same => n, Hangup()
