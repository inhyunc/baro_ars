; ********************************************************************************
; *                                                                              *
; * 장기 보관함 서비스 : Long-Term Storage Service                               *
; *                                                                              *
; ********************************************************************************

[ltss_main]

exten => _X.,1,Noop([ltss_main] Recv Call[${CALLERID(ANI)} --> ${CALLERID(DNID)}] From [${CHANNEL(peerip)}])

	same => n, Answer()
	same => n, Set(CALLER=${CALLERID(ANI)})
	same => n, Set(CALLEE=${CALLERID(DNID)})
	same => n, Goto(ltss_start,1)


exten => ltss_start,1, Noop(ltss_start)

	same => n, Set(CHANNEL(language)=kr)
	same => n, Set(m_CompanyID=0)	; 1=바로서비스, 2=이마트24, 3=피비글로발, 0=미정의, 5=장기보관함
	same => n, Set(wavDIR=sbox)
	same => n, Set(agiDIR=sbox)
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)
	same => n, Set(m_AuthCode=)
	same => n, Set(m_PhoneNumber=)
	same => n, Set(m_BoxNumber=0)
	same => n, Set(m_UserType=0)	; // 1=일반고객, 2=택배기사 문열기, 3=장기사용고객
	same => n, Set(m_PayType=2)	; // 1=GmPOS, 2=CiderPay
	same => n, Set(m_TermType=3)	; // 1=1주일, 2=10일, 3=1개월, 4=종료일지정
	same => n, Set(m_Month=0)	; // 등록 개월수 정보


	; ********************************************************************************
	; 0-0 Greeting Message(인사말)                                                   *
	; ********************************************************************************
	same => n, Set(ErrorCode=L00_greeting)
	same => n, GoSub(GreetingMessage,start,1(${ErrorCode},5))
	same => n, Set(m_CompanyID=${GOSUB_RETVAL})

	; ********************************************************************************
	; 0-1 다우 050 매개 번호 정보 검색                                               *
	; ********************************************************************************
	same => n, Set(ErrorCode=L01_get_dau_050)
	same => n, GoSub(Get_Daou050Number,start,1(${ErrorCode},1))
	same => n, Set(DAOU050NUMBER=${GOSUB_RETVAL})
	same => n, Set(CALLEE=${DAOU050NUMBER})
	same => n, GotoIf($[${DAOU050NUMBER} = 0]?ltss_Finish,1)

	; ********************************************************************************
	; 0-2 BU의 MAC Address 정보 검색                                                 *
	; ********************************************************************************
	same => n, Set(ErrorCode=L02_get_mac_inform)
	same => n, GoSub(Get_BuMacInform,start,1(${ErrorCode}))
	same => n, Set(m_MacAddr=${GOSUB_RETVAL})
	same => n, GotoIf($[${m_MacAddr} = 0]?ltss_Finish,1)
	same => n, ExecIf($["${GROUPNO}"="0128700001"]?Set(m_CompanyID=2))

	; ********************************************************************************
	; 0-3 물품 보관함 내의 소형,중형,대형 크기별로 설정되어 있는 갯수 검색           *
	; ********************************************************************************
	same => n, Set(ErrorCode=L03_get_box_style)
	same => n, GoSub(Get_BoxStyle,start,1(${ErrorCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM} = 0]?ltss_Finish,1)

	; ********************************************************************************
	; [1] 단계 : 서비스 타입 선택                                                    *
	; ********************************************************************************
	same => n(L1_MainMenu), Set(ErrorCode=L1_MainMenu)
	same => n, GoSub(init_Data,start,1(${ErrorCode}))
	same => n, GoSub(playMainMenu,start,1(${ErrorCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM} = 1]?L11_main)	; // 보관함 열기
	same => n, GotoIf($[${SELNUM} = 2]?L21_main)	; // 장기 사용자 등록
	same => n, GotoIf($[${SELNUM} = 3]?L31_main)	; // 부사용자 관리
	same => n, GotoIf($[${SELNUM} = 4]?L61_main)	; // 장기 사용 연장
	same => n, GotoIf($[${SELNUM} = 5]?L71_main)	; // 장기 사용 해지
	same => n, GotoIf($[${SELNUM} = 6]?L81_main)	; // 관리자 모드
	same => n, Goto(ltss_Finish,1)

	; ********************************************************************************
	; [11] 단계 : 보관함 열기                                                        *
	; ********************************************************************************
	same => n(L11_main), Set(ErrorCode=L11_main)
	same => n, GoSub(ltss_OpenLtuBox,start,1(${ErrorCode}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT} = 0]?L1_MainMenu)	; // 이전 단계로 이동
	same => n, GotoIf($[${RESULT} = 1]?L14_main)	; // 추가 요금 결제 요청
	same => n, GotoIf($[${RESULT} = 2]?L21_main)	; // 장기 사용 등록 안내
	same => n, Goto(ltss_GoodBye,1)

	same => n(L14_main), Set(ErrorCode=L14_main)
	same => n, GoSub(ltss_ExtraPayREQ,start,1(${ErrorCode}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT} = 0]?L11_main)	; // 이전 단계로 이동
	same => n, Goto(ltss_GoodBye,1)


	; ********************************************************************************
	; [21] 단계 : 장기 사용자 등록                                                   *
	; ********************************************************************************
	same => n(L21_main), Set(ErrorCode=L21_main)
	same => n, Playback(${wavDIR}/SBOX_230)		; 사용자 등록 단계입니다.

	; ----------------------------------------
	; 비어 있는 보관함 갯수 검색              
	; ----------------------------------------
	same => n, GoSub(check_EmptyLocker,start,1(${ErrorCode}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}!=1111]?ltss_GoodBye,1)

	; ----------------------------------------
	; [22] 단계 : 보관함 크기 선택                   
	; ----------------------------------------
	same => n(L22_main), Set(ErrorCode=L22_main)

	; ----------------------------------------
	; 보관함 크기 동일 크기시 아래 메뉴 SKIP  
	; ----------------------------------------
	same => n, GotoIf($[${m_BoxStyle}>1]?L22_GetBoxType)
	same => n, GoSub(GetStyleEmptyLocker,start,1(${ErrorCode}))
	same => n, Goto(L23_main)

	; ----------------------------------------
	; 보관함 크기 선택                        
	; ----------------------------------------
	same => n(L22_GetBoxType), Noop(L22_GetBoxType)
	same => n, GoSub(sbox_GetBoxType,start,1(${ErrorCode}))	; 보관함 크기를 선택하세요.
	                                                      	; 소형은 1번.
	                                                      	; 중형은 2번.
	                                                      	; 대형은 3번.
	                                                      	; 이전 단계는 별표.
	                                                      	; 다시 듣기는 0번을 누르세요.
	same => n, Set(RESULT=${GOSUB_RETVAL})

	same => n, GotoIf($[${RESULT}=4444]?L1_MainMenu)	; // 이전 단계 -> [1] 단계로 이동
	same => n, GotoIf($[${RESULT}=2222]?L22_main)		; // 비어 있는 보관함 없음 -> 재선택
	same => n, Goto(L23_main)


	; ----------------------------------------
	; [23] 단계 : 선택한 보관함 크기별로 비어 있는 보관함 갯수 검색
	; ----------------------------------------
	same => n(L23_main), Set(ErrorCode=L23_main)
	same => n, Set(m_BoxNumber=${LN0})
	same => n, GoSub(init_Data,start,1(${ErrorCode}))
	same => n, GoSub(ltss_Get_LockBasicFee,start,1(L23_main))
	same => n, Set(m_BasicFee=${GOSUB_RETVAL})

	same => n, GoSub(sbox_SelBoxNumber,start,1(L212_recvDgt,${m_BasicFee}))
	                                                       	; 사용 가능한 보관함은 xx 번 이며,
	                                                       	; 1개월 사용료는 xxxxx 원 입니다.
                                                        	; 이 보관함 사용은 1번.
                                                     		; 다른 보관함으로 변경은 2번.
                                                        	; 보관함 크기 변경은 3번.
                                                        	; 이전 단계는 별표.
                                                        	; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})

	same => n, GotoIf($[${SELNUM}=1]?L24_main) 		; // 현재 보관함 사용 확정
	same => n, GotoIf($[${SELNUM}=3]?L22_main)		; // 보관함 크기 변경                      
	same => n, GotoIf($[${SELNUM}=4]?L1_MainMenu)		; // 이전 단계 -> [1] 단계로 이동
	same => n, Goto(sbox_Finish,1)

	; ----------------------------------------
	; [24] 단계 : 사용 기간 선택              
	; ----------------------------------------
	same => n(L24_main), Set(ErrorCode=L24_main)
	same => n, GoSub(ltss_SelUsingPeriodType,start,1(${ErrorCode}))
	same => n, Set(m_Month=${GOSUB_RETVAL})
	same => n, GotoIf($[${m_Month}=0]?L22_main)		; // 이전 단계 -> [22] 단계로 이동

	; ----------------------------------------
	; [25] 단계 : 선택 정보 및 결제 고지      
	; ----------------------------------------
	same => n(L25_main), Set(ErrorCode=L25_main)
	same => n, GoSub(ltss_GuidePayment,start,1(${ErrorCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?L24_main)		; // 이전 단계 -> [24] 단계로 이동
	same => n, GotoIf($[${SELNUM}=1]?L25_ciderpay)		; // 보관함 예약
	same => n, Goto(ltss_Finish,1)

	; ----------------------------------------
	; 사이다페이 결제 문자 요청               
	; ----------------------------------------
	same => n(L25_ciderpay), Set(ErrorCode=L25_ciderpay)
	same => n, GoSub(procCiderPay,start,1(${CALLER},${m_BasicFee},${m_MacAddr},${ErrorCode}))
	same => n, Goto(ltss_GoodBye,1)


	; ********************************************************************************
	; [31] 단계 : 부사용자 관리                                                      *
	; ********************************************************************************
	same => n(L31_main), Set(ErrorCode=L31_main)
	same => n, GoSub(ltss_playSubUserMainMenu,start,1(${ErrorCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?L32_main) 		; // 부사용자 등록
	same => n, GotoIf($[${SELNUM}=2]?L42_main) 		; // 부사용자 삭제
	same => n, GotoIf($[${SELNUM}=3]?L52_main) 		; // 부사용자 조회
	same => n, GotoIf($[${SELNUM}=0]?L1_MainMenu) 		; // 이전 단계
	same => n, Goto(ltss_GoodBye,1)

	same => n(L32_main), Set(ErrorCode=L32_main)
	same => n, GoSub(ltss_SubUserAddREQ,start,1(${ErrorCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?L31_main) 		; // 이전 단계
	same => n, Goto(ltss_GoodBye,1)

	same => n(L42_main), Set(ErrorCode=L42_main)
	same => n, GoSub(ltss_SubUserDelREQ,start,1(${ErrorCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?L31_main) 		; // 이전 단계
	same => n, Goto(ltss_GoodBye,1)

	same => n(L52_main), Set(ErrorCode=L52_main)
	same => n, GoSub(ltss_SubUserRefREQ,start,1(${ErrorCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?L31_main) 		; // 이전 단계
	same => n, Goto(ltss_GoodBye,1)


	; ********************************************************************************
	; [61] 단계 : 장기 사용 연장                                                     *
	; ********************************************************************************
	same => n(L61_main), Set(ErrorCode=L61_start)
	same => n, GoSub(ltss_renewLTU,start,1(${ErrorCode}))
        same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM} = 0]?L1_MainMenu)			; // 이전 단계
	same => n, Goto(ltss_GoodBye,1)


	; ********************************************************************************
	; [71] 단계 : 장기 사용 해지                                                     *
	; ********************************************************************************
	same => n(L71_main), Set(ErrorCode=L71_start)
	same => n, GoSub(ltss_cancelLTU,start,1(${ErrorCode}))
        same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM} = 0]?L1_MainMenu)			; // 이전 단계
	same => n, Goto(ltss_GoodBye,1)


	; ********************************************************************************
	; [81] 단계 : 관리자 모드                                                        *
	; ********************************************************************************
	same => n(L81_main), Set(ErrorCode=L81_start)

	same => n, GoSub(Get_OpenBoxNumber,start,1(${ErrorCode}))
        same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM} = 0]?L1_MainMenu)			; // 이전 단계
        same => n, Goto(ltss_GoodBye,1)


	; ********************************************************************************
	;                                                                                *
	; 장기 보관함 서비스 종료                                                        *
	;                                                                                *
	; ********************************************************************************
exten => ltss_GoodBye, 1, Log(NOTICE,[${CALLER}] ltss_GoodBye ERR=[${ErrorCode}])
	same => n, Playback(${wavDIR}/SBOX_C04)		; 이용해 주셔서 감사합니다.
	same => n, Hangup()

exten => ltss_Finish, 1, Log(NOTICE,[${CALLER}] ltss_Finish ERR=[${ErrorCode}])
	same => n, Hangup()

exten => h, 1, Log(NOTICE,[${CALLER}] ltss_Hangup ERR=[${ErrorCode}])
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; 장기 보관함 메인 메뉴                                                          *
;                                                                                *
; ********************************************************************************

[playMainMenu]
exten => start,1,Noop(playMainMenu from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode


	same => n(PMM_recvDgt), Set(ErrCode=PMM_recvDgt)

	; ----------------------------------------
	; 메인 메뉴                               
	; ----------------------------------------
	same => n, Read(SELNUM,${wavDIR}/SBOX_210,1,n,1,5)		; 내 보관함 열기는 1번.
	                                                  		; 사용자 등록은 2번.
	                                                  		; 공유 사용자 관리는 3번.
	                                                  		; 장기 사용 연장은 4번.
	                                                  		; 장기 사용 해지은 5번.
	                                                  		; 관리자 모드는 6번.
	                                                  		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?PMM_not_enter)		; // 미입력

	same => n, GotoIf($["${SELNUM}"="1"]?PMM_1)
	same => n, GotoIf($["${SELNUM}"="2"]?PMM_2)
	same => n, GotoIf($["${SELNUM}"="3"]?PMM_3)
	same => n, GotoIf($["${SELNUM}"="4"]?PMM_4)
	same => n, GotoIf($["${SELNUM}"="5"]?PMM_5)
	same => n, GotoIf($["${SELNUM}"="6"]?PMM_6)
	same => n, GotoIf($["${SELNUM}"="0"]?PMM_recvDgt)

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(PMM_wrong), Set(ErrCode=PMM_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(PMM_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(PMM_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(PMM_not_enter), Set(ErrCode=PMM_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(PMM_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(PMM_recvDgt)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PMM_1), Return(1)
	same => n(PMM_2), Return(2)
	same => n(PMM_3), Return(3)
	same => n(PMM_4), Return(4)
	same => n(PMM_5), Return(5)
	same => n(PMM_6), Return(6)


exten => h,1, Log(NOTICE,[${CALLER}] playMainMenu/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; 장기 사용 기간 선택                                                            *
;                                                                                *
; ********************************************************************************

[ltss_SelUsingPeriodType]
exten => start,1,Noop(ltss_SelUsingPeriodType from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode

	same => n(SUPT_recvDgt), Set(ErrCode=SUPT_recvDgt)

	; ----------------------------------------
	; 메인 메뉴                               
	; ----------------------------------------
	same => n, Read(SELNUM,${wavDIR}/SBOX_236,1,n,1,5)		; 사용 기간 설정 단계입니다.
	                                                  		; 1개월 사용은 1번.
	                                                  		; 6개월 사용은 2번.
	                                                  		; 12개월 사용은 3번.
	                                                  		; 이전 단계는 별표.
	                                                  		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?SUPT_not_enter)		; // 미입력

	same => n, GotoIf($["${SELNUM}"="1"]?SUPT_1)
	same => n, GotoIf($["${SELNUM}"="2"]?SUPT_2)
	same => n, GotoIf($["${SELNUM}"="3"]?SUPT_3)
	same => n, GotoIf($["${SELNUM}"="*"]?SUPT_4)
	same => n, GotoIf($["${SELNUM}"="0"]?SUPT_recvDgt)

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(SUPT_wrong), Set(ErrCode=SUPT_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(SUPT_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(SUPT_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(SUPT_not_enter), Set(ErrCode=SUPT_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(SUPT_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(SUPT_recvDgt)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SUPT_1), Return(1)	; //  1 개월
	same => n(SUPT_2), Return(6)	; //  6 개월
	same => n(SUPT_3), Return(12)	; // 12 개월
	same => n(SUPT_4), Return(0)	; // 이전 단계로 이동


exten => h,1, Log(NOTICE,[${CALLER}] ltss_SelUsingPeriodType/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; 장기 사용 등록 정보 안내                                                       *
;                                                                                *
; ********************************************************************************

[ltss_GuidePayment]
exten => start,1,Noop(ltss_GuidePayment from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=LGP_get_ltu_info)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GoSub(agi_GetLtuInfo,start,1(${ErrCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?LGLI_succ)
	same => n, GotoIf($[${SELNUM}=2]?LGLI_fail)
	same => n, Goto(ltss_main,ltss_Finish,1)

	same => n(LGLI_fail), Set(ErrCode=LGLI_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(GLI_reg_fail,SBOX_023,1))
	same => n, Goto(ltss_main,ltss_Finish,1)

	same => n(LGLI_succ), Set(ErrCode=LGLI_succ)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(LGP_recvDgt), Set(ErrCode=LGP_recvDgt)

	same => n, Playback(${wavDIR}/SBOX_237)				; 사용하실 보관함은
	same => n, GoSub(read_Number,start,1(${m_BoxNumber},B))		; xx 번
	same => n, Playback(${wavDIR}/SBOX_C23)				; 이고,
	same => n, Playback(${wavDIR}/SBOX_238)				; 사용 기간은 오늘부터
	same => n, GoSub(read_Number,start,1(${m_month},M))		; xx 월
	same => n, GoSub(read_Number,start,1(${m_day},D))		; xx 일
	same => n, Playback(${wavDIR}/SBOX_C16)				; 까지  
	same => n, GoSub(read_Number,start,1(${m_Month},m))		; xx 개월
	same => n, Playback(${wavDIR}/SBOX_C23)				; 이며,  
	same => n, Playback(${wavDIR}/SBOX_239)				; 사용 요금은
	same => n, GoSub(read_Number,start,1(${m_BasicFee},W))		; xxxxx 원
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.
	same => n, Playback(${wavDIR}/SBOX_240)				; 결제를 하시면 오늘부터 사용할 수 있습니다. 
	same => n, Playback(${wavDIR}/SBOX_241)				; 사용 기간이 지나면,
	                                      				; 추가 요금을 지불한 후에 보관함을 열 수 있습니다.


	same => n, Read(SELNUM,${wavDIR}/SBOX_242,1,n,1,5)		; 결제는 1번.
	                                                     		; 이전 단계는 별표.
	                                                     		; 다시 듣기는 0번을 누르세요.

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?LGP_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="1"]?LGP_succ) 			; // 현재 보관함 사용 확정
	same => n, GotoIf($["${SELNUM}"="*"]?LGP_0)			; // 이전 단계 이동
	same => n, GotoIf($["${SELNUM}"="0"]?LGP_recvDgt)		; // 다시 듣기


	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(LGP_wrong), Set(ErrCode=LGP_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(LGP_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(LGP_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(LGP_not_enter), Set(ErrCode=LGP_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(LGP_wrong,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(LGP_recvDgt)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(LGP_succ), Set(ErrCode=LGP_succ)
	same => n, GoSub(agi_RegLtu,start,1(${ErrCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?LGP_1)
	same => n, GotoIf($[${SELNUM}=2]?LGP_fail)
	same => n, Goto(ltss_main,ltss_Finish,1)

	same => n(LGP_fail), Set(ErrCode=LGP_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(LGP_reg_fail,SBOX_023,1))
	same => n, Goto(ltss_main,ltss_Finish,1)		; // 원인없이 종료

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(LGP_0), Return(0)	; // 이전 단계
	same => n(LGP_1), Return(1)	; // 성공

exten => h,1, Log(NOTICE,[${CALLER}] ltss_GuidePayment/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; 장기 사용자 보관함 열기                                                        *
; - 장기 사용 기간중인 경우에는 문열기                                           *
; - 장기 사용 기간이 만료한 경우에는 추가 요금 결제 요청                         *
;                                                                                *
; ********************************************************************************

[ltss_OpenLtuBox]
exten => start,1,Noop(ltss_OpenLtuBox from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})
	same => n, Set(LOCAL(countOPEN)=0)

	same => n, Set(LOCAL(countShare)=0)
	same => n, Set(LOCAL(countLtu)=0)
	same => n, Set(LOCAL(countSUM)=0)

	same => n(OLB_check_1), Set(ErrCode=check_1)
	same => n, GoSub(ltss_GetLtsuLockNumber,start,1(${ErrCode},${CALLER},2))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}!=1]?OLB_check_2)
	same => n, ExecIf($[${m_UsingCount}>0]?Set(countShare=2))

	same => n(OLB_check_2), Set(ErrCode=check_2)
	same => n, GoSub(GetLtuLockNumber,start,1(${ErrCode},${CALLER},2))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}!=1111]?OLB_check_3)
	same => n, ExecIf($[${m_UsingCount}>0]?Set(countLtu=1))

	same => n(OLB_check_3), Set(ErrCode=check_3)
	same => n, Set(countSUM=$[${countLtu}+${countShare}])
	same => n, Noop(----------------------------- countLtu=${countLtu})
	same => n, Noop(----------------------------- countShare=${countShare})
	same => n, Noop(----------------------------- countSUM=${countSUM})

	same => n, GotoIf($[${countSUM}=0]?OLB_not_reged)	; // 사용중인 보관함 없슴
	same => n, GotoIf($[${countSUM}=1]?OLB_sel_Ltu)		; // 장기 사용자
	same => n, GotoIf($[${countSUM}=2]?OLB_sel_Ltsu)	; // 공유 사용자

	same => n, GoSub(SelStorageType,start,1(${ErrCode}))
	same => n, GotoIf($[${SELNUM}=1]?OLB_sel_Ltu)		; // 장기 사용자
	same => n, GotoIf($[${SELNUM}=2]?OLB_sel_Ltsu)		; // 공유 사용자
	same => n, Return(0)

	; ----------------------------------------
	; 장기 사용 등록 고객 여부 확인 및 장기 사용중인 보관함 정보 가져오기                     
	; ----------------------------------------
	same => n(OLB_sel_Ltu), Set(ErrCode=OLB_sel_Ltu)
	same => n, GoSub(GetLtuLockNumber,start,1(${ErrCode},${CALLER},2))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}=1111]?OLB_selBoxNumber)		; // 장기 사용자
	same => n, Goto(OLB_not_reged)

	same => n(OLB_sel_Ltsu), Set(ErrCode=OLB_sel_Ltsu)
	same => n, GoSub(ltss_GetLtsuLockNumber,start,1(${ErrCode},${CALLER},2))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}=1]?OLB_selBoxNumber)		; // 공유 사용자
	same => n, Goto(OLB_not_reged)

	; ----------------------------------------
	; 장기 사용자가 아닌 경우                 
	; ----------------------------------------
	same => n(OLB_not_reged), Set(ErrCode=OLB_not_reged)
	same => n, Playback(${wavDIR}/SBOX_223)				; 죄송합니다.
	                                       				; 고객님은 등록된 가입자가 아닙니다.
	                                       				; 먼저 사용자 등록을 하십시요.
	                                       				; 안내하겠습니다.
	same => n, Goto(OLB_not_reg)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(OLB_selBoxNumber), Set(ErrCode=OLB_selBoxNumber)
	same => n, Set(countLOOP=1)
	same => n, Set(m_BoxNumber=${LN0})
	same => n, GotoIf($[${m_UsingCount}=1]?OLB_LTU_succ)

	same => n, GoSub(play_Count,start,1(${ErrCode},${m_UsingCount},1))	; 고객님께서 보관중인 물품이 xx 개 있습니다.
	same => n, Wait(1)
	same => n, Set(m_EmptyCount=${m_UsingCount})

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(OLB_rcvDgt), Set(ErrCode=OLB_rcvDgt)
	same => n, GoSub(get_YourBoxNumber,start,1(${ErrCode}))		; 보관함 xx 번에 있는 물품을 찾으시겠습니까?
	                                                         	; 찾기는 1번.
	                                                         	; 다른 보관함의 물품을 찾기는 2번.
	                                                         	; 이전 단계는 별표.
	                                                         	; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})

	same => n, GotoIf($[${SELNUM}=1]?OLB_LTU_succ)			; // 열기
	same => n, GotoIf($[${SELNUM}=2]?OLB_ChkPreStep)		; // 이전 단계로 이동
	same => n, Goto(ltss_main,ltss_Finish,1)			; // 원인없이 종료

	same => n(OLB_ChkPreStep), Set(ErrCode=OLB_ChkPreStep)
	same => n, GotoIf($[${countSUM}=3]?OLB_check_3:OLB_PreStep)


	; ----------------------------------------
	; 특정 보관함 정보 가져오기(만료여부, 만료 날짜, 추가요금)            
	; ----------------------------------------
	same => n(OLB_LTU_succ), Set(ErrCode=OLB_LTU_succ)
	same => n, GoSub(GetLtuLockInfo,start,1(${ErrCode},${m_BoxNumber}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}=1111]?OLB_openBox)		; // 사용 기간중
	same => n, GotoIf($[${RESULT}=2222]?OLB_PayExtra)		; // 사용 기간 만료로 추가 결제 요금 발생

	same => n(OLB_openBox), Set(ErrCode=OLB_openBox)
	same => n, Set(m_UserType=3)					; // 1=일반고객, 2=택배기사 문열기, 3=장기사용고객
	same => n, GoSub(OpenBoxDoor,start,1(${ErrCode},3))		; xx번 보관함 문을 열었습니다.
	same => n, GotoIf($[${m_UsingCount} = ${countOPEN}]?OLB_ChkGoodBye)
	same => n, GotoIf($[${m_UsingCount} > 1]?OLB_recvDgt)
	same => n, Goto(OLB_ChkGoodBye)					; // 원인없이 종료

	same => n(OLB_ChkGoodBye), Set(ErrCode=OLB_ChkGoodBye)
	same => n, GotoIf($[${countSUM}=3]?OLB_check_3:OLB_GoodBye)
	
	same => n(OLB_PreStep), Return(0)				; // 이전 단계로 이동
	same => n(OLB_PayExtra), Return(1)				; // 추가 요금 결제 요청
	same => n(OLB_not_reg), Return(2)				; // 장기 사용자 아님으로 등록 단계로 안내
	same => n(OLB_GoodBye), Goto(ltss_main,ltss_GoodBye,1)		; // 원인없이 종료

	same => n(OLB_recvDgt), Set(ErrCode=OLB_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/SBOX_214,1,n,1,5)		; 다른 보관함의 물품 찾기는 1번.
	                                                  		; 서비스 종료는 2번.
	                                                  		; 이전 단계는 별표.
	                                                  		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?OLB_not_enter)		; // 미입력

	same => n, GotoIf($["${SELNUM}"="1"]?OLB_NextBox)		; // 다음 보관함 열기
	same => n, GotoIf($["${SELNUM}"="2"]?OLB_GoodBye)		; // 서비스 종료
	same => n, GotoIf($["${SELNUM}"="*"]?OLB_ChkPreStep)		; // 이전 단계
	same => n, GotoIf($["${SELNUM}"="0"]?OLB_recvDgt)		; // 다시 듣기 선택

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(OLB_wrong), Set(ErrCode=OLB_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(OLB_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(OLB_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(OLB_not_enter), Set(ErrCode=OLB_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(OLB_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(OLB_recvDgt)

	same => n(OLB_NextBox), Set(ErrCode=OLB_NextBox)
	same => n, GoSub(sbox_GetNextBox,start,1(${m_UsingCount},${ErrCode})) ; // 다음 보관함 번호 가져오기
	same => n, Set(countOPEN=$[${countOPEN}+1])
	same => n, Goto(OLB_rcvDgt)


exten => h,1, Log(NOTICE,[${CALLER}] ltss_OpenLtuBox/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; 부사용자 여부 조회 및 사용중인 보관함 정보 조회                                *
;                                                                                *
; ********************************************************************************
[SelStorageType]
exten => start,1,Noop(SelStorageType from ${ARG1})
	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n(SST_rcvDgt), Set(ErrCode=SST_rcvDgt)
	same => n, Read(SELNUM,${wavDIR}/SBOX_224,1,n,1,3)		; 고객님은 장기 사용자 이면서 공유 사용자입니다.
	                                                  		; 장기 사용 보관함 열기는 1번.
	                                                  		; 공유 사용 보관함 열기는 2번.
	                                                  		; 이전 단계는 별표.
	                                                  		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?SST_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="1"]?SST_1)			; // 장기 보관함 열기
	same => n, GotoIf($["${SELNUM}"="2"]?SST_2)			; // 공유 보관함 열기
	same => n, GotoIf($["${SELNUM}"="*"]?SST_0)			; // 이전 단계 선택
	same => n, GotoIf($["${SELNUM}"="0"]?SST_rcvDgt)		; // 다시 듣기 선택

	same => n(SST_wrong), Set(ErrCode=SST_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(SST_wrong,SBOX_C01,2))
	same => n, Goto(SST_rcvDgt)

	same => n(SST_not_enter), Set(ErrCode=SST_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(SST_not_enter,SBOX_C02,3))
	same => n, Goto(SST_rcvDgt)

	same => n(SST_1), Return(1)	; // 장기 보관함 열기
	same => n(SST_2), Return(2)	; // 공유 보관함 열기
	same => n(SST_0), Return(0)	; // 이전 단계

exten => h,1, Log(NOTICE,[${CALLER}] SelStorageType/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; 부사용자 여부 조회 및 사용중인 보관함 정보 조회                                *
;                                                                                *
; ********************************************************************************

[ltss_GetLtsuLockNumber]

exten => start,1,Noop(ltss_GetLtsuLockNumber from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode
	same => n, Set(RESULT=)

	same => n, Set(m_PhoneNumber=${CALLER})
	; ----------------------------------------
	; 부사용자 정보 조회                      
	; ----------------------------------------
	same => n, AGI(${agiDIR}/sbox_get_subuser_box.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_get_subuser_box.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_UsingCount=[${m_UsingCount}] )

;	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(GSLN_agi_fail,SBOX_021,0))

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?GSLN_bad)
	same => n, GotoIf($["${RESULT}"="1111"]?GSLN_succ)		; // 등록된 부사용자 OK
;	same => n, GotoIf($["${RESULT}"="2222"]?GSLN_fail)		; // 미등록 사용자
;	same => n, GoSub(sbox_PlayErrMesg,start,1(GSLN_not_define,SBOX_022,0))
	same => n, Goto(GSLN_bad)					; // 등록된 부사용자이나 정보 가지고 오지 못함

	same => n(GSLN_succ), Return(1)		; // 등록된 부사용자
	same => n(GSLN_bad), Return(2)		; // AGI 정합 실패
	same => n(GSLN_fail), Return(0)		; // 미등록


exten => h,1, Log(NOTICE,[${CALLER}] ltss_GetLtsuLockNumber/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; 장기 사용자 추가 요금 결제 요청                                                *
;                                                                                *
; ********************************************************************************

[ltss_ExtraPayREQ]
exten => start,1,Noop(ltss_ExtraPayREQ from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode

	; ----------------------------------------
	; 장기 사용 기간 만료 안내                
	; ----------------------------------------
	same => n, GoSub(check_ExpireUsing,start,1(${ErrCode},${m_BoxNumber},${m_Month},${m_Day},${m_AddFee},1))
	                                                        ; xx 번 보관함의
	                                                        ; 장기 사용 기간이 xx 월 xx 일로 만료되었으며
	                                                        ; 추가 요금 xxxx 원이 발생하였습니다.
	                                                        ; 결제는 1번.
	                                                        ; 이전 단계는 별표.
	                                                        ; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?EPR_payment)		; // 추가 요금 지불
	same => n, GotoIf($[${SELNUM}=0]?EPR_0)			; // 이전 단계
	same => n, Goto(EPR_2)					; // 원인없이 종료

	; ----------------------------------------
	; 장기 사용 추가 요금 지불                
	; ----------------------------------------
	same => n(EPR_payment), Set(ErrCode=EPR_payment)
	same => n, GoSub(pay_ExtraFee,start,1(${ErrCode},${m_BoxNumber},${m_AddFee},1,${m_PayType}))
	                                                        ; 지금 결제하시겠습니까?
	                                                        ; 결제는 1번.
	                                                        ; 이전 단계는 별표를.
	                                                        ; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?EPR_0)			; // 이전 단계
	same => n, GotoIf($[${SELNUM}=1]?EPR_paySucc)		; // 추가 요금 결제 요청 성공 --> 서비스 종료
	same => n, GotoIf($[${SELNUM}=2]?EPR_payFail)		; // 추가 요금 결제 요청 실패 --> 서비스 종료
	same => n, Goto(EPR_2)					; // 원인없이 종료

	; ----------------------------------------
	; 추가 요금 결제 요청 및 서비스 종료              
	; ----------------------------------------
	same => n(EPR_paySucc), Set(ErrCode=EPR_paySucc)
	same => n, GotoIF($[${m_PayType}=2]?EPR_ciderpay)	; // CiderPay 결제
	same => n, Goto(EPR_1)					; // 정상수행

	same => n(EPR_payFail), Set(ErrCode=EPR_payFail)
	same => n, Goto(EPR_2)					; // 원인없이 종료

	; ----------------------------------------
	; CiderPay 결제 문자 요청                 
	; ----------------------------------------
	same => n(EPR_ciderpay), Set(ErrCode=EPR_ciderpay)
	same => n, GoSub(procCiderPay,start,1(${CALLER},${m_AddFee},${m_MacAddr},${ErrCode}))
	same => n, Goto(EPR_2)				; // 원인없이 종료

	same => n(EPR_0), Return(0)				; // 이전단계
	same => n(EPR_1), Return(1)				; // 정상수행
	same => n(EPR_2), Return(2)				; // 원인없이 종료

exten => h,1, Log(NOTICE,[${CALLER}] ltss_ExtraPayREQ/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()




; ********************************************************************************
;                                                                                *
; 부사용자 관리 메인 메뉴                                                        *
;                                                                                *
; ********************************************************************************

[ltss_playSubUserMainMenu]
exten => start,1,Noop(ltss_playSubUserMainMenu from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode


	; ----------------------------------------
	; 주사용자 여부 확인                           
	; ----------------------------------------
	same => n, AGI(${agiDIR}/sbox_get_ltu_LockNumber.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_get_ltu_LockNumber.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] )

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(SUMM_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?SUMM_recvDgt)

	; ----------------------------------------
	; 주사용자가 아닌 경우                       
	; ----------------------------------------
	same => n, Playback(${wavDIR}/SBOX_255)				; 죄송합니다.고객님은 이 서비스를 이용할 수 없습니다.
	same => n, Goto(SUMM_0)

	; ----------------------------------------
	; 메인 메뉴                               
	; ----------------------------------------
	same => n(SUMM_recvDgt), Set(ErrCode=SUMM_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/SBOX_250,1,n,1,5)		; 부사용자 등록은 1번.
	                                                  		; 삭제는 2번.
	                                                  		; 조회는 3번.
	                                                  		; 이전 단계는 별표.
	                                                  		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?SUMM_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="1"]?SUMM_1)			; // 등록
	same => n, GotoIf($["${SELNUM}"="2"]?SUMM_2)			; // 삭제
	same => n, GotoIf($["${SELNUM}"="3"]?SUMM_3)			; // 조회
	same => n, GotoIf($["${SELNUM}"="*"]?SUMM_0)			; // 이전 단계
	same => n, GotoIf($["${SELNUM}"="0"]?SUMM_recvDgt)		; // 다시 듣기 선택

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(SUMM_wrong), Set(ErrCode=SUMM_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(SUMM_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(SUMM_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(SUMM_not_enter), Set(ErrCode=SUMM_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(SUMM_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(SUMM_recvDgt)

	same => n(SUMM_0), Return(0)	; // 이전 단계
	same => n(SUMM_1), Return(1)	; // 등록
	same => n(SUMM_2), Return(2)	; // 삭제
	same => n(SUMM_3), Return(3)	; // 조회

exten => h,1, Log(NOTICE,[${CALLER}] ltss_playSubUserMainMenu/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()


; ********************************************************************************
;                                                                                *
; 부사용자 등록 갯수 가져오기                                                    *
;                                                                                *
; ********************************************************************************

[GetSubuserInform]

exten => start,1,Noop(GetSubuserInform from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode

	same => n, AGI(${agiDIR}/sbox_get_subuser_inform.php)
	same => n, Log(NOTICE,[${CALLER}] get_subuser_inform.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_SubUserCount=[${m_SubUserCount}] )

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(GSRC_get_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?GSRC_agi_get_ok)
	same => n, GotoIf($["${RESULT}"="2222"]?GSRC_agi_get_ok)
	same => n, GoSub(sbox_PlayErrMesg,start,1(GSRC_get_not_define,SBOX_022,1))

	same => n(GSRC_agi_get_ok), Set(ErrCode=GSRC_agi_get_ok)
	same => n, ExecIf($["${RESULT}"="2222"]?Set(m_SubUserCount=0)
	same => n, Return(${m_SubUserCount})


exten => h,1, Log(NOTICE,[${CALLER}] GetSubuserInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()


; ********************************************************************************
;                                                                                *
; 전화 번호 입력하기                                                             *
;                                                                                *
; ********************************************************************************

[RecvPhoneNumber]

exten => start,1,Noop(RecvPhoneNumber from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode
	same => n, Set(LOCAL(wavFile)=${ARG2})				; ErrCode
	same => n, Set(LOCAL(maxDgt)=${ARG3})				; ErrCode
	same => n, Set(LOCAL(PhoneNumber)=)				; ErrCode
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n(RPN_rcvDgt), Set(ErrCode=RPN_rcvDgt)
	same => n, Read(PhoneNumber,${wavDIR}/${wavFile},${maxDgt},n,1,10)	; 고객님의 보관함을 같이 사용하실 전화 번호와 #을 입력하세요.

	same => n, GotoIf($[${LEN(${PhoneNumber})}=0]?RPN_not_enter)
	same => n, GotoIf($[${LEN(${PhoneNumber})}<10]?RPN_wrong)

	same => n, Return(${PhoneNumber})

	; ----------------------------------------
	; 입력 번호가 10자리 미만인 경우          
	; ----------------------------------------
	same => n(RPN_wrong), Set(ErrCode=RPN_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(RPN_wrong,SBOX_256,2))	; 전화 번호는 10자리 이상이어야 합니다.
	same => n, Goto(RPN_rcvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(RPN_not_enter), Set(ErrCode=RPN_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(RPN_not_enter,SBOX_C02,3))
	same => n, Goto(RPN_rcvDgt)

exten => h,1, Log(NOTICE,[${CALLER}] RecvPhoneNumber/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()


; ********************************************************************************
;                                                                                *
; 입력된 전화 번호 처리 방법 질의                                                *
;                                                                                *
; ********************************************************************************

[CheckPhoneNumber]

exten => start,1,Noop(CheckPhoneNumber from [${ARG1}/${ARG2}/${ARG3}])

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode
	same => n, Set(LOCAL(ExeType)=${ARG2})				; 1=add, 2=del, 3=ref
	same => n, Set(LOCAL(PhoneNumber)=${ARG3})			; 
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Set(wavFile1=SBOX_252)
	same => n, ExecIf($[${ExeType}=2]?Set(wavFile1=SBOX_252))s	; 입력하신 번호는
	same => n, ExecIf($[${ExeType}=3]?Set(wavFile1=SBOX_271))	; 삭제하고자 하는 번호는

	same => n, Set(wavFile2=SBOX_253)
	same => n, ExecIf($[${ExeType}=2]?Set(wavFile2=SBOX_262))
	same => n, ExecIf($[${ExeType}=3]?Set(wavFile2=SBOX_272))
	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(CPN_talkNumber), Set(ErrCode=CPN_talkNumber)
	same => n, Playback(${wavDIR}/${wavFile1})				; {입력하신 | 삭제하고자 하는} 번호는
	same => n, SayDigits(${PhoneNumber})				; xxxxxxxx
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(CPN_rcvDgt), Set(ErrCode=CPN_rcvDgt)
	same => n, Read(SELNUM,${wavDIR}/${wavFile2},1,n,1,3)		;
		; SBOX_253 = 입력 번호 등록은 1번. 입력 번호 변경은 2번. 이전 단계는 별표. 다시 듣기는 0번을 누르세요.
		; SBOX_262 = 입력 번호 삭제는 1번. 입력 번호 변경은 2번. 이전 단계는 별표. 다시 듣기는 0번을 누르세요.
		; SBOX_272 =           삭제는 1번.           취소는 2번. 이전 단계는 별표. 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?CPN_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="1"]?CPN_1)			; // 등록/삭제 선택
	same => n, GotoIf($["${SELNUM}"="2"]?CPN_2)			; // 변경/취소 선택
	same => n, GotoIf($["${SELNUM}"="*"]?CPN_0)			; // 이전 단계 선택
	same => n, GotoIf($["${SELNUM}"="0"]?CPN_talkNumber)		; // 다시 듣기 선택

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(CPN_wrong), Set(ErrCode=CPN_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(CPN_wrong,SBOX_C01,2))
	same => n, Goto(CPN_talkNumber)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(CPN_not_enter), Set(ErrCode=CPN_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(CPN_not_enter,SBOX_C02,3))
	same => n, Goto(CPN_talkNumber)

	same => n(CPN_1), Return(1)	; // 등록/삭제
	same => n(CPN_2), Return(2)	; // 변경/취소
	same => n(CPN_0), Return(0)	; // 이전 단계

exten => h,1, Log(NOTICE,[${CALLER}] CheckPhoneNumber/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()


; ********************************************************************************
;                                                                                *
; 주사용자가 등록한 보관함 선택                                                  *
;                                                                                *
; ********************************************************************************

[ltss_CheckBoxNumber]

exten => start,1,Noop(ltss_CheckBoxNumber from ${ARG1}/${ARG2})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode
	same => n, Set(LOCAL(wavFile)=${ARG2})
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(LCBN_recvDgt), Set(ErrCode=LCBN_recvDgt)
	same => n, Playback(${wavDIR}/SBOX_281)				; 공유 사용이 가능한 보관함은
	same => n, GoSub(read_Number,start,1(${m_BoxNumber},B))		; xx 번
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.


	same => n, Read(SELNUM,${wavDIR}/${wavFile},1,n,1,5)		; SBOX_282 : 이 보관함에 공유 사용자 등록은 1번.
	                                                    		; SBOX_283 : 이 보관함의 공유 사용자 삭제는 1번.
	                                                    		; SBOX_284 : 이 보관함의 공유 사용자 조회는 1번.
	                                                    		; 다른 보관함으로 변경은 2번.
	                                                    		; 이전 단계는 별표.
	                                                    		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?LCBN_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="0"]?LCBN_recvDgt)		; // 다시 듣기
	same => n, GotoIf($["${SELNUM}"="1"]?LCBN_1) 			; // 현재 보관함 사용 확정
	same => n, GotoIf($["${SELNUM}"="2"]?LCBN_nextBox)		; // 다른 보관함으로 변경
	same => n, GotoIf($["${SELNUM}"="*"]?LCBN_0)			; // 이전 단계 이동


	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(LCBN_wrong), Set(ErrCode=LCBN_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(LCBN_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(LCBN_recvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(LCBN_not_enter), Set(ErrCode=LCBN_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(LCBN_wrong,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(LCBN_recvDgt)


	; ----------------------------------------
	; 다른 보관함으로 변경                    
	; ----------------------------------------
	same => n(LCBN_nextBox), Set(ErrorCode=LCBN_nextBox)
	same => n, GoSub(sbox_GetNextBox,start,1(${m_UsingCount},${ErrorCode}))
	same => n, Goto(LCBN_recvDgt)


	same => n(LCBN_1), Return(1)	; // 선택
	same => n(LCBN_2), Return(2)	; // 종료
	same => n(LCBN_0), Return(0)	; // 이전단계


exten => h,1, Log(NOTICE,[${CALLER}] ltss_CheckBoxNumber/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()

; ********************************************************************************
;                                                                                *
; 다음 단계 진행 여부 체크                                                       *
;                                                                                *
; ********************************************************************************

[check_NextStep]

exten => start,1,Noop(check_NextStep from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode
	same => n, Set(LOCAL(wavFile)=${ARG2})				; 1=add, 2=del, 3=ref
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	; ----------------------------------------
	; 멘트 내용                                   
	; SBOX_254 : 보관함 번호 선택은 1번. 부사용자 등록 번호 입력은 2번.
	; SBOX_263 : 보관함 번호 선택은 1번. 부사용자 삭제 번호 입력는 2번.
	; SBOX_273 : 보관함 번호 선택은 1번. 부사용자 번호 조회는 2번. 
	; 공동 멘트: 서비스 종료는 3번. 이전 단계는 별표. 다시 듣기는 0번을 누르세요.
	; ----------------------------------------
	same => n(CNS_rcvDgt), Set(ErrCode=CNS_rcvDgt)

	same => n, Read(SELNUM,${wavDIR}/${wavFile},1,n,1,3)

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?CNS_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="1"]?CNS_1)			; // 보관함 선택
	same => n, GotoIf($["${SELNUM}"="2"]?CNS_2)			; // 입력/삭제/조회 선택 
	same => n, GotoIf($["${SELNUM}"="3"]?CNS_3)			; // 서비스 종료 선택
	same => n, GotoIf($["${SELNUM}"="*"]?CNS_0)			; // 이전 단계 선택
	same => n, GotoIf($["${SELNUM}"="0"]?CNS_rcvDgt)		; // 다시 듣기 선택

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(CNS_wrong), Set(ErrCode=CNS_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(CNS_wrong,SBOX_C01,2))
	same => n, Goto(CNS_rcvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(CNS_not_enter), Set(ErrCode=CNS_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(CNS_not_enter,SBOX_C02,3))
	same => n, Goto(CNS_rcvDgt)

	same => n(CNS_1), Return(1)	; // 보관함 선택
	same => n(CNS_2), Return(2)	; // 입력/삭제/조회
	same => n(CNS_3), Return(3)	; // 서비스 종료
	same => n(CNS_0), Return(0)	; // 이전 단계

exten => h,1, Log(NOTICE,[${CALLER}] check_NextStep/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()

; ********************************************************************************
;                                                                                *
; 부사용자 등록 정보 조회                                                        *
;                                                                                *
; ********************************************************************************

[RefSubUser]

exten => start,1,Noop(RefSubUser from ${ARG1})
	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode
	same => n, Set(LOCAL(wavFile)=${ARG2})				; 1=add, 2=del, 3=ref
	same => n, Set(LOCAL(PhoneNumber)=)				; 1=add, 2=del, 3=ref
	same => n, Set(countWRONG=0)
	same => n, Set(countENTER=0)

	same => n, Set(m_PhoneNumber=${DN0})
	same => n, Set(countLOOP=1)

	same => n(RSU_talkUserNumber), Set(ErrCode=RSU_talkUserNumber)
	same => n, Playback(${wavDIR}/SBOX_268)				; 등록되어 있는 부사용자는
	same => n, GoSub(read_Number,start,1(${m_SubUserCount},P))	; xx 명,
	same => n, Playback(${wavDIR}/SBOX_C15)				; 이고,
	same => n, Playback(${wavDIR}/SBOX_269)				; 현재 조회된 부사용자 번호는
	same => n, SayDigits(${m_PhoneNumber})				; xxxxxxxx
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(RSU_rcvDgt), Set(ErrCode=RSU_rcvDgt)
	same => n, Read(SELNUM,${wavDIR}/SBOX_270,1,n,1,3)		; 다음 부사용자 번호 조회는 1번.
	                                                  		; 현재 조회 번호 삭제는 2번.
	                                                  		; 이전 단계는 별표.
	                                                  		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?RSU_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}"="1"]?RSU_NextUser)		; // 다음 가입자 조회 선택
	same => n, GotoIf($["${SELNUM}"="2"]?RSU_2)			; // 삭제 선택
	same => n, GotoIf($["${SELNUM}"="*"]?RSU_0)			; // 이전 단계 선택
	same => n, GotoIf($["${SELNUM}"="0"]?RSU_talkUserNumber)	; // 다시 듣기 선택

	same => n(RSU_NextUser), Set(ErrCode=RSU_NextUser)
	same => n, GoSub(ltss_GetNextSharedUser,start,1(${m_SubUserCount},${ErrCode}))	; // 다음 부사용자 번호 가져오기
	same => n, Set(m_PhoneNumber=${GOSUB_RETVAL})
	same => n, Goto(RSU_talkUserNumber)

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(RSU_wrong), Set(ErrCode=RSU_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(RSU_wrong,SBOX_C01,2))
	same => n, Goto(RSU_rcvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(RSU_not_enter), Set(ErrCode=RSU_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(RSU_not_enter,SBOX_C02,3))
	same => n, Goto(RSU_rcvDgt)

	same => n(RSU_2), Return(2)	; // 삭제
	same => n(RSU_0), Return(0)	; // 이전 단계

exten => h,1, Log(NOTICE,[${CALLER}] RefSubUser/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()


; ********************************************************************************
;                                                                                *
; 부사용자 추가                                                                  *
; - 부사용자 등록은 주사용자만 가능                                              *
; - 부사용자 등록은 10 개까지 가능                                               *
;                                                                                *
; ********************************************************************************

[ltss_SubUserAddREQ]

exten => start,1,Noop(ltss_SubUserAddREQ from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode
	same => n, Set(m_PhoneNumber=)
	same => n, Set(m_BoxNumber=)

	; ----------------------------------------
	; 주사용자 보관함 정보 조회                 
	; ----------------------------------------
	same => n, GoSub(GetLtuLockNumber,start,1(${ErrCode},${CALLER},2))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, Set(countLOOP=0)
	same => n, Set(m_BoxNumber=${LN0})
	same => n, GotoIf($[${m_UsingCount}>0]?SUAR_32_step)

	same => n, Playback(${wavDIR}/SBOX_280)			; 사용중인 보관함이 없습니다.
	same => n, Goto(SUAR_0)					; // 이전 단계로 이동

	; ----------------------------------------
	; 보관함 번호 선택                               
	; ----------------------------------------
	same => n(SUAR_32_step), Set(ErrCode=SUAR_32_step)
	same => n, GoSub(ltss_CheckBoxNumber,start,1(${ErrCode},SBOX_282))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?SUAR_get_reg_count)	; // 보관함 선택
	same => n, GotoIf($[${SELNUM}=0]?SUAR_0)		; // 이전 단계
	same => n, Goto(SUAR_2)					; // 종료

	; ----------------------------------------
	; 부사용자 등록 갯수 조회                 
	; ----------------------------------------
	same => n(SUAR_get_reg_count), Set(ErrCode=SUAR_get_reg_count)
	same => n, GoSub(GetSubuserInform,start,1(${ErrCode}))
	same => n, Set(m_SubUserCount=${GOSUB_RETVAL})

	same => n, GotoIf($[${m_SubUserCount}<10]?SUAR_33_step)
	same => n, Playback(${wavDIR}/SBOX_258)			; 더 이상 등록할 수 없습니다.
	                                       			; 부 사용자는 최대 10개까지만 등록 가능합니다.
	same => n, Goto(SUAR_0)					; // 이전 단계로 이동


	; ----------------------------------------
	; 부사용자 번호 입력 요구                 
	; ----------------------------------------
	same => n(SUAR_33_step), Set(ErrCode=SUAR_33_step)
	same => n, GoSub(RecvPhoneNumber,start,1(${ErrCode},SBOX_251,11))
	same => n, Set(m_PhoneNumber=${GOSUB_RETVAL})

	same => n, GotoIf($["${CALLER}"!="${m_PhoneNumber}"]?SUAR_34_step)

	; ----------------------------------------
	; 입력 번호가 주사용자 번호와 동일               
	; ----------------------------------------
	same => n, Playback(${wavDIR}/SBOX_257)			; 고객님의 전화 번호를 부사용자 번호로
	                                       			; 사용할 수 없습니다.
	same => n, Goto(SUAR_33_step)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SUAR_34_step), Set(ErrCode=SUAR_34_step)
	same => n, GoSub(CheckPhoneNumber,start,1(${ErrCode},1,${m_PhoneNumber}))	; 입력 번호 등록은 1번.
	                                                                               	; 입력 번호 변경은 2번.
	                                                                               	; 이전 단계는 별표.
	                                                                               	; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?SUAR_regStep)		; // 등록
	same => n, GotoIf($[${SELNUM}=2]?SUAR_33_step)		; // 입력 번호 변경
	same => n, GotoIf($[${SELNUM}=0]?SUAR_32_step)		; // 이전 단계
	same => n, Goto(SUAR_2)					; // 종료

	; ----------------------------------------
	; 입력 번호 등록 하기                     
	; ----------------------------------------
	same => n(SUAR_regStep), Set(ErrCode=SUAR_regStep)
	same => n, AGI(${agiDIR}/sbox_add_subuser.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_add_subuser.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_PhoneNumber=[${m_PhoneNumber}] m_BoxNumber=[${m_BoxNumber}] )

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(SUAR_agi_add_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?SUAR_agi_add_succ)
	same => n, GotoIf($["${RESULT}"="2222"]?SUAR_agi_add_already)
	same => n, GoSub(sbox_PlayErrMesg,start,1(SUAR_add_not_define,SBOX_022,1))

	same => n(SUAR_agi_add_succ), Set(ErrCode=SUAR_agi_add_succ)
	same => n, Playback(${wavDIR}/SBOX_259)				; 등록되었습니다
	same => n, Goto(SUAR_35_step)

	same => n(SUAR_agi_add_already), Set(ErrCode=SUAR_agi_add_already)
	same => n, Playback(${wavDIR}/SBOX_260)				; 입력하신 번호는 이미 등록되어 있는 번호입니다.
	same => n, Goto(SUAR_33_step)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SUAR_35_step), Set(ErrCode=SUAR_35_step)
	same => n, GoSub(check_NextStep,start,1(${ErrCode},SBOX_254))	; 보관함 번호 선택은 1번.
	                                                             	; 부사용자 등록 번호 입력은 2번.
	                                                             	; 서비스 종료는 3번.
	                                                             	; 이전 단계는 별표.
	                                                             	; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})

	same => n, GotoIf($[${SELNUM}=1]?SUAR_32_step)		; // 보관함 선택
	same => n, GotoIf($[${SELNUM}=2]?SUAR_get_reg_count)	; // 번호 입력 단계
	same => n, GotoIf($[${SELNUM}=3]?SUAR_2)		; // 서비스 종료 선택
	same => n, GotoIf($[${SELNUM}=0]?SUAR_0)		; // 이전 단계 선택
	same => n, Goto(SUAR_2)					; // 종료

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SUAR_0), Return(0)	; // 이전 단계
	same => n(SUAR_1), Return(1)	; // 등록 단계
	same => n(SUAR_2), Return(2)	; // 종료 단계

exten => h,1, Log(NOTICE,[${CALLER}] ltss_SubUserAddREQ/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()




; ********************************************************************************
;                                                                                *
; 부사용자 삭제                                                                  *
;                                                                                *
; ********************************************************************************

[ltss_SubUserDelREQ]
exten => start,1,Noop(ltss_SubUserDelREQ from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode

	same => n, Set(m_PhoneNumber=)
	same => n, Set(m_BoxNumber=)

	; ----------------------------------------
	; 주사용자 보관함 정보 조회                 
	; ----------------------------------------
	same => n, GoSub(GetLtuLockNumber,start,1(${ErrCode},${CALLER},2))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, Set(countLOOP=0)
	same => n, Set(m_BoxNumber=${LN0})
	same => n, GotoIf($[${m_UsingCount}>0]?SUDR_42_step)

	same => n, Playback(${wavDIR}/SBOX_280)			; 사용중인 보관함이 없습니다.
	same => n, Goto(SUDR_0)					; // 이전 단계로 이동

	; ----------------------------------------
	; 보관함 선택                                  
	; ----------------------------------------
	same => n(SUDR_42_step), Set(ErrCode=SUDR_42_step)
	same => n, GoSub(ltss_CheckBoxNumber,start,1(${ErrCode},SBOX_283))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?SUDR_get_reg_count)	; // 삭제
	same => n, GotoIf($[${SELNUM}=0]?SUDR_0)		; // 이전 단계
	same => n, Goto(SUDR_2)					; // 종료

	; ----------------------------------------
	; 부사용자 등록 갯수 조회                 
	; ----------------------------------------
	same => n(SUDR_get_reg_count), Set(ErrCode=SUDR_get_reg_count)
	same => n, GoSub(GetSubuserInform,start,1(${ErrCode}))
	same => n, Set(m_SubUserCount=${GOSUB_RETVAL})

	same => n, GotoIf($[${m_SubUserCount}>0]?SUDR_43_step)
	same => n, Playback(${wavDIR}/SBOX_265)				; 삭제할 정보가 없습니다.
	same => n, Goto(SUDR_0)						; // 이전 단계로 이동

	; ----------------------------------------
	; 삭졔할 부사용자 번호 입력 요구                 
	; ----------------------------------------
	same => n(SUDR_43_step), Set(ErrCode=SUDR_43_step)
	same => n, GoSub(RecvPhoneNumber,start,1(SUDR_43_step,SBOX_261,11))	; 삭제하실 가입자 번호와 #을 입력하세요.
	same => n, Set(m_PhoneNumber=${GOSUB_RETVAL})
	same => n, GotoIf($["${CALLER}"!="${m_PhoneNumber}"]?SUDR_44_step)

	; ----------------------------------------
	; 입력 번호가 주사용자 번호와 동일               
	; ----------------------------------------
	same => n, Playback(${wavDIR}/SBOX_264)				; 고객님의 전화 번호는 부사용자 번호가 아니어서
	                                       				; 삭제할 수 없습니다.
	same => n, Goto(SUDR_43_step)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SUDR_44_step), Set(ErrCode=SUDR_44_step)

	same => n, GoSub(CheckPhoneNumber,start,1(${ErrCode},2,${m_PhoneNumber}))	; 입력 번호 삭제는 1번.
	                                                                                ; 입력 번호 변경은 2번.
	                                                                                ; 이전 단계는 별표.
	                                                                                ; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?SUDR_delStep)		; // 삭제
	same => n, GotoIf($[${SELNUM}=2]?SUDR_43_step)		; // 입력 번호 변경
	same => n, GotoIf($[${SELNUM}=0]?SUDR_42_step)		; // 이전 단계
	same => n, Goto(SUDR_2)					; // 종료

	; ----------------------------------------
	; 입력 번호 삭제 하기                     
	; ----------------------------------------
	same => n(SUDR_delStep), Set(ErrCode=SUDR_delStep)
	same => n, AGI(${agiDIR}/sbox_del_subuser.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_del_subuser.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_PhoneNumber=[${m_PhoneNumber}] m_BoxNumber=[${m_BoxNumber}] )

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(SUDR_agi_del_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?SUDR_agi_del_succ)
	same => n, GotoIf($["${RESULT}"="2222"]?SUDR_agi_del_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(SUDR_add_not_define,SBOX_022,1))


	same => n(SUDR_agi_del_succ), Set(ErrCode=SUDR_agi_del_succ)
	same => n, Playback(${wavDIR}/SBOX_266)			; 삭제되었습니다.
	same => n, Goto(SUDR_45_step)

	same => n(SUDR_agi_del_fail), Set(ErrCode=SUDR_agi_del_fail)
	same => n, Playback(${wavDIR}/SBOX_267)			; 입력하신 번호는 등록된 번호가 아니어서 삭제할 수 없습니다.
	same => n, Goto(SUDR_45_step)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SUDR_45_step), Set(ErrCode=SUDR_45_step)
	same => n, GoSub(check_NextStep,start,1(${ErrCode},SBOX_263))	; 보관함 번호 선택은 1번.
	                                                             	; 부사용자 삭제 번호 입력는 2번.
	                                                             	; 서비스 종료는 3번.
	                                                             	; 이전 단계는 별표.
	                                                             	; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})

	same => n, GotoIf($[${SELNUM}=1]?SUDR_42_step)		; // 보관함 선택
	same => n, GotoIf($[${SELNUM}=2]?SUDR_get_reg_count)	; // 부사용자 번호 삭제
	same => n, GotoIf($[${SELNUM}=3]?SUDR_2)		; // 서비스 종료 선택
	same => n, GotoIf($[${SELNUM}=0]?SUDR_0)		; // 이전 단계 선택
	same => n, Goto(SUDR_2)					; // 종료

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SUDR_0), Return(0)	; // 이전 단계
	same => n(SUDR_1), Return(1)	; // 삭제 단계
	same => n(SUDR_2), Return(2)	; // 종료 단계

exten => h,1, Log(NOTICE,[${CALLER}] ltss_SubUserDelREQ/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()




; ********************************************************************************
;                                                                                *
; 부사용자 조회 및 삭제                                                          *
;                                                                                *
; ********************************************************************************

[ltss_SubUserRefREQ]
exten => start,1,Noop(ltss_SubUserRefREQ from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode

	same => n, Set(m_PhoneNumber=)
	same => n, Set(m_BoxNumber=)

	; ----------------------------------------
	; 주사용자 보관함 정보 조회                 
	; ----------------------------------------
	same => n, GoSub(GetLtuLockNumber,start,1(${ErrCode},${CALLER},2))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, Set(countLOOP=0)
	same => n, Set(m_BoxNumber=${LN0})
	same => n, GotoIf($[${m_UsingCount}>0]?SURR_52_step)

	same => n, Playback(${wavDIR}/SBOX_280)			; 사용중인 보관함이 없습니다.
	same => n, Goto(SURR_0)					; // 이전 단계로 이동

	; ----------------------------------------
	; 보관함 선택                                  
	; ----------------------------------------
	same => n(SURR_52_step), Set(ErrCode=SURR_52_step)
	same => n, GoSub(ltss_CheckBoxNumber,start,1(${ErrCode},SBOX_284))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?SURR_get_reg_count)	; // 삭제
	same => n, GotoIf($[${SELNUM}=0]?SURR_0)		; // 이전 단계
	same => n, Goto(SURR_2)					; // 종료

	; ----------------------------------------
	; 부사용자 등록 갯수 조회                 
	; ----------------------------------------
	same => n(SURR_get_reg_count), Set(ErrCode=SURR_get_reg_count)
	same => n, GoSub(GetSubuserInform,start,1(${ErrCode}))
	same => n, Set(m_SubUserCount=${GOSUB_RETVAL})

	same => n, GotoIf($[${m_SubUserCount}>0]?SURR_53_step)
	same => n, Playback(${wavDIR}/SBOX_274)				; 등록된 정보가 없습니다.
	same => n, Goto(SURR_0)						; // 이전 단계로 이동

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SURR_53_step), Set(ErrCode=SURR_53_step)
	same => n, GoSub(RefSubUser,start,1(SURR_53_step))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=2]?SURR_54_step)		; // 삭제
	same => n, GotoIf($[${SELNUM}=0]?SURR_52_step)		; // 이전 단계

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SURR_54_step), Set(ErrCode=SURR_54_step)

	same => n, GoSub(CheckPhoneNumber,start,1(${ErrCode},3,${m_PhoneNumber}))	; 삭제는 1번.
	                                                                                ; 취소는 2번.
	                                                                                ; 이전 단계는 별표.
	                                                                                ; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?SURR_delStep)		; // 삭제
	same => n, GotoIf($[${SELNUM}=2]?SURR_cancel)		; // 취소
	same => n, GotoIf($[${SELNUM}=0]?SURR_0)		; // 이전 단계
	same => n, Goto(SURR_2)					; // 종료


	; ----------------------------------------
	; 입력 번호 삭제 하기                     
	; ----------------------------------------
	same => n(SURR_delStep), Set(ErrCode=SURR_delStep)
	same => n, AGI(${agiDIR}/sbox_del_subuser.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_del_subuser.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_PhoneNumber=[${m_PhoneNumber}] m_BoxNumber=[${m_BoxNumber}] )

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(SURR_agi_del_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?SURR_agi_del_succ)
	same => n, GotoIf($["${RESULT}"="2222"]?SURR_agi_del_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(SURR_add_not_define,SBOX_022,1))


	same => n(SURR_agi_del_succ), Set(ErrCode=SURR_agi_del_succ)
	same => n, Playback(${wavDIR}/SBOX_266)				; 삭제되었습니다.
	same => n, Goto(SURR_55_step)

	same => n(SURR_agi_del_fail), Set(ErrCode=SURR_agi_del_fail)
	same => n, Playback(${wavDIR}/SBOX_267)			; 입력하신 번호는 등록된 번호가 아니어서 삭제할 수 없습니다.
	same => n, Goto(SURR_55_step)

	same => n(SURR_cancel), Set(ErrCode=SURR_cancel)
	same => n, Playback(${wavDIR}/SBOX_275)				; 조회 번호 삭제를 취소하였습니다.
	same => n, Goto(SURR_55_step)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SURR_55_step), Set(ErrCode=SURR_55_step)
	same => n, GoSub(check_NextStep,start,1(${ErrCode},SBOX_273))	; 보관함 번호 선택은 1번.
	                                                             	; 부사용자 번호 조회는 2번.
	                                                             	; 서비스 종료는 3번.
	                                                             	; 이전 단계는 별표.
	                                                             	; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})

	same => n, GotoIf($[${SELNUM}=1]?SURR_52_step)			; // 보관함 선택
	same => n, GotoIf($[${SELNUM}=2]?SURR_get_reg_count)		; // 조회
	same => n, GotoIf($[${SELNUM}=3]?SURR_2)			; // 서비스 종료 선택
	same => n, GotoIf($[${SELNUM}=0]?SURR_0)			; // 이전 단계 선택
	same => n, Goto(SURR_2)						; // 종료

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(SURR_0), Return(0)	; // 이전 단계
	same => n(SURR_1), Return(1)	; // 삭제 단계
	same => n(SURR_2), Return(2)	; // 종료 단계


exten => h,1, Log(NOTICE,[${CALLER}] ltss_SubUserRefREQ/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; 보관함 요금 정보 가져오기                                                      *
;                                                                                *
; ********************************************************************************

[ltss_Get_LockBasicFee]
exten => start,1,Noop(ltss_SubUserRefREQ from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode
	same => n, Set(m_TermType=3)					; 한달 사용료 조회
	same => n, Set(m_Month=1)					; 한달 사용료 조회

	same => n, AGI(${agiDIR}/sbox_get_ltu_info.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_get_ltu_info.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_BoxNumber=[${m_BoxNumber}] MM=[${m_TermType}/${m_Month}] m_BasicFee=[${m_BasicFee}] )

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(GLBF_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?GLBF_succ)
	same => n, GotoIf($["${RESULT}"="9999"]?GLBF_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(GLBF_not_define,SBOX_022,1))

	same => n(GLBF_succ), Return(${m_BasicFee})
	same => n(GLBF_fail), Return(0)


exten => h,1, Log(NOTICE,[${CALLER}] ltss_Get_LockBasicFee/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()

; ********************************************************************************
; *                                                                              *
; * 다음 공유 사용자 번호 가져오기                                               *
; *                                                                              *
; ********************************************************************************

[ltss_GetNextSharedUser]

exten => start,1,Noop(ltss_GetNextSharedUser from ${ARG2})

	same => n, Set(LOCAL(MaxCount)=${ARG1})
	same => n, Set(countLOOP=$[${countLOOP}+1])

	same => n, ExecIf($[${countLOOP}>10]?Set(countLOOP=1))
	same => n, ExecIf($[${countLOOP}>${MaxCount}]?Set(countLOOP=1))

	same => n, ExecIf($[${countLOOP} = 1]?Set(PhoneNumber=${DN0}))
	same => n, ExecIf($[${countLOOP} = 2]?Set(PhoneNumber=${DN1}))
	same => n, ExecIf($[${countLOOP} = 3]?Set(PhoneNumber=${DN2}))
	same => n, ExecIf($[${countLOOP} = 4]?Set(PhoneNumber=${DN3}))
	same => n, ExecIf($[${countLOOP} = 5]?Set(PhoneNumber=${DN4}))
	same => n, ExecIf($[${countLOOP} = 6]?Set(PhoneNumber=${DN5}))
	same => n, ExecIf($[${countLOOP} = 7]?Set(PhoneNumber=${DN6}))
	same => n, ExecIf($[${countLOOP} = 8]?Set(PhoneNumber=${DN7}))
	same => n, ExecIf($[${countLOOP} = 9]?Set(PhoneNumber=${DN8}))
	same => n, ExecIf($[${countLOOP} =10]?Set(PhoneNumber=${DN9}))

	same => n, Return(${PhoneNumber})


; ********************************************************************************
; *                                                                              *
; * 장기 사용 보관함의 상세 정보 안내                                             *
; *                                                                              *
; ********************************************************************************

[ltss_ChimeLtuInfo]
exten => start,1,Noop(ltss_ChimeLtuInfo from ${ARG1})
	same => n, Set(LOCAL(ErrCode)=${ARG1})		; // ErrCode

	same => n, Set(LOCAL(m_cnt)=${ARG2})		; // using count
	same => n, Set(LOCAL(m_box)=${ARG3})		; // box number
	same => n, Set(LOCAL(m_mon)=${ARG4})		; // month
	same => n, Set(LOCAL(m_day)=${ARG5})		; // day
	same => n, Set(LOCAL(m_term)=${ARG6})		; // request type(1=기간중,2=기간만료)

	same => n, Playback(${wavDIR}/SBOX_285)				; 사용중인 보관함은
	same => n, GoSub(read_Count,start,1(${m_cnt},G))		; xx 개
	same => n, Playback(${wavDIR}/SBOX_C06)				; 있습니다.

	same => n(LPLI_start), Set(ErrCode=LPLI_start)
	same => n, GotoIf($[${m_term}=1]?:LPLI_req_2)

	same => n(LPLI_req_1), Set(ErrCode=LPLI_req_1)
	same => n, GoSub(read_Number,start,1(${m_box},B))		; xx 번
	same => n, Playback(${wavDIR}/SBOX_286)				; 보관함의 사용 기간은
	same => n, GoSub(read_Number,start,1(${m_mon},M))		; xx 월
	same => n, GoSub(read_Number,start,1(${m_day},D))		; xx 일
	same => n, Playback(${wavDIR}/SBOX_C16)				; 까지
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.
	same => n, Goto(LPLI_rcvDgt)

	same => n(LPLI_req_2), Set(ErrCode=LPLI_req_2)
	same => n, GoSub(read_Number,start,1(${m_box},B))		; xx 번
	same => n, Playback(${wavDIR}/SBOX_C24)				; 보관함은
	same => n, GoSub(read_Number,start,1(${m_mon},M))		; xx 월
	same => n, GoSub(read_Number,start,1(${m_day},D))		; xx 일
	same => n, Playback(${wavDIR}/SBOX_287)				; 로 사용 기간이 만료되었습니다.
	same => n, Goto(LPLI_rcvDgt)

	same => n(LPLI_rcvDgt), Set(ErrCode=LPLI_rcvDgt)
	same => n, Read(SELNUM,${C1}&${wavDIR}/SBOX_288,1,n,1,5)	; 이 보관함 선택은 1번.
	                                                  		; 다른 보관함 선택은 2번.
	                                                  		; 이전 단계는 별표.
	                                                  		; 다시 듣기는 0번을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})}=0]?LPLI_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="1"]?LPLI_1)			; // 이 보관함
	same => n, GotoIf($["${SELNUM}"="2"]?LPLI_2)			; // 다른 보관함
	same => n, GotoIf($["${SELNUM}"="*"]?LPLI_0)			; // 이전 단계
	same => n, GotoIf($["${SELNUM}"="0"]?LPLI_start)		; // 다시 듣기
	same => n, Goto(LPLI_wrong)

	same => n(LPLI_wrong), Set(ErrCode=LPLI_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(LPLI_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(LPLI_rcvDgt)

	same => n(LPLI_not_enter), Set(ErrCode=LPLI_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(LPLI_not_enter,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(LPLI_rcvDgt)

	same => n(LPLI_0), Return(0)		; // 이전단계
	same => n(LPLI_1), Return(1)		; // 보관함 선택 완료
	same => n(LPLI_2), Return(2)		; // 보관함으로 변경


exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [ltss_ChimeLtuInfo/Hangup] ERR=[${ErrorCode}/${ErrCode}])
	same => n, Hangup()


; ********************************************************************************
;                                                                                *
; 기간 연장 결제 안내                                                            *
;                                                                                *
; ********************************************************************************

[ltss_PayRenewFee]
exten => start,1,Noop(ltss_PayRenewFee from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=LPRF_start)
	same => n, Set(LOCAL(m_box)=${ARG2})		; // box number
	same => n, Set(LOCAL(m_term)=${ARG3})		; // 연장 기간

	same => n, Set(m_TermType=3)			; // 1=1주일, 2=10일, 3=1개월, 4=종료일지정
	same => n, Set(m_Month=${m_term})		; // 장기 사용 기간

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GoSub(agi_GetLtuInfo,start,1(${ErrCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?lprf_succ)
	same => n, GotoIf($[${SELNUM}=2]?lprf_fail)
	same => n, Goto(LPRF_2)

	same => n(lprf_fail), Playback(${wavDIR}/SBOX_023))		; 서버로부터 사용 허가를 받지 못하여, 
	                                                  		; 서비스를 진행할 수 없습니다.
	same => n, Goto(LPRF_2)

	same => n(lprf_succ), Set(ErrCode=lprf_succ)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(LPRF_announce), Set(ErrCode=LPRF_announce)

	same => n, Playback(${wavDIR}/SBOX_292)				; 사용하실 보관함은
	same => n, GoSub(read_Number,start,1(${m_BoxNumber},B))		; xx 번
	same => n, Playback(${wavDIR}/SBOX_C21)				; 의
	same => n, Playback(${wavDIR}/SBOX_293)				; 사용 기간 연장은
	same => n, GoSub(read_Number,start,1(${m_Month},m))		; xx 개월
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.

	same => n, ExecIf($[${m_term}=2]?Playback(${wavDIR}/SBOX_294))	; 이 보관함은 장기 사용 기간이 만료되었음으로
	                                       				; 만료 경과된 날까지 포함하여.
	same => n, Playback(${wavDIR}/SBOX_295)				; 사용 유효기간은
	same => n, GoSub(read_Number,start,1(${m_month},M))		; xx 월
	same => n, GoSub(read_Number,start,1(${m_day},D))		; xx 일
	same => n, Playback(${wavDIR}/SBOX_C16)				; 까지.
	same => n, Playback(${wavDIR}/SBOX_C23)				; 이며.
	same => n, Playback(${wavDIR}/SBOX_296)				; 결제하실 요금은
	same => n, GoSub(read_Number,start,1(${m_BasicFee},W))		; xxxxx 원
	same => n, Playback(${wavDIR}/SBOX_C05)				; 입니다.

	same => n, Playback(${wavDIR}/SBOX_297)				; 결제를 하시면 보관함 변경없이,
	                                      				; 사용 만료일까지 사용할 수 있습니다. 
	same => n, Playback(${wavDIR}/SBOX_087)				; 결제가 완료되면, 서버에서 보관함 문을 열어줍니다. 
	same => n, Playback(${wavDIR}/SBOX_088)				; 지금 계신 곳이 원격지이고
	                                      				; 보관 중인 물품이 있는 경우,
	                                      				; 분실 우려가 있음으로, 결제를 권장하지 않습니다.
	same => n, Playback(${wavDIR}/SBOX_298)				; 사용 기간이 지나서 해지를 하면,
	                                      				; 추가 요금이 발생할 수 있습니다.

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(LPRF_rcvDgt), Set(ErrCode=LPRF_rcvDgt)
	same => n, Read(SELNUM,${wavDIR}/SBOX_242,1,n,1,5)		; 결제는 1번.
	                                                     		; 이전 단계는 별표.
	                                                     		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})}=0]?LPRF_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}"="1"]?LPRF_succ) 		; // 현재 보관함 사용 확정
	same => n, GotoIf($["${SELNUM}"="*"]?LPRF_0)			; // 이전 단계 이동
	same => n, GotoIf($["${SELNUM}"="0"]?LPRF_announce)		; // 다시 듣기

	; ----------------------------------------
	; 입력 정보 오류                          
	; ----------------------------------------
	same => n(LPRF_wrong), Set(ErrCode=LPRF_wrong)
	same => n, GoSub(sbox_PlayErrMesg,start,1(LPRF_wrong,SBOX_C01,2))	; 잘못 눌렀습니다.
	same => n, Goto(LPRF_rcvDgt)

	; ----------------------------------------
	; 입력된 정보 없음                        
	; ----------------------------------------
	same => n(LPRF_not_enter), Set(ErrCode=LPRF_not_enter)
	same => n, GoSub(sbox_PlayErrMesg,start,1(LPRF_wrong,SBOX_C02,3))	; 입력된 정보가 없습니다.
	same => n, Goto(LPRF_rcvDgt)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(LPRF_succ), Set(ErrCode=LPRF_succ)
	same => n, GoSub(agi_RegLtu,start,1(${ErrCode}))
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?LPRF_1)
	same => n, GotoIf($[${SELNUM}=2]?LPRF_fail)
	same => n, Goto(LPRF_2)

	same => n(LPRF_fail), Set(ErrCode=LPRF_fail)
	same => n, GoSub(sbox_PlayErrMesg,start,1(LPRF_reg_fail,SBOX_023,1))
	same => n, Goto(LPRF_2)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(LPRF_0), Return(0)	; // 이전 단계
	same => n(LPRF_1), Return(1)	; // 성공
	same => n(LPRF_2), Return(2)	; // 원인없이 종료

exten => h,1, Log(NOTICE,[${CALLER}] ltss_PayRenewFee/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; 장기 사용 기간 연장                                                            *
;                                                                                *
; ********************************************************************************

[ltss_renewLTU]

exten => start,1,Noop(ltss_renewLTU from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=LRL_start)		; ErrCode
	same => n, Set(LOCAL(m_term)=0)				; 연장 사용 기간
	same => n, Set(LOCAL(count_wrong)=0)			; 연장 불가능 보관함 갯수

	same => n, GoSub(init_Data,start,1(${ErrCode}))

	; ----------------------------------------
	; 장기 사용 등록 고객 여부 확인 및 장기 사용중인 보관함 정보 가져오기                     
	; ----------------------------------------
	same => n, GoSub(GetLtuLockNumber,start,1(${ErrCode},${CALLER},2))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}=1111]?:LRL_not_ltu)	; // 장기 사용자 아니면 복귀

	same => n, Set(countLOOP=1)
	same => n, Set(m_BoxNumber=${LN0})
	same => n, Playback(${wavDIR}/SBOX_057)			; 장기 사용 기간 연장 단계 입니다.

	; ----------------------------------------
	; 보관함 선택 및 상세 정보 가져오기(만료여부, 만료 날짜, 추가요금)            
	; ----------------------------------------
	same => n(LRL_get_ltu_info), Set(ErrCode=LRL_get_ltu_info)
	same => n, GoSub(GetLtuLockInfo,start,1(${ErrCode},${m_BoxNumber}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}=1111]?LRL_UseTerm)	; // 사용 기간중    --> 연장 가능
	same => n, GotoIf($[${RESULT}=2222]?LRL_chime_info)	; // 사용 기간 만료 -->
	same => n, Goto(LRL_3)					; // 원인없이 종료

	same => n(LRL_UseTerm), Set(ErrorCode=LRL_UseTerm)
	same => n, Set(count_wrong=$[${count_wrong}+1])
	same => n, GotoIF($[${count_wrong} < ${m_UsingCount}]?LRL_nextBox)
	same => n, Playback(${wavDIR}/SBOX_069)                         ; 장기 사용 연장을 해야 하는 보관함이 없습니다.
	same => n, Goto(LRL_3)

	same => n(LRL_chime_info), Set(ErrCode=LRL_chime_info)
	same => n, ExecIf($[${RESULT}=1111]?Set(m_term=1))	; // 사용 기간중    --> 연장 가능
	same => n, ExecIf($[${RESULT}=2222]?Set(m_term=2))	; // 사용 기간 만료 --> 만료 경과일 포함하여 연장 가능 
	same => n, GoSub(ltss_ChimeLtuInfo,start,1(${ErrCode},${m_UsingCount},${m_BoxNumber},${m_Month},${m_Day},${m_term}))
	                                                        ; 사용중인 보관함은 xx개 있습니다.
	                                                        ; xx번 보관함의 사용 기간은 x월 xx일까지 입니다.
	                                                        ; (xx번 보관함은 x월 xx일로 사용 기간이 만료되었습니다.)
	                                                        ; 이 보관함 선택은 1번.
	                                                        ; 다른 보관함 선택은 2번.
	                                                        ; 이전 단계는 별표.
	                                                        ; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?LRL_0)			; // 이전 단계
	same => n, GotoIf($[${SELNUM}=1]?LRL_SetPeriod)		; // 보관함 선택
	same => n, GotoIf($[${SELNUM}=2]?LRL_nextBox)		; // 다른 보관함으로 변경

	; ----------------------------------------
	; 연장 기간 설정                          
	; ----------------------------------------
	same => n(LRL_SetPeriod), Set(ErrCode=LRL_SetPeriod)

	same => n, GoSub(ltss_SelUsingPeriodType,start,1(${ErrCode}))
	                                                        ; 사용 기간 설정 단계입니다.
	                                                        ; 1개월 사용은 1번.
	                                                        ; 6개월 사용은 2번.
	                                                        ; 12개월 사용은 3번.
	                                                        ; 이전 단계는 별표.
	                                                        ; 다시 듣기는 0번을 누르세요.
	same => n, Set(m_Month=${GOSUB_RETVAL})
	same => n, GotoIf($[${m_Month}=0]?LRL_get_ltu_info)	; // 이전 단계
	same => n, GotoIf($[${m_PassDate}<$[${m_Month} *30]]?LRL_regFee)
	same => n, Playback(${wavDIR}/SBOX_299)			; 선택한 연장 기간 일수가 기간 만료일보다 짧아,
	                                                        ; 다시 선택하여야 합니다.
	same => n, Goto(LRL_SetPeriod)

	; ----------------------------------------
	; 장기 사용 연장 안내 및 결제 안내        
	; ----------------------------------------
	same => n(LRL_regFee), Set(ErrCode=LRL_regFee)
	same => n, GoSub(ltss_PayRenewFee,start,1(${ErrCode},${m_BoxNumber},${m_Month}))
	                                                        ; 선택하신 보관함 xx번의 사용 기간 연장은 xx개월입니다.
	                                                        ; (이 보관함은 장기 사용 기간이 만료되었음으로
	                                                        ;  만료 경과된 날까지 포함하여)
	                                                        ; 사용 유효기간은 x월 xx일까지이며,
	                                                        ; 결제하실 요금은 xxxxx원입니다.
	                                                        ; 결제를 하시면 보관함 변경없이,
	                                                        ; 사용 만료일까지 사용할 수 있습니다.
	                                                        ; 사용 기간이 지나서 해지를 하면,
	                                                        ; 추가 요금이 발생할 수 있습니다.
	                                                        ; 결제는 1번.
	                                                        ; 이전 단계는 별표.
	                                                        ; 다시 듣기는 0번을 누르세요.

	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?LRL_SetPeriod)		; // 이전 단계 : 연장 기간 선택
	same => n, GotoIf($[${SELNUM}=1]?LRL_ciderpay)		; // 연장 요금 결제 시작
	same => n, Goto(LRL_3)					; // 원인없이 종료

	; ----------------------------------------
	; 기간 연장 요금 결제 진행                
	; ----------------------------------------
	same => n(LRL_ciderpay), Set(ErrCode=LRL_ciderpay)
	same => n, GoSub(procCiderPay,start,1(${CALLER},${m_BasicFee},${m_MacAddr},${ErrCode}))	; //사이다페이 결제 문자 요청
	                                                        ; 고객님의 핸드폰으로 결제 요청 문자를 보냈습니다.
	                                                        ; 받으신 문자에서 URL을 클릭하시면,
	                                                        ; 핸드폰에서 결제를 할 수 있습니다.
	                                                        ; 사이다페이 앱 화면에서 신용 카드 번호를 입력하시면,
	                                                        ; 결재가 진행됩니다.
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=1]?LRL_1)			; // 결제 성공 
	same => n, GotoIf($[${SELNUM}=2]?LRL_2)			; // 결제 실패
	same => n, Goto(LRL_3)					; // 원인없이 종료

	; ----------------------------------------
	; 다른 보관함으로 변경                    
	; ----------------------------------------
	same => n(LRL_nextBox), Set(ErrCode=LRL_nextBox)
	same => n, GoSub(sbox_GetNextBox,start,1(${m_UsingCount},${ErrCode}))	; // 다음 보관함 번호 가져오기
	same => n, Goto(LRL_get_ltu_info)

	same => n(LRL_not_ltu), Set(ErrCode=LRL_not_ltu)
	same => n, Playback(${wavDIR}/SBOX_041)			; 장기 사용 등록 고객님이 아닙니다.  확인후 이용해 주세요. 
	same => n, Goto(LRL_3)					; // 원인없이 종료

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(LRL_0), Return(0)	; // 이전 단계
	same => n(LRL_1), Return(1)	; // 성공적 수행 완료
	same => n(LRL_2), Return(2)	; // 실패 
	same => n(LRL_3), Return(3)	; // 원인없이 종료


exten => h,1, Noop(ltss_renewLTU/Hangup)
	same => n, Log(NOTICE,[${CALLER} --> ${CALLEE}] [ltss_renewLTU/Hangup] ERR=[${ErrorCode}/${ErrCode}])
	same => n, Hangup()



; ********************************************************************************
;                                                                                *
; 장기 사용 해지                                                                 *
;                                                                                *
; ********************************************************************************

[ltss_cancelLTU]

exten => start,1,Noop(ltss_cancelLTU from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})			; ErrCode

	same => n, GoSub(init_Data,start,1(${ErrCode}))

	; ----------------------------------------
	; 장기 사용 등록 고객 여부 확인 및 장기 사용중인 보관함 정보 가져오기                     
	; ----------------------------------------
	same => n, GoSub(GetLtuLockNumber,start,1(${ErrCode},${CALLER},2))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}=1111]?:LCL_not_ltu)	; // 장기 사용자 아니면 복귀

	same => n, Set(countLOOP=1)
	same => n, Set(m_BoxNumber=${LN0})
	same => n, Playback(${wavDIR}/SBOX_059)			; 장기 사용 해지 단계 입니다.

	; ----------------------------------------
	; 보관함 상세 정보 가져오기(만료여부, 만료 날짜, 추가요금)            
	; ----------------------------------------
	same => n(LCL_get_ltu_info), Set(ErrCode=LCL_get_ltu_info)
	same => n, GoSub(GetLtuLockInfo,start,1(${ErrCode},${m_BoxNumber}))
	same => n, Set(RESULT=${GOSUB_RETVAL})
	same => n, GotoIf($[${RESULT}=1111]?LCL_chime_info)	; // 사용 기간중    --> 해지 가능
	same => n, GotoIf($[${RESULT}=2222]?LCL_chime_info)	; // 사용 기간 만료 --> 추가 비용 결재 필요
	same => n, Goto(LCL_2)					; // 원인없이 종료

	same => n(LCL_chime_info), Set(ErrCode=LCL_chime_info)
	same => n, ExecIf($[${RESULT}=1111]?Set(m_term=1))	; // 사용 기간중    --> 해지 가능
	same => n, ExecIf($[${RESULT}=2222]?Set(m_term=2))	; // 사용 기간 만료 --> 추가 비용 결재 필요
	same => n, GoSub(ltss_ChimeLtuInfo,start,1(${ErrCode},${m_UsingCount},${m_BoxNumber},${m_Month},${m_Day},${m_term}))
	                                                        ; 사용중인 보관함은 xx개 있습니다.
	                                                        ; xx번 보관함의 사용 기간은 x월 xx일까지 입니다.
	                                                        ; (xx번 보관함은 x월 xx일로 사용 기간이 만료되었습니다.)
	                                                        ; 이 보관함 선택은 1번.
	                                                        ; 다른 보관함 선택은 2번.
	                                                        ; 이전 단계는 별표.
	                                                        ; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?LCL_0)			; // 이전 단계
	same => n, GotoIf($[${SELNUM}=1]?LCL_UnregLTU)		; // 해지 신청
	same => n, GotoIf($[${SELNUM}=2]?LCL_nextBox)		; // 다른 보관함으로 변경

	; ----------------------------------------
	; 장기 사용 기간 만료전 해지 및 보관함 문열기          
	; ----------------------------------------
	same => n(LCL_UnregLTU), Set(ErrCode=LCL_UnregLTU)
	same => n, GotoIf($[${m_term}=2]?LCL_checkFee)		; // 장기사용 기간 만료후 해지 신청

	same => n, GoSub(UnregLTU,start,1(${ErrCode},${m_BoxNumber}))
	                                                        ; xx 번 보관함의 
	                                                        ; 장기 사용 해지는 1번.
	                                                        ; 다른 보관함 장기 사용 해지는 2번.
	                                                        ; 이전 단계는 별표.
	                                                        ; 다시 듣기는 0번을 누르세요.
	same => n, Set(RESULT=${GOSUB_RETVAL})

	same => n, GotoIf($[${RESULT}=0]?LCL_get_ltu_info)	; // 이전 단계
	same => n, GotoIf($[${RESULT}=1]?LCL_unregSucc)		; // 해지 등록 성공
	same => n, GotoIf($[${RESULT}=2]?LCL_nextBox)		; // 다른 보관함 해지
	same => n, Goto(LCL_2)					; // 원인없이 종료

	same => n(LCL_unregSucc), Set(ErrCode=LCL_unregSucc)
	same => n, Playback(${wavDIR}/SBOX_289)			; 해지 되었습니다.
	same => n, Set(m_UserType=3)				; // 1=일반고객, 2=택배기사 문열기, 3=장기사용고객
	same => n, GoSub(OpenBoxDoor,start,1(${ErrCode},4))	; xx번 보관함 문을 열었습니다.
	same => n, Playback(${wavDIR}/SBOX_291)			; 보관함에 보관중인 물품을 꺼내시고, 보관함 문을 닫아 주세요.
	same => n, Goto(LCL_2)					; // 원인없이 종료

	; ----------------------------------------
	; 장기 사용 기간 만료후 해지로 추가 요금 결제 안내               
	; ----------------------------------------
	same => n(LCL_checkFee), Set(ErrCode=LCL_checkFee)
	same => n, GoSub(check_ExpireUsing,start,1(${ErrCode},${m_BoxNumber},${m_Month},${m_Day},${m_AddFee},2))
	                                                        ; xx 번 보관함의 장기 사용 기간이 xx 월 xx 일로 만료되었으며
	                                                        ; 추가 요금 xxxx 원이 발생하였습니다.
	                                                        ; 장기 사용 해지는 1번.
	                                                        ; 다른 보관함을 해지하려면 2번.
	                                                        ; 이전 단계는 별표를.
	                                                        ; 다시 듣기는 0번을 누르세요.

	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?LCL_get_ltu_info)	; // 이전 단계
	same => n, GotoIf($[${SELNUM}=1]?LCL_payFee)		; // 장기 사용 해지
	same => n, GotoIf($[${SELNUM}=2]?LCL_nextBox)		; // 다른 보관함 해지
	same => n, Goto(LCL_2)					; // 원인없이 종료

	; ----------------------------------------
	; 추가 요금 결제                          
	; ----------------------------------------
	same => n(LCL_payFee), Set(ErrCode=LCL_payFee)
	same => n, GoSub(pay_ExtraFee,start,1(${ErrCode},${m_BoxNumber},${m_AddFee},2,${m_PayType}))
	                                                        ; 지금 결제하시겠습니까?
	                                                        ; 결제는 1번.
	                                                        ; 이전 단계는 별표를.
	                                                        ; 다시 듣기는 0번을 누르세요.
	same => n, Set(SELNUM=${GOSUB_RETVAL})
	same => n, GotoIf($[${SELNUM}=0]?LCL_checkFee)		; // 이전 단계 --> 5-7 단계
	same => n, GotoIf($[${SELNUM}=1]?LCL_paySucc)		; // 추가 요금 결제 요청 성공 --> 서비스 종료
	same => n, GotoIf($[${SELNUM}=2]?LCL_payFail)		; // 추가 요금 결제 요청 실패 --> 서비스 종료
	same => n, Goto(LCL_2)					; // 원인없이 종료

	same => n(LCL_paySucc), Set(ErrCode=LCL_paySucc)
	same => n, GoSub(procCiderPay,start,1(${CALLER},${m_AddFee},${m_MacAddr},${ErrCode}))	; //사이다페이 결제 문자 요청
	                                                        ; 고객님의 핸드폰으로 결제 요청 문자를 보냈습니다.
	                                                        ; 받으신 문자에서 URL을 클릭하시면,
	                                                        ; 핸드폰에서 결제를 할 수 있습니다.
	                                                        ; 사이다페이 앱 화면에서 신용 카드 번호를 입력하시면,
	                                                        ; 결재가 진행됩니다.
	same => n, Goto(LCL_2)					; // 원인없이 종료

	; ----------------------------------------
	; 다른 보관함으로 변경                    
	; ----------------------------------------
	same => n(LCL_nextBox), Set(ErrCode=LCL_nextBox)
	same => n, GoSub(sbox_GetNextBox,start,1(${m_UsingCount},${ErrCode}))	; // 다음 보관함 번호 가져오기
	same => n, Goto(LCL_get_ltu_info)

	same => n(LCL_not_ltu), Set(ErrCode=LCL_not_ltu)
	same => n, Playback(${wavDIR}/SBOX_041)			; 장기 사용 등록 고객님이 아닙니다.  확인후 이용해 주세요. 
	same => n, Goto(LCL_2)					; // 원인없이 종료

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(LCL_0), Return(0)	; // 이전 단계
	same => n(LCL_1), Return(1)	; // 성공적 수행 완료
	same => n(LCL_2), Return(2)	; // 이유없이 종료하기


exten => h,1, Log(NOTICE,[${CALLER} --> ${CALLEE}] [ltss_cancelLTU/Hangup] ERR=[${ErrorCode}/${ErrCode}])
	same => n, Hangup()


;===========================================================================================================================
[agi_GetLtuInfo]
exten => start,1,Noop(agi_GetLtuInfo from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode

	same => n, AGI(${agiDIR}/sbox_get_ltu_info.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_get_ltu_info.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] BOX=[${m_BoxNumber}] TERM=[${m_TermType}/${m_Month}] MMDD=[${m_month}/${m_day}/${m_PassDate}] FEE=[${m_BasicFee}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(gli_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?gli_1)
	same => n, GotoIf($["${RESULT}"="9999"]?gli_2)
	same => n, Goto(gli_3)

	same => n(gli_1), Return(1)	; // succ
	same => n(gli_2), Return(2)	; // fail
	same => n(gli_3), Return(3)	; // not_define

exten => h,1, Log(NOTICE,[${CALLER}] agi_GetLtuInfo/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()

[agi_RegLtu]
exten => start,1,Noop(agi_RegLtu from ${ARG1})

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; ErrCode

	same => n, AGI(${agiDIR}/sbox_reg_ltu.php)
	same => n, Log(NOTICE,[${CALLER}] sbox_reg_ltu.php : AGI=[${AGISTATUS}] RLT=[${RESULT}] BOX=[${m_BoxNumber}])

	same => n, GoSubIf($["${AGISTATUS}"!="SUCCESS"]?sbox_PlayErrMesg,start,1(rli_agi_fail,SBOX_021,0))
	same => n, GotoIf($["${RESULT}"="1111"]?rli_1)
	same => n, GotoIf($["${RESULT}"="9999"]?rli_2)
	same => n, Goto(rli_3)

	same => n(rli_1), Return(1)	; // succ
	same => n(rli_2), Return(2)	; // fail
	same => n(rli_3), Return(3)	; // not_define

exten => h,1, Log(NOTICE,[${CALLER}] agi_RegLtu/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()
