; ********************************************************************************
; *                                                                              *
; * PSN(주차 안심 번호 서비스)                                                   *
; *                                                                              *
; ********************************************************************************

[psn_main]

exten => _X., 1, Noop([psn_main] Recv Call [${CALLERID(ANI)} --> ${CALLERID(DNID)}] From [${CHANNEL(peerip)}] )

	same => n, Ringing()


	; ********************************************************************************
	; 1-1. 공통 정보 초기화                                                          *
	; ********************************************************************************
	same => n(psn_initial), Set(ErrorCode=psn_initial)
	same => n, GoSub(psn_InitCommInfo,s,1(NM_PSN))		; // 1=NM_PSN, 2=QR_PSN


	; ********************************************************************************
	; 1-2.1 0507 번호 검색                                                           *
	; ********************************************************************************
	same => n(psn_get_0507), Set(ErrorCode=psn_get_0507)
	same => n, Set(DAOU050NUMBER=)

	same => n, GoSub(GetDau050Number,start,1(${ErrorCode},1,${m_CALLER},${m_CALLEE}))	; // 1=err_ment_on, 2=off
	same => n, Set(m_0507_Number=${GOSUB_RETVAL})
	same => n, Noop([PSN : ${CALLER} --> ${CALLEE}] m_0507_Number=[${m_0507_Number}] )

	same => n, Answer()
	same => n, GotoIf($[${m_0507_Number} != 0]?psn_start,${EXTEN},1)
	same => n, Hangup()





[psn_start]

exten => _X., 1, Noop([psn_start] Recv Call [${CALLERID(ANI)} --> ${CALLERID(DNID)}] From [${CHANNEL(peerip)}] )

	; ********************************************************************************
	; 1-3. PSN 정보 검색                                                             *
	; ********************************************************************************
	same => n(psn_get_psn_inform), Set(ErrorCode=psn_get_psn_inform)
	same => n, Set(m_MyDN=${m_0507_Number})

	same => n, GoSub(psn_GetPsnInform,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})

	same => n, GoSub(psn_Seize_0507,s,1(${ErrorCode},${rValue}))
	same => n, Set(rValue=${GOSUB_RETVAL})

	same => n, GotoIf($[${rValue} = 1]?psn_start)			; // 2.0 최상위 메뉴 안내
	same => n, GotoIf($[${rValue} = 2]?psn_call_conn_owner)		; // 5.2 차주 연결
	same => n, GotoIf($[${rValue} = 3]?greeting)			; // 4.2 착신번호 등록 <-- 신청자인 경우
	same => n, GotoIf($[${rValue} = 4]?greeting)			; // 4.0 정보 설정 메뉴
	same => n, Goto(psn_Finish,1)

	same => n(greeting), Set(F1=${SPRINTF(PSN_007_${m_CustomInfo})})
	same => n, Playback(${wavDIR}/${F1})				; (바로) 주차안심번호 서비스입니다.
	same => n, GotoIf($[${rValue} = 3]?psn_reg_inform)		; // 4.2 착신번호 등록 <-- 신청자인 경우
	same => n, GotoIf($[${rValue} = 4]?psn_inform_set_menu)		; // 4.0 정보 설정 메뉴

	; ********************************************************************************
	; 2.0 최상위 메뉴 안내                                                           *
	; ********************************************************************************
	same => n(psn_start), Set(F1=${SPRINTF(PSN_007_${m_CustomInfo})})
	same => n, Playback(${wavDIR}/${F1})				; (바로) 주차안심번호 서비스입니다.

	same => n(psn_top_menu), Set(ErrorCode=psn_top_menu)
	same => n, GoSub(psn_TopMenu,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 1]?psn_conn_caller)	 	; // 5.1 차량 호출자 연결
	same => n, GotoIf($[${rValue} = 2]?psn_inform_set_menu) 	; // 4.0 정보 설정 메뉴
	same => n, GotoIf($[${rValue} = 3]?psn_add_svc_menu)		; // 3.0 부가서비스 안내 메뉴
	same => n, Goto(psn_Finish,1)

	; ********************************************************************************
	; 3.0 부가서비스 안내 메뉴                                                       *
	; ********************************************************************************
	same => n(psn_add_svc_menu), Set(ErrorCode=psn_add_svc_menu)
	same => n, GosubIf($[${m_AgiReloadFlag} = 2]?psn_ReloadPsnInform,s,1(${ErrorCode}))

	same => n, GoSub(psn_AdditionalSvcMenu,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 1]?psn_chauffeur_svc)		; // 3.1 부가서비스/대리운전 서비스
	same => n, GotoIf($[${rValue} = 2]?psn_insurance_svc)		; // 3.2 부가서비스/보험사 서비스
	same => n, GotoIf($[${rValue} = 3]?psn_vars_svc) 		; // 3.3 부가서비스/보이는ARS 서비스
	same => n, GotoIf($[${rValue} = 4]?psn_top_menu) 		; // 2.0 최상위 메뉴 안내
	same => n, Goto(psn_Finish,1)


	; ********************************************************************************
	; 3.1 부가서비스/대리운전 서비스                                                 *
	; ********************************************************************************
	same => n(psn_chauffeur_svc), Set(ErrorCode=psn_chauffeur_svc)
	same => n, GoSub(psn_ChaufeurSvcMenu,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 1]?psn_conn_chauffeur) 		; // 5.3 대리 운전 연결
	same => n, GotoIf($[${rValue} = 2]?psn_add_svc_menu) 		; // 3.0 부가서비스 안내 메뉴
	same => n, Goto(psn_Finish,1)


	; ********************************************************************************
	; 3.2 부가서비스/보험사 서비스                                                   *
	; ********************************************************************************
	same => n(psn_insurance_svc), Set(ErrorCode=psn_insurance_svc)
	same => n, GoSub(psn_InsuranceSvcMenu,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 1]?psn_conn_insurance)		; // 5.4 보험사 연결
	same => n, GotoIf($[${rValue} = 2]?psn_add_svc_menu) 		; // 3.0 부가서비스 안내 메뉴
	same => n, Goto(psn_Finish,1)


	; ********************************************************************************
	; 3.3 부가서비스/보이는ARS 서비스                                                *
	; ********************************************************************************
	same => n(psn_vars_svc), PlayBack(${comDIR}/COMM_004)		; 서비스 준비중입니다. 다음에 이용해 주세요.
	same => n, Goto(psn_add_svc_menu)


	; ********************************************************************************
	; 4.0 정보 설정 메뉴                                                             *
	; ********************************************************************************
	same => n(psn_inform_set_menu), Set(ErrorCode=psn_inform_set_menu)
	same => n, GosubIf($[${m_AgiReloadFlag} = 2]?psn_ReloadPsnInform,s,1(${ErrorCode}))

	same => n, GoSub(psn_InformSetMenu,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})

	same => n, GotoIf($[${rValue} = 0]?psn_GoodBye,1)
	same => n, GotoIf($[${rValue} = 1]?psn_chk_inform)	; // 4.1 착신번호 확인
	same => n, GotoIf($[${rValue} = 2]?psn_reg_inform)	; // 4.2 착신번호 등록
	same => n, GotoIf($[${rValue} = 3]?psn_chg_inform)	; // 4.3 착신번호 변경
	same => n, GotoIf($[${rValue} = 4]?psn_del_inform)	; // 4.4 착신번호 삭제
	same => n, GotoIf($[${rValue} = 5]?psn_chg_priority)	; // 4.5 우선순위 변경
	same => n, GotoIf($[${rValue} = 6]?psn_act_inform)	; // 4.6 서비스 활성화/일시정지
	same => n, GotoIf($[${rValue} = 7]?psn_top_menu)	; // 2.0 최상위 메뉴 안내
	same => n, Goto(psn_Finish,1)


	; ********************************************************************************
	; 4.1 착신번호 확인                                                              *
	; ********************************************************************************
	same => n(psn_chk_inform), Set(ErrorCode=psn_chk_inform)
	same => n, GoSub(psn_ChkInform,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 0]?psn_inform_set_menu)
	same => n, GotoIf($[${rValue} = 1]?psn_GoodBye,1)
	same => n, Goto(psn_Finish,1)

	; ********************************************************************************
	; 4.2 착신번호 등록                                                              *
	; ********************************************************************************
	same => n(psn_reg_inform), Set(ErrorCode=psn_reg_inform)
	same => n, GoSub(psn_RegInform,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 0]?psn_inform_set_menu)
	same => n, GotoIf($[${rValue} = 1]?psn_GoodBye,1)
	same => n, Goto(psn_Finish,1)

	; ********************************************************************************
	; 4.3 착신번호 변경                                                              *
	; ********************************************************************************
	same => n(psn_chg_inform), Set(ErrorCode=psn_chg_inform)
	same => n, GoSub(psn_ChgInform,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 0]?psn_inform_set_menu)
	same => n, GotoIf($[${rValue} = 1]?psn_GoodBye,1)
	same => n, Goto(psn_Finish,1)

	; ********************************************************************************
	; 4.4 착신번호 삭제                                                              *
	; ********************************************************************************
	same => n(psn_del_inform), Set(ErrorCode=psn_del_inform)
	same => n, GoSub(psn_DelInform,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 0]?psn_inform_set_menu)
	same => n, GotoIf($[${rValue} = 1]?psn_GoodBye,1)
	same => n, Goto(psn_Finish,1)

	; ********************************************************************************
	; 4.5 우선순위 변경                                                              *
	; ********************************************************************************
	same => n(psn_chg_priority), Set(ErrorCode=psn_chg_priority)
	same => n, GoSub(psn_ChgPriority,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 0]?psn_inform_set_menu)
	same => n, GotoIf($[${rValue} = 1]?psn_GoodBye,1)
	same => n, Goto(psn_Finish,1)

	; ********************************************************************************
	; 4.6 서비스 활성화/일시정지                                                     *
	; ********************************************************************************
	same => n(psn_act_inform), Set(ErrorCode=psn_act_inform)
	same => n, GoSub(psn_ActInform,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 0]?psn_inform_set_menu)
	same => n, GotoIf($[${rValue} = 1]?psn_GoodBye,1)
	same => n, Goto(psn_Finish,1)

	; ********************************************************************************
	; 5.1 차량 호출자 연결                                                           *
	; ********************************************************************************
	same => n(psn_conn_caller), Set(ErrorCode=psn_conn_caller)
	same => n, GoSub(psn_ConnLastCaller,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 0]?psn_top_menu)		; //  2.0 최상위 메뉴 안내
	same => n, GotoIf($[${rValue} = 1]?psn_GoodBye,1)
	same => n, Goto(psn_Finish,1)

	; ********************************************************************************
	; 5.2 차주 연결                                                                  *
	; ********************************************************************************
	same => n(psn_call_conn_owner), Set(ErrorCode=psn_call_conn_owner)
	same => n, GoSub(psn_CarOwnertoCallSvc,s,1(${ErrorCode}))
	same => n, Hangup()

	; ********************************************************************************
	; 5.3 대리 운전 연결                                                             *
	; ********************************************************************************
	same => n(psn_conn_chauffeur), Set(ErrorCode=psn_conn_chauffeur)
	same => n, GoSub(psn_ConnAddSvcPhoneNumber,s,1(${ErrorCode},3,${m_Chauffeur}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 0]?psn_chauffeur_svc)		; // 3.1 부가서비스/대리운전 서비스
	same => n, GotoIf($[${rValue} = 1]?psn_GoodBye,1)
	same => n, Hangup()

	; ********************************************************************************
	; 5.4 보험사 연결                                                                *
	; ********************************************************************************
	same => n(psn_conn_insurance), Set(ErrorCode=psn_conn_insurance)
	same => n, GoSub(psn_ConnAddSvcPhoneNumber,s,1(${ErrorCode},4,${m_Insurance}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} = 0]?psn_insurance_svc)		; // 3.2 부가서비스/보험사 서비스
	same => n, GotoIf($[${rValue} = 1]?psn_GoodBye,1)
	same => n, Hangup()

	; ********************************************************************************
	;                                                                                *
	; PSN 서비스 종료                                                                *
	;                                                                                *
	; ********************************************************************************
exten => psn_GoodBye, 1, Log(NOTICE,[${m_CALLER} --> ${m_0507_Number}] [psn_GoodBye] ERR=[${ErrorCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Playback(${comDIR}/COMM_001)			; 이용해 주셔서 감사합니다.
	same => n, Hangup()

exten => psn_Finish, 1, Log(NOTICE,[${m_CALLER} --> ${m_0507_Number}] [psn_Finish] ERR=[${ErrorCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()

exten => h,1, Log(NOTICE,[${m_CALLER} --> ${m_0507_Number}] [psn_Hangup] ERR=[${ErrorCode}] )
	same => n, GoSub(psn_StopMonitor,s,1())
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_InitCommInfo(공통 데이타 초기화)                                           *
;                                                                                *
; ********************************************************************************

[psn_InitCommInfo]
exten => s, 1, Set(CHANNEL(language)=kr)
	same => n, Set(m_CALLER=${CALLERID(ANI)})
	same => n, Set(m_CALLEE=${CALLERID(DNID)})
	same => n, Set(wavDIR=psn)
	same => n, Set(agiDIR=psn)
	same => n, Set(comDIR=comm)
	same => n, Set(emgDIR=EMGHDD)
	same => n, Set(recPath=/var/spool/asterisk/monitor)
	same => n, Set(agiPath=/var/lib/asterisk/agi-bin/${agiDIR})

	same => n, Set(RESULT=)
	same => n, Set(m_QR_Inform=)
	same => n, Set(m_Applicant=)
	same => n, Set(m_PDN=)
	same => n, Set(m_PDNActSts=)
	same => n, Set(m_MDN=)
	same => n, Set(m_MDNActSts=)
	same => n, Set(m_CallPriority=)
	same => n, Set(m_LastCaller=)				; // 24시간내에 호출하였던 가입자 전화 번호
	same => n, Set(m_Chauffeur=)				; // 대리 운전 번호
	same => n, Set(m_Insurance=)				; // 등록되어 있는 차량 보험사 전화번호
	same => n, Set(m_InsChkType=)				; // 차량 보험사 조회 타입 (조회시에만 사용)
	same => n, Set(m_InsCompId=)				; // 차량 보험사 company_id(음원 play시 사용)
	same => n, Set(m_InsCallCent=)				; // 차량 보험사 콜센타 전화번호
	same => n, Set(m_MaxInsCompId=0)			; // 등록된 자동차 보험사 갯수
	same => n, Set(m_CidChgInfo=0)				; // 발신번호 변경 타입(0=0507번호, 1=02-2071-0922)
	same => n, Set(m_CustomInfo=0)				; // Custom 고객 정보(0~6:valid)
	same => n, Set(m_MyPstnCID=0220710922)

	same => n, Set(countPMDN=0)				; // count PDN MDN
	same => n, Set(m_CallType=0)				; // 0=init, 1=주번호, 2=부번호, 3=대리운전번호,4=보험사번호

	same => n, Set(m_CurCalleeDN=)
	same => n, Set(m_FstNoAnswerTO=30)			; // First No Answer Time Out
	same => n, Set(m_SndNoAnswerTO=60)			; // Second No Answer Time Out
	same => n, Set(m_AgiReloadFlag=1)			; // 1=no, 2=yes
	same => n, Set(m_SvcPayedSts=1)				; // 0=not_pay, 1=payed
	same => n, Set(m_RecSave=0)				; // m_RecSave status 0=no_record,1=SUCC, 2=FAIL
	same => n, Set(m_MyPsnType=${ARG1})			; // 1=NM_PSN, 2=QR_PSN
	same => n, Set(m_Seize_0507=0)				; // 0=not_seized,1=seized

	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiDIR=qrpsn))	; // AGI 폴더 위치

	same => n, Return





; ********************************************************************************
;                                                                                *
; psn_AgiGetPsnInform                                                            *
;   주차 안심 번호 정보 검색                                                     *
;   1) input  :                                                                  *
;      - m_0507_Number                                                           *
;                                                                                *
;   2) output :                                                                  *
;      - m_QR_Inform   : QR 고유번호(QR_PSN에서만 유효)                          *
;      - m_Applicant   : 서비스 신청자 전화번호                                  *
;      - m_PDN         : 착신 호출 주번호                                        *
;      - m_PDNActSts   : 착신 호출 주번호 활성화 상태(0=no_dn,1=act,2=dact)      *
;      - m_MDN         : 착신 호출 부번호                                        *
;      - m_MDNActSts   : 착신 호출 부번호 활성화 상태(0=no_dn,1=act,2=dact)      *
;      - m_CallPriority: 호출 우선 순위(1=주번호 , 2=부번호 )                    *
;      - m_LastCaller  : 착신 호출 주(부)번호와 24시간내에 통화 연결된 발신자    *
;      - m_Chauffeur   : 대리 운전 전화 번호                                     *
;      - m_Insurance   : 차량 보험사 긴급 출동 서비스 번호                       *
;      - RESULT        : 정보 검색 결과                                          *
;                        2000= 주차 안심번호 서비스 가능                         *
;                        2001= 등록된 착신 번호 없음                             *
;                        2002= 등록된 착신 번호가 모두 비활성화 상태임           *
;                        2003= 050 번호는 미결재 상태                            *
;                        2004= 050 번호는 DB없음                                 *
;                        8888= db conn fail                                      *
;                        9999= 알려지지 않은 에라 발생                           *
;      - m_CidChgInfo  : 발신번호 표시 변경 정보                                 *
;                        0 = 0507 번호를 발신번호로 사용                         *
;                        1 = 02-2071-0922을 발신번호 사용                        *
;      - m_CustomInfo  : Customizing 고객 정보(ARS회사명 표시)                   *
;                        0 = 음원파일 없는 경우(Say1680음원 제공)                *
;                        1 = 바로서비스                                          *
;                        2 = SKBB/Say1680                                        *
;                        3 = DB 손해 보험                                        *
;                        4 = 더바른 메디컬 의원                                  *
;                        5 = 명륜진사 갈비                                       *
;                        6 = 페마연                                              *
;                        7 = 현대자동차                                          *
;                        8 = 순복음교회                                          *
;                                                                                *
; ********************************************************************************

[psn_AgiGetPsnInform]
exten => s, 1, Noop(psn_AgiGetPsnInform from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_GetPsnInform.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN
	same => n, Set(RESULT=)

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_QR_Inform=[${m_QR_Inform}] m_Applicant=[${m_Applicant}] m_PDN=[${m_PDN}] m_PDNActSts=[${m_PDNActSts}] m_MDN=[${m_MDN}] m_MDNActSts=[${m_MDNActSts}] m_CallPriority=[${m_CallPriority}] m_LastCaller=[${m_LastCaller}] m_Chauffeur=[${m_Chauffeur}] m_Insurance=[${m_Insurance}] m_CidChgInfo=[${m_CidChgInfo}] m_CustomInfo=[${m_CustomInfo}] )

	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.

	same => n, Return(${RESULT})						; // AGI로부터 수신된 결과 


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiGetPsnInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AgiGetInsCompanyInform                                                     *
;   자동차 보험사 콜센타 전화번호 또는 회사ID 검색                               *
;   1) input  :                                                                  *
;      - m_InsChkType : 1=콜센타전번 -> company_id 검색                          *
;                     : 2=company_id -> 콜센타 전화번호 검색                     *
;                     : 3=MAX company_id                                         *
;                                                                                *
;   2) output :                                                                  *
;      - m_InsCallCent  : 자동차 보험사 콜센타 전화 번호 (AGI 파일 참조)         *
;      - m_InsCompId    : 자동차 보험사 company_id (AGI 파일 참조)               *
;      - m_MaxInsCompId : max company_id (AGI 파일 참조)                         *
;                                                                                *
; ********************************************************************************

[psn_AgiGetInsCompanyInform]
exten => s, 1, Noop(psn_AgiGetInsCompanyInform from [${ARG1}/${ARG2}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})		; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_GetInsuranceCompany.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN
	same => n, Set(m_InsChkType=${ARG2})					; // 차량 보험사 조회 타입 (조회시에만 사용)
	same => n, Set(RESULT=)

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_InsChkType=[${m_InsChkType}] m_InsCallCent=[${m_InsCallCent}] m_InsCompId=[${m_InsCompId}] m_MaxInsCompId=[${m_MaxInsCompId}] )

	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.

	same => n, Return(${RESULT})						; // AGI로부터 수신된 결과 


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiGetInsCompanyInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AgiSaveCallNumber                                                          *
;   주차 안심 번호 정보 등록                                                     *
;   1) input  : none                                                             *
;      - 발신번호, m_QR_Inform, m_0507_Number, m_CallType, m_CallNumber,m_ActSts *
;   2) output :                                                                  *
;      - RESULT : 저장 결과                                                      *
;	          2100=succ                                                      *
;	          2101=설정 실패                                                 *
;	          2102=등록 실패(등록된 번호와 동일한 번호로 저장시도)           *
;	          2103=already_reg(등록된 번호 있음)                             *
;                                                                                *
; ********************************************************************************

[psn_AgiSaveCallNumber]
exten => s, 1, Noop(psn_AgiSaveCallNumber from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_SaveCallNumber.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN
	same => n, Set(RESULT=)
	same => n, Set(m_AgiReloadFlag=2)					; // 1=no, 2=yes

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_QR_Inform=[${m_QR_Inform}] m_0507_Number=[${m_0507_Number}] m_CallType=[${m_CallType}] m_CallNumber=[${m_CallNumber}] m_ActSts=[${m_ActSts}] )

	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.

	same => n, Return(${RESULT})						; // AGI로부터 수신된 결과 


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiSaveCallNumber/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AgiSaveAddSvcPhoneNumber                                                   *
;   주차 안심 번호 대리운전, 보험사 번호 등록                                    *
;   1) input  : none                                                             *
;      - 발신번호, m_QR_Inform, m_0507_Number, m_CallType, m_CallNumber          *
;   2) output :                                                                  *
;      - RESULT : 저장 결과                                                      *
;	          2100=succ                                                      *
;	          2101=설정 실패                                                 *
;	          2102=등록 실패(등록된 번호와 동일한 번호로 저장시도)           *
;	          2103=already_reg(등록된 번호 있음)                             *
;                                                                                *
; ********************************************************************************

[psn_AgiSaveAddSvcPhoneNumber]
exten => s, 1, Noop(psn_AgiEtcCallNumber from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_SaveAddSvcPhoneNumber.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN
	same => n, Set(RESULT=)
	same => n, Set(m_AgiReloadFlag=2)					; // 1=no, 2=yes

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_QR_Inform=[${m_QR_Inform}] m_0507_Number=[${m_0507_Number}] m_CallType=[${m_CallType}] m_CallNumber=[${m_CallNumber}] )

	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.

	same => n, Return(${RESULT})						; // AGI로부터 수신된 결과 


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiSaveAddSvcPhoneNumber/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AgiDeleteCallNumber                                                        *
;   주차 안심 번호 정보 등록                                                     *
;   1) input  : none                                                             *
;      - 발신번호, m_QR_Inform, m_0507_Number, m_CallType                        *
;   2) output :                                                                  *
;      - RESULT : 삭제 결과                                                      *
;	          2200=succ                                                      *
;	          2201=fail                                                      *
;	          2202=already_del(이미 삭제한 경우, 미등록 상태)                *
;                                                                                *
; ********************************************************************************

[psn_AgiDeleteCallNumber]
exten => s, 1, Noop(psn_AgiDeleteCallNumber from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_DeleteCallNumber.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN
	same => n, Set(RESULT=)
	same => n, Set(m_AgiReloadFlag=2)					; // 1=no, 2=yes

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_QR_Inform=[${m_QR_Inform}] m_0507_Number=[${m_0507_Number}] m_CallType=[${m_CallType}] )

	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.

	same => n, Return(${RESULT})						; // AGI로부터 수신된 결과 


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiDeleteCallNumber/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AgiChangeActSts                                                            *
;   주차 안심 번호 정보 활성화/서비스 정지  상태 변경                            *
;   1) input  : none                                                             *
;      - 발신번호, m_QR_Inform, m_0507_Number, m_CallType, m_ActSts              *
;   2) output :                                                                  *
;      - RESULT : 변경 결과                                                      *
;                 2300=succ                                                      *
;                 2301=fail                                                      *
;                 2302=already_act(이미 활성화 상태)                             *
;                 2303=already_dact(이미 서비스 중지 상태)                       *
;                                                                                *
; ********************************************************************************

[psn_AgiChangeActSts]
exten => s, 1, Noop(psn_AgiChangeActSts from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_ChangeActSts.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN
	same => n, Set(RESULT=)
	same => n, Set(m_AgiReloadFlag=2)					; // 1=no, 2=yes

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_QR_Inform=[${m_QR_Inform}] m_0507_Number=[${m_0507_Number}] m_CallType=[${m_CallType}] m_ActSts=[${m_ActSts}] )

	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.

	same => n, Return(${RESULT})						; // AGI로부터 수신된 결과 


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiChangeActSts/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AgiChangePriority                                                          *
;   주차 안심번호 호출 우선순위 정보 변경                                        *
;   1) input  :                                                                  *
;      - 발신번호, m_QR_Inform, m_0507_Number, m_CallPriority                    *
;   2) output :                                                                  *
;      - RESULT : 변경 결과                                                      *
;                 2400=succ                                                      *
;                 2401=fail                                                      *
;                 2402=already_chg(이미 요청한 것으로 1차 호출우선순위를 사용중) *
;                                                                                *
; ********************************************************************************

[psn_AgiChangePriority]
exten => s, 1, Noop(psn_AgiChangePriority from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_ChangePriority.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN
	same => n, Set(RESULT=)
	same => n, Set(m_AgiReloadFlag=2)					; // 1=no, 2=yes

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_QR_Inform=[${m_QR_Inform}] m_0507_Number=[${m_0507_Number}] m_CallPriority=[${m_CallPriority}] )

	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.

	same => n, Return(${RESULT})						; // AGI로부터 수신된 결과 


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiChangePriority/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AgiSaveHistory                                                             *
;   주차 안심 번호 연력 이력 정보 저장                                           *
;   1) input  :                                                                  *
;      - 발신번호(m_CALLER), m_QR_Inform, m_0507_Number, m_CurCalleeDN           *
;   2) output :                                                                  *
;      - RESULT : 저장 결과                                                      *
;                 2500=succ                                                      *
;                 2501=fail                                                      *
;                                                                                *
; ********************************************************************************

[psn_AgiSaveHistory]
exten => s, 1, Noop(psn_AgiSaveHistory from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_SaveHistory.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN
	same => n, Set(RESULT=)

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGI=[${AGISTATUS}] RLT=[${RESULT}] m_QR_Inform=[${m_QR_Inform}] m_0507_Number=[${m_0507_Number}] m_CurCalleeDN=[${m_CurCalleeDN}] m_CALLER=[${m_CALLER}] )
	same => n, Return


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiSaveHistory/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()




; ********************************************************************************
;                                                                                *
; psn_AgiGetUserCode                                                             *
;   녹취 파일 저장을 위한 usercode 정보 검색                                     *
;   1) input  :                                                                  *
;      - 070 착신번호                                                            *
;   2) output :                                                                  *
;      - RESULT : 저장 결과                                                      *
;                 0000=succ                                                      *
;      - USERCODE                                                                *
;                                                                                *
; ********************************************************************************

[psn_AgiGetUserCode]
exten => s, 1, Noop(psn_AgiGetUserCode from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_get_user_code.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN
	same => n, Set(RESULT=)

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}] USERCODE=[${USERCODE}] )

	same => n, GotoIf($["${AGISTATUS}"!="SUCCESS"]?abnorm)
	same => n, GotoIf($["${RESULT}"!="0000"]?abnorm)
	same => n, Goto(norm)

	same => n(norm), Return;
	same => n(abnorm), Set(USERCODE=psn)
	same => n, Return;


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiGetUserCode/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()




; ********************************************************************************
;                                                                                *
; psn_AgiSaveRecFile                                                             *
;   녹취 파일을 저장하고, 녹취 파일에 대한 정보를 DB에 저장                      *
;   1) input  : none                                                             *
;   2) output :                                                                  *
;      - RESULT : 저장 결과                                                      *
;                                                                                *
; ********************************************************************************

[psn_AgiSaveRecFile]
exten => s, 1, Noop(psn_AgiSaveRecFile from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_save_recfile.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}] )
	same => n, Return;

exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiSaveRecFile/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AgiGetQRInform                                                             *
;   0507번호와 발신번호로 0507 pool에 저장되어 있는 QR고유번호를 검색            *
;   1) input  :                                                                  *
;      - m_0507_Number, 발신번호                                                 *
;   2) output :                                                                  *
;      - RESULT : 검색 결과                                                      *
;                 2600=OK                                                        *
;                 2601=fail(QR 정보 없음)                                        *
;                 2602=fail(QR 정보 있으나, 0507번호가 다름)                     *
;                 2603=fail(QR 정보 있으나, 발신번호가 다름)                     *
;      - m_QR_Inform: QR 고유번호(고객 정보 검색을 위한 키값)                    *
;                                                                                *
; ********************************************************************************

[psn_AgiGetQRInform]
exten => s, 1, Noop(psn_AgiGetQRInform from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_GetQRInform.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}] m_0507_Number=[${m_0507_Number}] m_QR_Inform=[${m_QR_Inform}] )

	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.

	same => n, Return(${RESULT})

exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiGetQRInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AgiSeize_0507                                                              *
;   0507 pool에서 0507번호를 사용하도록 할당 요청                                *
;   할당받은 번호를 회수 요청시까지는 다른 사용자에게 할당되어서는 안된다.       *
;   서비스가 완료되거나 통화가 종료되면 0507 번호를 반환하여 다른 사용자가       *
;   사용할 수 있게 하여야 한다.                                                  *
;   1) input  :                                                                  *
;      - m_0507_Number, 발신번호(m_CALLER), m_QR_Inform                          *
;   2) output :                                                                  *
;      - RESULT : 검색 결과                                                      *
;                 2620=OK                                                        *
;                 2621=fail                                                      *
;                                                                                *
; ********************************************************************************

[psn_AgiSeize_0507]
exten => s, 1, Noop(psn_AgiSeize_0507 from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_Seize_0507.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}] m_0507_Number=[${m_0507_Number}] m_CALLER=[${m_CALLER}] m_QR_Inform=[${m_QR_Inform}] )

	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.

	same => n, Return(${RESULT})

exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiSeize_0507/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AgiRelease_0507                                                            *
;   0507 pool에서 할당받은 번호의 서비스 이용이 완료됨에 따라 재사용을 위해      *
;   0507 pool로 회수하도록 요청.  서비스 종료시 항상 수행하여야 함.              *
;   1) input  :                                                                  *
;      - m_0507_Number, 발신번호(m_CALLER), m_QR_Inform                          *
;   2) output :                                                                  *
;      - RESULT : 회수 요청 결과                                                 *
;                 2630=OK                                                        *
;                 2631=fail                                                      *
;                                                                                *
; ********************************************************************************

[psn_AgiRelease_0507]
exten => s, 1, Noop( ---------------- psn_AgiRelease_0507 from [${ARG1}/${m_Seize_0507}] ---------------- )
	same => n, GotoIf($["${m_MyPsnType}" != "QR_PSN"]?ret)
	same => n, GotoIf($[${m_Seize_0507} != 1]?ret)

	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_Release_0507.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}] m_0507_Number=[${m_0507_Number}] m_QR_Inform=[${m_QR_Inform}] m_CALLER=[${m_CALLER}] )

	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.
	same => n, ExecIf($[${RESULT} = 2630]?Set(m_Seize_0507=0))		; // 0=not_seized,1=seized

	same => n, Return(${RESULT})
	same => n(ret), Return

exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiRelease_0507/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AgiGetLastCallHistory                                                      *
;   통화 이력 목록에서 최근 차주 통화자 이력 정보 조회                           *
;   최근 차주 호출자 통화 연결시 사용하였던 0507번호를 검색하여 사용하기 위함.   *
;   1) input  :                                                                  *
;      - m_QR_Inform, m_LastCaller                                               *
;   2) output :                                                                  *
;      - RESULT : 회수 요청 결과                                                 *
;                 2640=OK                                                        *
;                 2641=fail                                                      *
;      - m_0507_Inform                                                           *
;                                                                                *
; ********************************************************************************

[psn_AgiGetLastCallHistory]
exten => s, 1, Noop(psn_AgiGetLastCallHistory from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_GetLastCallHistory.php)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}] m_QR_Inform=[${m_QR_Inform}] m_LastCaller=[${m_LastCaller}] m_0507_Inform=[${m_0507_Inform}] )

	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.

	same => n, Return(${RESULT})

exten => h, 1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AgiGetLastCallHistory/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AgiCheckCallerId                                                           *
;   QR_PSN 서비스를 위하여 지정된 070 번호를 직접 호출하는 경우                  *
;   DB에서 발신번호로 등록되어 있는 신청자, 주번호, 부번호를 검색하여            *
;   일차하는 정보가 있는 경우 해당 QR 고유번호를 알려준다.                       *
;   1) input  :                                                                  *
;      - 발신번호                                                                *
;   2) output :                                                                  *
;      - m_QR_Inform   : QR 고유번호                                             *
;      - m_0507_Inform : 0507 pool에 있는 0507 번호                              *
;      - RESULT : 검색 요청 결과                                                 *
;                 2610=OK                                                        *
;                 2611=발신번호로 검색된 신청자/주번호/부번호 정보 없음.         *
;                 2612=0507번호를 할당받지 못함.                                 *
;                                                                                *
; ********************************************************************************

[psn_AgiCheckCallerId]
exten => s, 1, Noop(psn_AgiCheckCallerId from [${ARG1}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})					; // ErrCode
	same => n, Set(LOCAL(agiFN)=psn_check_callerId.php)
	same => n, Set(RESULT=)
	same => n, ExecIf($["${m_MyPsnType}" = "QR_PSN"]?Set(agiFN=qr${agiFN}))	; // if QR-PSN

	same => n, AGI(${agiDIR}/${agiFN})
	same => n, Log(NOTICE,[${m_CALLER}] ${agiFN} : AGISTATUS=${AGISTATUS} RESULT=[${RESULT}] m_QR_Inform=[${m_QR_Inform}] m_0507_Inform=[${m_0507_Inform}] )

	same => n, ExecIf($["${AGISTATUS}"!="SUCCESS"]?Set(RESULT=9093))	; // 외부 장치에 접속하지 못하여, ~~~~~~~~~.
	same => n, ExecIf($[${LEN(${RESULT})} = 0]?Set(RESULT=9999))

	same => n, Return(${RESULT})

exten => h, 1, Log(NOTICE,PSN [${m_CALLER} --> ${m_CALLEE}] psn_AgiCheckCallerId/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_GetUserAuth                                                                *
;   발신자 번호를 가지고 사용자 구분                                             *
;   1) input  : none                                                             *
;   2) output :   0=해당안됨                                                     *
;             :   1=신청자                                                       *
;                 2=주번호 사용자                                                *
;                 3=부번호 사용자                                                *
;                23=주번호 사용자 + 부번호 사용자                                *
;                12=신청자 + 주번호 사용자                                       *
;                13=신청자 + 부번호 사용자                                       *
;               123=신청자 + 주번호 사용자 + 부번호 사용자                       *
;                                                                                *
; ********************************************************************************

[psn_GetUserAuth]
exten => s, 1, Set(LOCAL(UserAuth)=0)

	same => n(app), GotoIf($[${LEN(${m_Applicant})} = 0]?pdn)
	same => n, ExecIf($[${m_CALLER} = ${m_Applicant}]?Set(UserAuth=1))
	same => n, GotoIf($[${UserAuth} = 1]?end)

	same => n(pdn), GotoIf($[${LEN(${m_PDN})} = 0]?mdn)
	same => n, ExecIf($[${m_CALLER} = ${m_PDN}]?Set(UserAuth=2))
	same => n, GotoIf($[${UserAuth} = 2]?end)

	same => n(mdn), GotoIf($[${LEN(${m_MDN})} = 0]?end)
	same => n, ExecIf($[${m_CALLER} = ${m_MDN}]?Set(UserAuth=3))
	same => n, Goto(end)

	same => n(end), GotoIf($[${UserAuth} = 0]?rte)
	same => n, GotoIf($[${UserAuth} = 1]?chk_pdn)
	same => n, GotoIf($[${UserAuth} = 2]?chkmmdn:rte)

	same => n(chk_pdn), GotoIf($[${LEN(${m_PDN})} = 0]?chk_mdn)
	same => n, ExecIf($[${m_CALLER} = ${m_PDN}]?Set(UserAuth=12))
	same => n, GotoIf($[${UserAuth} = 12]?chkMMDN:rte)

	same => n(chk_mdn), GotoIf($[${LEN(${m_MDN})} = 0]?rte)
	same => n, ExecIf($[${m_CALLER} = ${m_MDN}]?Set(UserAuth=13))
	same => n, Goto(rte)

	same => n(chkmmdn), GotoIf($[${LEN(${m_MDN})} = 0]?rte)
	same => n, ExecIf($[${m_CALLER} = ${m_MDN}]?Set(UserAuth=23))
	same => n, Goto(rte)

	same => n(chkMMDN), GotoIf($[${LEN(${m_MDN})} = 0]?rte)
	same => n, ExecIf($[${m_CALLER} = ${m_MDN}]?Set(UserAuth=123))
	same => n, Goto(rte)

	same => n(rte), return(${UserAuth})





; ********************************************************************************
;                                                                                *
; psn_ReloadPsnInform                                                            *
;   주차 안심 번호 서비스 정보 재검색                                            *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_ReloadPsnInform]

exten => s,1,Noop(psn_ReloadPsnInform from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=${ARG1})						; // ErrCode
	same => n, Set(m_AgiReloadFlag=1)						; // 1=no, 2=yes

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GoSub(psn_AgiGetPsnInform,s,1(${ErrCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})

	same => n, GotoIf($[${rValue} >= 2004]?PGPI_2)

	same => n, Set(countPMDN=0)

	same => n, ExecIf($[${LEN(${m_PDN})} > 0]?Set(countPMDN=$[${countPMDN}+1]))
	same => n, ExecIf($[${LEN(${m_MDN})} > 0]?Set(countPMDN=$[${countPMDN}+1]))
	same => n, ExecIf($[${LEN(${m_PDNActSts})} = 0]?Set(m_PDNActSts=1)		; // 1=활성화, 2=일시정지
	same => n, ExecIf($[${LEN(${m_MDNActSts})} = 0]?Set(m_MDNActSts=1)
	same => n, ExecIf($[${LEN(${m_CallPriority})} = 0]?Set(m_CallPriority=1)	; // 1=주번호, 2=부번호

	same => n, ExecIf($[${m_PDNActSts} != 2]?Set(m_PDNActSts=1)			; // 1=활성화, 2=일시정지
	same => n, ExecIf($[${m_MDNActSts} != 2]?Set(m_MDNActSts=1)			; // 1=활성화, 2=일시정지
	same => n, ExecIf($[${m_CallPriority} != 2]?Set(m_CallPriority=1)		; // 1=주번호, 2=부번호
	same => n, ExecIf($[${m_CidChgInfo} > 1]?Set(m_CidChgInfo=0)			; // 0=0507, 1=02-2071-0922
	same => n, GoSub(psn_CheckCustomInfo,s,1())

	same => n(PGPI_1), Return(1)							; // succ
	same => n(PGPI_2), Return(2)							; // fail


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_ReloadPsnInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_PlayAnm(AGI 수행 결과에 대한 안내 멘트)                                    *
;                                                                                *
; ********************************************************************************

[psn_PlayAnm]

exten => s, 1, Noop(psn_AnmforAgifail [${ARG1} / ${ARG2}] )

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; // ErrCode
	same => n, Set(LOCAL(rlt)=${ARG2})				; // agi_result
	same => n, Set(LOCAL(FN)=PSN_000)				; // 1초 묵음: 알려지지 않은 에라발생시

	same => n, ExecIf($[${rlt} < 1000]?Set(rlt=9092)		; undefined_error
	same => n, GotoIf($[${rlt} >= 8000]?msg_err)

	same => n(msg_0), GotoIf($[${rlt} >= 2100]?msg_1)
	same => n, ExecIf($[${rlt} = 2001]?Set(FN=PSN_101))		; 등록된 호출 번호가 없습니다.
	same => n, ExecIf($[${rlt} = 2002]?Set(FN=PSN_102))		; 등록된 호출 번호는 모두 일시 정지 상태입니다.
	same => n, ExecIf($[${rlt} = 2003]?Set(FN=PSN_103))		; 지금 거신 전화 번호는 결재가 되어 있지 않아, 서비스를 제공할 수 없습니다.
	same => n, ExecIf($[${rlt} = 2004]?Set(FN=PSN_104))		; 지금 거신 전화 번호는 서비스를 등록하지 않은 번호입니다.
	same => n, Goto(play)

	same => n(msg_1), GotoIf($[${rlt} >= 2200]?msg_2)
	same => n, ExecIf($[${rlt} = 2100]?Set(FN=PSN_110))		; 등록되었습니다.
	same => n, ExecIf($[${rlt} = 2101]?Set(FN=PSN_111))		; 등록하지 못했습니다.
	same => n, ExecIf($[${rlt} = 2102]?Set(FN=PSN_112))		; 이미 등록되어 있는 번호입니다.
	same => n, ExecIf($[${rlt} = 2103]?Set(FN=PSN_113))		; 등록된 정보가 있습니다.
	same => n, Goto(play)

	same => n(msg_2), GotoIf($[${rlt} >= 2300]?msg_3)
	same => n, ExecIf($[${rlt} = 2200]?Set(FN=PSN_120))		; 삭제되었습니다.
	same => n, ExecIf($[${rlt} = 2201]?Set(FN=PSN_121))		; 삭제하지 못했습니다.
	same => n, ExecIf($[${rlt} = 2202]?Set(FN=PSN_122))		; 등록된 정보가 없어, 삭제하지 못했습니다.
	same => n, Goto(play)

	same => n(msg_3), GotoIf($[${rlt} >= 2400]?msg_4)
	same => n, ExecIf($[${rlt} = 2300]?Set(FN=PSN_130))		; 서비스를 활성화하였습니다.
	same => n, ExecIf($[${rlt} = 2301]?Set(FN=PSN_131))		; 서비스를 활성화하지 못했습니다.
	same => n, ExecIf($[${rlt} = 2302]?Set(FN=PSN_132))		; 이미 서비스는 활성화되어 있습니다.
	same => n, ExecIf($[${rlt} = 2303]?Set(FN=PSN_133))		; 이미 서비스는 일시 정지되어 있습니다.
	same => n, ExecIf($[${rlt} = 2304]?Set(FN=PSN_134))		; 서비스를 일시 정지하였습니다.
	same => n, ExecIf($[${rlt} = 2305]?Set(FN=PSN_135))		; 서비스를 일시 정지하지 못했습니다.
	same => n, Goto(play)

	same => n(msg_4), GotoIf($[${rlt} >= 2500]?msg_5)
	same => n, ExecIf($[${rlt} = 2400]?Set(FN=PSN_140))		; 호출 우선 순위를 변경하였습니다.
	same => n, ExecIf($[${rlt} = 2401]?Set(FN=PSN_141))		; 호출 우선 순위를 변경하지 못했습니다.
	same => n, ExecIf($[${rlt} = 2402]?Set(FN=PSN_142))		; 이미 변경된 우선 순위 입니다.
	same => n, Goto(play)

	same => n(msg_5), GotoIf($[${rlt} >= 2500]?msg_6)
	same => n, ExecIf($[${rlt} = 2500]?Set(FN=PSN_150))		; 호출자 정보를 저장하였습니다.
	same => n, ExecIf($[${rlt} = 2501]?Set(FN=PSN_151))		; 호출자 정보를 저장하지 못 했습니다.
	same => n, Goto(play)

	same => n(msg_6), GotoIf($[${rlt} >= 2610]?msg_7)
	same => n, ExecIf($[${rlt} = 2600]?Set(FN=PSN_200))		; QR 주차 안심 서비스를 시작 합니다.
	same => n, ExecIf($[${rlt} = 2601]?Set(FN=PSN_201))		; 지금 거신 전화 번호는 QR 코드가 등록되어 있지 않습니다. QR 코드를 다시 스캔하십시요.
	same => n, ExecIf($[${rlt} = 2602]?Set(FN=PSN_202))		; QR 정보는 정상이나, 호출 번호가 달라 서비스를 제공할 수 없습니다.
	same => n, ExecIf($[${rlt} = 2603]?Set(FN=PSN_203))		; QR 정보는 정상이나, 발신 번호가 달라 서비스를 제공할 수 없습니다.
	same => n, ExecIf($[${rlt} = 2604]?Set(FN=PSN_204))		; 지금 거신 전화 번호는 잘못된 QR 정보를 수신하였습니다. QR 코드를 다시 스캔 하십시요.

	same => n, Goto(play)

	same => n(msg_7), GotoIf($[${rlt} >= 2640]?msg_err)
	same => n, ExecIf($[${rlt} = 2610]?Set(FN=PSN_210))		; QR 주차 서비스를 시작하겠습니다.
	same => n, ExecIf($[${rlt} = 2611]?Set(FN=PSN_211))		; 고객님의 정보가 검색되지 않아, 서비스를 제공할 수 없습니다.
	same => n, ExecIf($[${rlt} = 2612]?Set(FN=PSN_212))		; 정보를 할당받지 못하여, 서비스를 제공할 수 없습니다.
	same => n, ExecIf($[${rlt} = 2613]?Set(FN=PSN_213))		; 고객님의 정보에 접근할 수 없습니다.
	same => n, ExecIf($[${rlt} = 2614]?Set(FN=PSN_214))		; 서버가 정보를 할당하지 않아, 서비스를 제공할 수 없습니다.
	same => n, ExecIf($[${rlt} = 2615]?Set(FN=PSN_215))		; 고객님은 등록 정보가 2개 이상입니다. 
	                                                   		; 직접 전화하여 서비스를 받을 수 없습니다.
	                                                   		; QR 코드를 스캔하여, 서비스를 받으세요. 
	same => n, ExecIf($[${rlt} = 2616]?Set(FN=PSN_215))		; 
	same => n, ExecIf($[${rlt} = 2617]?Set(FN=PSN_215))		; 

	same => n, ExecIf($[${rlt} = 2620]?Set(FN=PSN_216))		; 호출 번호 사용 허가를 받았습니다.
	same => n, ExecIf($[${rlt} = 2621]?Set(FN=PSN_217))		; 호출 번호 사용 허가를 받지 못했습니다.
	same => n, ExecIf($[${rlt} = 2630]?Set(FN=PSN_218))		; 호출 번호를 반환하였습니다.
	same => n, ExecIf($[${rlt} = 2631]?Set(FN=PSN_219))		; 호출 번호를 반환하지 못했습니다.
	same => n, Goto(play)

	same => n(msg_err), Set(FN=COMM_000)				; // 1초 묵음: 알려지지 않은 에라발생시
	same => n, ExecIf($[${rlt} = 8888]?Set(FN=COMM_901))		; 외부장치와 접속이 원할하지 않아,서비스를 진행할수 없습니다.
	same => n, ExecIf($[${rlt} = 9999]?Set(FN=COMM_902))		; 알려지지 않은 장애가 발생하여, 서비스가 중단되었습니다.
	same => n, ExecIf($[${rlt} = 9092]?Set(FN=COMM_903))		; 서버로부터 알 수 없는 정보를 수신하여, 서비스가 중단 되었습니다.
	same => n, ExecIf($[${rlt} = 9093]?Set(FN=COMM_900))		; 외부 장치에 접속하지 못하여, 서비스를 진행할 수 없습니다.
	same => n, ExecIf($[${rlt} = 9084]?Set(FN=COMM_004))		; 서비스 준비중입니다. 다음에 이용해 주세요.
	same => n, Playback(${comDIR}/${FN})
	same => n, Return

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(play), Playback(${wavDIR}/${FN})
	same => n, Return


exten => h,1, Log(NOTICE,[${m_CALLER} --> ${m_0507_Number}] psn_PlayAnm/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_GetPsnInform                                                               *
;   주차 안심 번호 서비스 정보 검색                                              *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_GetPsnInform]

exten => s,1,Noop(psn_GetPsnInform from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; // ErrCode

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GoSub(psn_AgiGetPsnInform,s,1(${ErrCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})

	same => n, GotoIf($[${rValue} = 2000]?PGPI_agi_succ)	; // OK
	same => n, GotoIf($[${rValue} = 2001]?PGPI_agi_succ)	; // none_callee_number
	same => n, GotoIf($[${rValue} = 2002]?PGPI_agi_succ)	; // all deacted
	same => n, GotoIf($[${rValue} = 2003]?PGPI_agi_2003)	; // not payed
;	same => n, GotoIf($[${rValue} = 2004]?PGPI_agi_fail)	; // no 0507 number
;	same => n, GotoIf($[${rValue} = 8888]?PGPI_agi_fail)	; // db_conn_fail
;	same => n, GotoIf($[${rValue} = 9999]?PGPI_agi_fail)	; // undefined_err
;	same => n, GotoIf($[${rValue} = 9092]?PGPI_agi_fail)	; 알려지지 않은 장애가 발생하여, 서비스를 진행할 수 없습니다.
;	same => n, GotoIf($[${rValue} = 9093]?PGPI_agi_fail)	; // agi_acc_fail
	same => n, Goto(PGPI_agi_fail)				; // unkwon_error

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PGPI_agi_succ), Set(ErrCode=PGPI_agi_succ)
	same => n, GotoIf($["${m_MyPsnType}" != "QR_PSN"]?PGPI_agi_check)	; // if not QR-PSN
	same => n, GotoIf($[${LEN(${m_QR_Inform})} > 0]?PGPI_agi_check)
	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},2611))
	same => n, Goto(PGPI_0)

	same => n(PGPI_agi_check), Set(ErrCode=PGPI_agi_check)
	same => n, ExecIf($[${LEN(${m_PDN})} > 0]?Set(countPMDN=$[${countPMDN}+1]))
	same => n, ExecIf($[${LEN(${m_MDN})} > 0]?Set(countPMDN=$[${countPMDN}+1]))
	same => n, ExecIf($[${LEN(${m_PDNActSts})} = 0]?Set(m_PDNActSts=1)		; // 1=활성화, 2=비활성화
	same => n, ExecIf($[${LEN(${m_MDNActSts})} = 0]?Set(m_MDNActSts=1)
	same => n, ExecIf($[${LEN(${m_CallPriority})} = 0]?Set(m_CallPriority=1)	; // 1=주번호, 2=부번호

	same => n, ExecIf($[${m_PDNActSts} != 2]?Set(m_PDNActSts=1)		; // 1=활성화, 2=비활성화
	same => n, ExecIf($[${m_MDNActSts} != 2]?Set(m_MDNActSts=1)		; // 1=활성화, 2=비활성화
	same => n, ExecIf($[${m_CallPriority} != 2]?Set(m_CallPriority=1)	; // 1=주번호, 2=부번호

	same => n, ExecIf($[${m_CidChgInfo} > 1]?Set(m_CidChgInfo=0)		; // 0=0507, 1=02-2071-0922
	same => n, GoSub(psn_CheckCustomInfo,s,1())

	same => n, GotoIf($[${LEN(${m_Applicant})} = 0]?PGPI_pdn)		; // 서비스 신청자 확인
	same => n, GotoIf($[${m_CALLER} != ${m_Applicant}]?PGPI_pdn)		; // 서비스 신청자
	same => n, GotoIf($[${countPMDN} < 1]?PGPI_3)				; // 서비스 신청자 & 착신번호 미등록

	same => n(pd), GotoIf($[${LEN(${m_PDN})} = 0]?md)
	same => n, GotoIf($[${m_CALLER} = ${m_PDN}]?PGPI_1)			; // 주번호
	same => n(md), GotoIf($[${LEN(${m_MDN})} = 0]?ap)
	same => n, GotoIf($[${m_CALLER} = ${m_MDN}]?PGPI_1)			; // 부번호
	same => n(ap), Goto(PGPI_4)

	same => n(PGPI_pdn), GotoIf($[${LEN(${m_PDN})} = 0]?PGPI_mdn)		; // 주번호 존재 여부 확인
	same => n, GotoIf($[${m_CALLER} = ${m_PDN}]?PGPI_1)			; // 주번호

	same => n(PGPI_mdn), GotoIf($[${LEN(${m_MDN})} = 0]?PGPI_ndn)		; // 부번호 존재 여부 확인
	same => n, GotoIf($[${m_CALLER} = ${m_MDN}]?PGPI_1)			; // 부번호

	same => n(PGPI_ndn), GotoIf($[${countPMDN} = 0]?PGPI_none_dn)
	same => n, Goto(PGPI_2)							; // 차주에게 연락해야 하는 자

	same => n(PGPI_none_dn), GoSub(psn_PlayAnm,s,1(PGPI_none_dn,9084))	; 서비스 준비중입니다. 다음에 이용해 주세요.
	same => n, Goto(PGPI_0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PGPI_agi_2003), Set(ErrCode=PGPI_agi_2003)
	same => n, Set(m_SvcPayedSts=0)						; // 0=not_pay, 1=payed
	same => n, GotoIf($[${LEN(${m_Applicant})} = 0]?pdn)
	same => n, GotoIf($[${m_CALLER} != ${m_Applicant}]?pdn)

	same => n, ExecIf($[${LEN(${m_PDN})} > 0]?Set(countPMDN=$[${countPMDN}+1]))
	same => n, ExecIf($[${LEN(${m_MDN})} > 0]?Set(countPMDN=$[${countPMDN}+1]))
	same => n, GotoIf($[${countPMDN} < 2]?PGPI_3)				; // 등록만 행위 허용
	same => n, Goto(PGPI_agi_fail)

	same => n(pdn), GotoIf($[${LEN(${m_PDN})} = 0]?mdn)
	same => n, GotoIf($[${m_CALLER} = ${m_PDN}]?PGPI_agi_fail)

	same => n(mdn), GotoIf($[${LEN(${m_MDN})} = 0]?rdy)
	same => n, GotoIf($[${m_CALLER} = ${m_MDN}]?PGPI_agi_fail)

	same => n(rdy), GoSub(psn_PlayAnm,s,1(${ErrCode},9084))			; 서비스 준비중입니다. 다음에 이용해 주세요.
	same => n, Goto(PGPI_0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PGPI_agi_fail), Set(ErrCode=PGPI_agi_fail)
	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},${rValue}))
	same => n, Goto(PGPI_0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PGPI_1), Return(1)	; // OK - 메인 메뉴 이동
	same => n(PGPI_2), Return(2)	; // OK - 차주 연결
	same => n(PGPI_3), Return(3)	; // OK - 신청자 & 착신번호 등록
	same => n(PGPI_4), Return(4)	; // OK - 신청자 & 정보설정 메뉴
	same => n(PGPI_0), Return(0)	; // Fail - 종료


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_GetPsnInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_CheckCustimeInfo                                                           *
;    m_CustomInfo의 값에 해당하는 PSN_007_x.wav 음원 파일이 있는지 여부 확인     *
;    고객사가 새로이 추가되는 경우 음원파일이 없는 경우 기본 say1680음원 제공    *
;                                                                                *
; ********************************************************************************

[psn_CheckCustomInfo]
exten => s, 1, Set(LOCAL(FileSize)=${STAT(s,/var/lib/asterisk/sounds/psn/PSN_007_${m_CustomInfo}.wav)});
	same => n, ExecIf($[${FileSize} = 0]?Set(m_CustomInfo=0))
	same => n, Return()





; ********************************************************************************
;                                                                                *
; psn_CarOwnertoCallSvc                                                          *
;   차주와 통화 연결 시도                                                        *
;   1) input  : none                                                             *
;   2) output :                                                                  *
;      - 1=connect_fail,2=fail,3=차주연결불가,4=연결서비스못함                   *
;                                                                                *
; ********************************************************************************

[macro-psn_answer]
exten => s, 1, Noop(macro-psn_answer=[${ARG1}/${ARG2}/${ARG3}])
;	same => n, Set(m_0507_Number=${ARG1})
;	same => n, Set(m_CurCalleeDN=${ARG2})
;	same => n, Set(m_CALLER=${ARG3})
;	same => n, GoSub(psn_AgiSaveHistory,s,1(macro_psn_answer))

	same => n, Playback(psn/PSN_003)	; 주차 안심 번호 서비스 호출 전화입니다.


[psn_CarOwnertoCallSvc]

exten => s, 1, Noop(psn_CarOwnertoCallSvc from [${ARG1}] )

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, Set(LOCAL(ErrCode)=${ARG1})			; // ErrCode
	same => n, Set(LOCAL(NoAnswerTime)=${m_FstNoAnswerTO})	; // timeout for no answer
	same => n, Set(LOCAL(m_mdn)=)				; // secondary DN
	same => n, Set(LOCAL(m_act)=0)				; // dn active state
	same => n, Set(LOCAL(m_mact)=0)				; // dn active state
	same => n, Set(LOCAL(m_anm)=0)				; // anm play flag   (0=not_play, 1=already_play)

	same => n, GotoIf($[${countPMDN} = 0]?PCCO_svc_unavail)
	same => n, GotoIf($[${countPMDN} > 1]?bdn)

	; ----------------------------------------
	; 주번호 혹은 부번호 하나만 등록되어 있는 경우               
	; ----------------------------------------
	same => n(sdn), Set(NoAnswerTime=${m_SndNoAnswerTO})
	same => n, ExecIf($[${LEN(${m_PDN})} = 0]?Set(m_mdn=${m_MDN}):Set(m_mdn=${m_PDN}))
	same => n, ExecIf($[${LEN(${m_PDN})} = 0]?Set(m_act=${m_MDNActSts}):Set(m_act=${m_PDNActSts}))

	same => n, Set(m_CurCalleeDN=${m_mdn})
	same => n, Set(m_mdn=)
	same => n, Set(m_mact=)

	same => n, GotoIf($[${LEN(${m_CurCalleeDN})} = 0]?PCCO_unable_conn_call)
	same => n, GotoIf($[${m_act} != 1]?PCCO_unable_conn_call)
	same => n, Goto(PCCO_connect_call)

	; ----------------------------------------
	; 주번호 혹은 부번호 모두 등록되어 있는 경우               
	; ----------------------------------------
	same => n(bdn), Set(NoAnswerTime=${m_FstNoAnswerTO})
	same => n, ExecIf($[${m_CallPriority} = 1]?Set(m_mdn=${m_PDN}):Set(m_mdn=${m_MDN}))
	same => n, ExecIf($[${m_CallPriority} = 1]?Set(m_act=${m_PDNActSts}):Set(m_act=${m_MDNActSts}))
	same => n, Set(m_CurCalleeDN=${m_mdn})

	same => n, ExecIf($[${m_CallPriority} = 1]?Set(m_mdn=${m_MDN}):Set(m_mdn=${m_PDN}))
	same => n, ExecIf($[${m_CallPriority} = 1]?Set(m_mact=${m_MDNActSts}):Set(m_mact=${m_PDNActSts}))

	same => n, GotoIf($[${LEN(${m_CurCalleeDN})} = 0]?chg_bdn)
	same => n, GotoIf($[${m_act} = 1]?PCCO_connect_call)

	same => n(chg_bdn), Set(m_CurCalleeDN=${m_mdn})
	same => n, Set(m_act=${m_mact})
	same => n, Set(m_mdn=)
	same => n, Set(m_mact=)

	same => n, GotoIf($[${LEN(${m_CurCalleeDN})} = 0]?PCCO_unable_conn_call)
	same => n, GotoIf($[${m_act} != 1]?PCCO_unable_conn_call)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCCO_connect_call), Set(ErrCode=PCCO_connect_call)

	same => n, GotoIf($[${m_act} != 1]?PCCO_2nd_call)

	same => n, GosubIf($[${m_anm} = 0]?psn_AgiSaveHistory,s,1(${ErrCode}))

	same => n, ExecIf($[${m_CidChgInfo} = 1]?Set(m_MyDN=${m_MyPstnCID}))

	same => n, Set(CALLERID(num)=${m_MyDN})
	same => n, Set(CALLERID(name)=${m_MyDN})
	same => n, Gosub(psn_MixMonitor,s,1(${ErrCode},1,${m_CALLER},${m_CurCalleeDN},${m_anm}))
	same => n, Set(m_anm=1)						; // already play anm
	same => n, Dial(SIP/${RDN}/${m_CurCalleeDN},${NoAnswerTime}, S(180) | M(psn_answer))	; // RingTimeOut=30/90, 180초 통화

	same => n, Noop(DIALSTATUS=[${DIALSTATUS}])
	same => n, Set(m_RecSave=0)					; // m_RecSave status 0=not_record,1=SUCC, 2=FAIL
	same => n, GotoIf($["${DIALSTATUS}" = "BUSY"]?PCCO_2nd_call)
	same => n, GotoIf($["${DIALSTATUS}" = "NOANSWER"]?PCCO_2nd_call)
	same => n, GotoIf($["${DIALSTATUS}" = "CHANUNAVAIL"]?PCCO_2nd_call)
	same => n, Playback(${wavDIR}/PSN_006)				; 전화 연결이 되지 않고 있습니다.
	same => n, Return(1)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCCO_2nd_call), Set(ErrCode=PCCO_2nd_call)

	same => n, GotoIf($[${LEN(${m_mdn})} = 0]?PCCO_stop_conn_owner)

	same => n, Set(m_CurCalleeDN=${m_mdn})
	same => n, Set(m_act=${m_mact})
	same => n, Set(m_mdn=)
	same => n, Set(m_mact=)
	same => n, GotoIf($[${m_act} != 1]?PCCO_stop_conn_owner)

	same => n, Set(m_RecSave=0)			; // m_RecSave status 0=not_record,1=SUCC, 2=FAIL
;	same => n, GoSub(psn_StopMonitor,s,1())

	same => n, Set(NoAnswerTime=${m_SndNoAnswerTO})
	same => n, Goto(PCCO_connect_call)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCCO_stop_conn_owner), Set(ErrCode=PCCO_stop_conn_owner)
	same => n, Playback(${wavDIR}/PSN_002)		; 차주와 전화 연결이 되지 않고 있습니다. 잠시 후에 다시 연결하세요.
	same => n, Hangup()

	same => n(PCCO_unable_conn_call), Set(ErrCode=PCCO_unable_conn_call)
	same => n, Playback(${wavDIR}/PSN_004)		; 죄송합니다. 차주에게 전화를 연결할 수 없습니다. 
	same => n, Hangup()

	same => n(PCCO_svc_unavail), Set(ErrCode=PCCO_svc_unavail)
	same => n, Playback(${comDIR}/COMM_004)		; 서비스 준비중입니다. 다음에 이용해 주세요.
	same => n, Hangup()


exten => h, 1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_CarOwnertoCallSvc/Hangup ERR=[${ErrorCode} ${ErrCode}] DIALSTATUS=[${DIALSTATUS}] )
	same => n, ExecIf($["${DIALSTATUS}" != "ANSWER"]?Set(m_RecSave=0)
	same => n, GoSub(psn_StopMonitor,s,1())
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_TopMenu                                                                    *
;   주차 안심 번호 서비스 ARS의 최상위 메뉴 안내                                 *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_TopMenu]

exten => s,1,Noop(psn_TopMenu from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; // ErrCode
	same => n, Set(LOCAL(countWRONG)=0)
	same => n, Set(LOCAL(SELNUM)=)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PTM_recvDgt), Set(ErrCode=PTM_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_010,1,n,3,5)		; 마지막 차량 호출자 연결은 1번.
	                                                 		; 내 정보 설정은 2번.
	                                                 		; 부가 서비스는 3번.
	                                                 		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PTM_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "*"]?PTM_wrong)
	same => n, GotoIf($[${SELNUM} = 0]?PTM_recvDgt)
	same => n, GotoIf($[${SELNUM} < 4]?PTM_succ)

	same => n(PTM_wrong), Set(ErrCode=PTM_wrong)
	same => n, Playback(${comDIR}/COMM_010)				; 잘못 눌렀습니다.
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIf($[${countWRONG} < 3]?:PTM_fail)
	same => n, Goto(PTM_recvDgt)

	same => n(PTM_not_enter), Set(ErrCode=PTM_not_enter)
	same => n, Playback(${comDIR}/COMM_011)				; 입력된 정보가 없습니다.
	same => n, Goto(PTM_fail)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PTM_succ), Return(${SELNUM})
	same => n(PTM_fail), Return(0)


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_TopMenu/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_AdditionalSvcMenu                                                          *
;   부가 서비스 메뉴 안내                                                        *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_AdditionalSvcMenu]

exten => s,1,Noop(psn_TopMenu from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; // ErrCode
	same => n, Set(LOCAL(countWRONG)=0)
	same => n, Set(LOCAL(SELNUM)=)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PASM_recvDgt), Set(ErrCode=PASM_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_011_2,1,n,3,5)		; 대리운전은 1번.
	                                                 		; 보험사 안내는 2번.
	                                                 		; 보이는ARS는 3번.
	                                                 		; 이전 단계는 별표.
	                                                 		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PASM_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "*"]?PASM_prev)
	same => n, GotoIf($[${SELNUM} = 0]?PASM_recvDgt)
	same => n, GotoIf($[${SELNUM} < 4]?PASM_succ)

	same => n(PASM_wrong), Set(ErrCode=PASM_wrong)
	same => n, Playback(${comDIR}/COMM_010)				; 잘못 눌렀습니다.
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIf($[${countWRONG} < 3]?:PASM_fail)
	same => n, Goto(PASM_recvDgt)

	same => n(PASM_not_enter), Set(ErrCode=PASM_not_enter)
	same => n, Playback(${comDIR}/COMM_011)				; 입력된 정보가 없습니다.
	same => n, Goto(PASM_fail)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PASM_succ), Return(${SELNUM})
	same => n(PASM_fail), Return(0)
	same => n(PASM_prev), Return(4)


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_AdditionalSvcMenu/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_ChaufeurSvcMenu                                                            *
;   대리운전 콜센터 연결 서비스 ARS 안내 메뉴                                    *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_ChaufeurSvcMenu]

exten => s,1,Noop(psn_ChaufeurSvcMenu from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; // ErrCode

	same => n, Set(LOCAL(countWRONG)=0)
	same => n, Set(LOCAL(SELNUM)=)
	same => n, Set(LOCAL(UserType)=)
	same => n, Set(LOCAL(svcType)=1)				; // 1=user,2=system
	same => n, Set(LOCAL(menuType)=)

	; ----------------------------------------
	; 권한 : 주번호, 부번호 사용자만 이용 가능   
	; ----------------------------------------
	same => n, GoSub(psn_GetUserAuth,s,1(${ErrCode}))
	same => n, Set(UserType=${GOSUB_RETVAL})
	same => n, GotoIf($[${UserType} = 0]?PCSM_stop)
	same => n, GotoIf($[${UserType} = 1]?PCSM_stop)
	same => n, Goto(PCSM_check_chauff)

	same => n(PCSM_stop), Playback(${wavDIR}/PSN_026)		; 고객님은 이 서비스를 이용할 수 없습니다.
	same => n, Goto(PCSM_prev)

	; ----------------------------------------
	; 대리운전 초기 안내                                   
	; ----------------------------------------
	same => n(PCSM_check_chauff), Set(ErrCode=PCSM_check_chauff)
	same => n, GotoIf($[${LEN(${m_Chauffeur})} > 0]?phone_info)
	same => n, Set(svcType=2)					; // 1=user,2=system
	same => n, Playback(${wavDIR}/PSN_114)				; 등록된 정보가 없습니다.
	same => n, Goto(PCSM_get_phonenumber)

	same => n(phone_info), Playback(${wavDIR}/PSN_078)		; 현재 등록된 대리운전 전화번호는
	same => n, SayDigits(${m_Chauffeur})				; xxx-xxxx-xxxx
	same => n, Playback(${comDIR}/COMM_022)				; 입니다.

	; ----------------------------------------
	; 서비스 안내                                  
	; ----------------------------------------
	same => n(PCSM_menu_1), Set(menuType=1)
	same => n, Set(countWRONG=0)

	same => n(PCSM_recvDgt), Set(ErrCode=PCSM_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_013,1,n,3,5)		; 통화 연결은 1번.
	                                                 		; 연결 번호 설정은 2번.
	                                                 		; 이전 단계는 별표.
	                                                 		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PCSM_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "*"]?PCSM_prev)
	same => n, GotoIf($[${SELNUM} = 0]?PCSM_recvDgt)
	same => n, GotoIf($[${SELNUM} = 1]?PCSM_succ)
	same => n, GotoIf($[${SELNUM} = 2]?PCSM_get_phonenumber)

	same => n(PCSM_wrong), Set(ErrCode=PCSM_wrong)
	same => n, Playback(${comDIR}/COMM_010)				; 잘못 눌렀습니다.
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIf($[${countWRONG} < 3]?:PCSM_fail)
	same => n, GotoIf($[${menuType} = 1]?PCSM_recvDgt)
	same => n, GotoIf($[${menuType} = 2]?PCSM_recvDgt2)

	same => n(PCSM_not_enter), Set(ErrCode=PCSM_not_enter)
	same => n, Playback(${comDIR}/COMM_011)				; 입력된 정보가 없습니다.
	same => n, Goto(PCSM_fail)

	; ----------------------------------------
	; 대리운전 번호 입력                              
	; ----------------------------------------
	same => n(PCSM_get_phonenumber), Set(ErrCode=PCSM_get_phonenumber)
	same => n, Read(SELNUM,${wavDIR}/PSN_092,1,n,,0.1)		; 고객님께서 자주 이용하시는 
	                                                		; 대리운전 콜센터 전화 번호를 입력하세요.

	same => n, Set(m_CallType=3)					; // 3=대리운전, 4=보험사
	same => n, GoSub(psn_EnterPhoneNumber,s,1(${ErrCode},${m_CallType}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, Set(m_CallNumber=${m_EnterPhoneNumber})

	same => n, GotoIf($[${rValue} = 0]?PCSM_chkb)			; // 입력 취소
	same => n, GotoIf($[${rValue} = 1]?PCSM_chka)			; // succ
	same => n, GotoIf($[${rValue} = 2]?PCSM_fail)			; // fail
	same => n, GotoIf($[${rValue} = 3]?PCSM_prev)			; // 이전단계

	same => n(PCSM_chka), Goto(PCSM_reg_chauf)
	same => n(PCSM_chkb), GotoIf($[${svcType} = 1]?PCSM_menu_1:PCSM_fail)
	same => n(PCSM_chkc), GotoIf($[${svcType} = 1]?PCSM_menu_1:PCSM_prev)

	; ----------------------------------------
	; 정보 등록 안내
	; ----------------------------------------
	same => n(PCSM_reg_chauf), Set(menuType=2)
	same => n, Set(countWRONG=0)

	same => n(PCSM_recvDgt2), Set(ErrCode=PCSM_recvDgt2)
	same => n, Read(SELNUM,${wavDIR}/PSN_015,1,n,3,5)		; 등록 후 연결은 1번.  
	                                                 		; 등록없이 연결은 2번.
	                                                 		; 등록만 3번.
	                                                 		; 이전 단계는 별표.
	                                                 		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PCSM_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "*"]?PCSM_chkc)		; //
	same => n, GotoIf($[${SELNUM} = 0]?PCSM_recvDgt2)
	same => n, GotoIf($[${SELNUM} = 1]?PCSM_reg_conn)
	same => n, GotoIf($[${SELNUM} = 2]?PCSM_onlyconn)
	same => n, GotoIf($[${SELNUM} = 3]?PCSM_only_reg)
	same => n, Goto(PCSM_wrong)

	same => n(PCSM_reg_conn), Set(ErrCode=PCSM_reg_conn)
	same => n, Goto(p2)
	same => n(PCSM_only_reg), Set(ErrCode=PCSM_only_reg)
	same => n, Goto(p2)
	same => n(PCSM_onlyconn), Set(ErrCode=PCSM_onlyconn)
	same => n, Set(m_Chauffeur=${m_CallNumber})
	same => n, Goto(PCSM_succ)

	same => n(p2), Set(m_Chauffeur=${m_CallNumber})
	same => n, Set(m_CallType=3)				; // 3=대리운전, 4=보험사
	same => n, GoSub(psn_AgiSaveAddSvcPhoneNumber,s,1(${ErrCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},${rValue}))
	same => n, GotoIf($[${ErrCode} = PCSM_reg_conn]?PCSM_succ:PCSM_prev)
	same => n, Goto(PCSM_prev)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCSM_fail), Return(0)					; // 종료
	same => n(PCSM_succ), Return(1)					; // 통화 연결
	same => n(PCSM_prev), Return(2)					; // 이전 단계


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_ChaufeurSvcMenu/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_InsuranceSvcMenu                                                           *
;   자동차 보험사 콜센터 연결 서비스 ARS 안내 메뉴                               *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_InsuranceSvcMenu]

exten => s,1,Noop(psn_InsuranceSvcMenu from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; // ErrCode

	same => n(PISM_init), Set(ErrCode=PISM_init)
	same => n, Set(LOCAL(countWRONG)=0)
	same => n, Set(LOCAL(FN)=)
	same => n, Set(LOCAL(menuType)=)
	same => n, Set(LOCAL(UserType)=)
	same => n, Set(LOCAL(svcType)=1)				; // 1=user,2=system
	same => n, Set(LOCAL(SelCompId)=1)				; // 삼성화재부터 시작 (AGI파일 참조)

	; ----------------------------------------
	; 권한 : 주번호, 부번호 사용자만 이용 가능   
	; ----------------------------------------
	same => n, GoSub(psn_GetUserAuth,s,1(${ErrCode}))
	same => n, Set(UserType=${GOSUB_RETVAL})
	same => n, GotoIf($[${UserType} = 0]?PISM_stop)
	same => n, GotoIf($[${UserType} = 1]?PISM_stop)
	same => n, Goto(PISM_check_insurance)

	same => n(PISM_stop), Playback(${wavDIR}/PSN_026)		; 고객님은 이 서비스를 이용할 수 없습니다.
	same => n, Goto(PISM_prev)

	; ----------------------------------------
	; 자동차 보험사 초기 안내                           
	; ----------------------------------------
	same => n(PISM_check_insurance), Set(ErrCode=PISM_check_insurance)
	same => n, GotoIf($[${LEN(${m_Insurance})} > 0]?phone_info)
	same => n, Set(svcType=2)					; // 1=user,2=system
	same => n, Playback(${wavDIR}/PSN_114)				; 등록된 정보가 없습니다.
	same => n, Goto(PISM_guide_ins)

	same => n(phone_info), Set(m_InsCallCent=${m_Insurance})
	same => n, GoSub(psn_AgiGetInsCompanyInform,s,1(${ErrCode},1))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, Set(FN=${SPRINTF(${wavDIR}/PSN_$[160+${m_InsCompId}])})
	same => n, ExecIf($[${rValue} != 1111]?Set(FN=))

	same => n, Playback(${wavDIR}/PSN_079_1)				; 현재 등록된 자동차 보험사는
	same => n, ExecIf($[${LEN(${FN})} = 0]?SayDigits(${m_Insurance}))	; xxx-xxxx-xxxx 
	same => n, ExecIf($[${LEN(${FN})} > 0]?Playback(${FN}))			; // 자동차 보험사 명칭
	same => n, Playback(${comDIR}/COMM_022)					; 입니다.


	; ----------------------------------------
	; 보험사 서비스 안내                           
	; ----------------------------------------
	same => n(PISM_menu_1), Set(menuType=1)
	same => n, Set(countWRONG=0)

	same => n(PISM_recvDgt), Set(ErrCode=PISM_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_013_2,1,n,3,5)		; 연결은 1번.
	                                                 		; 설정은 2번.
	                                                 		; 이전 단계는 별표.
	                                                 		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PISM_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "*"]?PISM_prev)
	same => n, GotoIf($[${SELNUM} = 0]?PISM_recvDgt)
	same => n, GotoIf($[${SELNUM} = 1]?PISM_succ)
	same => n, GotoIf($[${SELNUM} = 2]?PISM_guide_ins)

	same => n(PISM_wrong), Set(ErrCode=PISM_wrong)
	same => n, Playback(${comDIR}/COMM_010)				; 잘못 눌렀습니다.
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIf($[${countWRONG} < 3]?:PISM_fail)
	same => n, GotoIf($[${menuType} = 1]?PISM_recvDgt)
	same => n, GotoIf($[${menuType} = 2]?PISM_recvDgt2)
	same => n, GotoIf($[${menuType} = 3]?PISM_recvDgt3)
	same => n, GotoIf($[${menuType} = 4]?PISM_recvDgt4)

	same => n(PISM_not_enter), Set(ErrCode=PISM_not_enter)
	same => n, Playback(${comDIR}/COMM_011)				; 입력된 정보가 없습니다.
	same => n, Goto(PISM_fail)


	; ----------------------------------------
	; 자동차 보험사 선택 안내 메뉴-1          
	; ----------------------------------------
	same => n(PISM_guide_ins), Set(menuType=2)
	same => n, Set(m_MaxInsCompId=0)
	same => n, GoSub(psn_AgiGetInsCompanyInform,s,1(${ErrCode},3))	; // m_MaxInsComId 조회
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, ExecIf($[${rValue} != 1111]?Set(m_MaxInsCompId=0))

	same => n, Set(countWRONG=0)
	same => n, Set(SelCompId=1)
	same => n, Playback(${wavDIR}/PSN_160)				; 자동차 보험사 안내입니다.

	same => n(PISM_recvDgt2), Set(ErrCode=PISM_recvDgt2)
	same => n, Set(FN=${SPRINTF(${wavDIR}/PSN_$[160+${SelCompId}])})

	same => n, Read(SELNUM,${FN}&${wavDIR}/PSN_014_1,1,n,3,3)	; **손해보험 이면 1번. 아니면 2번
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PISM_comp_next)	; // 미입력 --> 다음 보험사 안내
	same => n, GotoIf($["${SELNUM}" = "*"]?PISM_chkc)
	same => n, GotoIf($[${SELNUM} = 2]?PISM_comp_next)
	same => n, GotoIf($[${SELNUM} = 1]?PISM_comp_sel)
	same => n, GotoIf($[${SELNUM} = 0]?PISM_comp_prev)
	same => n, Goto(PISM_wrong)

	same => n(PISM_comp_prev), Set(ErrCode=PISM_comp_prev)
	same => n, Set(SelCompId=$[${SelCompId}-1])
	same => n, ExecIf($[${SelCompId} = 0]?Set(SelCompId=${m_MaxInsCompId}))
	same => n, Goto(PISM_recvDgt2)

	same => n(PISM_comp_next), Set(ErrCode=PISM_comp_next)
	same => n, Set(SelCompId=$[${SelCompId}+1])
	same => n, GotoIf($[${SelCompId} > ${m_MaxInsCompId}]?n12)
	same => n, Goto(PISM_recvDgt2)
	same => n(n12), Set(SelCompId=${m_MaxInsCompId})
	same => n, Goto(PISM_guide2_ins)

	same => n(PISM_comp_sel), Set(ErrCode=PISM_comp_sel)
	same => n, Set(m_InsCompId=${SelCompId})
	same => n, GoSub(psn_AgiGetInsCompanyInform,s,1(${ErrCode},2))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GotoIf($[${rValue} != 1111]?PISM_comp_fail)
	same => n, Set(m_CallNumber=${m_InsCallCent})
	same => n, Goto(PISM_chka)

	same => n(PISM_comp_fail),Set(ErrCode=PISM_comp_fail)
	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},8888))		; 외부장치와 접속이 원할하지 않아......
	same => n, Goto(PISM_fail)


	; ----------------------------------------
	; 자동차 보험사 선택 안내 메뉴-2          
	; ----------------------------------------
	same => n(PISM_guide2_ins), Set(menuType=3)
	same => n, Set(countWRONG=0)

	same => n(PISM_recvDgt3), Set(ErrCode=PISM_recvDgt3)
	same => n, Read(SELNUM,${wavDIR}/PSN_014_2,1,n,3,5)		; 보험사 다시 안내는 1번.
	                                                 		; 안내 메뉴에 가입 보험사가 없으면 2번.
	                                                 		; 이전 단계는 별표.
	                                                 		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PISM_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "*"]?PISM_chkc)
	same => n, GotoIf($[${SELNUM} = 0]?PISM_recvDgt3)
	same => n, GotoIf($[${SELNUM} = 1]?PISM_guide_ins)
	same => n, GotoIf($[${SELNUM} = 2]?PISM_get_phonenumber)
	same => n, Goto(PISM_wrong)

	; ----------------------------------------
	; 보험사 전화번호 직접 입력                          
	; ----------------------------------------
	same => n(PISM_get_phonenumber), Set(ErrCode=PISM_get_phonenumber)
	same => n, Read(SELNUM,${wavDIR}/PSN_090,1,n,,0.1); 죄송합니다. 
	                                                  ; 안내 메뉴에서 자동차 보험사가 조회되지 않고 있습니다. 
	                                                  ; 고객님께서 보험사 전화 번호를 직접 입력하여 사용하여야 합니다.
	                                                  ; 해당 서비스 메뉴로 이동하겠습니다.
	same => n, Wait(1)
	same => n, Set(m_CallType=4)					; // 3=대리운전, 4=보험사
	same => n, GoSub(psn_EnterPhoneNumber,s,1(${ErrCode},${m_CallType}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, Set(m_CallNumber=${m_EnterPhoneNumber})

	same => n, GotoIf($[${rValue} = 0]?PISM_chkb)			; // 입력 취소
	same => n, GotoIf($[${rValue} = 1]?PISM_chka)			; // succ
	same => n, GotoIf($[${rValue} = 2]?PISM_fail)			; // fail
	same => n, GotoIf($[${rValue} = 3]?PISM_guide_ins)		; // 이전단계

	same => n(PISM_chka), Goto(PISM_reg_ins)
	same => n(PISM_chkb), GotoIf($[${svcType} = 1]?PISM_guide_ins:PISM_fail)
	same => n(PISM_chkc), GotoIf($[${svcType} = 1]?PISM_menu_1:PISM_prev)

	; ----------------------------------------
	; 정보 등록 안내                                    
	; ----------------------------------------
	same => n(PISM_reg_ins), Set(menuType=4)
	same => n, Set(countWRONG=0)

	same => n(PISM_recvDgt4), Set(ErrCode=PISM_recvDgt4)
	same => n, Read(SELNUM,${wavDIR}/PSN_015,1,n,3,5)		; 등록 후 연결은 1번.  
	                                                 		; 등록없이 연결은 2번.
	                                                 		; 등록만 3번.
	                                                 		; 이전 단계는 별표.
	                                                 		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PISM_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "*"]?PISM_guide_ins)		; // 
	same => n, GotoIf($[${SELNUM} = 0]?PISM_recvDgt4)
	same => n, GotoIf($[${SELNUM} = 1]?PISM_reg_conn)
	same => n, GotoIf($[${SELNUM} = 2]?PISM_onlyconn)
	same => n, GotoIf($[${SELNUM} = 3]?PISM_only_reg)
	same => n, Goto(PISM_wrong)

	same => n(PISM_reg_conn), Set(ErrCode=PISM_reg_conn)
	same => n, Goto(p2)
	same => n(PISM_only_reg), Set(ErrCode=PISM_only_reg)
	same => n, Goto(p2)
	same => n(PISM_onlyconn), Set(ErrCode=PISM_onlyconn)
	same => n, Set(m_Insurance=${m_CallNumber})
	same => n, Goto(PISM_succ)

	same => n(p2), Set(m_Insurance=${m_CallNumber})
	same => n, Set(m_CallType=4)					; // 3=대리운전, 4=보험사
	same => n, GoSub(psn_AgiSaveAddSvcPhoneNumber,s,1(${ErrCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},${rValue}))
	same => n, GotoIf($[${ErrCode} = PISM_reg_conn]?PISM_succ:PISM_prev)
	same => n, Goto(PISM_prev)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PISM_succ), Return(1)					; // 통화연결
	same => n(PISM_prev), Return(2)					; // 이전 메뉴
	same => n(PISM_fail), Return(3)					; // 종료


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_InsuranceSvcMenu/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_InformSetMenu                                                              *
;   주차 안심 번호 서비스 메인 메뉴 안내방송                                     *
;   1) input  : none                                                             *
;   2) output :                                                                  *
;      - SELNUM : 1 ~ 8                                                          *
;                                                                                *
; ********************************************************************************

[psn_InformSetMenu]

exten => s,1,Noop(psn_InformSetMenu from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=${ARG1})		; // ErrCode
	same => n, Set(LOCAL(countWRONG)=0)
	same => n, Set(LOCAL(SELNUM)=)
	same => n, Set(LOCAL(UserType)=)
	same => n, Set(LOCAL(FN)=)
	same => n, Set(LOCAL(menuType)=1)		; // 1="서비스 일시 정지" 항목 포함, 2=제외

	same => n, GoSub(psn_GetUserAuth,s,1(${ErrCode}))
	same => n, Set(UserType=${GOSUB_RETVAL})
	same => n, GotoIf($[${UserType} = 0]?PISM_fail)

	same => n, GotoIf($[${menuType} = 2]?PISM_M2)

	same => n(PISM_M1), Set(FN=PSN_030_0)
	same => n, ExecIf($[${UserType} = 2]?Set(FN=PSN_030_1))		; // "착신 번호 등록" 항목 제외
	same => n, ExecIf($[${UserType} = 3]?Set(FN=PSN_030_1))		; // "착신 번호 등록" 항목 제외
	same => n, ExecIf($[${UserType} =23]?Set(FN=PSN_030_1))		; // "착신 번호 등록" 항목 제외
	same => n, Goto(PISM_recvDgt)

	same => n(PISM_M2), Set(FN=PSN_030_2)				; // "서비스일시정지" 항목 제외
	same => n, ExecIf($[${UserType} = 2]?Set(FN=PSN_030_3))		; // "착신 번호 등록" 항목 제외
	same => n, ExecIf($[${UserType} = 3]?Set(FN=PSN_030_3))		; // "착신 번호 등록" 항목 제외
	same => n, ExecIf($[${UserType} =23]?Set(FN=PSN_030_3))		; // "착신 번호 등록" 항목 제외
	same => n, Goto(PISM_recvDgt)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PISM_recvDgt), Set(ErrCode=PISM_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/${FN},1,n,3,5)			; 착신 번호 확인은 1번.  
	                                                        	; (착신 번호 등록은 2번.)
	                                                        	; 착신 번호 변경은 3번.
	                                                        	; 착신 번호 삭제는 4번.
	                                                        	; 호출 우선 순위 설정은 5번.
	                                                        	; (서비스 일시 정지는 6번.)
	                                                        	; 이전 단계는 별표.
	                                                        	; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PISM_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "*"]?PISM_chk_prev)
	same => n, GotoIf($[${SELNUM} = 0]?PISM_recvDgt)
	same => n, GotoIf($[${SELNUM} < 7]?PISM_chk_selnum)

	same => n(PISM_wrong), Set(ErrCode=PISM_wrong)
	same => n, Playback(${comDIR}/COMM_010)				; 잘못 눌렀습니다.
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIf($[${countWRONG} < 3]?:PISM_fail)
	same => n, Goto(PISM_recvDgt)

	same => n(PISM_not_enter), Set(ErrCode=PISM_not_enter)
	same => n, Playback(${comDIR}/COMM_011)				; 입력된 정보가 없습니다.
	same => n, Goto(PISM_fail)

	same => n(PISM_chk_prev), Set(ErrCode=PISM_chk_prev)
	same => n, ExecIf($[${UserType} = 1]?Playback(${wavDIR}/PSN_026))	; 고객님은 이 서비스를 이용할 수 없습니다.
	same => n, GotoIf($[${UserType} = 1]?PISM_fail)
	same => n, Goto(PISM_prev)

	same => n(PISM_chk_selnum), Set(ErrCode=PISM_chk_selnum)
	same => n, GotoIf($[${FN} = PSN_030_0]?PISM_succ)
	same => n, GotoIf($[${FN} = PSN_030_1]?PISM_P1)
	same => n, GotoIf($[${FN} = PSN_030_2]?PISM_P2)
	same => n, GotoIf($[${FN} = PSN_030_3]?PISM_P3)

	same => n(PISM_P1), GotoIf($[${SELNUM} = 2]?PISM_wrong)
	same => n, Goto(PISM_succ)

	same => n(PISM_P2), GotoIf($[${SELNUM} = 6]?PISM_wrong)
	same => n, Goto(PISM_succ)

	same => n(PISM_P3), GotoIf($[${SELNUM} = 2]?PISM_wrong)
	same => n, GotoIf($[${SELNUM} = 6]?PISM_wrong)
	same => n, Goto(PISM_succ)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PISM_succ), Return(${SELNUM})
	same => n(PISM_fail), Return(0)
	same => n(PISM_prev), Return(7)


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_InformSetMenu/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_RegInform                                                                  *
;   서비스 신청자가 호출시 착신되길 원하는 전화번호를 등록                       *
;   1) input  : none                                                             *
;   2) output :                                                                  *
;      - m_CallType                                                              *
;      - m_CallNumber                                                            *
;      - m_ActSts                                                                *
;                                                                                *
; ********************************************************************************

[psn_RegInform]

exten => s, 1, Noop(psn_RegInform from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=psn_reg_inform)
	same => n, Set(LOCAL(UserType)=)
	same => n, Set(LOCAL(countREG)=0)		; // 0=not_all_reg, 1=all_reg

	; ----------------------------------------
	; 권한 : 신청자만 가능                            
	; ----------------------------------------
	same => n, GoSub(psn_GetUserAuth,s,1(${ErrCode}))
	same => n, Set(UserType=${GOSUB_RETVAL})
	same => n, GotoIf($[${UserType} = 1]?PREG_init)
	same => n, GotoIf($[${UserType} = 12]?PREG_init)
	same => n, GotoIf($[${UserType} = 13]?PREG_init)
	same => n, GotoIf($[${UserType} = 123]?PREG_init)

	same => n, Playback(${wavDIR}/PSN_020)			; 주차안심번호 서비스 등록은 서비스 신청자만 할 수 있습니다.
	same => n, Goto(PREG_prev)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PREG_init), Set(ErrCode=PREG_init)

	same => n, ExecIf($[${m_SvcPayedSts} = 0]?Playback(${wavDIR}/PSN_027))	; 고객님께서 신청하신 안심 번호는 결재가 되어 있지 않습니다.

	same => n, Set(LOCAL(countNOENT)=0)
	same => n, Set(LOCAL(countWRONG)=0)
	same => n, Set(LOCAL(SELNUM)=)
	same => n, Set(LOCAL(menuType)=1)

	same => n, GotoIf($[${LEN(${m_PDN})} = 0]?PREG_recvDgt)		; // 미등록
	same => n, GotoIf($[${LEN(${m_MDN})} = 0]?PREG_recvDgt)		; // 미등록
	same => n, Playback(${wavDIR}/PSN_076)				; 주번호와 부번호는 모두 등록 상태입니다.
	same => n, Goto(PREG_pchk)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PREG_recvDgt), Set(ErrCode=PREG_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_031,1,n,3,5)		; 고객님의 전화 번호를
	                                                		; 주번호로 등록하시려면 1번.
	                                                		; 부번호로 등록하시려면 2번. 
	                                                		; 착신 번호를 입력하여 등록하려면 3번.
	                                                		; 이전 단계는 별표. 
	                                                		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PREG_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "0"]?PREG_recvDgt)
	same => n, GotoIf($["${SELNUM}" = "1"]?PREG_pnumber)
	same => n, GotoIf($["${SELNUM}" = "2"]?PREG_snumber)
	same => n, GotoIf($["${SELNUM}" = "3"]?PREG_input)
	same => n, GotoIf($["${SELNUM}" = "*"]?PREG_prev)

	same => n(PREG_wrong_dgt), Set(ErrCode=PREG_wrong_dgt)
	same => n, Playback(${comDIR}/COMM_010)				; 잘못 눌렀습니다.
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIf($[${countWRONG} < 3]?:PREG_fail)
	same => n, GotoIf($[${menuType} = 1]?PREG_recvDgt:PREG_rcvDgt)

	same => n(PREG_not_enter), Set(ErrCode=PREG_not_enter)
	same => n, Playback(${comDIR}/COMM_011)				; 입력된 정보가 없습니다.
	same => n, Set(countNOENT=$[${countNOENT}+3])
	same => n, GotoIf($[${countNOENT} < 3]?:PREG_fail)
	same => n, GotoIf($[${menuType} = 1]?PREG_recvDgt:PREG_rcvDgt)

	same => n(PREG_pnumber), Set(ErrCode=PREG_pnumber)
	same => n, GotoIf($[${LEN(${m_PDN})} > 0]?PREG_anm_reg)		; // 등록

	same => n, Set(m_CallType=1)
	same => n, Set(m_CallNumber=${m_CALLER})
	same => n, Set(m_ActSts=1)
	same => n, Goto(PREG_agi_save)

	same => n(PREG_snumber), Set(ErrCode=PREG_snumber)
	same => n, GotoIf($[${LEN(${m_MDN})} > 0]?PREG_anm_reg)		; // 등록

	same => n, Set(m_CallType=2)
	same => n, Set(m_CallNumber=${m_CALLER})
	same => n, Set(m_ActSts=1)
	same => n, Goto(PREG_agi_save)

	same => n(PREG_anm_reg), Set(ErrCode=PREG_anm_reg)
	same => n, Playback(${wavDIR}/PSN_113)				; 등록된 정보가 있습니다.
	same => n, Playback(${wavDIR}/PSN_118)				; 미등록 상태에서만 등록할 수 있습니다.
;	same => n, Playback(${wavDIR}/PSN_119)				; 먼저 등록된 정보를 삭제한 다음에, 등록하셔야 합니다.
	same => n, GotoIf($[${menuType} = 1]?PREG_recvDgt:PREG_rcvDgt)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PREG_input), Set(ErrCode=PREG_input)
	same => n, Set(countNOENT=0)
	same => n, Set(countWRONG=0)
	same => n, Set(SELNUM=)
	same => n, Set(menuType=2)

	same => n(PREG_rcvDgt), Set(ErrCode=PREG_rcvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_032,1,n,3,5)		; 주번호 등록은 1번. 
	                                                		; 부번호 등록은 2번.
	                                                		; 이전 단계는 별표.
	                                                		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PREG_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "0"]?PREG_rcvDgt)
	same => n, GotoIf($["${SELNUM}" = "1"]?PREG_pn)
	same => n, GotoIf($["${SELNUM}" = "2"]?PREG_sn)
	same => n, GotoIf($["${SELNUM}" = "*"]?PREG_init)
	same => n, Goto(PREG_wrong_dgt)

	same => n(PREG_pn), Set(ErrCode=PREG_pn)
	same => n, GotoIf($[${LEN(${m_PDN})} > 0]?PREG_anm_reg)		; // 등록

	same => n, Set(m_CallType=1)
	same => n, Set(m_ActSts=1)
	same => n, Goto(PREG_get_phonenumber)

	same => n(PREG_sn), Set(ErrCode=PREG_sn)
	same => n, GotoIf($[${LEN(${m_MDN})} > 0]?PREG_anm_reg)		; // 등록

	same => n, Set(m_CallType=2)
	same => n, Set(m_ActSts=1)
	same => n, Goto(PREG_get_phonenumber)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PREG_get_phonenumber), Set(ErrCode=PREG_get_phonenumber)
	same => n, GoSub(psn_EnterPhoneNumber,s,1(${ErrCode},${m_CallType}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, Set(m_CallNumber=${m_EnterPhoneNumber})

	same => n, GotoIf($[${rValue} = 0]?PREG_input)		; // 입력취소
	same => n, GotoIf($[${rValue} = 1]?PREG_agi_save)	; // succ
	same => n, GotoIf($[${rValue} = 2]?PREG_fail)		; // fail
	same => n, GotoIf($[${rValue} = 3]?PREG_input)		; // 이전단계

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PREG_agi_save), Set(ErrCode=PREG_agi_save)
	same => n, GoSub(psn_AgiSaveCallNumber,s,1(${ErrCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})

	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},${rValue}))

	same => n, GotoIf($[${rValue} = 2100]?PREG_pchk)	; // OK
	same => n, GotoIf($[${rValue} = 2101]?PREG_fail)	; // fail
	same => n, GotoIf($[${rValue} = 2102]?PREG_pchk)	; // already(등록된 번호와 동일한 번호로 저장시도)
	same => n, GotoIf($[${rValue} = 2103]?PREG_pchk)	; // already(등록된 번호 있음)
	same => n, Goto(PREG_fail)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PREG_pchk), Set(ErrCode=PREG_pchk)
	same => n, GotoIf($[${m_SvcPayedSts} = 1]?PREG_succ)	; // 결제상태 확인

	same => n, Gosub(psn_ReloadPsnInform,s,1(${ErrCode}))

	same => n, Set(countREG=0)
	same => n, ExecIf($[${LEN(${m_PDN})} > 0]?Set(countREG=$[${countREG}+1]))
	same => n, ExecIf($[${LEN(${m_MDN})} > 0]?Set(countREG=$[${countREG}+1]))

	same => n, GotoIf($[${countREG} < 2]?PREG_init)		; // 착신번호 모두 등록할 때까지 계속
	same => n, Playback(${wavDIR}/PSN_076)			; 주번호와 부번호는 모두 등록 상태입니다.
	same => n, Playback(${wavDIR}/PSN_028)			; 결재가 되어 있지 않아, 서비스를 받을 수 없습니다.
	same => n, Goto(PREG_fail)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PREG_succ), Return(0)		; // 정상 수행
	same => n(PREG_prev), Return(0)		; // 이전 단계
	same => n(PREG_fail), Return(2) 	; // 멘트없이 종료


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_RegInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_EnterPhoneNumber                                                           *
;   전화 번호 입력                                                               *
;   1) input  : none                                                             *
;   2) output :                                                                  *
;      - m_EnterPhoneNumber                                                      *
;                                                                                *
; ********************************************************************************

[psn_EnterPhoneNumber]

exten => s,1,Noop(psn_EnterPhoneNumber from [${ARG1}/${ARG2}] )

	same => n, Set(LOCAL(ErrCode)=${ARG1})				; // ErrCode
	same => n, Set(LOCAL(CallType)=${ARG2})				; // CallType

	same => n(PEPN_init), Set(ErrCode=PEPN_init)
	same => n, Set(LOCAL(countSHORT)=0)
	same => n, Set(LOCAL(countNOENT)=0)
	same => n, Set(LOCAL(countWRONG)=0)
	same => n, Set(LOCAL(SELNUM)=)
	same => n, Set(LOCAL(menuType)=1)
	same => n, Set(LOCAL(FN)=PSN_064)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PEPN_recvDgt), Set(ErrCode=PEPN_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_033,13,n,3,5)		; 입력 가능한 전화 번호는 최대 12자리 입니다. 
	                                                  		; 착신하고자 하는 번호를 입력하세요.
	                                                  		; 번호 입력이 완료되면, 샾 버튼을 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PEPN_not_enter)	; // 미입력
	same => n, GotoIf($[${LEN(${SELNUM})} < 4]?PEPN_short_dgt)	; // 자릿수 오류

	same => n, Set(menuType=2)
	same => n, Set(m_EnterPhoneNumber=${SELNUM})
	same => n, Goto(PEPN_check_number)

	same => n(PEPN_wrong_dgt), Set(ErrCode=PEPN_wrong_dgt)
	same => n, Playback(${comDIR}/COMM_010)				; 잘못 눌렀습니다.
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIf($[${countWRONG} < 3]?:PEPN_fail)
	same => n, GotoIf($[${menuType} = 1]?PEPN_recvDgt:PEPN_rcvDgt)

	same => n(PEPN_not_enter), Set(ErrCode=PEPN_not_enter)
	same => n, Playback(${comDIR}/COMM_011)				; 입력된 정보가 없습니다.
	same => n, Set(countNOENT=$[${countNOENT}+3])
	same => n, GotoIf($[${countNOENT} < 3]?:PEPN_fail)
	same => n, GotoIf($[${menuType} = 1]?PEPN_recvDgt:PEPN_rcvDgt)

	same => n(PEPN_short_dgt), Set(ErrCode=PEPN_short_dgt)
	same => n, GotoIf($["${SELNUM:0:1}" = "*"]?PEPN_ndgt)

	same => n, Playback(${comDIR}/COMM_013)				; 입력 정보의 자릿수가 맞지 않습니다.
	same => n, Set(countSHORT=$[${countSHORT}+1])
	same => n, GotoIf($[${countSHORT} < 3]?:PEPN_fail)
	same => n, GotoIf($[${menuType} = 1]?PEPN_recvDgt:PEPN_rcvDgt)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PEPN_check_number), Set(ErrCode=PEPN_check_number)
	same => n, ExecIf($[${CallType} = 1]?Set(FN=PSN_064):Set(FN=PSN_065))

	same => n, Playback(${wavDIR}/PSN_060)					; 입력하신 전화 번호는
	same => n, SayDigits(${m_EnterPhoneNumber})				; xxx-yyyy-zzzz

	same => n, ExecIf($[${CallType} > 2]?Playback(${comDIR}/COMM_022))	; 입니다.
	same => n, ExecIf($[${CallType} < 3]?Playback(${comDIR}/COMM_024))	; 이고
	same => n, ExecIf($[${CallType} < 3]?Playback(${wavDIR}/${FN}))		; 주(부)번호 입니다.

	same => n(PEPN_rcvDgt), Set(ErrCode=PEPN_rcvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_034,1,n,3,5)			; 맞으면 1번. 
	                                                  			; 다시 입력은 2번.
	                                                  			; 이전 단계는 별표.
	                                                  			; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PEPN_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}" = "0"]?PEPN_check_number)
	same => n, GotoIf($["${SELNUM}" = "1"]?PEPN_succ)
	same => n, GotoIf($["${SELNUM}" = "2"]?PEPN_init)
	same => n, GotoIf($["${SELNUM}" = "*"]?PEPN_prev)
	same => n, Goto(PEPN_wrong_dgt)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PEPN_ndgt), Playback(${wavDIR}/PSN_068)			; // 전화 번호 입력을 취소하였습니다.
	same => n, Return(0)			; // 전화 번호 입력 취소

	same => n(PEPN_succ), Return(1)		; // succ
	same => n(PEPN_fail), Return(2)		; // fail
	same => n(PEPN_prev), Return(3)		; // 이전단계


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_EnterPhoneNumber/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_ChgInform                                                                  *
;   서비스 신청자/등록된 사용자가 등록된 착신번호를 삭제                         *
;   1) input  : none                                                             *
;   2) output :                                                                  *
;      - m_CallType                                                              *
;      - m_CallNumber                                                            *
;      - m_ActSts                                                                *
;                                                                                *
; ********************************************************************************

[psn_ChgInform]

exten => s, 1, Noop(psn_ChgInform from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=psn_chg_inform)
	same => n, Set(LOCAL(UserType)=)

	; ----------------------------------------
	; 권한 : 신청자 및 등록된 사용자만 가능   
	; ----------------------------------------
	same => n, GoSub(psn_GetUserAuth,s,1(${ErrCode}))
	same => n, Set(UserType=${GOSUB_RETVAL})
	same => n, GotoIf($[${UserType} != 0]?PCHG_init)

	same => n, Playback(${wavDIR}/PSN_021)			; 고객님은 호출 번호를 변경할 수 있는 권한이 없습니다.
	same => n, Goto(PCHG_prev)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCHG_init), Set(ErrCode=PCHG_init)

	same => n, Set(LOCAL(countNOENT)=0)
	same => n, Set(LOCAL(countWRONG)=0)
	same => n, Set(LOCAL(SELNUM)=)
	same => n, Set(LOCAL(menuType)=1)

	same => n, GotoIf($[${UserType} =  2]?PCHG_pnumber)
	same => n, GotoIf($[${UserType} =  3]?PCHG_snumber)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCHG_recvDgt), Set(ErrCode=PCHG_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_035,1,n,3,5)		; 주번호 변경은 1번.
	                                                		; 부번호 변경은 2번.
	                                                		; 이전 단계는 별표.
	                                                		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PCHG_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "0"]?PCHG_recvDgt)
	same => n, GotoIf($["${SELNUM}" = "1"]?PCHG_pnumber)
	same => n, GotoIf($["${SELNUM}" = "2"]?PCHG_snumber)
	same => n, GotoIf($["${SELNUM}" = "*"]?PCHG_prev)

	same => n(PCHG_wrong_dgt), Set(ErrCode=PCHG_wrong_dgt)
	same => n, Playback(${comDIR}/COMM_010)				; 잘못 눌렀습니다.
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIf($[${countWRONG} < 3]?:PCHG_fail)
	same => n, GotoIf($[${menuType} = 1]?PCHG_recvDgt:PCHG_rcvDgt)

	same => n(PCHG_not_enter), Set(ErrCode=PCHG_not_enter)
	same => n, Playback(${comDIR}/COMM_011)				; 입력된 정보가 없습니다.
	same => n, Set(countNOENT=$[${countNOENT}+3])
	same => n, GotoIf($[${countNOENT} < 3]?:PCHG_fail)
	same => n, GotoIf($[${menuType} = 1]?PCHG_recvDgt:PCHG_rcvDgt)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCHG_pnumber), Set(ErrCode=PCHG_pnumber)
	same => n, GotoIf($[${LEN(${m_PDN})} > 0]?pauth)		; // 등록
	same => n, Playback(${wavDIR}/PSN_115)				; 변경할 정보가 없습니다.
	same => n, Goto(PCHG_recvDgt)

	same => n(pauth), GotoIf($[${UserType} != 3]?pchg)		; // 사용자는 부번호
	same => n, Playback(${wavDIR}/PSN_116)				; 부번호 사용자는 주번호를 변경할 수 없습니다.
	same => n, Goto(PCHG_recvDgt)

	same => n(pchg), Set(m_CallType=1)
	same => n, Set(m_CallNumber=${m_PDN})
	same => n, Goto(PCHG_get_phonenumber)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCHG_snumber), Set(ErrCode=PCHG_snumber)
	same => n, GotoIf($[${LEN(${m_MDN})} > 0]?sauth)		; // 등록
	same => n, Playback(${wavDIR}/PSN_115)				; 변경할 정보가 없습니다.
	same => n, Goto(PCHG_recvDgt)

	same => n(sauth), GotoIf($[${UserType} != 2]?schg)		; // 사용자는 주번호
	same => n, Playback(${wavDIR}/PSN_117)				; 주번호 사용자는 부번호를 변경할 수 없습니다.
	same => n, Goto(PCHG_recvDgt)

	same => n(schg), Set(m_CallType=2)
	same => n, Set(m_CallNumber=${m_MDN})
	same => n, Goto(PCHG_get_phonenumber)

	; ----------------------------------------
	;
	; ----------------------------------------
	same => n(PCHG_get_phonenumber), Set(ErrCode=PCHG_get_phonenumber)
	same => n, GoSub(psn_CheckUserType,s,1(${ErrCode},${UserType}))
	same => n, GoSub(psn_EnterPhoneNumber,s,1(${ErrCode},${m_CallType}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, Set(m_CallNumber=${m_EnterPhoneNumber})

	same => n, GotoIf($[${rValue} = 0]?PCHG_prev)		; // 입력취소
	same => n, GotoIf($[${rValue} = 1]?PCHG_agi_save)	; // succ
	same => n, GotoIf($[${rValue} = 2]?PCHG_fail)		; // fail
	same => n, GotoIf($[${rValue} = 3]?PCHG_init)		; // 이전단계

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCHG_agi_save), Set(ErrCode=PCHG_agi_save)
	same => n, GoSub(psn_AgiSaveCallNumber,s,1(${ErrCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})

	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},${rValue}))

	same => n, GotoIf($[${rValue} = 2100]?PCHG_succ)	; // OK
	same => n, GotoIf($[${rValue} = 2101]?PCHG_fail)	; // fail
	same => n, GotoIf($[${rValue} = 2102]?PCHG_succ)	; // already(등록된 번호와 동일한 번호로 저장시도)
	same => n, GotoIf($[${rValue} = 2103]?PCHG_succ)	; // already(등록된 번호 있음)
	same => n, Goto(PCHG_fail)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCHG_prev), Return(0)		; // 이전 단계
	same => n(PCHG_succ), Return(0)		; // 정상 수행
	same => n(PCHG_fail), Return(2) 	; // 멘트없이 종료


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_ChgInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_DelInform                                                                  *
;   서비스 신청자/등록된 사용자가 등록된 착신번호를 삭제                         *
;   1) input  : none                                                             *
;   2) output :                                                                  *
;      - m_CallType                                                              *
;      - m_CallNumber                                                            *
;      - m_ActSts                                                                *
;                                                                                *
; ********************************************************************************

[psn_DelInform]

exten => s, 1, Noop(psn_DelInform from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=psn_del_inform)
	same => n, Set(LOCAL(UserType)=)

	; ----------------------------------------
	; 권한 : 신청자 및 등록된 사용자만 가능   
	; ----------------------------------------
	same => n, GoSub(psn_GetUserAuth,s,1(${ErrCode}))
	same => n, Set(UserType=${GOSUB_RETVAL})
	same => n, GotoIf($[${UserType} != 0]?PDEL_init)

	same => n, Playback(${wavDIR}/PSN_022)			; 고객님은 호출 번호를 삭제할 수 있는 권한이 없습니다.
	same => n, Goto(PDEL_prev)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PDEL_init), Set(ErrCode=PDEL_init)

	same => n, Set(LOCAL(countNOENT)=0)
	same => n, Set(LOCAL(countWRONG)=0)
	same => n, Set(LOCAL(SELNUM)=)
	same => n, Set(LOCAL(menuType)=1)
	same => n, Set(LOCAL(FN)=PSN_064)
	same => n, Set(LOCAL(uType)=1)	; // 1=주번호 사용자이거나 부번호 사용자인 경우, 2=그외

	same => n, GotoIf($[${UserType} =  2]?PDEL_pnumber)
	same => n, GotoIf($[${UserType} =  3]?PDEL_snumber)
	same => n, Set(uType=2)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PDEL_recvDgt), Set(ErrCode=PDEL_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_036,1,n,3,5)		; 주번호 삭제는 1번.
	                                                		; 부번호 삭제는 2번.
	                                                		; 이전 단계는 별표.
	                                                		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PDEL_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "0"]?PDEL_recvDgt)
	same => n, GotoIf($["${SELNUM}" = "1"]?PDEL_pnumber)
	same => n, GotoIf($["${SELNUM}" = "2"]?PDEL_snumber)
	same => n, GotoIf($["${SELNUM}" = "*"]?PDEL_prev)

	same => n(PDEL_wrong_dgt), Set(ErrCode=PDEL_wrong_dgt)
	same => n, Playback(${comDIR}/COMM_010)				; 잘못 눌렀습니다.
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIf($[${countWRONG} < 3]?:PDEL_fail)
	same => n, GotoIf($[${menuType} = 1]?PDEL_recvDgt:PDEL_rcvDgt)

	same => n(PDEL_not_enter), Set(ErrCode=PDEL_not_enter)
	same => n, Playback(${comDIR}/COMM_011)				; 입력된 정보가 없습니다.
	same => n, Set(countNOENT=$[${countNOENT}+3])
	same => n, GotoIf($[${countNOENT} < 3]?:PDEL_fail)
	same => n, GotoIf($[${menuType} = 1]?PDEL_recvDgt:PDEL_rcvDgt)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PDEL_pnumber), Set(ErrCode=PDEL_pnumber)
	same => n, GotoIf($[${LEN(${m_PDN})} > 0]?pauth)	; // 미등록
	same => n, Playback(${wavDIR}/PSN_080)			; 주번호는 미등록 상태입니다.
	same => n, Goto(PDEL_recvDgt)

	same => n(pauth), GotoIf($[${UserType} != 3]?pnext)	; // 사용자는 부번호
	same => n, Playback(${wavDIR}/PSN_123)			; 부번호 사용자는 주번호를 삭제할 수 없습니다.
	same => n, Goto(PDEL_recvDgt)

	same => n(pnext), Set(m_CallType=1)
	same => n, Set(m_CallNumber=${m_PDN})
	same => n, Goto(PDEL_input)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PDEL_snumber), Set(ErrCode=PDEL_snumber)
	same => n, GotoIf($[${LEN(${m_MDN})} > 0]?sauth)	; // 미등록
	same => n, Playback(${wavDIR}/PSN_081)			; 부번호는 미등록 상태입니다.
	same => n, Goto(PDEL_recvDgt)

	same => n(sauth), GotoIf($[${UserType} != 2]?snext)	; // 사용자는 주번호
	same => n, Playback(${wavDIR}/PSN_124)			; 주번호 사용자는 부번호를 삭제할 수 없습니다.
	same => n, Goto(PDEL_recvDgt)

	same => n(snext), Set(m_CallType=2)
	same => n, Set(m_CallNumber=${m_MDN})
	same => n, Goto(PDEL_input)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PDEL_input), Set(ErrCode=PDEL_input)
	same => n, Set(countNOENT=0)
	same => n, Set(countWRONG=0)
	same => n, Set(SELNUM=)
	same => n, Set(menuType=2)

	same => n, GosubIf($[${uType} = 1]?psn_CheckUserType,s,1(${ErrCode},${UserType}))
	same => n, Gotoif($[${uType} = 1]?PDEL_rcvDgt)

	same => n(PDEL_check_number), Set(ErrCode=PDEL_check_number)
	same => n, ExecIf($[${m_CallType} = 1]?Set(FN=PSN_064):Set(FN=PSN_065))

	same => n, Playback(${wavDIR}/PSN_061)				; 삭제할 전화 번호는
	same => n, SayDigits(${m_CallNumber})				; xxx-yyyy-zzzz
	same => n, Playback(${comDIR}/COMM_024)				; 이고
	same => n, Playback(${wavDIR}/${FN})				; 주(부)번호 입니다.

	same => n(PDEL_rcvDgt), Set(ErrCode=PDEL_rcvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_037,1,n,3,5)		; 삭제는 1번.
	                                                		; 이전 단계는 별표.
	                                                		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PDEL_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "0"]?PDEL_check_number)
	same => n, GotoIf($["${SELNUM}" = "1"]?PDEL_agi_delete)
	same => n, GotoIf($["${SELNUM}" = "*"]?PDEL_pre_check)
	same => n, Goto(PDEL_wrong_dgt)

	same => n(PDEL_pre_check), Set(ErrCode=PDEL_pre_check)
	same => n, Gotoif($[${uType} = 1]?PDEL_prev:PDEL_init)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PDEL_agi_delete), Set(ErrCode=PDEL_agi_delete)
	same => n, GoSub(psn_AgiDeleteCallNumber,s,1(${ErrCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})

	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},${rValue}))

	same => n, GotoIf($[${rValue} = 2200]?PDEL_succ)	; // OK
	same => n, GotoIf($[${rValue} = 2201]?PDEL_fail)	; // fail
	same => n, GotoIf($[${rValue} = 2202]?PDEL_succ)	; // already(이미 삭제한 경우, 미등록 상태)
	same => n, Goto(PDEL_fail)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PDEL_prev), Return(0)		; // 이전 단계
	same => n(PDEL_succ), Return(0)		; // 정상 수행
	same => n(PDEL_fail), Return(2) 	; // 멘트없이 종료


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_DelInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()






; ********************************************************************************
;                                                                                *
; psn_ActInform                                                                  *
;   서비스 신청자/등록된 사용자가 서비스 정지되어 있는 등록된 착신번호를         *
;   활성화 또는 비화성화(서비스 중지)                                            *
;   1) input  : none                                                             *
;   2) output :                                                                  *
;      - m_CallType                                                              *
;      - m_CallNumber                                                            *
;      - m_ActSts                                                                *
;                                                                                *
; ********************************************************************************

[psn_ActInform]

exten => s, 1, Noop(psn_ActInform from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=psn_act_inform)
	same => n, Set(LOCAL(FN)=PSN_023)
	same => n, Set(LOCAL(UserType)=)
	same => n, Set(LOCAL(ActType)=)

	; ----------------------------------------
	; 권한 : 신청자 및 등록된 사용자만 가능   
	; ----------------------------------------
	same => n, GoSub(psn_GetUserAuth,s,1(${ErrCode}))
	same => n, Set(UserType=${GOSUB_RETVAL})
	same => n, GotoIf($[${UserType} != 0]?PACT_init)
	same => n, Playback(${wavDIR}/PSN_023)				; 고객님은 호출 서비스를 활성화하거나 일시 정지 할 수 없습니다.
	same => n, Goto(PACT_prev)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PACT_init), Set(ErrCode=PACT_init)

	same => n, Set(LOCAL(countNOENT)=0)
	same => n, Set(LOCAL(countWRONG)=0)
	same => n, Set(LOCAL(SELNUM)=)
	same => n, Set(LOCAL(menuType)=1)
	same => n, Set(LOCAL(uType)=1)					; // 1=주번호 사용자이거나 부번호 사용자인 경우, 2=그외

	same => n, GotoIf($[${UserType} = 2]?PACT_pnumber)
	same => n, GotoIf($[${UserType} = 3]?PACT_snumber)
	same => n, Set(uType=2)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PACT_recvDgt), Set(ErrCode=PACT_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_038,1,n,3,5)		; 주번호는 1번.
	                                                		; 부번호는 2번.
	                                                		; 이전 단계는 별표.
	                                                		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PACT_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "0"]?PACT_recvDgt)
	same => n, GotoIf($["${SELNUM}" = "1"]?PACT_pnumber)
	same => n, GotoIf($["${SELNUM}" = "2"]?PACT_snumber)
	same => n, GotoIf($["${SELNUM}" = "*"]?PACT_prev)

	same => n(PACT_wrong_dgt), Set(ErrCode=PACT_wrong_dgt)
	same => n, Playback(${comDIR}/COMM_010)				; 잘못 눌렀습니다.
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIf($[${countWRONG} < 3]?:PACT_fail)
	same => n, GotoIf($[${menuType} = 1]?PACT_recvDgt:PACT_rcvDgt)

	same => n(PACT_not_enter), Set(ErrCode=PACT_not_enter)
	same => n, Playback(${comDIR}/COMM_011)				; 입력된 정보가 없습니다.
	same => n, Set(countNOENT=$[${countNOENT}+3])
	same => n, GotoIf($[${countNOENT} < 3]?:PACT_fail)
	same => n, GotoIf($[${menuType} = 1]?PACT_recvDgt:PACT_rcvDgt)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PACT_pnumber), Set(ErrCode=PACT_pnumber)
	same => n, Set(m_CallType=1)
	same => n, GotoIf($[${LEN(${m_PDN})} > 0]?pauth)		; // 미등록
	same => n, Playback(${wavDIR}/PSN_080)				; 주번호는 미등록 상태입니다.
	same => n, GotoIf($[${uType} = 1]?PACT_succ)
	same => n, Goto(PACT_recvDgt)

	same => n(pauth), GotoIf($[${UserType} != 3]?pnext)		; // 사용자는 부번호
	same => n, Goto(PACT_chk_auth)

	same => n(pnext), Set(m_CallNumber=${m_PDN})
	same => n, Set(m_ActSts=${m_PDNActSts})
	same => n, Goto(PACT_input)


	same => n(PACT_snumber), Set(ErrCode=PACT_snumber)
	same => n, Set(m_CallType=2)
	same => n, GotoIf($[${LEN(${m_MDN})} > 0]?sauth)		; // 미등록
	same => n, Playback(${wavDIR}/PSN_081)				; 부번호는 미등록 상태입니다.
	same => n, GotoIf($[${uType} = 1]?PACT_succ)
	same => n, Goto(PACT_recvDgt)

	same => n(sauth), GotoIf($[${UserType} != 2]?snext)		; // 사용자는 주번호
	same => n, Goto(PACT_chk_auth)


	same => n(snext), Set(m_CallNumber=${m_MDN})
	same => n, Set(m_ActSts=${m_MDNActSts})
	same => n, Goto(PACT_input)

	; ----------------------------------------
	;
	; ----------------------------------------
	same => n(PACT_input), Set(ErrCode=PACT_input)
	same => n, Set(countNOENT=0)
	same => n, Set(countWRONG=0)
	same => n, Set(SELNUM=)
	same => n, Set(menuType=2)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PACT_rcvDgt), Set(ErrCode=PACT_rcvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_039,1,n,3,5)		; 서비스 활성화는 1번.
	                                                		; 서비스 일시 정지는 2번.
	                                                		; 이전 단계는 별표.
	                                                		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PACT_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "0"]?PACT_rcvDgt)
	same => n, GotoIf($["${SELNUM}" = "1"]?PACT_check_act)
	same => n, GotoIf($["${SELNUM}" = "2"]?PACT_check_dact)
	same => n, GotoIf($["${SELNUM}" = "*"]?PACT_init)
	same => n, Goto(PACT_wrong_dgt)

	same => n(PACT_check_act), Set(ErrCode=PACT_check_act)
	same => n, Set(ActType=1)
	same => n, GotoIf($[${m_ActSts} = 1]?:PACT_check_number)
	same => n, ExecIf($[${m_CallType} = 1]?Playback(${wavDIR}/PSN_082))	; 주번호 호출 서비스는 활성화되어 있습니다.
	same => n, ExecIf($[${m_CallType} = 2]?Playback(${wavDIR}/PSN_083))	; 부번호 호출 서비스는 활성화되어 있습니다.
	same => n, Goto(PACT_input)

	same => n(PACT_check_dact), Set(ErrCode=PACT_check_dact)
	same => n, Set(ActType=2)
	same => n, GotoIf($[${m_ActSts} = 2}]?:PACT_check_number)
	same => n, ExecIf($[${m_CallType} = 1]?Playback(${wavDIR}/PSN_084))	; 주번호 호출서비스는 일시정지되어 있습니다.
	same => n, ExecIf($[${m_CallType} = 2]?Playback(${wavDIR}/PSN_085))	; 부번호 호출서비스는 일시정지되어 있습니다.
	same => n, Goto(PACT_input)


	same => n(PACT_check_number), Set(ErrCode=PACT_check_number)
	same => n, GotoIf($[${uType} = 1]?PACT_agi_change)
	same => n, ExecIf($[${ActType} = 1]?Set(FN=PSN_062):Set(FN=PSN_063))
	                                                          	; PSN_062=서비스를 활성화할 전화 번호는
	                                                          	; PSN_063=서비스를 일시 정지할 전화 번호는
	same => n, Playback(${wavDIR}/${FN})				; 서비스를 활성화할(일시 정지할) 전화 번호는
	same => n, SayDigits(${m_CallNumber})				; xxx-yyyy-zzzz
	same => n, Playback(${comDIR}/COMM_024)				; 이고
	same => n, ExecIf($[${m_CallType} = 1]?Set(FN=PSN_064):Set(FN=PSN_065))
	same => n, Playback(${wavDIR}/${FN})				; 주(부)번호 입니다.


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PACT_agi_change), Set(ErrCode=PACT_agi_change)
	same => n, ExecIf($[${ActType} = 1]?Set(m_ActSts=1))
	same => n, ExecIf($[${ActType} = 2]?Set(m_ActSts=2))
	same => n, GoSub(psn_AgiChangeActSts,s,1(${ErrCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})
	same => n, ExecIf($[$[${rValue} = 2300] && $[${ActType} = 2]]?Set(rValue=2304))
	same => n, ExecIf($[$[${rValue} = 2301] && $[${ActType} = 2]]?Set(rValue=2305))

	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},${rValue}))

	same => n, GotoIf($[${rValue} = 2300]?PACT_succ)	; // OK
	same => n, GotoIf($[${rValue} = 2301]?PACT_fail)	; // fail
	same => n, GotoIf($[${rValue} = 2302]?PACT_succ)	; // already(등록된 번호와 동일한 번호로 저장시도)
	same => n, GotoIf($[${rValue} = 2303]?PACT_succ)	; // already(등록된 번호 있음)
	same => n, GotoIf($[${rValue} = 2304]?PACT_succ)	; // OK : 서비스 중지 성공
	same => n, GotoIf($[${rValue} = 2305]?PACT_fail)	; // fail : 서비스 중지 실패
	same => n, Goto(PACT_fail)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PACT_prev), Return(0)		; // 이전 단계
	same => n(PACT_succ), Return(0)		; // 정상 수행
	same => n(PACT_fail), Return(2) 	; // 멘트없이 종료


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_ActInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_ChkInform                                                                  *
;   서비스 신청자/등록된 사용자가 등록된 착신번호 정보를 확인                    *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_ChkInform]

exten => s, 1, Noop(psn_ChkInform from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=psn_chk_inform)
	same => n, Set(LOCAL(UserType)=)
	same => n, Set(LOCAL(countNOENT)=0)

	; ----------------------------------------
	; 권한 : 신청자 및 등록된 사용자만 이용 가능   
	; ----------------------------------------
	same => n, GoSub(psn_GetUserAuth,s,1(${ErrCode}))
	same => n, Set(UserType=${GOSUB_RETVAL})
	same => n, GotoIf($[${UserType} != 0]?PCHK_init)

	same => n, Playback(${wavDIR}/PSN_026)				; 고객님은 이 서비스를 이용할 수 없습니다.
	same => n, Goto(PCHK_prev)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCHK_init), Set(ErrCode=PCHK_init)

	same => n, Set(LOCAL(SELNUM)=)
	same => n, Set(LOCAL(FN)=PSN_064)
	same => n, Set(LOCAL(CallPriority)=0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCHK_pnumber), Set(ErrCode=PCHK_pnumber)
	same => n, GoSub(psn_CheckUserType,s,1(${ErrCode},${UserType}))

	same => n, Set(m_CallType=1)
	same => n, Set(m_CallNumber=${m_PDN})
	same => n, Set(m_ActSts=${m_PDNActSts})
	same => n, ExecIf($[${m_CallPriority} = 1]?Set(CallPriority=1):Set(CallPriority=2))
	same => n, Goto(PCHK_check_status)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCHK_snumber), Set(ErrCode=PCHK_snumber)
	same => n, Set(m_CallType=2)
	same => n, Set(m_CallNumber=${m_MDN})
	same => n, Set(m_ActSts=${m_MDNActSts})
	same => n, ExecIf($[${m_CallPriority} = 1]?Set(CallPriority=2):Set(CallPriority=1))
	same => n, Goto(PCHK_check_status)

	same => n(PCHK_check_status), Set(ErrCode=PCHK_check_status)
	same => n, GotoIf($[${LEN(${m_CallNumber})} = 0]?PCHK_not_reg_sts)
	same => n, Goto(PCHK_anm_inform)

	same => n(PCHK_not_reg_sts), Set(ErrCode=PCHK_not_reg_sts)
	same => n, ExecIf($[${m_CallType} = 1]?Playback(${wavDIR}/PSN_080)	; 주번호는 미등록 상태입니다.
	same => n, ExecIf($[${m_CallType} = 2]?Playback(${wavDIR}/PSN_081)	; 부번호는 미등록 상태입니다.
	same => n, GotoIf($[${m_CallType} = 1]?PCHK_snumber)
	same => n, Goto(PCHK_retry)

	; ----------------------------------------
	;
	; ----------------------------------------
	same => n(PCHK_anm_inform), Set(ErrCode=PCHK_anm_inform)
	same => n, ExecIf($[${m_CallType} = 1]?Set(FN=PSN_066):Set(FN=PSN_067))
	same => n, Playback(${wavDIR}/${FN})					; 주(부)전화 번호는
	same => n, SayDigits(${m_CallNumber})					; xxx-yyyy-zzzz
	same => n, Playback(${comDIR}/COMM_024)					; 이고,

	same => n, ExecIf($[${CallPriority} = 1]?Playback(${wavDIR}/PSN_052))	; 호출 우선 순위는 1차 호출 번호이고,
	same => n, ExecIf($[${CallPriority} = 2]?Playback(${wavDIR}/PSN_053))	; 호출 우선 순위는 2차 호출 번호이고,

	same => n, ExecIf($[${m_ActSts} = 1]?Playback(${wavDIR}/PSN_054))	; 서비스는 활성화되어 있습니다.
	same => n, ExecIf($[${m_ActSts} = 2]?Playback(${wavDIR}/PSN_055))	; 서비스는 일시 정지되어 있습니다.
	same => n, GotoIf($[${m_CallType} = 1]?PCHK_snumber)


	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCHK_retry), Set(ErrCode=PCHK_retry)
	same => n, Read(SELNUM,${wavDIR}/PSN_043,1,n,1,3)			; 다시 듣기는 0번.이전 단계는 별표를 누르세요.

	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PCHK_not_enter)		; // 미입력
	same => n, GotoIf($["${SELNUM}" = "0"]?PCHK_pnumber)
	same => n, GotoIf($["${SELNUM}" = "*"]?PCHK_prev)
	same => n, Goto(PCHK_init)

	same => n(PCHK_not_enter), Set(ErrCode=PCHK_not_enter)
	same => n, Set(countNOENT=$[${countNOENT}+1])
	same => n, GotoIf($[${countNOENT} < 3]?:PCHK_prev)
	same => n, Goto(PCHK_init)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCHK_prev), Return(0)		; // 이전 단계
	same => n(PCHK_succ), Return(0)		; // 정상 수행
	same => n(PCHK_fail), Return(2) 	; // 멘트없이 종료


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_ChkInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_ChgPriority                                                                *
;   서비스 신청자/등록된 사용자가 착신번호 호출 우선 순위 변경                   *
;   1) input  : none                                                             *
;   2) output :                                                                  *
;      - m_CallType                                                              *
;      - m_CallNumber                                                            *
;      - m_ActSts                                                                *
;                                                                                *
; ********************************************************************************

[psn_ChgPriority]

exten => s, 1, Noop(psn_ChgPriority from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=psn_chg_priority)
	same => n, Set(LOCAL(UserType)=)

	; ----------------------------------------
	; 권한 : 신청자 및 등록된 사용자만 가능   
	; ----------------------------------------
	same => n, GoSub(psn_GetUserAuth,s,1(${ErrCode}))
	same => n, Set(UserType=${GOSUB_RETVAL})
	same => n, GotoIf($[${UserType} != 0]?PCPR_init)

	same => n, Playback(${wavDIR}/PSN_025)			; 고객님은 호출 우선 순위를 변경할 수 없습니다.
	same => n, Goto(PCPR_prev)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCPR_init), Set(ErrCode=PCPR_init)

	same => n, Set(LOCAL(countNOENT)=0)
	same => n, Set(LOCAL(countWRONG)=0)
	same => n, Set(LOCAL(SELNUM)=)
	same => n, Set(LOCAL(menuType)=1)
	same => n, Set(LOCAL(FN)=PSN_064)

	same => n, GotoIf($[$[${LEN(${m_PDN})} = 0] & $[${LEN(${m_MDN})} = 0]]?PCPR_all_notreg)
	same => n, GotoIf($[$[${LEN(${m_PDN})} > 0] & $[${LEN(${m_MDN})} = 0]]?PCPR_mdn_notreg)
	same => n, GotoIf($[$[${LEN(${m_PDN})} = 0] & $[${LEN(${m_MDN})} > 0]]?PCPR_pdn_notreg)
	same => n, Goto(PCPR_anm)


	same => n(PCPR_all_notreg), Playback(${wavDIR}/PSN_077)		; 주번호와 부번호는 모두 미등록 상태입니다.
	same => n, Goto(PCPR_prev)
	same => n(PCPR_pdn_notreg), Playback(${wavDIR}/PSN_080)		; 주번호는 미등록 상태입니다.
	same => n, Goto(PCPR_prev)
	same => n(PCPR_mdn_notreg), Playback(${wavDIR}/PSN_081)		; 부번호는 미등록 상태입니다.
	same => n, Goto(PCPR_prev)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCPR_anm), Set(ErrCode=PCPR_anm)
	same => n, ExecIf($[${m_CallPriority} = 1]?Set(m_CallNumber=${m_PDN}):Set(m_CallNumber=${m_MDN})
	same => n, ExecIf($[${m_CallPriority} = 1]?Set(FN=PSN_069):Set(FN=PSN_070))

	same => n, Playback(${wavDIR}/${FN})				; 1차 호출 번호는 주(부)번호이고, 전화 번호는
	same => n, SayDigits(${m_CallNumber})				; xxx-yyyy-zzzz
	same => n, Playback(${comDIR}/COMM_022)				; 입니다.

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCPR_recvDgt), Set(ErrCode=PCPR_recvDgt)
	same => n, Read(SELNUM,${wavDIR}/PSN_044,1,n,3,5)		; 1차 호출 우선 순위를 
	                                                		; 주번호로 하려면 1번.
	                                                		; 부번호로 하려면 2번.
	                                                		; 이전 단계는 별표.
	                                                		; 다시 듣기는 0번을 누르세요.
	same => n, GotoIf($[${LEN(${SELNUM})} = 0]?PCPR_not_enter)	; // 미입력
	same => n, GotoIf($["${SELNUM}" = "0"]?PCPR_anm)
	same => n, GotoIf($["${SELNUM}" = "1"]?PCPR_pnumber)
	same => n, GotoIf($["${SELNUM}" = "2"]?PCPR_snumber)
	same => n, GotoIf($["${SELNUM}" = "*"]?PCPR_prev)

	same => n(PCPR_wrong_dgt), Set(ErrCode=PCPR_wrong_dgt)
	same => n, Playback(${comDIR}/COMM_010)				; 잘못 눌렀습니다.
	same => n, Set(countWRONG=$[${countWRONG}+1])
	same => n, GotoIf($[${countWRONG} < 3]?:PCPR_fail)
	same => n, Goto(PCPR_recvDgt)

	same => n(PCPR_not_enter), Set(ErrCode=PCPR_not_enter)
	same => n, Playback(${comDIR}/COMM_011)				; 입력된 정보가 없습니다.
	same => n, Set(countNOENT=$[${countNOENT}+3])
	same => n, GotoIf($[${countNOENT} < 3]?:PCPR_fail)
	same => n, Goto(PCPR_recvDgt)


	same => n(PCPR_already), ExecIf($[${ErrCode} = PCPR_pnumber]?Set(FN=PSN_143):Set(FN=PSN_144))
	same => n, Playback(${wavDIR}/${FN})				; 현재 1차 호출 우선순위는 주(부)번호로 되어 있습니다.
	same => n, Goto(PCPR_recvDgt)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCPR_pnumber), Set(ErrCode=PCPR_pnumber)
	same => n, GotoIf($[${m_CallPriority} = 1]?PCPR_already)
	same => n, Set(m_CallPriority=1)
	same => n, Set(m_CallNumber=${m_PDN})
	same => n, Goto(PCPR_agi_change)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCPR_snumber), Set(ErrCode=PCPR_snumber)
	same => n, GotoIf($[${m_CallPriority} = 2]?PCPR_already)
	same => n, Set(m_CallPriority=2)
	same => n, Set(m_CallNumber=${m_MDN})
	same => n, Goto(PCPR_agi_change)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCPR_agi_change), Set(ErrCode=PCPR_agi_change)
	same => n, GoSub(psn_AgiChangePriority,s,1(${ErrCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})

	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},${rValue}))

	same => n, GotoIf($[${rValue} = 2400]?PCPR_succ)	; // OK
	same => n, GotoIf($[${rValue} = 2401]?PCPR_fail)	; // fail
	same => n, GotoIf($[${rValue} = 2402]?PCPR_succ)	; // already(현재 설정되어 있는 값과 동일한 경우)
	same => n, Goto(PCPR_fail)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCPR_prev), Return(0)		; // 이전 단계
	same => n(PCPR_succ), Return(0)		; // 정상 수행
	same => n(PCPR_fail), Return(2)		; // 멘트없이 종료


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_ChgPriority/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_ConnLastCaller                                                             *
;   차주가 최근 24시간내에 마지막으로 호출을 시도했던 가입자와 연결 시도         *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************
[macro-last_answer]
exten => s, 1, Noop(macro-last_answer=[${ARG1}/${ARG2}/${ARG3}])
	same => n, Set(recFileName=${ARG1})

	same => n, MixMonitor(${recFileName},p)
	same => n, Playback(psn/PSN_091)	; 보다 나은 주차 안심 번호 서비스를 제공하기 위하여 통화 내용은 녹음됩니다. 
	                                	; 동의하지 않으면, 통화를 끊어 주시기 바랍니다.

[psn_ConnLastCaller]

exten => s, 1, Noop(psn_ConnLastCaller from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=psn_conn_caller)
	same => n, Set(LOCAL(UserType)=)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GoSub(psn_GetUserAuth,s,1(${ErrCode}))
	same => n, Set(UserType=${GOSUB_RETVAL})
	same => n, GotoIf($[$[${UserType} = 0] | $[${UserType} = 1]]?:PCC_check_nocall)		;//주(부)번호등록자 아닌경우

	same => n(PCC_anm), Playback(${wavDIR}/PSN_026)			; 고객님은 이 서비스를 이용할 수 없습니다.
	same => n, Goto(PCC_prev)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCC_check_nocall), Set(ErrCode=PCC_check_nocall)

	same => n, GotoIf($[${LEN(${m_LastCaller})} = 0]?:PCC_try_lastcall)
	same => n(PCC_none_call), Playback(${wavDIR}/PSN_005)		; 최근 24시간내에 호출받은 정보가 없습니다.
	same => n, Goto(PCC_prev)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCC_try_lastcall), Set(ErrCode=PCC_try_lastcall)
;	same => n, GoSub(psn_GetLastCallHistory,s,1(${ErrCode}))
;	same => n, Set(rValue=${GOSUB_RETVAL})
;	same => n, ExecIf($[${rValue} = 1]?Set(m_MyDN=${m_0507_Inform}))

	same => n, Set(CALLERID(num)=${m_MyDN})
	same => n, Set(CALLERID(name)=${m_MyDN})
	same => n, GoSub(psn_MixMonitor,s,1(${ErrCode},2,${m_CALLER},${m_LastCaller},2))
	same => n, Dial(SIP/${RDN}/${m_LastCaller},90,S(180) | M(last_answer,${recFileName}))	; // RingTimeOut=90초, 통화시간=180초
	same => n, Noop(== DIALSTATUS=[${DIALSTATUS}])
	same => n, Set(m_RecSave=0)					; // m_RecSave status 0=not_record,1=SUCC, 2=FAIL

	same => n, Playback(${wavDIR}/PSN_006)				; 전화 연결이 되지 않고 있습니다.
	same => n, Goto(PCC_succ)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCC_prev), Return(0)		; // 이전 단계
	same => n(PCC_succ), Return(1)		; // GoodBye 멘트후 종료
	same => n(PCC_fail), Return(2)		; // 멘트없이 종료


exten => h, 1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_ConnLastCaller/Hangup ERR=[${ErrorCode} ${ErrCode}] DIALSTATUS=[${DIALSTATUS}] )
	same => n, ExecIf($["${DIALSTATUS}" != "ANSWER"]?Set(m_RecSave=0)
	same => n, GoSub(psn_StopMonitor,s,1())
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_ConnAddSvcPhoneNumber                                                      *
;   대리 운전/자동차보험사 통화 연결 서비스                                      *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_ConnAddSvcPhoneNumber]

exten => s, 1, Noop(psn_ConnAddSvcPhoneNumber from [${ARG1}] )

	same => n, Set(LOCAL(ErrCode)=psn_conn_etcnumber)
	same => n, Set(LOCAL(EtcType)=${ARG2})		; // 3=대리운전, 4=보험사
	same => n, Set(LOCAL(EtcNumber)=${ARG3})	; // 대리운전/보험사 전화번호
	same => n, Set(LOCAL(UserType)=)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GoSub(psn_GetUserAuth,s,1(${ErrCode}))
	same => n, Set(UserType=${GOSUB_RETVAL})
	same => n, GotoIf($[${UserType} = 0]?anm)			; // 정의되지 않음 가입자
	same => n, GotoIf($[${UserType} = 1]?:PCCF_check_nocall)	; // 주(부)가입자로 등록되지 않은 신청자

	same => n(PCCF_anm), Playback(${wavDIR}/PSN_026)		; 고객님은 이 서비스를 이용할 수 없습니다.
	same => n, Goto(PCCF_prev)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCCF_check_nocall), Set(ErrCode=PCCF_check_nocall)

	same => n, GotoIf($[${LEN(${EtcNumber})} = 0]?:PCCF_try_call)
	same => n(PCCF_none_call), Playback(${wavDIR}/PSN_114)		; 등록된 정보가 없습니다.
	same => n, Goto(PCCF_prev)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCCF_try_call), Set(ErrCode=PCCF_try_call)
	same => n, GoSub(psn_MixMonitor,s,1(${ErrCode},3,${m_CALLER},${EtcNumber},3))
	same => n, Dial(SIP/${RDN}/${EtcNumber},,S(180))			; // 180초 통화
	same => n, Noop(== DIALSTATUS=[${DIALSTATUS}])

	same => n, Set(m_RecSave=0)					; // m_RecSave status 0=not_record,1=SUCC, 2=FAIL

	same => n, Playback(${wavDIR}/PSN_006)				; 전화 연결이 되지 않고 있습니다.
	same => n, Goto(PCCF_succ)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCCF_prev), Return(0)		; // 이전 단계
	same => n(PCCF_succ), Return(1)		; // GoodBye 멘트후 종료
	same => n(PCCF_fail), Return(2)		; // 멘트없이 종료


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_ConnAddSvcPhoneNumber/Hangup ERR=[${ErrorCode} ${ErrCode}] DIALSTATUS=[${DIALSTATUS}] )
	same => n, ExecIf($["${DIALSTATUS}" != "ANSWER"]?Set(m_RecSave=0)
	same => n, GoSub(psn_StopMonitor,s,1())
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_CheckUserType                                                              *
;   사용자 구분 정보를 음성으로 통지                                             *
;   1) input  : UserType                                                         *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_CheckUserType]

exten => s, 1, Set(LOCAL(ErrCode)=${ARG1})
	same => n, Set(LOCAL(UserType)=${ARG2})	

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n, GotoIf($[${UserType} =  1]?PCUT_1)
	same => n, GotoIf($[${UserType} =  2]?PCUT_2)
	same => n, GotoIf($[${UserType} =  3]?PCUT_3)
	same => n, GotoIf($[${UserType} = 12]?PCUT_2)
	same => n, GotoIf($[${UserType} = 13]?PCUT_3)
	same => n, GotoIf($[${UserType} = 23}]?PCUT_4)
	same => n, GotoIf($[${UserType} =123}]?PCUT_4)
	same => n, Goto(PCUT_0)

	; ----------------------------------------
	;                                         
	; ----------------------------------------
	same => n(PCUT_1), Playback(${wavDIR}/PSN_057)		; 고객님은 서비스 신청자입니다.
	same => n, Return

	same => n(PCUT_2), Playback(${wavDIR}/PSN_050)		; 고객님은 주번호 사용자입니다.
	same => n, Return

	same => n(PCUT_3), Playback(${wavDIR}/PSN_051)		; 고객님은 부번호 사용자입니다.
	same => n, Return

	same => n(PCUT_4), Playback(${wavDIR}/PSN_056)		; 고객님은 주번호와 부번호 동시 사용자입니다.
	same => n, Return

	same => n(PCUT_0), Return

exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_CheckUserType/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_MixMonitor                                                                 *
;   녹취 정보 설정 및 녹취 시작                                                  *
;   1) input  : CallerDN, CalleeDN                                               *
;   2) output : recFileName                                                      *
;                                                                                *
; ********************************************************************************

[psn_MixMonitor]
exten => s, 1, Set(LOCAL(ErrCode)=${ARG1})
	same => n, Set(LOCAL(CallType)=${ARG2})
	same => n, Set(LOCAL(CALLER)=${ARG3})
	same => n, Set(LOCAL(CALLEE)=${ARG4})
	same => n, Set(LOCAL(recAnm)=${ARG5})
	same => n, Set(LOCAL(record_data_Dir)=)
	same => n, Set(m_RecSave=1)			; // m_RecSave status 0=not_record,1=SUCC, 2=FAIL
	same => n, Set(RESULT=)

	same => n, GotoIf($[${recAnm} = 1]?rec_b)	; // second call

	same => n, GoSub(psn_AgiGetUserCode,s,1(${ErrCode}))

	same => n, Set(mp3FileName=${CALLER}-${CALLEE}_${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}.mp3)
	same => n, Set(recFileName=${CALLER}-${CALLEE}_${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}.wav)
	same => n, Set(savFileName=${mp3FileName})

	same => n, GotoIf($[${recAnm} = 0]?rec_a)
	same => n, GotoIf($[${recAnm} = 1]?rec_b)
	same => n, GotoIf($[${recAnm} = 2]?rec_d:rec_c)

	same => n(rec_a), MixMonitor(${recFileName})

	same => n, Set(F1=${SPRINTF(PSN_007_${m_CustomInfo})})
	same => n, ExecIf($[${m_CustomInfo} = 5]?Playback(${wavDIR}/PSN_LOGO_7))
	same => n, Playback(${wavDIR}/${F1})	; (바로) 주차안심번호 서비스입니다.
	same => n, Playback(${wavDIR}/PSN_091)	; 보다 나은 주차 안심 번호 서비스를 제공하기 위하여 통화 내용은 녹음됩니다. 
	                                      	; 동의하지 않으면, 통화를 끊어 주시기 바랍니다.
	same => n, Wait(1)
	same => n, Playback(${wavDIR}/PSN_008)	; 잠시만 기다리시면 차주에게 연결됩니다.
	same => n, StopMixMonitor()
	same => n, MixMonitor(${recFileName},pab)

	same => n, Return()

	same => n(rec_b), MixMonitor(${recFileName},ab)
	same => n, Return()

	same => n(rec_c), MixMonitor(${recFileName},pb)
	same => n, Return()

	same => n(rec_d), return()

exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_MixMonitor/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Set(m_RecSave=0)			; // m_RecSave status 0=not_record,1=SUCC, 2=FAIL
	same => n, GoSub(psn_StopMonitor,s,1())
	same => n, GosubIf($[${m_Seize_0507} = 1]?psn_AgiRelease_0507,s,1(${ErrorCode}))
	same => n, Hangup()




; ********************************************************************************
;                                                                                *
; psn_StopMonitor                                                                *
;   녹취를 중단 및 녹취 파일 특정 위치로 이동 저장                               *
;   1) input  : m_RecSave                                                        *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_StopMonitor]
exten => s, 1, StopMixMonitor()
	same => n, Set(LOCAL(wavFileName)=${MIXMONITOR_FILENAME})
	same => n, Set(LOCAL(FileSize)=${STAT(s,${wavFileName})})
	same => n, ExecIf($[${FileSize} = 0]?Set(wavFileName=${recPath}/${recFileName})
	same => n, GotoIf($[${LEN(${m_RecSave})} = 0]?end)
	same => n, GotoIf($[${m_RecSave} = 0]?end)

	same => n, Set(LOCAL(saveFileName)=${wavFileName})

	; ----------------------------------------
	; wav --> mp3로 변환                         
	; ----------------------------------------
	same => n, System(/usr/bin/lame -h -b 128 ${saveFileName} ${recPath}/${mp3FileName})
	same => n, Set(FileSize=${STAT(s,${recPath}/${mp3FileName})})

	same => n, Set(saveFileName=${recPath}/${mp3FileName})

	; ----------------------------------------
	; 녹취 파일 저장 기본 위치 확인                          
	; ----------------------------------------
	same => n, Set(PathDir=/var/spool/asterisk/monitor/RECHDD)
	same => n, Set(record_data_Dir=${STAT(d,${PathDir}/record_data)})
	same => n, GotoIf($[${record_data_Dir} = 0]?local)    			; directory 없으면 EMGHDD에 저장

	; ----------------------------------------
	; 개인별 저장 폴더 생성                               
	; ----------------------------------------
	same => n, System(${agiPath}/psn_norm_recdir.sh  ${PathDir} record_data ${USERCODE} ${m_CALLEE} ${m_0507_Number})
	same => n, Log(NOTICE, psn_MixMonitor SYSTEMSTATUS=${SYSTEMSTATUS})
	same => n, GotoIf($["${SYSTEMSTATUS}" != "SUCCESS"]?local)		; directory 없으면 EMGHDD에 저장

	; ----------------------------------------
	; 녹취 파일 저장 위치로 이동                            
	; ----------------------------------------
	same => n, System(mv ${saveFileName} ${PathDir}/record_data/${USERCODE}/${m_CALLEE}/${m_0507_Number}/.)
	same => n, GotoIf($["${SYSTEMSTATUS}" != "SUCCESS"]?local)
	same => n, GoSub(psn_AgiSaveRecFile,s,1(StopMonitor_remote_hdd))
	same => n, Goto(end)

	; ----------------------------------------
	; 녹취 파일 저장 : EMGHDD에 임시 저장                   
	; ----------------------------------------
	same => n(local), System(${agiPath}/psn_emer_recdir.sh ${recPath} ${emgDIR} ${USERCODE} ${m_0507_Number})
	same => n, System(mv ${saveFileName} ${recPath}/${emgDIR}/${USERCODE}/${m_0507_Number}/.)
	same => n, GoSub(psn_AgiSaveRecFile,s,1(StopMonitor_local_hdd))

	; ----------------------------------------
	; 녹취되지 않은 경우 삭제                              
	; ----------------------------------------
	same => n(end), Set(FileSize=${STAT(s,${wavFileName})})
	same => n, ExecIf($[${FileSize} > 0]?System(/bin/rm ${wavFileName}))
	same => n, Return

[psn_0922_anm]
exten => _X., 1, Noop(psn_0922_anm from [${EXTEN} / ${CALLERID(ANI)}] )
	same => n, Playback(psn/PSN_009)				; (바로) 주차안심번호 서비스입니다.
	same => n, Hangup()

exten => h,1, Log(NOTICE,PSN [${CALLERID(ANI)} psn_0922_anm/Hangup )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_GetQRInform                                                                *
;   0507번호와 발신번호로 DB에 저장한 QR 정보를 검색                             *
;   1) input  : 발신번호, m_0507_Number                                          *
;   2) output : m_QR_Inform                                                      *
;                                                                                *
; ********************************************************************************

[psn_GetQRInform]
exten => s, 1, Set(LOCAL(ErrCode)=${ARG1})

	same => n, GoSub(psn_AgiGetQRInform,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})

	same => n, GotoIf($[${rValue} = 2600]?PGQI_agi_succ)	; // OK
	same => n, GotoIf($[${rValue} = 2601]?PGQI_agi_fail)	; // fail
	same => n, GotoIf($[${rValue} = 2602]?PGQI_agi_fail)	; // fail
	same => n, GotoIf($[${rValue} = 2603]?PGQI_agi_fail)	; // fail
	same => n, Goto(PGQI_agi_fail)

	; ----------------------------------------
	;
	; ----------------------------------------
	same => n(PGQI_agi_succ), Set(ErrCode=PGQI_agi_succ)
	same => n, GotoIf($[${LEN(${m_QR_Inform})} > 0]?PGQI_1)
	same => n, Set(rValue=2604)

	same => n(PGQI_agi_fail), Set(ErrCode=PGQI_agi_fail)
	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},${rValue}))
	same => n, Goto(PGQI_0)

	; ----------------------------------------
	;
	; ----------------------------------------
	same => n(PGQI_1), Return(1)	; // OK - 메인 메뉴 이동
	same => n(PGQI_0), Return(0)	; // Fail - 종료


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_GetQRInform/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_Seize_0507                                                                 *
;   0507 번호를 사용하기 위한 허가요청                                           *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_Seize_0507]
exten => s, 1, Noop(psn_Seize_0507 from [${ARG1}/${ARG2}] )
	same => n, Set(LOCAL(ErrCode)=${ARG1})
	same => n, Set(LOCAL(ExecSts)=${ARG2})
	same => n, Set(LOCAL(retval)=9999)

	same => n, GotoIf($[${ExecSts} = 0]?PALC_0)
	same => n, GotoIf($["${m_MyPsnType}" != "QR_PSN"]?PALC_1)

	same => n, GoSub(psn_AgiSeize_0507,s,1(${ErrCode}))
	same => n, Set(retval=${GOSUB_RETVAL})

	same => n, GotoIf($[${retval} = 2620]?PALC_agi_succ)	; // OK
	same => n, GotoIf($[${retval} = 2621]?PALC_agi_fail)	; // fail
	same => n, Goto(PALC_agi_fail)

	same => n(PALC_agi_succ), Set(m_Seize_0507=1)		; // 0=not_seized,1=seized
	same => n, Goto(PALC_1)

	same => n(PALC_agi_fail), Set(ErrCode=PALC_agi_fail)
	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},${retval}))
	same => n, Goto(PALC_0)

	same => n(PALC_1), Return(${ExecSts})	; // Succ - 계속 진행
	same => n(PALC_0), Return(0)		; // Fail - 종료


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] psn_Seize_0507/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_GetLastCallHistory                                                         *
;   마지막 호출자와 통화시 사용하였던 0507번호 검색                              *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_GetLastCallHistory]
exten => s, 1, Noop(ps_GetLastCallHistory from [${ARG1}])
	same => n, GotoIf($["${m_MyPsnType}" != "QR_PSN"]?PGLC_0)
	same => n, Set(LOCAL(ErrCode)=${ARG1})
	same => n, Set(LOCAL(retval)=9999)
	same => n, GotoIf($["${m_MyPsnType}" != "QR_PSN"]?PGLC_1)

	same => n, GoSub(psn_AgiGetLastCallHistory,s,1(${ErrCode}))
	same => n, Set(retval=${GOSUB_RETVAL})

	same => n, GotoIf($[${retval} = 2640]?PGLC_1)	; // OK
	same => n, GotoIf($[${retval} = 2641]?PGLC_2)	; // fail
	same => n, Goto(PGLC_0)

	same => n(PGLC_0), Return(0)	; // Fail - 현재 점유중인 0507번호를 발신번호로
	same => n(PGLC_1), Return(1)	; // Succ - 이전 사용한 0507번호를 발신번호로
	same => n(PGLC_2), Return(2)	; // Fail - 현재 점유중인 0507번호를 발신번호로


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_0507_Number}] GetLastCallHistory/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; psn_CheckCallerId                                                              *
;   발신번호가 등록된 가입자인지 여부와 0507번호 할당 요청                       *
;   1) input  : none                                                             *
;   2) output : none                                                             *
;                                                                                *
; ********************************************************************************

[psn_CheckCallerId]
exten => s, 1, Noop(psn_CheckCallerId from [${ARG1}])
	same => n, Set(LOCAL(ErrCode)=${ARG1})
	same => n, Set(LOCAL(retval)=9999)
	same => n, Set(m_QR_Inform=)
	same => n, Set(m_0507_Inform=)

	same => n, GotoIf($["${m_MyPsnType}" != "QR_PSN"]?PGLC_1)

	same => n, GoSub(psn_AgiCheckCallerId,s,1(${ErrCode}))
	same => n, Set(retval=${GOSUB_RETVAL})

	same => n, GotoIf($[${retval} = 2610]?PCCI_agi_succ)	; // OK
	same => n, GotoIf($[${retval} = 2611]?PCCI_agi_fail)	; // 발신번호로 검색된 정보없음
	same => n, GotoIf($[${retval} = 2612]?PCCI_agi_fail)	; // 0507번호 할당받지 못함
	same => n, Goto(PCCI_agi_fail)

	same => n(PCCI_agi_succ), Set(ErrCode=PCCI_agi_succ)
	same => n, ExecIf($[${LEN(${m_QR_Inform})} = 0]?Set(retval=2613)	; // QR정보 수신못함
	same => n, GotoIf($[${retval} != 2610]?PCCI_agi_fail)

	same => n, ExecIf($[${LEN(${m_0507_Inform})} = 0]?Set(retval=2614)	; // 0507번호 수신못함
	same => n, GotoIf($[${retval} != 2610]?PCCI_agi_fail)
	same => n, Set(m_0507_Number=${m_0507_Inform})
	same => n, Goto(PCCI_1)

	same => n(PCCI_agi_fail), Set(ErrCode=PCCI_agi_fail)
	same => n, GoSub(psn_PlayAnm,s,1(${ErrCode},${retval}))
	same => n, Goto(PCCI_0)

	same => n(PCCI_0), Return(0)	; // Fail
	same => n(PCCI_1), Return(1)	; // Succ


exten => h,1, Log(NOTICE,PSN [${m_CALLER} --> ${m_CALLEE}] psn_CheckCallerId/Hangup ERR=[${ErrorCode} ${ErrCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; QR PSN(QR 주차 안심 번호 서비스)                                               *
;    - 부착뇐 QR코드를 스캔한후에 서버에서 수신한 0507번호를 호출시 서비스       *
;                                                                                *
; ********************************************************************************

[qrpsn_main]
exten => _X., 1, Noop([qrpsn_main] Recv Call [${CALLERID(ANI)} --> ${CALLERID(DNID)}] From [${CHANNEL(peerip)}] )
	same => n, Ringing()

	; ********************************************************************************
	; 1-1. 공통 정보 초기화                                                          *
	; ********************************************************************************
	same => n(psn_initial), Set(ErrorCode=psn_initial)
	same => n, GoSub(psn_InitCommInfo,s,1(QR_PSN))		; // 1=NM_PSN, 2=QR_PSN

	; ********************************************************************************
	; 1-2.1 0507 번호 검색                                                           *
	; ********************************************************************************
	same => n(qrpsn_get_0507), Set(ErrorCode=qrpsn_get_0507)
	same => n, Set(DAOU050NUMBER=)

	same => n, GoSub(GetDau050Number,start,1(${ErrorCode},1,${m_CALLER},${m_CALLEE}))	; // 1=err_ment_on, 2=off
	same => n, Set(m_0507_Number=${GOSUB_RETVAL})
	same => n, Noop([PSN : ${CALLER} --> ${CALLEE}] m_0507_Number=[${m_0507_Number}] )

	same => n, Answer()
	same => n, GotoIf($[${m_0507_Number} != 0]?psn_get_qrinfo)
	same => n, Hangup()

	; ********************************************************************************
	; 1-2.2 QR 고유번호 검색                                                         *
	; ********************************************************************************
	same => n(psn_get_qrinfo), Set(ErrorCode=psn_get_qrinfo)
	same => n, GoSub(psn_GetQRInform,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})

	same => n, GotoIf($[${rValue} = 1]?psn_start,${EXTEN},1)
	same => n, Hangup()

exten => h, 1, Log(NOTICE,[${m_CALLER} --> ${m_0507_Number}] [qrpsn_main] ERR=[${ErrorCode}] )
	same => n, Hangup()





; ********************************************************************************
;                                                                                *
; QR PSN(QR 주차 안심 번호 서비스)                                               *
;    - 지정된 번호를 직접호출하는 경우에 서비스함                                *
;                                                                                *
; ********************************************************************************

[qrpsn_svc]
exten => _X., 1, Noop([qrpsn_svc] Recv Call [${CALLERID(ANI)} --> ${CALLERID(DNID)}] From [${CHANNEL(peerip)}] )
	same => n, Ringing()

	; ********************************************************************************
	; 1-1. 공통 정보 초기화                                                          *
	; ********************************************************************************
	same => n(psn_initial), Set(ErrorCode=psn_initial)
	same => n, GoSub(psn_InitCommInfo,s,1(QR_PSN))		; // 1=NM_PSN, 2=QR_PSN

	; ********************************************************************************
	; 1-2.1 QR 정보, 0507번호 검색                                                   *
	; ********************************************************************************
	same => n(qrpsn_get_qrinfo), Set(ErrorCode=qrpsn_get_qrinfo)
	same => n, GoSub(psn_CheckCallerId,s,1(${ErrorCode}))
	same => n, Set(rValue=${GOSUB_RETVAL})

	same => n, GotoIf($[${rValue} = 1]?psn_start,${EXTEN},1)
	same => n, Hangup()

exten => h, 1, Log(NOTICE,[${m_CALLER} --> ${m_0507_Number}] [qrpsn_svc] ERR=[${ErrorCode}] )
	same => n, Hangup()
